{"ast":null,"code":"'use strict';\n\nvar glPlot3d = require('gl-plot3d');\n\nvar createCamera = glPlot3d.createCamera;\nvar createPlot = glPlot3d.createScene;\n\nvar getContext = require('webgl-context');\n\nvar passiveSupported = require('has-passive-events');\n\nvar Registry = require('../../registry');\n\nvar Lib = require('../../lib');\n\nvar preserveDrawingBuffer = Lib.preserveDrawingBuffer();\n\nvar Axes = require('../../plots/cartesian/axes');\n\nvar Fx = require('../../components/fx');\n\nvar str2RGBAarray = require('../../lib/str2rgbarray');\n\nvar showNoWebGlMsg = require('../../lib/show_no_webgl_msg');\n\nvar project = require('./project');\n\nvar createAxesOptions = require('./layout/convert');\n\nvar createSpikeOptions = require('./layout/spikes');\n\nvar computeTickMarks = require('./layout/tick_marks');\n\nvar STATIC_CANVAS, STATIC_CONTEXT;\n\nfunction Scene(options, fullLayout) {\n  // create sub container for plot\n  var sceneContainer = document.createElement('div');\n  var plotContainer = options.container; // keep a ref to the graph div to fire hover+click events\n\n  this.graphDiv = options.graphDiv; // create SVG container for hover text\n\n  var svgContainer = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\n  svgContainer.style.position = 'absolute';\n  svgContainer.style.top = svgContainer.style.left = '0px';\n  svgContainer.style.width = svgContainer.style.height = '100%';\n  svgContainer.style['z-index'] = 20;\n  svgContainer.style['pointer-events'] = 'none';\n  sceneContainer.appendChild(svgContainer);\n  this.svgContainer = svgContainer; // Tag the container with the sceneID\n\n  sceneContainer.id = options.id;\n  sceneContainer.style.position = 'absolute';\n  sceneContainer.style.top = sceneContainer.style.left = '0px';\n  sceneContainer.style.width = sceneContainer.style.height = '100%';\n  plotContainer.appendChild(sceneContainer);\n  this.fullLayout = fullLayout;\n  this.id = options.id || 'scene';\n  this.fullSceneLayout = fullLayout[this.id]; // Saved from last call to plot()\n\n  this.plotArgs = [[], {}, {}];\n  /*\n   * Move this to calc step? Why does it work here?\n   */\n\n  this.axesOptions = createAxesOptions(fullLayout, fullLayout[this.id]);\n  this.spikeOptions = createSpikeOptions(fullLayout[this.id]);\n  this.container = sceneContainer;\n  this.staticMode = !!options.staticPlot;\n  this.pixelRatio = this.pixelRatio || options.plotGlPixelRatio || 2; // Coordinate rescaling\n\n  this.dataScale = [1, 1, 1];\n  this.contourLevels = [[], [], []];\n  this.convertAnnotations = Registry.getComponentMethod('annotations3d', 'convert');\n  this.drawAnnotations = Registry.getComponentMethod('annotations3d', 'draw');\n  this.initializeGLPlot();\n}\n\nvar proto = Scene.prototype;\n\nproto.prepareOptions = function () {\n  var scene = this;\n  var opts = {\n    canvas: scene.canvas,\n    gl: scene.gl,\n    glOptions: {\n      preserveDrawingBuffer: preserveDrawingBuffer,\n      premultipliedAlpha: true,\n      antialias: true\n    },\n    container: scene.container,\n    axes: scene.axesOptions,\n    spikes: scene.spikeOptions,\n    pickRadius: 10,\n    snapToData: true,\n    autoScale: true,\n    autoBounds: false,\n    cameraObject: scene.camera,\n    pixelRatio: scene.pixelRatio\n  }; // for static plots, we reuse the WebGL context\n  //  as WebKit doesn't collect them reliably\n\n  if (scene.staticMode) {\n    if (!STATIC_CONTEXT) {\n      STATIC_CANVAS = document.createElement('canvas');\n      STATIC_CONTEXT = getContext({\n        canvas: STATIC_CANVAS,\n        preserveDrawingBuffer: true,\n        premultipliedAlpha: true,\n        antialias: true\n      });\n\n      if (!STATIC_CONTEXT) {\n        throw new Error('error creating static canvas/context for image server');\n      }\n    }\n\n    opts.gl = STATIC_CONTEXT;\n    opts.canvas = STATIC_CANVAS;\n  }\n\n  return opts;\n};\n\nvar firstInit = true;\n\nproto.tryCreatePlot = function () {\n  var scene = this;\n  var opts = scene.prepareOptions();\n  var success = true;\n\n  try {\n    scene.glplot = createPlot(opts);\n  } catch (e) {\n    if (scene.staticMode || !firstInit || preserveDrawingBuffer) {\n      success = false;\n    } else {\n      // try second time\n      // enable preserveDrawingBuffer setup\n      // in case is-mobile not detecting the right device\n      Lib.warn(['webgl setup failed possibly due to', 'false preserveDrawingBuffer config.', 'The mobile/tablet device may not be detected by is-mobile module.', 'Enabling preserveDrawingBuffer in second attempt to create webgl scene...'].join(' '));\n\n      try {\n        // invert preserveDrawingBuffer\n        preserveDrawingBuffer = opts.glOptions.preserveDrawingBuffer = true;\n        scene.glplot = createPlot(opts);\n      } catch (e) {\n        // revert changes to preserveDrawingBuffer\n        preserveDrawingBuffer = opts.glOptions.preserveDrawingBuffer = false;\n        success = false;\n      }\n    }\n  }\n\n  firstInit = false;\n  return success;\n};\n\nproto.initializeGLCamera = function () {\n  var scene = this;\n  var cameraData = scene.fullSceneLayout.camera;\n  var isOrtho = cameraData.projection.type === 'orthographic';\n  scene.camera = createCamera(scene.container, {\n    center: [cameraData.center.x, cameraData.center.y, cameraData.center.z],\n    eye: [cameraData.eye.x, cameraData.eye.y, cameraData.eye.z],\n    up: [cameraData.up.x, cameraData.up.y, cameraData.up.z],\n    _ortho: isOrtho,\n    zoomMin: 0.01,\n    zoomMax: 100,\n    mode: 'orbit'\n  });\n};\n\nproto.initializeGLPlot = function () {\n  var scene = this;\n  scene.initializeGLCamera();\n  var success = scene.tryCreatePlot();\n  /*\n  * createPlot will throw when webgl is not enabled in the client.\n  * Lets return an instance of the module with all functions noop'd.\n  * The destroy method - which will remove the container from the DOM\n  * is overridden with a function that removes the container only.\n  */\n\n  if (!success) return showNoWebGlMsg(scene); // List of scene objects\n\n  scene.traces = {};\n  scene.make4thDimension();\n  var gd = scene.graphDiv;\n  var layout = gd.layout;\n\n  var makeUpdate = function () {\n    var update = {};\n\n    if (scene.isCameraChanged(layout)) {\n      // camera updates\n      update[scene.id + '.camera'] = scene.getCamera();\n    }\n\n    if (scene.isAspectChanged(layout)) {\n      // scene updates\n      update[scene.id + '.aspectratio'] = scene.glplot.getAspectratio();\n\n      if (layout[scene.id].aspectmode !== 'manual') {\n        scene.fullSceneLayout.aspectmode = layout[scene.id].aspectmode = update[scene.id + '.aspectmode'] = 'manual';\n      }\n    }\n\n    return update;\n  };\n\n  var relayoutCallback = function (scene) {\n    if (scene.fullSceneLayout.dragmode === false) return;\n    var update = makeUpdate();\n    scene.saveLayout(layout);\n    scene.graphDiv.emit('plotly_relayout', update);\n  };\n\n  if (scene.glplot.canvas) {\n    scene.glplot.canvas.addEventListener('mouseup', function () {\n      relayoutCallback(scene);\n    });\n    scene.glplot.canvas.addEventListener('wheel', function (e) {\n      if (gd._context._scrollZoom.gl3d) {\n        if (scene.camera._ortho) {\n          var s = e.deltaX > e.deltaY ? 1.1 : 1.0 / 1.1;\n          var o = scene.glplot.getAspectratio();\n          scene.glplot.setAspectratio({\n            x: s * o.x,\n            y: s * o.y,\n            z: s * o.z\n          });\n        }\n\n        relayoutCallback(scene);\n      }\n    }, passiveSupported ? {\n      passive: false\n    } : false);\n    scene.glplot.canvas.addEventListener('mousemove', function () {\n      if (scene.fullSceneLayout.dragmode === false) return;\n      if (scene.camera.mouseListener.buttons === 0) return;\n      var update = makeUpdate();\n      scene.graphDiv.emit('plotly_relayouting', update);\n    });\n\n    if (!scene.staticMode) {\n      scene.glplot.canvas.addEventListener('webglcontextlost', function (event) {\n        if (gd && gd.emit) {\n          gd.emit('plotly_webglcontextlost', {\n            event: event,\n            layer: scene.id\n          });\n        }\n      }, false);\n    }\n  }\n\n  scene.glplot.oncontextloss = function () {\n    scene.recoverContext();\n  };\n\n  scene.glplot.onrender = function () {\n    scene.render();\n  };\n\n  return true;\n};\n\nproto.render = function () {\n  var scene = this;\n  var gd = scene.graphDiv;\n  var trace; // update size of svg container\n\n  var svgContainer = scene.svgContainer;\n  var clientRect = scene.container.getBoundingClientRect();\n\n  gd._fullLayout._calcInverseTransform(gd);\n\n  var scaleX = gd._fullLayout._invScaleX;\n  var scaleY = gd._fullLayout._invScaleY;\n  var width = clientRect.width * scaleX;\n  var height = clientRect.height * scaleY;\n  svgContainer.setAttributeNS(null, 'viewBox', '0 0 ' + width + ' ' + height);\n  svgContainer.setAttributeNS(null, 'width', width);\n  svgContainer.setAttributeNS(null, 'height', height);\n  computeTickMarks(scene);\n  scene.glplot.axes.update(scene.axesOptions); // check if pick has changed\n\n  var keys = Object.keys(scene.traces);\n  var lastPicked = null;\n  var selection = scene.glplot.selection;\n\n  for (var i = 0; i < keys.length; ++i) {\n    trace = scene.traces[keys[i]];\n\n    if (trace.data.hoverinfo !== 'skip' && trace.handlePick(selection)) {\n      lastPicked = trace;\n    }\n\n    if (trace.setContourLevels) trace.setContourLevels();\n  }\n\n  function formatter(axLetter, val, hoverformat) {\n    var ax = scene.fullSceneLayout[axLetter + 'axis'];\n\n    if (ax.type !== 'log') {\n      val = ax.d2l(val);\n    }\n\n    return Axes.hoverLabelText(ax, val, hoverformat);\n  }\n\n  var oldEventData;\n\n  if (lastPicked !== null) {\n    var pdata = project(scene.glplot.cameraParams, selection.dataCoordinate);\n    trace = lastPicked.data;\n    var traceNow = gd._fullData[trace.index];\n    var ptNumber = selection.index;\n    var labels = {\n      xLabel: formatter('x', selection.traceCoordinate[0], trace.xhoverformat),\n      yLabel: formatter('y', selection.traceCoordinate[1], trace.yhoverformat),\n      zLabel: formatter('z', selection.traceCoordinate[2], trace.zhoverformat)\n    };\n    var hoverinfo = Fx.castHoverinfo(traceNow, scene.fullLayout, ptNumber);\n    var hoverinfoParts = (hoverinfo || '').split('+');\n    var isHoverinfoAll = hoverinfo && hoverinfo === 'all';\n\n    if (!traceNow.hovertemplate && !isHoverinfoAll) {\n      if (hoverinfoParts.indexOf('x') === -1) labels.xLabel = undefined;\n      if (hoverinfoParts.indexOf('y') === -1) labels.yLabel = undefined;\n      if (hoverinfoParts.indexOf('z') === -1) labels.zLabel = undefined;\n      if (hoverinfoParts.indexOf('text') === -1) selection.textLabel = undefined;\n      if (hoverinfoParts.indexOf('name') === -1) lastPicked.name = undefined;\n    }\n\n    var tx;\n    var vectorTx = [];\n\n    if (trace.type === 'cone' || trace.type === 'streamtube') {\n      labels.uLabel = formatter('x', selection.traceCoordinate[3], trace.uhoverformat);\n\n      if (isHoverinfoAll || hoverinfoParts.indexOf('u') !== -1) {\n        vectorTx.push('u: ' + labels.uLabel);\n      }\n\n      labels.vLabel = formatter('y', selection.traceCoordinate[4], trace.vhoverformat);\n\n      if (isHoverinfoAll || hoverinfoParts.indexOf('v') !== -1) {\n        vectorTx.push('v: ' + labels.vLabel);\n      }\n\n      labels.wLabel = formatter('z', selection.traceCoordinate[5], trace.whoverformat);\n\n      if (isHoverinfoAll || hoverinfoParts.indexOf('w') !== -1) {\n        vectorTx.push('w: ' + labels.wLabel);\n      }\n\n      labels.normLabel = selection.traceCoordinate[6].toPrecision(3);\n\n      if (isHoverinfoAll || hoverinfoParts.indexOf('norm') !== -1) {\n        vectorTx.push('norm: ' + labels.normLabel);\n      }\n\n      if (trace.type === 'streamtube') {\n        labels.divergenceLabel = selection.traceCoordinate[7].toPrecision(3);\n\n        if (isHoverinfoAll || hoverinfoParts.indexOf('divergence') !== -1) {\n          vectorTx.push('divergence: ' + labels.divergenceLabel);\n        }\n      }\n\n      if (selection.textLabel) {\n        vectorTx.push(selection.textLabel);\n      }\n\n      tx = vectorTx.join('<br>');\n    } else if (trace.type === 'isosurface' || trace.type === 'volume') {\n      labels.valueLabel = Axes.hoverLabelText(scene._mockAxis, scene._mockAxis.d2l(selection.traceCoordinate[3]), trace.valuehoverformat);\n      vectorTx.push('value: ' + labels.valueLabel);\n\n      if (selection.textLabel) {\n        vectorTx.push(selection.textLabel);\n      }\n\n      tx = vectorTx.join('<br>');\n    } else {\n      tx = selection.textLabel;\n    }\n\n    var pointData = {\n      x: selection.traceCoordinate[0],\n      y: selection.traceCoordinate[1],\n      z: selection.traceCoordinate[2],\n      data: traceNow._input,\n      fullData: traceNow,\n      curveNumber: traceNow.index,\n      pointNumber: ptNumber\n    };\n    Fx.appendArrayPointValue(pointData, traceNow, ptNumber);\n\n    if (trace._module.eventData) {\n      pointData = traceNow._module.eventData(pointData, selection, traceNow, {}, ptNumber);\n    }\n\n    var eventData = {\n      points: [pointData]\n    };\n\n    if (scene.fullSceneLayout.hovermode) {\n      var bbox = [];\n      Fx.loneHover({\n        trace: traceNow,\n        x: (0.5 + 0.5 * pdata[0] / pdata[3]) * width,\n        y: (0.5 - 0.5 * pdata[1] / pdata[3]) * height,\n        xLabel: labels.xLabel,\n        yLabel: labels.yLabel,\n        zLabel: labels.zLabel,\n        text: tx,\n        name: lastPicked.name,\n        color: Fx.castHoverOption(traceNow, ptNumber, 'bgcolor') || lastPicked.color,\n        borderColor: Fx.castHoverOption(traceNow, ptNumber, 'bordercolor'),\n        fontFamily: Fx.castHoverOption(traceNow, ptNumber, 'font.family'),\n        fontSize: Fx.castHoverOption(traceNow, ptNumber, 'font.size'),\n        fontColor: Fx.castHoverOption(traceNow, ptNumber, 'font.color'),\n        nameLength: Fx.castHoverOption(traceNow, ptNumber, 'namelength'),\n        textAlign: Fx.castHoverOption(traceNow, ptNumber, 'align'),\n        hovertemplate: Lib.castOption(traceNow, ptNumber, 'hovertemplate'),\n        hovertemplateLabels: Lib.extendFlat({}, pointData, labels),\n        eventData: [pointData]\n      }, {\n        container: svgContainer,\n        gd: gd,\n        inOut_bbox: bbox\n      });\n      pointData.bbox = bbox[0];\n    }\n\n    if (selection.buttons && selection.distance < 5) {\n      gd.emit('plotly_click', eventData);\n    } else {\n      gd.emit('plotly_hover', eventData);\n    }\n\n    oldEventData = eventData;\n  } else {\n    Fx.loneUnhover(svgContainer);\n    gd.emit('plotly_unhover', oldEventData);\n  }\n\n  scene.drawAnnotations(scene);\n};\n\nproto.recoverContext = function () {\n  var scene = this;\n  scene.glplot.dispose();\n\n  var tryRecover = function () {\n    if (scene.glplot.gl.isContextLost()) {\n      requestAnimationFrame(tryRecover);\n      return;\n    }\n\n    if (!scene.initializeGLPlot()) {\n      Lib.error('Catastrophic and unrecoverable WebGL error. Context lost.');\n      return;\n    }\n\n    scene.plot.apply(scene, scene.plotArgs);\n  };\n\n  requestAnimationFrame(tryRecover);\n};\n\nvar axisProperties = ['xaxis', 'yaxis', 'zaxis'];\n\nfunction computeTraceBounds(scene, trace, bounds) {\n  var fullSceneLayout = scene.fullSceneLayout;\n\n  for (var d = 0; d < 3; d++) {\n    var axisName = axisProperties[d];\n    var axLetter = axisName.charAt(0);\n    var ax = fullSceneLayout[axisName];\n    var coords = trace[axLetter];\n    var calendar = trace[axLetter + 'calendar'];\n    var len = trace['_' + axLetter + 'length'];\n\n    if (!Lib.isArrayOrTypedArray(coords)) {\n      bounds[0][d] = Math.min(bounds[0][d], 0);\n      bounds[1][d] = Math.max(bounds[1][d], len - 1);\n    } else {\n      var v;\n\n      for (var i = 0; i < (len || coords.length); i++) {\n        if (Lib.isArrayOrTypedArray(coords[i])) {\n          for (var j = 0; j < coords[i].length; ++j) {\n            v = ax.d2l(coords[i][j], 0, calendar);\n\n            if (!isNaN(v) && isFinite(v)) {\n              bounds[0][d] = Math.min(bounds[0][d], v);\n              bounds[1][d] = Math.max(bounds[1][d], v);\n            }\n          }\n        } else {\n          v = ax.d2l(coords[i], 0, calendar);\n\n          if (!isNaN(v) && isFinite(v)) {\n            bounds[0][d] = Math.min(bounds[0][d], v);\n            bounds[1][d] = Math.max(bounds[1][d], v);\n          }\n        }\n      }\n    }\n  }\n}\n\nfunction computeAnnotationBounds(scene, bounds) {\n  var fullSceneLayout = scene.fullSceneLayout;\n  var annotations = fullSceneLayout.annotations || [];\n\n  for (var d = 0; d < 3; d++) {\n    var axisName = axisProperties[d];\n    var axLetter = axisName.charAt(0);\n    var ax = fullSceneLayout[axisName];\n\n    for (var j = 0; j < annotations.length; j++) {\n      var ann = annotations[j];\n\n      if (ann.visible) {\n        var pos = ax.r2l(ann[axLetter]);\n\n        if (!isNaN(pos) && isFinite(pos)) {\n          bounds[0][d] = Math.min(bounds[0][d], pos);\n          bounds[1][d] = Math.max(bounds[1][d], pos);\n        }\n      }\n    }\n  }\n}\n\nproto.plot = function (sceneData, fullLayout, layout) {\n  var scene = this; // Save parameters\n\n  scene.plotArgs = [sceneData, fullLayout, layout];\n  if (scene.glplot.contextLost) return;\n  var data, trace;\n  var i, j, axis, axisType;\n  var fullSceneLayout = fullLayout[scene.id];\n  var sceneLayout = layout[scene.id]; // Update layout\n\n  scene.fullLayout = fullLayout;\n  scene.fullSceneLayout = fullSceneLayout;\n  scene.axesOptions.merge(fullLayout, fullSceneLayout);\n  scene.spikeOptions.merge(fullSceneLayout); // Update camera and camera mode\n\n  scene.setViewport(fullSceneLayout);\n  scene.updateFx(fullSceneLayout.dragmode, fullSceneLayout.hovermode);\n  scene.camera.enableWheel = scene.graphDiv._context._scrollZoom.gl3d; // Update scene background\n\n  scene.glplot.setClearColor(str2RGBAarray(fullSceneLayout.bgcolor)); // Update axes functions BEFORE updating traces\n\n  scene.setConvert(axis); // Convert scene data\n\n  if (!sceneData) sceneData = [];else if (!Array.isArray(sceneData)) sceneData = [sceneData]; // Compute trace bounding box\n\n  var dataBounds = [[Infinity, Infinity, Infinity], [-Infinity, -Infinity, -Infinity]];\n\n  for (i = 0; i < sceneData.length; ++i) {\n    data = sceneData[i];\n    if (data.visible !== true || data._length === 0) continue;\n    computeTraceBounds(this, data, dataBounds);\n  }\n\n  computeAnnotationBounds(this, dataBounds);\n  var dataScale = [1, 1, 1];\n\n  for (j = 0; j < 3; ++j) {\n    if (dataBounds[1][j] === dataBounds[0][j]) {\n      dataScale[j] = 1.0;\n    } else {\n      dataScale[j] = 1.0 / (dataBounds[1][j] - dataBounds[0][j]);\n    }\n  } // Save scale\n\n\n  scene.dataScale = dataScale; // after computeTraceBounds where ax._categories are filled in\n\n  scene.convertAnnotations(this); // Update traces\n\n  for (i = 0; i < sceneData.length; ++i) {\n    data = sceneData[i];\n\n    if (data.visible !== true || data._length === 0) {\n      continue;\n    }\n\n    trace = scene.traces[data.uid];\n\n    if (trace) {\n      if (trace.data.type === data.type) {\n        trace.update(data);\n      } else {\n        trace.dispose();\n        trace = data._module.plot(this, data);\n        scene.traces[data.uid] = trace;\n      }\n    } else {\n      trace = data._module.plot(this, data);\n      scene.traces[data.uid] = trace;\n    }\n\n    trace.name = data.name;\n  } // Remove empty traces\n\n\n  var traceIds = Object.keys(scene.traces);\n\n  traceIdLoop: for (i = 0; i < traceIds.length; ++i) {\n    for (j = 0; j < sceneData.length; ++j) {\n      if (sceneData[j].uid === traceIds[i] && sceneData[j].visible === true && sceneData[j]._length !== 0) {\n        continue traceIdLoop;\n      }\n    }\n\n    trace = scene.traces[traceIds[i]];\n    trace.dispose();\n    delete scene.traces[traceIds[i]];\n  } // order object per trace index\n\n\n  scene.glplot.objects.sort(function (a, b) {\n    return a._trace.data.index - b._trace.data.index;\n  }); // Update ranges (needs to be called *after* objects are added due to updates)\n\n  var sceneBounds = [[0, 0, 0], [0, 0, 0]];\n  var axisDataRange = [];\n  var axisTypeRatios = {};\n\n  for (i = 0; i < 3; ++i) {\n    axis = fullSceneLayout[axisProperties[i]];\n    axisType = axis.type;\n\n    if (axisType in axisTypeRatios) {\n      axisTypeRatios[axisType].acc *= dataScale[i];\n      axisTypeRatios[axisType].count += 1;\n    } else {\n      axisTypeRatios[axisType] = {\n        acc: dataScale[i],\n        count: 1\n      };\n    }\n\n    if (axis.autorange) {\n      sceneBounds[0][i] = Infinity;\n      sceneBounds[1][i] = -Infinity;\n      var objects = scene.glplot.objects;\n      var annotations = scene.fullSceneLayout.annotations || [];\n\n      var axLetter = axis._name.charAt(0);\n\n      for (j = 0; j < objects.length; j++) {\n        var obj = objects[j];\n        var objBounds = obj.bounds;\n        var pad = obj._trace.data._pad || 0;\n\n        if (obj.constructor.name === 'ErrorBars' && axis._lowerLogErrorBound) {\n          sceneBounds[0][i] = Math.min(sceneBounds[0][i], axis._lowerLogErrorBound);\n        } else {\n          sceneBounds[0][i] = Math.min(sceneBounds[0][i], objBounds[0][i] / dataScale[i] - pad);\n        }\n\n        sceneBounds[1][i] = Math.max(sceneBounds[1][i], objBounds[1][i] / dataScale[i] + pad);\n      }\n\n      for (j = 0; j < annotations.length; j++) {\n        var ann = annotations[j]; // N.B. not taking into consideration the arrowhead\n\n        if (ann.visible) {\n          var pos = axis.r2l(ann[axLetter]);\n          sceneBounds[0][i] = Math.min(sceneBounds[0][i], pos);\n          sceneBounds[1][i] = Math.max(sceneBounds[1][i], pos);\n        }\n      }\n\n      if ('rangemode' in axis && axis.rangemode === 'tozero') {\n        sceneBounds[0][i] = Math.min(sceneBounds[0][i], 0);\n        sceneBounds[1][i] = Math.max(sceneBounds[1][i], 0);\n      }\n\n      if (sceneBounds[0][i] > sceneBounds[1][i]) {\n        sceneBounds[0][i] = -1;\n        sceneBounds[1][i] = 1;\n      } else {\n        var d = sceneBounds[1][i] - sceneBounds[0][i];\n        sceneBounds[0][i] -= d / 32.0;\n        sceneBounds[1][i] += d / 32.0;\n      }\n\n      if (axis.autorange === 'reversed') {\n        // swap bounds:\n        var tmp = sceneBounds[0][i];\n        sceneBounds[0][i] = sceneBounds[1][i];\n        sceneBounds[1][i] = tmp;\n      }\n    } else {\n      var range = axis.range;\n      sceneBounds[0][i] = axis.r2l(range[0]);\n      sceneBounds[1][i] = axis.r2l(range[1]);\n    }\n\n    if (sceneBounds[0][i] === sceneBounds[1][i]) {\n      sceneBounds[0][i] -= 1;\n      sceneBounds[1][i] += 1;\n    }\n\n    axisDataRange[i] = sceneBounds[1][i] - sceneBounds[0][i]; // Update plot bounds\n\n    scene.glplot.setBounds(i, {\n      min: sceneBounds[0][i] * dataScale[i],\n      max: sceneBounds[1][i] * dataScale[i]\n    });\n  }\n  /*\n   * Dynamically set the aspect ratio depending on the users aspect settings\n   */\n\n\n  var aspectRatio;\n  var aspectmode = fullSceneLayout.aspectmode;\n\n  if (aspectmode === 'cube') {\n    aspectRatio = [1, 1, 1];\n  } else if (aspectmode === 'manual') {\n    var userRatio = fullSceneLayout.aspectratio;\n    aspectRatio = [userRatio.x, userRatio.y, userRatio.z];\n  } else if (aspectmode === 'auto' || aspectmode === 'data') {\n    var axesScaleRatio = [1, 1, 1]; // Compute axis scale per category\n\n    for (i = 0; i < 3; ++i) {\n      axis = fullSceneLayout[axisProperties[i]];\n      axisType = axis.type;\n      var axisRatio = axisTypeRatios[axisType];\n      axesScaleRatio[i] = Math.pow(axisRatio.acc, 1.0 / axisRatio.count) / dataScale[i];\n    }\n\n    if (aspectmode === 'data') {\n      aspectRatio = axesScaleRatio;\n    } else {\n      // i.e. 'auto' option\n      if (Math.max.apply(null, axesScaleRatio) / Math.min.apply(null, axesScaleRatio) <= 4) {\n        // USE DATA MODE WHEN AXIS RANGE DIMENSIONS ARE RELATIVELY EQUAL\n        aspectRatio = axesScaleRatio;\n      } else {\n        // USE EQUAL MODE WHEN AXIS RANGE DIMENSIONS ARE HIGHLY UNEQUAL\n        aspectRatio = [1, 1, 1];\n      }\n    }\n  } else {\n    throw new Error('scene.js aspectRatio was not one of the enumerated types');\n  }\n  /*\n   * Write aspect Ratio back to user data and fullLayout so that it is modifies as user\n   * manipulates the aspectmode settings and the fullLayout is up-to-date.\n   */\n\n\n  fullSceneLayout.aspectratio.x = sceneLayout.aspectratio.x = aspectRatio[0];\n  fullSceneLayout.aspectratio.y = sceneLayout.aspectratio.y = aspectRatio[1];\n  fullSceneLayout.aspectratio.z = sceneLayout.aspectratio.z = aspectRatio[2];\n  /*\n   * Finally assign the computed aspecratio to the glplot module. This will have an effect\n   * on the next render cycle.\n   */\n\n  scene.glplot.setAspectratio(fullSceneLayout.aspectratio); // save 'initial' aspectratio & aspectmode view settings for modebar buttons\n\n  if (!scene.viewInitial.aspectratio) {\n    scene.viewInitial.aspectratio = {\n      x: fullSceneLayout.aspectratio.x,\n      y: fullSceneLayout.aspectratio.y,\n      z: fullSceneLayout.aspectratio.z\n    };\n  }\n\n  if (!scene.viewInitial.aspectmode) {\n    scene.viewInitial.aspectmode = fullSceneLayout.aspectmode;\n  } // Update frame position for multi plots\n\n\n  var domain = fullSceneLayout.domain || null;\n  var size = fullLayout._size || null;\n\n  if (domain && size) {\n    var containerStyle = scene.container.style;\n    containerStyle.position = 'absolute';\n    containerStyle.left = size.l + domain.x[0] * size.w + 'px';\n    containerStyle.top = size.t + (1 - domain.y[1]) * size.h + 'px';\n    containerStyle.width = size.w * (domain.x[1] - domain.x[0]) + 'px';\n    containerStyle.height = size.h * (domain.y[1] - domain.y[0]) + 'px';\n  } // force redraw so that promise is returned when rendering is completed\n\n\n  scene.glplot.redraw();\n};\n\nproto.destroy = function () {\n  var scene = this;\n  if (!scene.glplot) return;\n  scene.camera.mouseListener.enabled = false;\n  scene.container.removeEventListener('wheel', scene.camera.wheelListener);\n  scene.camera = null;\n  scene.glplot.dispose();\n  scene.container.parentNode.removeChild(scene.container);\n  scene.glplot = null;\n}; // getCameraArrays :: plotly_coords -> gl-plot3d_coords\n// inverse of getLayoutCamera\n\n\nfunction getCameraArrays(camera) {\n  return [[camera.eye.x, camera.eye.y, camera.eye.z], [camera.center.x, camera.center.y, camera.center.z], [camera.up.x, camera.up.y, camera.up.z]];\n} // getLayoutCamera :: gl-plot3d_coords -> plotly_coords\n// inverse of getCameraArrays\n\n\nfunction getLayoutCamera(camera) {\n  return {\n    up: {\n      x: camera.up[0],\n      y: camera.up[1],\n      z: camera.up[2]\n    },\n    center: {\n      x: camera.center[0],\n      y: camera.center[1],\n      z: camera.center[2]\n    },\n    eye: {\n      x: camera.eye[0],\n      y: camera.eye[1],\n      z: camera.eye[2]\n    },\n    projection: {\n      type: camera._ortho === true ? 'orthographic' : 'perspective'\n    }\n  };\n} // get camera position in plotly coords from 'gl-plot3d' coords\n\n\nproto.getCamera = function () {\n  var scene = this;\n  scene.camera.view.recalcMatrix(scene.camera.view.lastT());\n  return getLayoutCamera(scene.camera);\n}; // set gl-plot3d camera position and scene aspects with a set of plotly coords\n\n\nproto.setViewport = function (sceneLayout) {\n  var scene = this;\n  var cameraData = sceneLayout.camera;\n  scene.camera.lookAt.apply(this, getCameraArrays(cameraData));\n  scene.glplot.setAspectratio(sceneLayout.aspectratio);\n  var newOrtho = cameraData.projection.type === 'orthographic';\n  var oldOrtho = scene.camera._ortho;\n\n  if (newOrtho !== oldOrtho) {\n    scene.glplot.redraw(); // TODO: figure out why we need to redraw here?\n\n    scene.glplot.clearRGBA();\n    scene.glplot.dispose();\n    scene.initializeGLPlot();\n  }\n};\n\nproto.isCameraChanged = function (layout) {\n  var scene = this;\n  var cameraData = scene.getCamera();\n  var cameraNestedProp = Lib.nestedProperty(layout, scene.id + '.camera');\n  var cameraDataLastSave = cameraNestedProp.get();\n\n  function same(x, y, i, j) {\n    var vectors = ['up', 'center', 'eye'];\n    var components = ['x', 'y', 'z'];\n    return y[vectors[i]] && x[vectors[i]][components[j]] === y[vectors[i]][components[j]];\n  }\n\n  var changed = false;\n\n  if (cameraDataLastSave === undefined) {\n    changed = true;\n  } else {\n    for (var i = 0; i < 3; i++) {\n      for (var j = 0; j < 3; j++) {\n        if (!same(cameraData, cameraDataLastSave, i, j)) {\n          changed = true;\n          break;\n        }\n      }\n    }\n\n    if (!cameraDataLastSave.projection || cameraData.projection && cameraData.projection.type !== cameraDataLastSave.projection.type) {\n      changed = true;\n    }\n  }\n\n  return changed;\n};\n\nproto.isAspectChanged = function (layout) {\n  var scene = this;\n  var aspectData = scene.glplot.getAspectratio();\n  var aspectNestedProp = Lib.nestedProperty(layout, scene.id + '.aspectratio');\n  var aspectDataLastSave = aspectNestedProp.get();\n  return aspectDataLastSave === undefined || aspectDataLastSave.x !== aspectData.x || aspectDataLastSave.y !== aspectData.y || aspectDataLastSave.z !== aspectData.z;\n}; // save camera to user layout (i.e. gd.layout)\n\n\nproto.saveLayout = function (layout) {\n  var scene = this;\n  var fullLayout = scene.fullLayout;\n  var cameraData;\n  var cameraNestedProp;\n  var cameraDataLastSave;\n  var aspectData;\n  var aspectNestedProp;\n  var aspectDataLastSave;\n  var cameraChanged = scene.isCameraChanged(layout);\n  var aspectChanged = scene.isAspectChanged(layout);\n  var hasChanged = cameraChanged || aspectChanged;\n\n  if (hasChanged) {\n    var preGUI = {};\n\n    if (cameraChanged) {\n      cameraData = scene.getCamera();\n      cameraNestedProp = Lib.nestedProperty(layout, scene.id + '.camera');\n      cameraDataLastSave = cameraNestedProp.get();\n      preGUI[scene.id + '.camera'] = cameraDataLastSave;\n    }\n\n    if (aspectChanged) {\n      aspectData = scene.glplot.getAspectratio();\n      aspectNestedProp = Lib.nestedProperty(layout, scene.id + '.aspectratio');\n      aspectDataLastSave = aspectNestedProp.get();\n      preGUI[scene.id + '.aspectratio'] = aspectDataLastSave;\n    }\n\n    Registry.call('_storeDirectGUIEdit', layout, fullLayout._preGUI, preGUI);\n\n    if (cameraChanged) {\n      cameraNestedProp.set(cameraData);\n      var cameraFullNP = Lib.nestedProperty(fullLayout, scene.id + '.camera');\n      cameraFullNP.set(cameraData);\n    }\n\n    if (aspectChanged) {\n      aspectNestedProp.set(aspectData);\n      var aspectFullNP = Lib.nestedProperty(fullLayout, scene.id + '.aspectratio');\n      aspectFullNP.set(aspectData);\n      scene.glplot.redraw();\n    }\n  }\n\n  return hasChanged;\n};\n\nproto.updateFx = function (dragmode, hovermode) {\n  var scene = this;\n  var camera = scene.camera;\n\n  if (camera) {\n    // rotate and orbital are synonymous\n    if (dragmode === 'orbit') {\n      camera.mode = 'orbit';\n      camera.keyBindingMode = 'rotate';\n    } else if (dragmode === 'turntable') {\n      camera.up = [0, 0, 1];\n      camera.mode = 'turntable';\n      camera.keyBindingMode = 'rotate'; // The setter for camera.mode animates the transition to z-up,\n      // but only if we *don't* explicitly set z-up earlier via the\n      // relayout. So push `up` back to layout & fullLayout manually now.\n\n      var gd = scene.graphDiv;\n      var fullLayout = gd._fullLayout;\n      var fullCamera = scene.fullSceneLayout.camera;\n      var x = fullCamera.up.x;\n      var y = fullCamera.up.y;\n      var z = fullCamera.up.z; // only push `up` back to (full)layout if it's going to change\n\n      if (z / Math.sqrt(x * x + y * y + z * z) < 0.999) {\n        var attr = scene.id + '.camera.up';\n        var zUp = {\n          x: 0,\n          y: 0,\n          z: 1\n        };\n        var edits = {};\n        edits[attr] = zUp;\n        var layout = gd.layout;\n        Registry.call('_storeDirectGUIEdit', layout, fullLayout._preGUI, edits);\n        fullCamera.up = zUp;\n        Lib.nestedProperty(layout, attr).set(zUp);\n      }\n    } else {\n      // none rotation modes [pan or zoom]\n      camera.keyBindingMode = dragmode;\n    }\n  } // to put dragmode and hovermode on the same grounds from relayout\n\n\n  scene.fullSceneLayout.hovermode = hovermode;\n};\n\nfunction flipPixels(pixels, w, h) {\n  for (var i = 0, q = h - 1; i < q; ++i, --q) {\n    for (var j = 0; j < w; ++j) {\n      for (var k = 0; k < 4; ++k) {\n        var a = 4 * (w * i + j) + k;\n        var b = 4 * (w * q + j) + k;\n        var tmp = pixels[a];\n        pixels[a] = pixels[b];\n        pixels[b] = tmp;\n      }\n    }\n  }\n}\n\nfunction correctRGB(pixels, w, h) {\n  for (var i = 0; i < h; ++i) {\n    for (var j = 0; j < w; ++j) {\n      var k = 4 * (w * i + j);\n      var a = pixels[k + 3]; // alpha\n\n      if (a > 0) {\n        var q = 255 / a;\n\n        for (var l = 0; l < 3; ++l) {\n          // RGB\n          pixels[k + l] = Math.min(q * pixels[k + l], 255);\n        }\n      }\n    }\n  }\n}\n\nproto.toImage = function (format) {\n  var scene = this;\n  if (!format) format = 'png';\n  if (scene.staticMode) scene.container.appendChild(STATIC_CANVAS); // Force redraw\n\n  scene.glplot.redraw(); // Grab context and yank out pixels\n\n  var gl = scene.glplot.gl;\n  var w = gl.drawingBufferWidth;\n  var h = gl.drawingBufferHeight;\n  gl.bindFramebuffer(gl.FRAMEBUFFER, null);\n  var pixels = new Uint8Array(w * h * 4);\n  gl.readPixels(0, 0, w, h, gl.RGBA, gl.UNSIGNED_BYTE, pixels);\n  flipPixels(pixels, w, h);\n  correctRGB(pixels, w, h);\n  var canvas = document.createElement('canvas');\n  canvas.width = w;\n  canvas.height = h;\n  var context = canvas.getContext('2d');\n  var imageData = context.createImageData(w, h);\n  imageData.data.set(pixels);\n  context.putImageData(imageData, 0, 0);\n  var dataURL;\n\n  switch (format) {\n    case 'jpeg':\n      dataURL = canvas.toDataURL('image/jpeg');\n      break;\n\n    case 'webp':\n      dataURL = canvas.toDataURL('image/webp');\n      break;\n\n    default:\n      dataURL = canvas.toDataURL('image/png');\n  }\n\n  if (scene.staticMode) scene.container.removeChild(STATIC_CANVAS);\n  return dataURL;\n};\n\nproto.setConvert = function () {\n  var scene = this;\n\n  for (var i = 0; i < 3; i++) {\n    var ax = scene.fullSceneLayout[axisProperties[i]];\n    Axes.setConvert(ax, scene.fullLayout);\n    ax.setScale = Lib.noop;\n  }\n};\n\nproto.make4thDimension = function () {\n  var scene = this;\n  var gd = scene.graphDiv;\n  var fullLayout = gd._fullLayout; // mock axis for hover formatting\n\n  scene._mockAxis = {\n    type: 'linear',\n    showexponent: 'all',\n    exponentformat: 'B'\n  };\n  Axes.setConvert(scene._mockAxis, fullLayout);\n};\n\nmodule.exports = Scene;","map":{"version":3,"sources":["C:/Projects/reactApp/frontend/node_modules/plotly.js/src/plots/gl3d/scene.js"],"names":["glPlot3d","require","createCamera","createPlot","createScene","getContext","passiveSupported","Registry","Lib","preserveDrawingBuffer","Axes","Fx","str2RGBAarray","showNoWebGlMsg","project","createAxesOptions","createSpikeOptions","computeTickMarks","STATIC_CANVAS","STATIC_CONTEXT","Scene","options","fullLayout","sceneContainer","document","createElement","plotContainer","container","graphDiv","svgContainer","createElementNS","style","position","top","left","width","height","appendChild","id","fullSceneLayout","plotArgs","axesOptions","spikeOptions","staticMode","staticPlot","pixelRatio","plotGlPixelRatio","dataScale","contourLevels","convertAnnotations","getComponentMethod","drawAnnotations","initializeGLPlot","proto","prototype","prepareOptions","scene","opts","canvas","gl","glOptions","premultipliedAlpha","antialias","axes","spikes","pickRadius","snapToData","autoScale","autoBounds","cameraObject","camera","Error","firstInit","tryCreatePlot","success","glplot","e","warn","join","initializeGLCamera","cameraData","isOrtho","projection","type","center","x","y","z","eye","up","_ortho","zoomMin","zoomMax","mode","traces","make4thDimension","gd","layout","makeUpdate","update","isCameraChanged","getCamera","isAspectChanged","getAspectratio","aspectmode","relayoutCallback","dragmode","saveLayout","emit","addEventListener","_context","_scrollZoom","gl3d","s","deltaX","deltaY","o","setAspectratio","passive","mouseListener","buttons","event","layer","oncontextloss","recoverContext","onrender","render","trace","clientRect","getBoundingClientRect","_fullLayout","_calcInverseTransform","scaleX","_invScaleX","scaleY","_invScaleY","setAttributeNS","keys","Object","lastPicked","selection","i","length","data","hoverinfo","handlePick","setContourLevels","formatter","axLetter","val","hoverformat","ax","d2l","hoverLabelText","oldEventData","pdata","cameraParams","dataCoordinate","traceNow","_fullData","index","ptNumber","labels","xLabel","traceCoordinate","xhoverformat","yLabel","yhoverformat","zLabel","zhoverformat","castHoverinfo","hoverinfoParts","split","isHoverinfoAll","hovertemplate","indexOf","undefined","textLabel","name","tx","vectorTx","uLabel","uhoverformat","push","vLabel","vhoverformat","wLabel","whoverformat","normLabel","toPrecision","divergenceLabel","valueLabel","_mockAxis","valuehoverformat","pointData","_input","fullData","curveNumber","pointNumber","appendArrayPointValue","_module","eventData","points","hovermode","bbox","loneHover","text","color","castHoverOption","borderColor","fontFamily","fontSize","fontColor","nameLength","textAlign","castOption","hovertemplateLabels","extendFlat","inOut_bbox","distance","loneUnhover","dispose","tryRecover","isContextLost","requestAnimationFrame","error","plot","apply","axisProperties","computeTraceBounds","bounds","d","axisName","charAt","coords","calendar","len","isArrayOrTypedArray","Math","min","max","v","j","isNaN","isFinite","computeAnnotationBounds","annotations","ann","visible","pos","r2l","sceneData","contextLost","axis","axisType","sceneLayout","merge","setViewport","updateFx","enableWheel","setClearColor","bgcolor","setConvert","Array","isArray","dataBounds","Infinity","_length","uid","traceIds","traceIdLoop","objects","sort","a","b","_trace","sceneBounds","axisDataRange","axisTypeRatios","acc","count","autorange","_name","obj","objBounds","pad","_pad","constructor","_lowerLogErrorBound","rangemode","tmp","range","setBounds","aspectRatio","userRatio","aspectratio","axesScaleRatio","axisRatio","pow","viewInitial","domain","size","_size","containerStyle","l","w","t","h","redraw","destroy","enabled","removeEventListener","wheelListener","parentNode","removeChild","getCameraArrays","getLayoutCamera","view","recalcMatrix","lastT","lookAt","newOrtho","oldOrtho","clearRGBA","cameraNestedProp","nestedProperty","cameraDataLastSave","get","same","vectors","components","changed","aspectData","aspectNestedProp","aspectDataLastSave","cameraChanged","aspectChanged","hasChanged","preGUI","call","_preGUI","set","cameraFullNP","aspectFullNP","keyBindingMode","fullCamera","sqrt","attr","zUp","edits","flipPixels","pixels","q","k","correctRGB","toImage","format","drawingBufferWidth","drawingBufferHeight","bindFramebuffer","FRAMEBUFFER","Uint8Array","readPixels","RGBA","UNSIGNED_BYTE","context","imageData","createImageData","putImageData","dataURL","toDataURL","setScale","noop","showexponent","exponentformat","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nvar glPlot3d = require('gl-plot3d');\nvar createCamera = glPlot3d.createCamera;\nvar createPlot = glPlot3d.createScene;\n\nvar getContext = require('webgl-context');\nvar passiveSupported = require('has-passive-events');\n\nvar Registry = require('../../registry');\nvar Lib = require('../../lib');\nvar preserveDrawingBuffer = Lib.preserveDrawingBuffer();\n\nvar Axes = require('../../plots/cartesian/axes');\nvar Fx = require('../../components/fx');\n\nvar str2RGBAarray = require('../../lib/str2rgbarray');\nvar showNoWebGlMsg = require('../../lib/show_no_webgl_msg');\n\nvar project = require('./project');\nvar createAxesOptions = require('./layout/convert');\nvar createSpikeOptions = require('./layout/spikes');\nvar computeTickMarks = require('./layout/tick_marks');\n\nvar STATIC_CANVAS, STATIC_CONTEXT;\n\nfunction Scene(options, fullLayout) {\n    // create sub container for plot\n    var sceneContainer = document.createElement('div');\n    var plotContainer = options.container;\n\n    // keep a ref to the graph div to fire hover+click events\n    this.graphDiv = options.graphDiv;\n\n    // create SVG container for hover text\n    var svgContainer = document.createElementNS(\n        'http://www.w3.org/2000/svg',\n        'svg');\n    svgContainer.style.position = 'absolute';\n    svgContainer.style.top = svgContainer.style.left = '0px';\n    svgContainer.style.width = svgContainer.style.height = '100%';\n    svgContainer.style['z-index'] = 20;\n    svgContainer.style['pointer-events'] = 'none';\n    sceneContainer.appendChild(svgContainer);\n    this.svgContainer = svgContainer;\n\n    // Tag the container with the sceneID\n    sceneContainer.id = options.id;\n    sceneContainer.style.position = 'absolute';\n    sceneContainer.style.top = sceneContainer.style.left = '0px';\n    sceneContainer.style.width = sceneContainer.style.height = '100%';\n    plotContainer.appendChild(sceneContainer);\n\n    this.fullLayout = fullLayout;\n    this.id = options.id || 'scene';\n    this.fullSceneLayout = fullLayout[this.id];\n\n    // Saved from last call to plot()\n    this.plotArgs = [ [], {}, {} ];\n\n    /*\n     * Move this to calc step? Why does it work here?\n     */\n    this.axesOptions = createAxesOptions(fullLayout, fullLayout[this.id]);\n    this.spikeOptions = createSpikeOptions(fullLayout[this.id]);\n    this.container = sceneContainer;\n    this.staticMode = !!options.staticPlot;\n    this.pixelRatio = this.pixelRatio || options.plotGlPixelRatio || 2;\n\n    // Coordinate rescaling\n    this.dataScale = [1, 1, 1];\n\n    this.contourLevels = [ [], [], [] ];\n\n    this.convertAnnotations = Registry.getComponentMethod('annotations3d', 'convert');\n    this.drawAnnotations = Registry.getComponentMethod('annotations3d', 'draw');\n\n    this.initializeGLPlot();\n}\n\nvar proto = Scene.prototype;\n\nproto.prepareOptions = function() {\n    var scene = this;\n\n    var opts = {\n        canvas: scene.canvas,\n        gl: scene.gl,\n        glOptions: {\n            preserveDrawingBuffer: preserveDrawingBuffer,\n            premultipliedAlpha: true,\n            antialias: true\n        },\n        container: scene.container,\n        axes: scene.axesOptions,\n        spikes: scene.spikeOptions,\n        pickRadius: 10,\n        snapToData: true,\n        autoScale: true,\n        autoBounds: false,\n        cameraObject: scene.camera,\n        pixelRatio: scene.pixelRatio\n    };\n\n    // for static plots, we reuse the WebGL context\n    //  as WebKit doesn't collect them reliably\n    if(scene.staticMode) {\n        if(!STATIC_CONTEXT) {\n            STATIC_CANVAS = document.createElement('canvas');\n            STATIC_CONTEXT = getContext({\n                canvas: STATIC_CANVAS,\n                preserveDrawingBuffer: true,\n                premultipliedAlpha: true,\n                antialias: true\n            });\n            if(!STATIC_CONTEXT) {\n                throw new Error('error creating static canvas/context for image server');\n            }\n        }\n\n        opts.gl = STATIC_CONTEXT;\n        opts.canvas = STATIC_CANVAS;\n    }\n\n    return opts;\n};\n\nvar firstInit = true;\n\nproto.tryCreatePlot = function() {\n    var scene = this;\n\n    var opts = scene.prepareOptions();\n\n    var success = true;\n\n    try {\n        scene.glplot = createPlot(opts);\n    } catch(e) {\n        if(scene.staticMode || !firstInit || preserveDrawingBuffer) {\n            success = false;\n        } else { // try second time\n            // enable preserveDrawingBuffer setup\n            // in case is-mobile not detecting the right device\n            Lib.warn([\n                'webgl setup failed possibly due to',\n                'false preserveDrawingBuffer config.',\n                'The mobile/tablet device may not be detected by is-mobile module.',\n                'Enabling preserveDrawingBuffer in second attempt to create webgl scene...'\n            ].join(' '));\n\n            try {\n                // invert preserveDrawingBuffer\n                preserveDrawingBuffer = opts.glOptions.preserveDrawingBuffer = true;\n\n                scene.glplot = createPlot(opts);\n            } catch(e) {\n                // revert changes to preserveDrawingBuffer\n                preserveDrawingBuffer = opts.glOptions.preserveDrawingBuffer = false;\n\n                success = false;\n            }\n        }\n    }\n\n    firstInit = false;\n\n    return success;\n};\n\nproto.initializeGLCamera = function() {\n    var scene = this;\n    var cameraData = scene.fullSceneLayout.camera;\n    var isOrtho = (cameraData.projection.type === 'orthographic');\n\n    scene.camera = createCamera(scene.container, {\n        center: [cameraData.center.x, cameraData.center.y, cameraData.center.z],\n        eye: [cameraData.eye.x, cameraData.eye.y, cameraData.eye.z],\n        up: [cameraData.up.x, cameraData.up.y, cameraData.up.z],\n        _ortho: isOrtho,\n        zoomMin: 0.01,\n        zoomMax: 100,\n        mode: 'orbit'\n    });\n};\n\nproto.initializeGLPlot = function() {\n    var scene = this;\n\n    scene.initializeGLCamera();\n\n    var success = scene.tryCreatePlot();\n    /*\n    * createPlot will throw when webgl is not enabled in the client.\n    * Lets return an instance of the module with all functions noop'd.\n    * The destroy method - which will remove the container from the DOM\n    * is overridden with a function that removes the container only.\n    */\n    if(!success) return showNoWebGlMsg(scene);\n\n    // List of scene objects\n    scene.traces = {};\n\n    scene.make4thDimension();\n\n    var gd = scene.graphDiv;\n    var layout = gd.layout;\n\n    var makeUpdate = function() {\n        var update = {};\n\n        if(scene.isCameraChanged(layout)) {\n            // camera updates\n            update[scene.id + '.camera'] = scene.getCamera();\n        }\n\n        if(scene.isAspectChanged(layout)) {\n            // scene updates\n            update[scene.id + '.aspectratio'] = scene.glplot.getAspectratio();\n\n            if(layout[scene.id].aspectmode !== 'manual') {\n                scene.fullSceneLayout.aspectmode =\n                layout[scene.id].aspectmode =\n                update[scene.id + '.aspectmode'] = 'manual';\n            }\n        }\n\n        return update;\n    };\n\n    var relayoutCallback = function(scene) {\n        if(scene.fullSceneLayout.dragmode === false) return;\n\n        var update = makeUpdate();\n        scene.saveLayout(layout);\n        scene.graphDiv.emit('plotly_relayout', update);\n    };\n\n    if(scene.glplot.canvas) {\n        scene.glplot.canvas.addEventListener('mouseup', function() {\n            relayoutCallback(scene);\n        });\n\n        scene.glplot.canvas.addEventListener('wheel', function(e) {\n            if(gd._context._scrollZoom.gl3d) {\n                if(scene.camera._ortho) {\n                    var s = (e.deltaX > e.deltaY) ? 1.1 : 1.0 / 1.1;\n                    var o = scene.glplot.getAspectratio();\n                    scene.glplot.setAspectratio({\n                        x: s * o.x,\n                        y: s * o.y,\n                        z: s * o.z\n                    });\n                }\n\n                relayoutCallback(scene);\n            }\n        }, passiveSupported ? {passive: false} : false);\n\n        scene.glplot.canvas.addEventListener('mousemove', function() {\n            if(scene.fullSceneLayout.dragmode === false) return;\n            if(scene.camera.mouseListener.buttons === 0) return;\n\n            var update = makeUpdate();\n            scene.graphDiv.emit('plotly_relayouting', update);\n        });\n\n        if(!scene.staticMode) {\n            scene.glplot.canvas.addEventListener('webglcontextlost', function(event) {\n                if(gd && gd.emit) {\n                    gd.emit('plotly_webglcontextlost', {\n                        event: event,\n                        layer: scene.id\n                    });\n                }\n            }, false);\n        }\n    }\n\n    scene.glplot.oncontextloss = function() {\n        scene.recoverContext();\n    };\n\n    scene.glplot.onrender = function() {\n        scene.render();\n    };\n\n    return true;\n};\n\nproto.render = function() {\n    var scene = this;\n    var gd = scene.graphDiv;\n    var trace;\n\n    // update size of svg container\n    var svgContainer = scene.svgContainer;\n    var clientRect = scene.container.getBoundingClientRect();\n\n    gd._fullLayout._calcInverseTransform(gd);\n    var scaleX = gd._fullLayout._invScaleX;\n    var scaleY = gd._fullLayout._invScaleY;\n    var width = clientRect.width * scaleX;\n    var height = clientRect.height * scaleY;\n    svgContainer.setAttributeNS(null, 'viewBox', '0 0 ' + width + ' ' + height);\n    svgContainer.setAttributeNS(null, 'width', width);\n    svgContainer.setAttributeNS(null, 'height', height);\n\n    computeTickMarks(scene);\n    scene.glplot.axes.update(scene.axesOptions);\n\n    // check if pick has changed\n    var keys = Object.keys(scene.traces);\n    var lastPicked = null;\n    var selection = scene.glplot.selection;\n    for(var i = 0; i < keys.length; ++i) {\n        trace = scene.traces[keys[i]];\n        if(trace.data.hoverinfo !== 'skip' && trace.handlePick(selection)) {\n            lastPicked = trace;\n        }\n\n        if(trace.setContourLevels) trace.setContourLevels();\n    }\n\n    function formatter(axLetter, val, hoverformat) {\n        var ax = scene.fullSceneLayout[axLetter + 'axis'];\n\n        if(ax.type !== 'log') {\n            val = ax.d2l(val);\n        }\n\n        return Axes.hoverLabelText(ax, val, hoverformat);\n    }\n\n    var oldEventData;\n\n    if(lastPicked !== null) {\n        var pdata = project(scene.glplot.cameraParams, selection.dataCoordinate);\n        trace = lastPicked.data;\n        var traceNow = gd._fullData[trace.index];\n        var ptNumber = selection.index;\n\n        var labels = {\n            xLabel: formatter('x', selection.traceCoordinate[0], trace.xhoverformat),\n            yLabel: formatter('y', selection.traceCoordinate[1], trace.yhoverformat),\n            zLabel: formatter('z', selection.traceCoordinate[2], trace.zhoverformat)\n        };\n\n        var hoverinfo = Fx.castHoverinfo(traceNow, scene.fullLayout, ptNumber);\n        var hoverinfoParts = (hoverinfo || '').split('+');\n        var isHoverinfoAll = hoverinfo && hoverinfo === 'all';\n\n        if(!traceNow.hovertemplate && !isHoverinfoAll) {\n            if(hoverinfoParts.indexOf('x') === -1) labels.xLabel = undefined;\n            if(hoverinfoParts.indexOf('y') === -1) labels.yLabel = undefined;\n            if(hoverinfoParts.indexOf('z') === -1) labels.zLabel = undefined;\n            if(hoverinfoParts.indexOf('text') === -1) selection.textLabel = undefined;\n            if(hoverinfoParts.indexOf('name') === -1) lastPicked.name = undefined;\n        }\n\n        var tx;\n        var vectorTx = [];\n\n        if(trace.type === 'cone' || trace.type === 'streamtube') {\n            labels.uLabel = formatter('x', selection.traceCoordinate[3], trace.uhoverformat);\n            if(isHoverinfoAll || hoverinfoParts.indexOf('u') !== -1) {\n                vectorTx.push('u: ' + labels.uLabel);\n            }\n\n            labels.vLabel = formatter('y', selection.traceCoordinate[4], trace.vhoverformat);\n            if(isHoverinfoAll || hoverinfoParts.indexOf('v') !== -1) {\n                vectorTx.push('v: ' + labels.vLabel);\n            }\n\n            labels.wLabel = formatter('z', selection.traceCoordinate[5], trace.whoverformat);\n            if(isHoverinfoAll || hoverinfoParts.indexOf('w') !== -1) {\n                vectorTx.push('w: ' + labels.wLabel);\n            }\n\n            labels.normLabel = selection.traceCoordinate[6].toPrecision(3);\n            if(isHoverinfoAll || hoverinfoParts.indexOf('norm') !== -1) {\n                vectorTx.push('norm: ' + labels.normLabel);\n            }\n            if(trace.type === 'streamtube') {\n                labels.divergenceLabel = selection.traceCoordinate[7].toPrecision(3);\n                if(isHoverinfoAll || hoverinfoParts.indexOf('divergence') !== -1) {\n                    vectorTx.push('divergence: ' + labels.divergenceLabel);\n                }\n            }\n            if(selection.textLabel) {\n                vectorTx.push(selection.textLabel);\n            }\n            tx = vectorTx.join('<br>');\n        } else if(trace.type === 'isosurface' || trace.type === 'volume') {\n            labels.valueLabel = Axes.hoverLabelText(scene._mockAxis, scene._mockAxis.d2l(selection.traceCoordinate[3]), trace.valuehoverformat);\n            vectorTx.push('value: ' + labels.valueLabel);\n            if(selection.textLabel) {\n                vectorTx.push(selection.textLabel);\n            }\n            tx = vectorTx.join('<br>');\n        } else {\n            tx = selection.textLabel;\n        }\n\n        var pointData = {\n            x: selection.traceCoordinate[0],\n            y: selection.traceCoordinate[1],\n            z: selection.traceCoordinate[2],\n            data: traceNow._input,\n            fullData: traceNow,\n            curveNumber: traceNow.index,\n            pointNumber: ptNumber\n        };\n\n        Fx.appendArrayPointValue(pointData, traceNow, ptNumber);\n\n        if(trace._module.eventData) {\n            pointData = traceNow._module.eventData(pointData, selection, traceNow, {}, ptNumber);\n        }\n\n        var eventData = {points: [pointData]};\n\n        if(scene.fullSceneLayout.hovermode) {\n            var bbox = [];\n            Fx.loneHover({\n                trace: traceNow,\n                x: (0.5 + 0.5 * pdata[0] / pdata[3]) * width,\n                y: (0.5 - 0.5 * pdata[1] / pdata[3]) * height,\n                xLabel: labels.xLabel,\n                yLabel: labels.yLabel,\n                zLabel: labels.zLabel,\n                text: tx,\n                name: lastPicked.name,\n                color: Fx.castHoverOption(traceNow, ptNumber, 'bgcolor') || lastPicked.color,\n                borderColor: Fx.castHoverOption(traceNow, ptNumber, 'bordercolor'),\n                fontFamily: Fx.castHoverOption(traceNow, ptNumber, 'font.family'),\n                fontSize: Fx.castHoverOption(traceNow, ptNumber, 'font.size'),\n                fontColor: Fx.castHoverOption(traceNow, ptNumber, 'font.color'),\n                nameLength: Fx.castHoverOption(traceNow, ptNumber, 'namelength'),\n                textAlign: Fx.castHoverOption(traceNow, ptNumber, 'align'),\n                hovertemplate: Lib.castOption(traceNow, ptNumber, 'hovertemplate'),\n                hovertemplateLabels: Lib.extendFlat({}, pointData, labels),\n                eventData: [pointData]\n            }, {\n                container: svgContainer,\n                gd: gd,\n                inOut_bbox: bbox\n            });\n\n            pointData.bbox = bbox[0];\n        }\n\n        if(selection.buttons && selection.distance < 5) {\n            gd.emit('plotly_click', eventData);\n        } else {\n            gd.emit('plotly_hover', eventData);\n        }\n\n        oldEventData = eventData;\n    } else {\n        Fx.loneUnhover(svgContainer);\n        gd.emit('plotly_unhover', oldEventData);\n    }\n\n    scene.drawAnnotations(scene);\n};\n\nproto.recoverContext = function() {\n    var scene = this;\n\n    scene.glplot.dispose();\n\n    var tryRecover = function() {\n        if(scene.glplot.gl.isContextLost()) {\n            requestAnimationFrame(tryRecover);\n            return;\n        }\n        if(!scene.initializeGLPlot()) {\n            Lib.error('Catastrophic and unrecoverable WebGL error. Context lost.');\n            return;\n        }\n        scene.plot.apply(scene, scene.plotArgs);\n    };\n\n    requestAnimationFrame(tryRecover);\n};\n\nvar axisProperties = [ 'xaxis', 'yaxis', 'zaxis' ];\n\nfunction computeTraceBounds(scene, trace, bounds) {\n    var fullSceneLayout = scene.fullSceneLayout;\n\n    for(var d = 0; d < 3; d++) {\n        var axisName = axisProperties[d];\n        var axLetter = axisName.charAt(0);\n        var ax = fullSceneLayout[axisName];\n        var coords = trace[axLetter];\n        var calendar = trace[axLetter + 'calendar'];\n        var len = trace['_' + axLetter + 'length'];\n\n        if(!Lib.isArrayOrTypedArray(coords)) {\n            bounds[0][d] = Math.min(bounds[0][d], 0);\n            bounds[1][d] = Math.max(bounds[1][d], len - 1);\n        } else {\n            var v;\n\n            for(var i = 0; i < (len || coords.length); i++) {\n                if(Lib.isArrayOrTypedArray(coords[i])) {\n                    for(var j = 0; j < coords[i].length; ++j) {\n                        v = ax.d2l(coords[i][j], 0, calendar);\n                        if(!isNaN(v) && isFinite(v)) {\n                            bounds[0][d] = Math.min(bounds[0][d], v);\n                            bounds[1][d] = Math.max(bounds[1][d], v);\n                        }\n                    }\n                } else {\n                    v = ax.d2l(coords[i], 0, calendar);\n                    if(!isNaN(v) && isFinite(v)) {\n                        bounds[0][d] = Math.min(bounds[0][d], v);\n                        bounds[1][d] = Math.max(bounds[1][d], v);\n                    }\n                }\n            }\n        }\n    }\n}\n\nfunction computeAnnotationBounds(scene, bounds) {\n    var fullSceneLayout = scene.fullSceneLayout;\n    var annotations = fullSceneLayout.annotations || [];\n\n    for(var d = 0; d < 3; d++) {\n        var axisName = axisProperties[d];\n        var axLetter = axisName.charAt(0);\n        var ax = fullSceneLayout[axisName];\n\n        for(var j = 0; j < annotations.length; j++) {\n            var ann = annotations[j];\n\n            if(ann.visible) {\n                var pos = ax.r2l(ann[axLetter]);\n                if(!isNaN(pos) && isFinite(pos)) {\n                    bounds[0][d] = Math.min(bounds[0][d], pos);\n                    bounds[1][d] = Math.max(bounds[1][d], pos);\n                }\n            }\n        }\n    }\n}\n\nproto.plot = function(sceneData, fullLayout, layout) {\n    var scene = this;\n\n    // Save parameters\n    scene.plotArgs = [sceneData, fullLayout, layout];\n\n    if(scene.glplot.contextLost) return;\n\n    var data, trace;\n    var i, j, axis, axisType;\n    var fullSceneLayout = fullLayout[scene.id];\n    var sceneLayout = layout[scene.id];\n\n    // Update layout\n    scene.fullLayout = fullLayout;\n    scene.fullSceneLayout = fullSceneLayout;\n\n    scene.axesOptions.merge(fullLayout, fullSceneLayout);\n    scene.spikeOptions.merge(fullSceneLayout);\n\n    // Update camera and camera mode\n    scene.setViewport(fullSceneLayout);\n    scene.updateFx(fullSceneLayout.dragmode, fullSceneLayout.hovermode);\n    scene.camera.enableWheel = scene.graphDiv._context._scrollZoom.gl3d;\n\n    // Update scene background\n    scene.glplot.setClearColor(str2RGBAarray(fullSceneLayout.bgcolor));\n\n    // Update axes functions BEFORE updating traces\n    scene.setConvert(axis);\n\n    // Convert scene data\n    if(!sceneData) sceneData = [];\n    else if(!Array.isArray(sceneData)) sceneData = [sceneData];\n\n    // Compute trace bounding box\n    var dataBounds = [\n        [Infinity, Infinity, Infinity],\n        [-Infinity, -Infinity, -Infinity]\n    ];\n\n    for(i = 0; i < sceneData.length; ++i) {\n        data = sceneData[i];\n        if(data.visible !== true || data._length === 0) continue;\n\n        computeTraceBounds(this, data, dataBounds);\n    }\n    computeAnnotationBounds(this, dataBounds);\n\n    var dataScale = [1, 1, 1];\n    for(j = 0; j < 3; ++j) {\n        if(dataBounds[1][j] === dataBounds[0][j]) {\n            dataScale[j] = 1.0;\n        } else {\n            dataScale[j] = 1.0 / (dataBounds[1][j] - dataBounds[0][j]);\n        }\n    }\n\n    // Save scale\n    scene.dataScale = dataScale;\n\n    // after computeTraceBounds where ax._categories are filled in\n    scene.convertAnnotations(this);\n\n    // Update traces\n    for(i = 0; i < sceneData.length; ++i) {\n        data = sceneData[i];\n        if(data.visible !== true || data._length === 0) {\n            continue;\n        }\n        trace = scene.traces[data.uid];\n        if(trace) {\n            if(trace.data.type === data.type) {\n                trace.update(data);\n            } else {\n                trace.dispose();\n                trace = data._module.plot(this, data);\n                scene.traces[data.uid] = trace;\n            }\n        } else {\n            trace = data._module.plot(this, data);\n            scene.traces[data.uid] = trace;\n        }\n        trace.name = data.name;\n    }\n\n    // Remove empty traces\n    var traceIds = Object.keys(scene.traces);\n\n    traceIdLoop:\n    for(i = 0; i < traceIds.length; ++i) {\n        for(j = 0; j < sceneData.length; ++j) {\n            if(sceneData[j].uid === traceIds[i] &&\n                (sceneData[j].visible === true && sceneData[j]._length !== 0)) {\n                continue traceIdLoop;\n            }\n        }\n        trace = scene.traces[traceIds[i]];\n        trace.dispose();\n        delete scene.traces[traceIds[i]];\n    }\n\n    // order object per trace index\n    scene.glplot.objects.sort(function(a, b) {\n        return a._trace.data.index - b._trace.data.index;\n    });\n\n    // Update ranges (needs to be called *after* objects are added due to updates)\n    var sceneBounds = [[0, 0, 0], [0, 0, 0]];\n    var axisDataRange = [];\n    var axisTypeRatios = {};\n\n    for(i = 0; i < 3; ++i) {\n        axis = fullSceneLayout[axisProperties[i]];\n        axisType = axis.type;\n\n        if(axisType in axisTypeRatios) {\n            axisTypeRatios[axisType].acc *= dataScale[i];\n            axisTypeRatios[axisType].count += 1;\n        } else {\n            axisTypeRatios[axisType] = {\n                acc: dataScale[i],\n                count: 1\n            };\n        }\n\n        if(axis.autorange) {\n            sceneBounds[0][i] = Infinity;\n            sceneBounds[1][i] = -Infinity;\n\n            var objects = scene.glplot.objects;\n            var annotations = scene.fullSceneLayout.annotations || [];\n            var axLetter = axis._name.charAt(0);\n\n            for(j = 0; j < objects.length; j++) {\n                var obj = objects[j];\n                var objBounds = obj.bounds;\n                var pad = obj._trace.data._pad || 0;\n\n                if(obj.constructor.name === 'ErrorBars' && axis._lowerLogErrorBound) {\n                    sceneBounds[0][i] = Math.min(sceneBounds[0][i], axis._lowerLogErrorBound);\n                } else {\n                    sceneBounds[0][i] = Math.min(sceneBounds[0][i], objBounds[0][i] / dataScale[i] - pad);\n                }\n                sceneBounds[1][i] = Math.max(sceneBounds[1][i], objBounds[1][i] / dataScale[i] + pad);\n            }\n\n            for(j = 0; j < annotations.length; j++) {\n                var ann = annotations[j];\n\n                // N.B. not taking into consideration the arrowhead\n                if(ann.visible) {\n                    var pos = axis.r2l(ann[axLetter]);\n                    sceneBounds[0][i] = Math.min(sceneBounds[0][i], pos);\n                    sceneBounds[1][i] = Math.max(sceneBounds[1][i], pos);\n                }\n            }\n\n            if('rangemode' in axis && axis.rangemode === 'tozero') {\n                sceneBounds[0][i] = Math.min(sceneBounds[0][i], 0);\n                sceneBounds[1][i] = Math.max(sceneBounds[1][i], 0);\n            }\n            if(sceneBounds[0][i] > sceneBounds[1][i]) {\n                sceneBounds[0][i] = -1;\n                sceneBounds[1][i] = 1;\n            } else {\n                var d = sceneBounds[1][i] - sceneBounds[0][i];\n                sceneBounds[0][i] -= d / 32.0;\n                sceneBounds[1][i] += d / 32.0;\n            }\n\n            if(axis.autorange === 'reversed') {\n                // swap bounds:\n                var tmp = sceneBounds[0][i];\n                sceneBounds[0][i] = sceneBounds[1][i];\n                sceneBounds[1][i] = tmp;\n            }\n        } else {\n            var range = axis.range;\n            sceneBounds[0][i] = axis.r2l(range[0]);\n            sceneBounds[1][i] = axis.r2l(range[1]);\n        }\n        if(sceneBounds[0][i] === sceneBounds[1][i]) {\n            sceneBounds[0][i] -= 1;\n            sceneBounds[1][i] += 1;\n        }\n        axisDataRange[i] = sceneBounds[1][i] - sceneBounds[0][i];\n\n        // Update plot bounds\n        scene.glplot.setBounds(i, {\n            min: sceneBounds[0][i] * dataScale[i],\n            max: sceneBounds[1][i] * dataScale[i]\n        });\n    }\n\n    /*\n     * Dynamically set the aspect ratio depending on the users aspect settings\n     */\n    var aspectRatio;\n    var aspectmode = fullSceneLayout.aspectmode;\n    if(aspectmode === 'cube') {\n        aspectRatio = [1, 1, 1];\n    } else if(aspectmode === 'manual') {\n        var userRatio = fullSceneLayout.aspectratio;\n        aspectRatio = [userRatio.x, userRatio.y, userRatio.z];\n    } else if(aspectmode === 'auto' || aspectmode === 'data') {\n        var axesScaleRatio = [1, 1, 1];\n        // Compute axis scale per category\n        for(i = 0; i < 3; ++i) {\n            axis = fullSceneLayout[axisProperties[i]];\n            axisType = axis.type;\n            var axisRatio = axisTypeRatios[axisType];\n            axesScaleRatio[i] = Math.pow(axisRatio.acc, 1.0 / axisRatio.count) / dataScale[i];\n        }\n\n        if(aspectmode === 'data') {\n            aspectRatio = axesScaleRatio;\n        } else { // i.e. 'auto' option\n            if(\n                Math.max.apply(null, axesScaleRatio) /\n                Math.min.apply(null, axesScaleRatio) <= 4\n            ) {\n                // USE DATA MODE WHEN AXIS RANGE DIMENSIONS ARE RELATIVELY EQUAL\n                aspectRatio = axesScaleRatio;\n            } else {\n                // USE EQUAL MODE WHEN AXIS RANGE DIMENSIONS ARE HIGHLY UNEQUAL\n                aspectRatio = [1, 1, 1];\n            }\n        }\n    } else {\n        throw new Error('scene.js aspectRatio was not one of the enumerated types');\n    }\n\n    /*\n     * Write aspect Ratio back to user data and fullLayout so that it is modifies as user\n     * manipulates the aspectmode settings and the fullLayout is up-to-date.\n     */\n    fullSceneLayout.aspectratio.x = sceneLayout.aspectratio.x = aspectRatio[0];\n    fullSceneLayout.aspectratio.y = sceneLayout.aspectratio.y = aspectRatio[1];\n    fullSceneLayout.aspectratio.z = sceneLayout.aspectratio.z = aspectRatio[2];\n\n    /*\n     * Finally assign the computed aspecratio to the glplot module. This will have an effect\n     * on the next render cycle.\n     */\n    scene.glplot.setAspectratio(fullSceneLayout.aspectratio);\n\n    // save 'initial' aspectratio & aspectmode view settings for modebar buttons\n    if(!scene.viewInitial.aspectratio) {\n        scene.viewInitial.aspectratio = {\n            x: fullSceneLayout.aspectratio.x,\n            y: fullSceneLayout.aspectratio.y,\n            z: fullSceneLayout.aspectratio.z\n        };\n    }\n    if(!scene.viewInitial.aspectmode) {\n        scene.viewInitial.aspectmode = fullSceneLayout.aspectmode;\n    }\n\n    // Update frame position for multi plots\n    var domain = fullSceneLayout.domain || null;\n    var size = fullLayout._size || null;\n\n    if(domain && size) {\n        var containerStyle = scene.container.style;\n        containerStyle.position = 'absolute';\n        containerStyle.left = (size.l + domain.x[0] * size.w) + 'px';\n        containerStyle.top = (size.t + (1 - domain.y[1]) * size.h) + 'px';\n        containerStyle.width = (size.w * (domain.x[1] - domain.x[0])) + 'px';\n        containerStyle.height = (size.h * (domain.y[1] - domain.y[0])) + 'px';\n    }\n\n    // force redraw so that promise is returned when rendering is completed\n    scene.glplot.redraw();\n};\n\nproto.destroy = function() {\n    var scene = this;\n\n    if(!scene.glplot) return;\n    scene.camera.mouseListener.enabled = false;\n    scene.container.removeEventListener('wheel', scene.camera.wheelListener);\n    scene.camera = null;\n    scene.glplot.dispose();\n    scene.container.parentNode.removeChild(scene.container);\n    scene.glplot = null;\n};\n\n// getCameraArrays :: plotly_coords -> gl-plot3d_coords\n// inverse of getLayoutCamera\nfunction getCameraArrays(camera) {\n    return [\n        [camera.eye.x, camera.eye.y, camera.eye.z],\n        [camera.center.x, camera.center.y, camera.center.z],\n        [camera.up.x, camera.up.y, camera.up.z]\n    ];\n}\n\n// getLayoutCamera :: gl-plot3d_coords -> plotly_coords\n// inverse of getCameraArrays\nfunction getLayoutCamera(camera) {\n    return {\n        up: {x: camera.up[0], y: camera.up[1], z: camera.up[2]},\n        center: {x: camera.center[0], y: camera.center[1], z: camera.center[2]},\n        eye: {x: camera.eye[0], y: camera.eye[1], z: camera.eye[2]},\n        projection: {type: (camera._ortho === true) ? 'orthographic' : 'perspective'}\n    };\n}\n\n// get camera position in plotly coords from 'gl-plot3d' coords\nproto.getCamera = function() {\n    var scene = this;\n    scene.camera.view.recalcMatrix(scene.camera.view.lastT());\n    return getLayoutCamera(scene.camera);\n};\n\n// set gl-plot3d camera position and scene aspects with a set of plotly coords\nproto.setViewport = function(sceneLayout) {\n    var scene = this;\n    var cameraData = sceneLayout.camera;\n\n    scene.camera.lookAt.apply(this, getCameraArrays(cameraData));\n    scene.glplot.setAspectratio(sceneLayout.aspectratio);\n\n    var newOrtho = (cameraData.projection.type === 'orthographic');\n    var oldOrtho = scene.camera._ortho;\n\n    if(newOrtho !== oldOrtho) {\n        scene.glplot.redraw(); // TODO: figure out why we need to redraw here?\n        scene.glplot.clearRGBA();\n        scene.glplot.dispose();\n        scene.initializeGLPlot();\n    }\n};\n\nproto.isCameraChanged = function(layout) {\n    var scene = this;\n    var cameraData = scene.getCamera();\n    var cameraNestedProp = Lib.nestedProperty(layout, scene.id + '.camera');\n    var cameraDataLastSave = cameraNestedProp.get();\n\n    function same(x, y, i, j) {\n        var vectors = ['up', 'center', 'eye'];\n        var components = ['x', 'y', 'z'];\n        return y[vectors[i]] && (x[vectors[i]][components[j]] === y[vectors[i]][components[j]]);\n    }\n\n    var changed = false;\n    if(cameraDataLastSave === undefined) {\n        changed = true;\n    } else {\n        for(var i = 0; i < 3; i++) {\n            for(var j = 0; j < 3; j++) {\n                if(!same(cameraData, cameraDataLastSave, i, j)) {\n                    changed = true;\n                    break;\n                }\n            }\n        }\n\n        if(!cameraDataLastSave.projection || (\n            cameraData.projection &&\n            cameraData.projection.type !== cameraDataLastSave.projection.type)) {\n            changed = true;\n        }\n    }\n\n    return changed;\n};\n\nproto.isAspectChanged = function(layout) {\n    var scene = this;\n    var aspectData = scene.glplot.getAspectratio();\n    var aspectNestedProp = Lib.nestedProperty(layout, scene.id + '.aspectratio');\n    var aspectDataLastSave = aspectNestedProp.get();\n\n    return (\n        aspectDataLastSave === undefined || (\n        aspectDataLastSave.x !== aspectData.x ||\n        aspectDataLastSave.y !== aspectData.y ||\n        aspectDataLastSave.z !== aspectData.z\n    ));\n};\n\n// save camera to user layout (i.e. gd.layout)\nproto.saveLayout = function(layout) {\n    var scene = this;\n    var fullLayout = scene.fullLayout;\n\n    var cameraData;\n    var cameraNestedProp;\n    var cameraDataLastSave;\n\n    var aspectData;\n    var aspectNestedProp;\n    var aspectDataLastSave;\n\n    var cameraChanged = scene.isCameraChanged(layout);\n    var aspectChanged = scene.isAspectChanged(layout);\n\n    var hasChanged = cameraChanged || aspectChanged;\n    if(hasChanged) {\n        var preGUI = {};\n        if(cameraChanged) {\n            cameraData = scene.getCamera();\n            cameraNestedProp = Lib.nestedProperty(layout, scene.id + '.camera');\n            cameraDataLastSave = cameraNestedProp.get();\n\n            preGUI[scene.id + '.camera'] = cameraDataLastSave;\n        }\n        if(aspectChanged) {\n            aspectData = scene.glplot.getAspectratio();\n            aspectNestedProp = Lib.nestedProperty(layout, scene.id + '.aspectratio');\n            aspectDataLastSave = aspectNestedProp.get();\n\n            preGUI[scene.id + '.aspectratio'] = aspectDataLastSave;\n        }\n        Registry.call('_storeDirectGUIEdit', layout, fullLayout._preGUI, preGUI);\n\n        if(cameraChanged) {\n            cameraNestedProp.set(cameraData);\n\n            var cameraFullNP = Lib.nestedProperty(fullLayout, scene.id + '.camera');\n            cameraFullNP.set(cameraData);\n        }\n\n        if(aspectChanged) {\n            aspectNestedProp.set(aspectData);\n\n            var aspectFullNP = Lib.nestedProperty(fullLayout, scene.id + '.aspectratio');\n            aspectFullNP.set(aspectData);\n\n            scene.glplot.redraw();\n        }\n    }\n\n    return hasChanged;\n};\n\nproto.updateFx = function(dragmode, hovermode) {\n    var scene = this;\n    var camera = scene.camera;\n    if(camera) {\n        // rotate and orbital are synonymous\n        if(dragmode === 'orbit') {\n            camera.mode = 'orbit';\n            camera.keyBindingMode = 'rotate';\n        } else if(dragmode === 'turntable') {\n            camera.up = [0, 0, 1];\n            camera.mode = 'turntable';\n            camera.keyBindingMode = 'rotate';\n\n            // The setter for camera.mode animates the transition to z-up,\n            // but only if we *don't* explicitly set z-up earlier via the\n            // relayout. So push `up` back to layout & fullLayout manually now.\n            var gd = scene.graphDiv;\n            var fullLayout = gd._fullLayout;\n            var fullCamera = scene.fullSceneLayout.camera;\n            var x = fullCamera.up.x;\n            var y = fullCamera.up.y;\n            var z = fullCamera.up.z;\n            // only push `up` back to (full)layout if it's going to change\n            if(z / Math.sqrt(x * x + y * y + z * z) < 0.999) {\n                var attr = scene.id + '.camera.up';\n                var zUp = {x: 0, y: 0, z: 1};\n                var edits = {};\n                edits[attr] = zUp;\n                var layout = gd.layout;\n                Registry.call('_storeDirectGUIEdit', layout, fullLayout._preGUI, edits);\n                fullCamera.up = zUp;\n                Lib.nestedProperty(layout, attr).set(zUp);\n            }\n        } else {\n            // none rotation modes [pan or zoom]\n            camera.keyBindingMode = dragmode;\n        }\n    }\n\n    // to put dragmode and hovermode on the same grounds from relayout\n    scene.fullSceneLayout.hovermode = hovermode;\n};\n\nfunction flipPixels(pixels, w, h) {\n    for(var i = 0, q = h - 1; i < q; ++i, --q) {\n        for(var j = 0; j < w; ++j) {\n            for(var k = 0; k < 4; ++k) {\n                var a = 4 * (w * i + j) + k;\n                var b = 4 * (w * q + j) + k;\n                var tmp = pixels[a];\n                pixels[a] = pixels[b];\n                pixels[b] = tmp;\n            }\n        }\n    }\n}\n\nfunction correctRGB(pixels, w, h) {\n    for(var i = 0; i < h; ++i) {\n        for(var j = 0; j < w; ++j) {\n            var k = 4 * (w * i + j);\n\n            var a = pixels[k + 3]; // alpha\n            if(a > 0) {\n                var q = 255 / a;\n\n                for(var l = 0; l < 3; ++l) { // RGB\n                    pixels[k + l] = Math.min(q * pixels[k + l], 255);\n                }\n            }\n        }\n    }\n}\n\nproto.toImage = function(format) {\n    var scene = this;\n\n    if(!format) format = 'png';\n    if(scene.staticMode) scene.container.appendChild(STATIC_CANVAS);\n\n    // Force redraw\n    scene.glplot.redraw();\n\n    // Grab context and yank out pixels\n    var gl = scene.glplot.gl;\n    var w = gl.drawingBufferWidth;\n    var h = gl.drawingBufferHeight;\n\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null);\n\n    var pixels = new Uint8Array(w * h * 4);\n    gl.readPixels(0, 0, w, h, gl.RGBA, gl.UNSIGNED_BYTE, pixels);\n    flipPixels(pixels, w, h);\n    correctRGB(pixels, w, h);\n\n    var canvas = document.createElement('canvas');\n    canvas.width = w;\n    canvas.height = h;\n    var context = canvas.getContext('2d');\n    var imageData = context.createImageData(w, h);\n    imageData.data.set(pixels);\n    context.putImageData(imageData, 0, 0);\n\n    var dataURL;\n\n    switch(format) {\n        case 'jpeg':\n            dataURL = canvas.toDataURL('image/jpeg');\n            break;\n        case 'webp':\n            dataURL = canvas.toDataURL('image/webp');\n            break;\n        default:\n            dataURL = canvas.toDataURL('image/png');\n    }\n\n    if(scene.staticMode) scene.container.removeChild(STATIC_CANVAS);\n\n    return dataURL;\n};\n\nproto.setConvert = function() {\n    var scene = this;\n    for(var i = 0; i < 3; i++) {\n        var ax = scene.fullSceneLayout[axisProperties[i]];\n        Axes.setConvert(ax, scene.fullLayout);\n        ax.setScale = Lib.noop;\n    }\n};\n\nproto.make4thDimension = function() {\n    var scene = this;\n    var gd = scene.graphDiv;\n    var fullLayout = gd._fullLayout;\n\n    // mock axis for hover formatting\n    scene._mockAxis = {\n        type: 'linear',\n        showexponent: 'all',\n        exponentformat: 'B'\n    };\n    Axes.setConvert(scene._mockAxis, fullLayout);\n};\n\nmodule.exports = Scene;\n"]},"metadata":{},"sourceType":"script"}