{"ast":null,"code":"'use strict';\n\nvar createCamera = require('./camera.js');\n\nvar createAxes = require('gl-axes3d');\n\nvar axesRanges = require('gl-axes3d/properties');\n\nvar createSpikes = require('gl-spikes3d');\n\nvar createSelect = require('gl-select-static');\n\nvar createFBO = require('gl-fbo');\n\nvar drawTriangle = require('a-big-triangle');\n\nvar mouseChange = require('mouse-change');\n\nvar perspective = require('gl-mat4/perspective');\n\nvar ortho = require('gl-mat4/ortho');\n\nvar createShader = require('./lib/shader');\n\nvar isMobile = require('is-mobile')({\n  tablet: true,\n  featureDetect: true\n});\n\nmodule.exports = {\n  createScene: createScene,\n  createCamera: createCamera\n};\n\nfunction MouseSelect() {\n  this.mouse = [-1, -1];\n  this.screen = null;\n  this.distance = Infinity;\n  this.index = null;\n  this.dataCoordinate = null;\n  this.dataPosition = null;\n  this.object = null;\n  this.data = null;\n}\n\nfunction getContext(canvas, options) {\n  var gl = null;\n\n  try {\n    gl = canvas.getContext('webgl', options);\n\n    if (!gl) {\n      gl = canvas.getContext('experimental-webgl', options);\n    }\n  } catch (e) {\n    return null;\n  }\n\n  return gl;\n}\n\nfunction roundUpPow10(x) {\n  var y = Math.round(Math.log(Math.abs(x)) / Math.log(10));\n\n  if (y < 0) {\n    var base = Math.round(Math.pow(10, -y));\n    return Math.ceil(x * base) / base;\n  } else if (y > 0) {\n    var base = Math.round(Math.pow(10, y));\n    return Math.ceil(x / base) * base;\n  }\n\n  return Math.ceil(x);\n}\n\nfunction defaultBool(x) {\n  if (typeof x === 'boolean') {\n    return x;\n  }\n\n  return true;\n}\n\nfunction createScene(options) {\n  options = options || {};\n  options.camera = options.camera || {};\n  var canvas = options.canvas;\n\n  if (!canvas) {\n    canvas = document.createElement('canvas');\n\n    if (options.container) {\n      var container = options.container;\n      container.appendChild(canvas);\n    } else {\n      document.body.appendChild(canvas);\n    }\n  }\n\n  var gl = options.gl;\n\n  if (!gl) {\n    if (options.glOptions) {\n      isMobile = !!options.glOptions.preserveDrawingBuffer;\n    }\n\n    gl = getContext(canvas, options.glOptions || {\n      premultipliedAlpha: true,\n      antialias: true,\n      preserveDrawingBuffer: isMobile\n    });\n  }\n\n  if (!gl) {\n    throw new Error('webgl not supported');\n  } //Initial bounds\n\n\n  var bounds = options.bounds || [[-10, -10, -10], [10, 10, 10]]; //Create selection\n\n  var selection = new MouseSelect(); //Accumulation buffer\n\n  var accumBuffer = createFBO(gl, gl.drawingBufferWidth, gl.drawingBufferHeight, {\n    preferFloat: !isMobile\n  });\n  var accumShader = createShader(gl);\n  var isOrtho = options.cameraObject && options.cameraObject._ortho === true || options.camera.projection && options.camera.projection.type === 'orthographic' || false; //Create a camera\n\n  var cameraOptions = {\n    eye: options.camera.eye || [2, 0, 0],\n    center: options.camera.center || [0, 0, 0],\n    up: options.camera.up || [0, 1, 0],\n    zoomMin: options.camera.zoomMax || 0.1,\n    zoomMax: options.camera.zoomMin || 100,\n    mode: options.camera.mode || 'turntable',\n    _ortho: isOrtho\n  }; //Create axes\n\n  var axesOptions = options.axes || {};\n  var axes = createAxes(gl, axesOptions);\n  axes.enable = !axesOptions.disable; //Create spikes\n\n  var spikeOptions = options.spikes || {};\n  var spikes = createSpikes(gl, spikeOptions); //Object list is empty initially\n\n  var objects = [];\n  var pickBufferIds = [];\n  var pickBufferCount = [];\n  var pickBuffers = []; //Dirty flag, skip redraw if scene static\n\n  var dirty = true;\n  var pickDirty = true;\n  var projection = new Array(16);\n  var model = new Array(16);\n  var cameraParams = {\n    view: null,\n    projection: projection,\n    model: model,\n    _ortho: false\n  };\n  var pickDirty = true;\n  var viewShape = [gl.drawingBufferWidth, gl.drawingBufferHeight];\n  var camera = options.cameraObject || createCamera(canvas, cameraOptions); //Create scene object\n\n  var scene = {\n    gl: gl,\n    contextLost: false,\n    pixelRatio: options.pixelRatio || 1,\n    canvas: canvas,\n    selection: selection,\n    camera: camera,\n    axes: axes,\n    axesPixels: null,\n    spikes: spikes,\n    bounds: bounds,\n    objects: objects,\n    shape: viewShape,\n    aspect: options.aspectRatio || [1, 1, 1],\n    pickRadius: options.pickRadius || 10,\n    zNear: options.zNear || 0.01,\n    zFar: options.zFar || 1000,\n    fovy: options.fovy || Math.PI / 4,\n    clearColor: options.clearColor || [0, 0, 0, 0],\n    autoResize: defaultBool(options.autoResize),\n    autoBounds: defaultBool(options.autoBounds),\n    autoScale: !!options.autoScale,\n    autoCenter: defaultBool(options.autoCenter),\n    clipToBounds: defaultBool(options.clipToBounds),\n    snapToData: !!options.snapToData,\n    onselect: options.onselect || null,\n    onrender: options.onrender || null,\n    onclick: options.onclick || null,\n    cameraParams: cameraParams,\n    oncontextloss: null,\n    mouseListener: null,\n    _stopped: false,\n    getAspectratio: function () {\n      return {\n        x: this.aspect[0],\n        y: this.aspect[1],\n        z: this.aspect[2]\n      };\n    },\n    setAspectratio: function (aspectratio) {\n      this.aspect[0] = aspectratio.x;\n      this.aspect[1] = aspectratio.y;\n      this.aspect[2] = aspectratio.z;\n      pickDirty = true;\n    },\n    setBounds: function (axisIndex, range) {\n      this.bounds[0][axisIndex] = range.min;\n      this.bounds[1][axisIndex] = range.max;\n    },\n    setClearColor: function (clearColor) {\n      this.clearColor = clearColor;\n    },\n    clearRGBA: function () {\n      this.gl.clearColor(this.clearColor[0], this.clearColor[1], this.clearColor[2], this.clearColor[3]);\n      this.gl.clear(this.gl.COLOR_BUFFER_BIT | this.gl.DEPTH_BUFFER_BIT);\n    }\n  };\n  var pickShape = [gl.drawingBufferWidth / scene.pixelRatio | 0, gl.drawingBufferHeight / scene.pixelRatio | 0];\n\n  function resizeListener() {\n    if (scene._stopped) {\n      return;\n    }\n\n    if (!scene.autoResize) {\n      return;\n    }\n\n    var parent = canvas.parentNode;\n    var width = 1;\n    var height = 1;\n\n    if (parent && parent !== document.body) {\n      width = parent.clientWidth;\n      height = parent.clientHeight;\n    } else {\n      width = window.innerWidth;\n      height = window.innerHeight;\n    }\n\n    var nextWidth = Math.ceil(width * scene.pixelRatio) | 0;\n    var nextHeight = Math.ceil(height * scene.pixelRatio) | 0;\n\n    if (nextWidth !== canvas.width || nextHeight !== canvas.height) {\n      canvas.width = nextWidth;\n      canvas.height = nextHeight;\n      var style = canvas.style;\n      style.position = style.position || 'absolute';\n      style.left = '0px';\n      style.top = '0px';\n      style.width = width + 'px';\n      style.height = height + 'px';\n      dirty = true;\n    }\n  }\n\n  if (scene.autoResize) {\n    resizeListener();\n  }\n\n  window.addEventListener('resize', resizeListener);\n\n  function reallocPickIds() {\n    var numObjs = objects.length;\n    var numPick = pickBuffers.length;\n\n    for (var i = 0; i < numPick; ++i) {\n      pickBufferCount[i] = 0;\n    }\n\n    obj_loop: for (var i = 0; i < numObjs; ++i) {\n      var obj = objects[i];\n      var pickCount = obj.pickSlots;\n\n      if (!pickCount) {\n        pickBufferIds[i] = -1;\n        continue;\n      }\n\n      for (var j = 0; j < numPick; ++j) {\n        if (pickBufferCount[j] + pickCount < 255) {\n          pickBufferIds[i] = j;\n          obj.setPickBase(pickBufferCount[j] + 1);\n          pickBufferCount[j] += pickCount;\n          continue obj_loop;\n        }\n      } //Create new pick buffer\n\n\n      var nbuffer = createSelect(gl, viewShape);\n      pickBufferIds[i] = numPick;\n      pickBuffers.push(nbuffer);\n      pickBufferCount.push(pickCount);\n      obj.setPickBase(1);\n      numPick += 1;\n    }\n\n    while (numPick > 0 && pickBufferCount[numPick - 1] === 0) {\n      pickBufferCount.pop();\n      pickBuffers.pop().dispose();\n    }\n  }\n\n  scene.update = function (options) {\n    if (scene._stopped) {\n      return;\n    }\n\n    options = options || {};\n    dirty = true;\n    pickDirty = true;\n  };\n\n  scene.add = function (obj) {\n    if (scene._stopped) {\n      return;\n    }\n\n    obj.axes = axes;\n    objects.push(obj);\n    pickBufferIds.push(-1);\n    dirty = true;\n    pickDirty = true;\n    reallocPickIds();\n  };\n\n  scene.remove = function (obj) {\n    if (scene._stopped) {\n      return;\n    }\n\n    var idx = objects.indexOf(obj);\n\n    if (idx < 0) {\n      return;\n    }\n\n    objects.splice(idx, 1);\n    pickBufferIds.pop();\n    dirty = true;\n    pickDirty = true;\n    reallocPickIds();\n  };\n\n  scene.dispose = function () {\n    if (scene._stopped) {\n      return;\n    }\n\n    scene._stopped = true;\n    window.removeEventListener('resize', resizeListener);\n    canvas.removeEventListener('webglcontextlost', checkContextLoss);\n    scene.mouseListener.enabled = false;\n\n    if (scene.contextLost) {\n      return;\n    } //Destroy objects\n\n\n    axes.dispose();\n    spikes.dispose();\n\n    for (var i = 0; i < objects.length; ++i) {\n      objects[i].dispose();\n    } //Clean up buffers\n\n\n    accumBuffer.dispose();\n\n    for (var i = 0; i < pickBuffers.length; ++i) {\n      pickBuffers[i].dispose();\n    } //Clean up shaders\n\n\n    accumShader.dispose(); //Release all references\n\n    gl = null;\n    axes = null;\n    spikes = null;\n    objects = [];\n  }; //Update mouse position\n\n\n  scene._mouseRotating = false;\n  scene._prevButtons = 0;\n\n  scene.enableMouseListeners = function () {\n    scene.mouseListener = mouseChange(canvas, function (buttons, x, y) {\n      if (scene._stopped) {\n        return;\n      }\n\n      var numPick = pickBuffers.length;\n      var numObjs = objects.length;\n      var prevObj = selection.object;\n      selection.distance = Infinity;\n      selection.mouse[0] = x;\n      selection.mouse[1] = y;\n      selection.object = null;\n      selection.screen = null;\n      selection.dataCoordinate = selection.dataPosition = null;\n      var change = false;\n\n      if (buttons && scene._prevButtons) {\n        scene._mouseRotating = true;\n      } else {\n        if (scene._mouseRotating) {\n          pickDirty = true;\n        }\n\n        scene._mouseRotating = false;\n\n        for (var i = 0; i < numPick; ++i) {\n          var result = pickBuffers[i].query(x, pickShape[1] - y - 1, scene.pickRadius);\n\n          if (result) {\n            if (result.distance > selection.distance) {\n              continue;\n            }\n\n            for (var j = 0; j < numObjs; ++j) {\n              var obj = objects[j];\n\n              if (pickBufferIds[j] !== i) {\n                continue;\n              }\n\n              var objPick = obj.pick(result);\n\n              if (objPick) {\n                selection.buttons = buttons;\n                selection.screen = result.coord;\n                selection.distance = result.distance;\n                selection.object = obj;\n                selection.index = objPick.distance;\n                selection.dataPosition = objPick.position;\n                selection.dataCoordinate = objPick.dataCoordinate;\n                selection.data = objPick;\n                change = true;\n              }\n            }\n          }\n        }\n      }\n\n      if (prevObj && prevObj !== selection.object) {\n        if (prevObj.highlight) {\n          prevObj.highlight(null);\n        }\n\n        dirty = true;\n      }\n\n      if (selection.object) {\n        if (selection.object.highlight) {\n          selection.object.highlight(selection.data);\n        }\n\n        dirty = true;\n      }\n\n      change = change || selection.object !== prevObj;\n\n      if (change && scene.onselect) {\n        scene.onselect(selection);\n      }\n\n      if (buttons & 1 && !(scene._prevButtons & 1) && scene.onclick) {\n        scene.onclick(selection);\n      }\n\n      scene._prevButtons = buttons;\n    });\n  };\n\n  function checkContextLoss() {\n    if (scene.contextLost) {\n      return true;\n    }\n\n    if (gl.isContextLost()) {\n      scene.contextLost = true;\n      scene.mouseListener.enabled = false;\n      scene.selection.object = null;\n\n      if (scene.oncontextloss) {\n        scene.oncontextloss();\n      }\n    }\n  }\n\n  canvas.addEventListener('webglcontextlost', checkContextLoss); //Render the scene for mouse picking\n\n  function renderPick() {\n    if (checkContextLoss()) {\n      return;\n    }\n\n    gl.colorMask(true, true, true, true);\n    gl.depthMask(true);\n    gl.disable(gl.BLEND);\n    gl.enable(gl.DEPTH_TEST);\n    gl.depthFunc(gl.LEQUAL);\n    var numObjs = objects.length;\n    var numPick = pickBuffers.length;\n\n    for (var j = 0; j < numPick; ++j) {\n      var buf = pickBuffers[j];\n      buf.shape = pickShape;\n      buf.begin();\n\n      for (var i = 0; i < numObjs; ++i) {\n        if (pickBufferIds[i] !== j) {\n          continue;\n        }\n\n        var obj = objects[i];\n\n        if (obj.drawPick) {\n          obj.pixelRatio = 1;\n          obj.drawPick(cameraParams);\n        }\n      }\n\n      buf.end();\n    }\n  }\n\n  var nBounds = [[Infinity, Infinity, Infinity], [-Infinity, -Infinity, -Infinity]];\n  var prevBounds = [nBounds[0].slice(), nBounds[1].slice()];\n\n  function redraw() {\n    if (checkContextLoss()) {\n      return;\n    }\n\n    resizeListener(); //Tick camera\n\n    var cameraMoved = scene.camera.tick();\n    cameraParams.view = scene.camera.matrix;\n    dirty = dirty || cameraMoved;\n    pickDirty = pickDirty || cameraMoved; //Set pixel ratio\n\n    axes.pixelRatio = scene.pixelRatio;\n    spikes.pixelRatio = scene.pixelRatio; //Check if any objects changed, recalculate bounds\n\n    var numObjs = objects.length;\n    var lo = nBounds[0];\n    var hi = nBounds[1];\n    lo[0] = lo[1] = lo[2] = Infinity;\n    hi[0] = hi[1] = hi[2] = -Infinity;\n\n    for (var i = 0; i < numObjs; ++i) {\n      var obj = objects[i]; //Set the axes properties for each object\n\n      obj.pixelRatio = scene.pixelRatio;\n      obj.axes = scene.axes;\n      dirty = dirty || !!obj.dirty;\n      pickDirty = pickDirty || !!obj.dirty;\n      var obb = obj.bounds;\n\n      if (obb) {\n        var olo = obb[0];\n        var ohi = obb[1];\n\n        for (var j = 0; j < 3; ++j) {\n          lo[j] = Math.min(lo[j], olo[j]);\n          hi[j] = Math.max(hi[j], ohi[j]);\n        }\n      }\n    } //Recalculate bounds\n\n\n    var bounds = scene.bounds;\n\n    if (scene.autoBounds) {\n      for (var j = 0; j < 3; ++j) {\n        if (hi[j] < lo[j]) {\n          lo[j] = -1;\n          hi[j] = 1;\n        } else {\n          if (lo[j] === hi[j]) {\n            lo[j] -= 1;\n            hi[j] += 1;\n          }\n\n          var padding = 0.05 * (hi[j] - lo[j]);\n          lo[j] = lo[j] - padding;\n          hi[j] = hi[j] + padding;\n        }\n\n        bounds[0][j] = lo[j];\n        bounds[1][j] = hi[j];\n      }\n    }\n\n    var boundsChanged = false;\n\n    for (var j = 0; j < 3; ++j) {\n      boundsChanged = boundsChanged || prevBounds[0][j] !== bounds[0][j] || prevBounds[1][j] !== bounds[1][j];\n      prevBounds[0][j] = bounds[0][j];\n      prevBounds[1][j] = bounds[1][j];\n    } //Recalculate bounds\n\n\n    pickDirty = pickDirty || boundsChanged;\n    dirty = dirty || boundsChanged;\n\n    if (!dirty) {\n      return;\n    }\n\n    if (boundsChanged) {\n      var tickSpacing = [0, 0, 0];\n\n      for (var i = 0; i < 3; ++i) {\n        tickSpacing[i] = roundUpPow10((bounds[1][i] - bounds[0][i]) / 10.0);\n      }\n\n      if (axes.autoTicks) {\n        axes.update({\n          bounds: bounds,\n          tickSpacing: tickSpacing\n        });\n      } else {\n        axes.update({\n          bounds: bounds\n        });\n      }\n    } //Get scene\n\n\n    var width = gl.drawingBufferWidth;\n    var height = gl.drawingBufferHeight;\n    viewShape[0] = width;\n    viewShape[1] = height;\n    pickShape[0] = Math.max(width / scene.pixelRatio, 1) | 0;\n    pickShape[1] = Math.max(height / scene.pixelRatio, 1) | 0; //Compute camera parameters\n\n    calcCameraParams(scene, isOrtho); //Apply axes/clip bounds\n\n    for (var i = 0; i < numObjs; ++i) {\n      var obj = objects[i]; //Set axes bounds\n\n      obj.axesBounds = bounds; //Set clip bounds\n\n      if (scene.clipToBounds) {\n        obj.clipBounds = bounds;\n      }\n    } //Set spike parameters\n\n\n    if (selection.object) {\n      if (scene.snapToData) {\n        spikes.position = selection.dataCoordinate;\n      } else {\n        spikes.position = selection.dataPosition;\n      }\n\n      spikes.bounds = bounds;\n    } //If state changed, then redraw pick buffers\n\n\n    if (pickDirty) {\n      pickDirty = false;\n      renderPick();\n    } //Recalculate pixel data\n\n\n    scene.axesPixels = axesRanges(scene.axes, cameraParams, width, height); //Call render callback\n\n    if (scene.onrender) {\n      scene.onrender();\n    } //Read value\n\n\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null);\n    gl.viewport(0, 0, width, height); //General strategy: 3 steps\n    //  1. render non-transparent objects\n    //  2. accumulate transparent objects into separate fbo\n    //  3. composite final scene\n    //Clear FBO\n\n    scene.clearRGBA();\n    gl.depthMask(true);\n    gl.colorMask(true, true, true, true);\n    gl.enable(gl.DEPTH_TEST);\n    gl.depthFunc(gl.LEQUAL);\n    gl.disable(gl.BLEND);\n    gl.disable(gl.CULL_FACE); //most visualization surfaces are 2 sided\n    //Render opaque pass\n\n    var hasTransparent = false;\n\n    if (axes.enable) {\n      hasTransparent = hasTransparent || axes.isTransparent();\n      axes.draw(cameraParams);\n    }\n\n    spikes.axes = axes;\n\n    if (selection.object) {\n      spikes.draw(cameraParams);\n    }\n\n    gl.disable(gl.CULL_FACE); //most visualization surfaces are 2 sided\n\n    for (var i = 0; i < numObjs; ++i) {\n      var obj = objects[i];\n      obj.axes = axes;\n      obj.pixelRatio = scene.pixelRatio;\n\n      if (obj.isOpaque && obj.isOpaque()) {\n        obj.draw(cameraParams);\n      }\n\n      if (obj.isTransparent && obj.isTransparent()) {\n        hasTransparent = true;\n      }\n    }\n\n    if (hasTransparent) {\n      //Render transparent pass\n      accumBuffer.shape = viewShape;\n      accumBuffer.bind();\n      gl.clear(gl.DEPTH_BUFFER_BIT);\n      gl.colorMask(false, false, false, false);\n      gl.depthMask(true);\n      gl.depthFunc(gl.LESS); //Render forward facing objects\n\n      if (axes.enable && axes.isTransparent()) {\n        axes.drawTransparent(cameraParams);\n      }\n\n      for (var i = 0; i < numObjs; ++i) {\n        var obj = objects[i];\n\n        if (obj.isOpaque && obj.isOpaque()) {\n          obj.draw(cameraParams);\n        }\n      } //Render transparent pass\n\n\n      gl.enable(gl.BLEND);\n      gl.blendEquation(gl.FUNC_ADD);\n      gl.blendFunc(gl.ONE, gl.ONE_MINUS_SRC_ALPHA);\n      gl.colorMask(true, true, true, true);\n      gl.depthMask(false);\n      gl.clearColor(0, 0, 0, 0);\n      gl.clear(gl.COLOR_BUFFER_BIT);\n\n      if (axes.isTransparent()) {\n        axes.drawTransparent(cameraParams);\n      }\n\n      for (var i = 0; i < numObjs; ++i) {\n        var obj = objects[i];\n\n        if (obj.isTransparent && obj.isTransparent()) {\n          obj.drawTransparent(cameraParams);\n        }\n      } //Unbind framebuffer\n\n\n      gl.bindFramebuffer(gl.FRAMEBUFFER, null); //Draw composite pass\n\n      gl.blendFunc(gl.ONE, gl.ONE_MINUS_SRC_ALPHA);\n      gl.disable(gl.DEPTH_TEST);\n      accumShader.bind();\n      accumBuffer.color[0].bind(0);\n      accumShader.uniforms.accumBuffer = 0;\n      drawTriangle(gl); //Turn off blending\n\n      gl.disable(gl.BLEND);\n    } //Clear dirty flags\n\n\n    dirty = false;\n\n    for (var i = 0; i < numObjs; ++i) {\n      objects[i].dirty = false;\n    }\n  } //Draw the whole scene\n\n\n  function render() {\n    if (scene._stopped || scene.contextLost) {\n      return;\n    } // this order is important: ios safari sometimes has sync raf\n\n\n    redraw();\n    requestAnimationFrame(render);\n  }\n\n  scene.enableMouseListeners();\n  render(); //Force redraw of whole scene\n\n  scene.redraw = function () {\n    if (scene._stopped) {\n      return;\n    }\n\n    dirty = true;\n    redraw();\n  };\n\n  return scene;\n}\n\nfunction calcCameraParams(scene, isOrtho) {\n  var bounds = scene.bounds;\n  var cameraParams = scene.cameraParams;\n  var projection = cameraParams.projection;\n  var model = cameraParams.model;\n  var width = scene.gl.drawingBufferWidth;\n  var height = scene.gl.drawingBufferHeight;\n  var zNear = scene.zNear;\n  var zFar = scene.zFar;\n  var fovy = scene.fovy;\n  var r = width / height;\n\n  if (isOrtho) {\n    ortho(projection, -r, r, -1, 1, zNear, zFar);\n    cameraParams._ortho = true;\n  } else {\n    perspective(projection, fovy, r, zNear, zFar);\n    cameraParams._ortho = false;\n  } //Compute model matrix\n\n\n  for (var i = 0; i < 16; ++i) {\n    model[i] = 0;\n  }\n\n  model[15] = 1;\n  var maxS = 0;\n\n  for (var i = 0; i < 3; ++i) {\n    maxS = Math.max(maxS, bounds[1][i] - bounds[0][i]);\n  }\n\n  for (var i = 0; i < 3; ++i) {\n    if (scene.autoScale) {\n      model[5 * i] = scene.aspect[i] / (bounds[1][i] - bounds[0][i]);\n    } else {\n      model[5 * i] = 1 / maxS;\n    }\n\n    if (scene.autoCenter) {\n      model[12 + i] = -model[5 * i] * 0.5 * (bounds[0][i] + bounds[1][i]);\n    }\n  }\n}","map":{"version":3,"sources":["C:/Projects/reactApp/frontend/node_modules/gl-plot3d/scene.js"],"names":["createCamera","require","createAxes","axesRanges","createSpikes","createSelect","createFBO","drawTriangle","mouseChange","perspective","ortho","createShader","isMobile","tablet","featureDetect","module","exports","createScene","MouseSelect","mouse","screen","distance","Infinity","index","dataCoordinate","dataPosition","object","data","getContext","canvas","options","gl","e","roundUpPow10","x","y","Math","round","log","abs","base","pow","ceil","defaultBool","camera","document","createElement","container","appendChild","body","glOptions","preserveDrawingBuffer","premultipliedAlpha","antialias","Error","bounds","selection","accumBuffer","drawingBufferWidth","drawingBufferHeight","preferFloat","accumShader","isOrtho","cameraObject","_ortho","projection","type","cameraOptions","eye","center","up","zoomMin","zoomMax","mode","axesOptions","axes","enable","disable","spikeOptions","spikes","objects","pickBufferIds","pickBufferCount","pickBuffers","dirty","pickDirty","Array","model","cameraParams","view","viewShape","scene","contextLost","pixelRatio","axesPixels","shape","aspect","aspectRatio","pickRadius","zNear","zFar","fovy","PI","clearColor","autoResize","autoBounds","autoScale","autoCenter","clipToBounds","snapToData","onselect","onrender","onclick","oncontextloss","mouseListener","_stopped","getAspectratio","z","setAspectratio","aspectratio","setBounds","axisIndex","range","min","max","setClearColor","clearRGBA","clear","COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","pickShape","resizeListener","parent","parentNode","width","height","clientWidth","clientHeight","window","innerWidth","innerHeight","nextWidth","nextHeight","style","position","left","top","addEventListener","reallocPickIds","numObjs","length","numPick","i","obj_loop","obj","pickCount","pickSlots","j","setPickBase","nbuffer","push","pop","dispose","update","add","remove","idx","indexOf","splice","removeEventListener","checkContextLoss","enabled","_mouseRotating","_prevButtons","enableMouseListeners","buttons","prevObj","change","result","query","objPick","pick","coord","highlight","isContextLost","renderPick","colorMask","depthMask","BLEND","DEPTH_TEST","depthFunc","LEQUAL","buf","begin","drawPick","end","nBounds","prevBounds","slice","redraw","cameraMoved","tick","matrix","lo","hi","obb","olo","ohi","padding","boundsChanged","tickSpacing","autoTicks","calcCameraParams","axesBounds","clipBounds","bindFramebuffer","FRAMEBUFFER","viewport","CULL_FACE","hasTransparent","isTransparent","draw","isOpaque","bind","LESS","drawTransparent","blendEquation","FUNC_ADD","blendFunc","ONE","ONE_MINUS_SRC_ALPHA","color","uniforms","render","requestAnimationFrame","r","maxS"],"mappings":"AAAA;;AAEA,IAAIA,YAAY,GAAGC,OAAO,CAAC,aAAD,CAA1B;;AACA,IAAIC,UAAU,GAAKD,OAAO,CAAC,WAAD,CAA1B;;AACA,IAAIE,UAAU,GAAKF,OAAO,CAAC,sBAAD,CAA1B;;AACA,IAAIG,YAAY,GAAGH,OAAO,CAAC,aAAD,CAA1B;;AACA,IAAII,YAAY,GAAGJ,OAAO,CAAC,kBAAD,CAA1B;;AACA,IAAIK,SAAS,GAAML,OAAO,CAAC,QAAD,CAA1B;;AACA,IAAIM,YAAY,GAAGN,OAAO,CAAC,gBAAD,CAA1B;;AACA,IAAIO,WAAW,GAAIP,OAAO,CAAC,cAAD,CAA1B;;AACA,IAAIQ,WAAW,GAAIR,OAAO,CAAC,qBAAD,CAA1B;;AACA,IAAIS,KAAK,GAAUT,OAAO,CAAC,eAAD,CAA1B;;AACA,IAAIU,YAAY,GAAGV,OAAO,CAAC,cAAD,CAA1B;;AACA,IAAIW,QAAQ,GAAGX,OAAO,CAAC,WAAD,CAAP,CAAqB;AAAEY,EAAAA,MAAM,EAAE,IAAV;AAAgBC,EAAAA,aAAa,EAAE;AAA/B,CAArB,CAAf;;AAEAC,MAAM,CAACC,OAAP,GAAiB;AACfC,EAAAA,WAAW,EAAEA,WADE;AAEfjB,EAAAA,YAAY,EAAEA;AAFC,CAAjB;;AAKA,SAASkB,WAAT,GAAuB;AACrB,OAAKC,KAAL,GAAsB,CAAC,CAAC,CAAF,EAAI,CAAC,CAAL,CAAtB;AACA,OAAKC,MAAL,GAAsB,IAAtB;AACA,OAAKC,QAAL,GAAsBC,QAAtB;AACA,OAAKC,KAAL,GAAsB,IAAtB;AACA,OAAKC,cAAL,GAAsB,IAAtB;AACA,OAAKC,YAAL,GAAsB,IAAtB;AACA,OAAKC,MAAL,GAAsB,IAAtB;AACA,OAAKC,IAAL,GAAsB,IAAtB;AACD;;AAED,SAASC,UAAT,CAAoBC,MAApB,EAA4BC,OAA5B,EAAqC;AACnC,MAAIC,EAAE,GAAG,IAAT;;AACA,MAAI;AACFA,IAAAA,EAAE,GAAGF,MAAM,CAACD,UAAP,CAAkB,OAAlB,EAA2BE,OAA3B,CAAL;;AACA,QAAG,CAACC,EAAJ,EAAQ;AACNA,MAAAA,EAAE,GAAGF,MAAM,CAACD,UAAP,CAAkB,oBAAlB,EAAwCE,OAAxC,CAAL;AACD;AACF,GALD,CAKE,OAAME,CAAN,EAAS;AACT,WAAO,IAAP;AACD;;AACD,SAAOD,EAAP;AACD;;AAED,SAASE,YAAT,CAAsBC,CAAtB,EAAyB;AACvB,MAAIC,CAAC,GAAGC,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,GAAL,CAASF,IAAI,CAACG,GAAL,CAASL,CAAT,CAAT,IAAwBE,IAAI,CAACE,GAAL,CAAS,EAAT,CAAnC,CAAR;;AACA,MAAGH,CAAC,GAAG,CAAP,EAAU;AACR,QAAIK,IAAI,GAAGJ,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACK,GAAL,CAAS,EAAT,EAAa,CAACN,CAAd,CAAX,CAAX;AACA,WAAOC,IAAI,CAACM,IAAL,CAAUR,CAAC,GAACM,IAAZ,IAAoBA,IAA3B;AACD,GAHD,MAGO,IAAGL,CAAC,GAAG,CAAP,EAAU;AACf,QAAIK,IAAI,GAAGJ,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACK,GAAL,CAAS,EAAT,EAAaN,CAAb,CAAX,CAAX;AACA,WAAOC,IAAI,CAACM,IAAL,CAAUR,CAAC,GAACM,IAAZ,IAAoBA,IAA3B;AACD;;AACD,SAAOJ,IAAI,CAACM,IAAL,CAAUR,CAAV,CAAP;AACD;;AAED,SAASS,WAAT,CAAqBT,CAArB,EAAwB;AACtB,MAAG,OAAOA,CAAP,KAAa,SAAhB,EAA2B;AACzB,WAAOA,CAAP;AACD;;AACD,SAAO,IAAP;AACD;;AAED,SAASjB,WAAT,CAAqBa,OAArB,EAA8B;AAC5BA,EAAAA,OAAO,GAAGA,OAAO,IAAI,EAArB;AACAA,EAAAA,OAAO,CAACc,MAAR,GAAiBd,OAAO,CAACc,MAAR,IAAkB,EAAnC;AAEA,MAAIf,MAAM,GAAGC,OAAO,CAACD,MAArB;;AACA,MAAG,CAACA,MAAJ,EAAY;AACVA,IAAAA,MAAM,GAAGgB,QAAQ,CAACC,aAAT,CAAuB,QAAvB,CAAT;;AACA,QAAGhB,OAAO,CAACiB,SAAX,EAAsB;AACpB,UAAIA,SAAS,GAAGjB,OAAO,CAACiB,SAAxB;AACAA,MAAAA,SAAS,CAACC,WAAV,CAAsBnB,MAAtB;AACD,KAHD,MAGO;AACLgB,MAAAA,QAAQ,CAACI,IAAT,CAAcD,WAAd,CAA0BnB,MAA1B;AACD;AACF;;AAED,MAAIE,EAAE,GAAGD,OAAO,CAACC,EAAjB;;AACA,MAAG,CAACA,EAAJ,EAAQ;AACN,QAAGD,OAAO,CAACoB,SAAX,EAAsB;AACpBtC,MAAAA,QAAQ,GAAG,CAAC,CAACkB,OAAO,CAACoB,SAAR,CAAkBC,qBAA/B;AACD;;AAEDpB,IAAAA,EAAE,GAAGH,UAAU,CAACC,MAAD,EACbC,OAAO,CAACoB,SAAR,IAAqB;AACnBE,MAAAA,kBAAkB,EAAE,IADD;AAEnBC,MAAAA,SAAS,EAAE,IAFQ;AAGnBF,MAAAA,qBAAqB,EAAEvC;AAHJ,KADR,CAAf;AAMD;;AACD,MAAG,CAACmB,EAAJ,EAAQ;AACN,UAAM,IAAIuB,KAAJ,CAAU,qBAAV,CAAN;AACD,GA9B2B,CAgC5B;;;AACA,MAAIC,MAAM,GAAGzB,OAAO,CAACyB,MAAR,IAAkB,CAAC,CAAC,CAAC,EAAF,EAAK,CAAC,EAAN,EAAS,CAAC,EAAV,CAAD,EAAgB,CAAC,EAAD,EAAI,EAAJ,EAAO,EAAP,CAAhB,CAA/B,CAjC4B,CAmC5B;;AACA,MAAIC,SAAS,GAAG,IAAItC,WAAJ,EAAhB,CApC4B,CAsC5B;;AACA,MAAIuC,WAAW,GAAGnD,SAAS,CAACyB,EAAD,EACzBA,EAAE,CAAC2B,kBADsB,EACF3B,EAAE,CAAC4B,mBADD,EACsB;AAC7CC,IAAAA,WAAW,EAAE,CAAChD;AAD+B,GADtB,CAA3B;AAKA,MAAIiD,WAAW,GAAGlD,YAAY,CAACoB,EAAD,CAA9B;AAEA,MAAI+B,OAAO,GACRhC,OAAO,CAACiC,YAAR,IAAwBjC,OAAO,CAACiC,YAAR,CAAqBC,MAArB,KAAgC,IAAzD,IACClC,OAAO,CAACc,MAAR,CAAeqB,UAAf,IAA6BnC,OAAO,CAACc,MAAR,CAAeqB,UAAf,CAA0BC,IAA1B,KAAmC,cADjE,IAEA,KAHF,CA9C4B,CAmD5B;;AACA,MAAIC,aAAa,GAAG;AAClBC,IAAAA,GAAG,EAAMtC,OAAO,CAACc,MAAR,CAAewB,GAAf,IAA0B,CAAC,CAAD,EAAG,CAAH,EAAK,CAAL,CADjB;AAElBC,IAAAA,MAAM,EAAGvC,OAAO,CAACc,MAAR,CAAeyB,MAAf,IAA0B,CAAC,CAAD,EAAG,CAAH,EAAK,CAAL,CAFjB;AAGlBC,IAAAA,EAAE,EAAOxC,OAAO,CAACc,MAAR,CAAe0B,EAAf,IAA0B,CAAC,CAAD,EAAG,CAAH,EAAK,CAAL,CAHjB;AAIlBC,IAAAA,OAAO,EAAEzC,OAAO,CAACc,MAAR,CAAe4B,OAAf,IAA0B,GAJjB;AAKlBA,IAAAA,OAAO,EAAE1C,OAAO,CAACc,MAAR,CAAe2B,OAAf,IAA0B,GALjB;AAMlBE,IAAAA,IAAI,EAAK3C,OAAO,CAACc,MAAR,CAAe6B,IAAf,IAA0B,WANjB;AAOlBT,IAAAA,MAAM,EAAGF;AAPS,GAApB,CApD4B,CA8D5B;;AACA,MAAIY,WAAW,GAAG5C,OAAO,CAAC6C,IAAR,IAAgB,EAAlC;AACA,MAAIA,IAAI,GAAGzE,UAAU,CAAC6B,EAAD,EAAK2C,WAAL,CAArB;AACAC,EAAAA,IAAI,CAACC,MAAL,GAAc,CAACF,WAAW,CAACG,OAA3B,CAjE4B,CAmE5B;;AACA,MAAIC,YAAY,GAAGhD,OAAO,CAACiD,MAAR,IAAkB,EAArC;AACA,MAAIA,MAAM,GAAG3E,YAAY,CAAC2B,EAAD,EAAK+C,YAAL,CAAzB,CArE4B,CAuE5B;;AACA,MAAIE,OAAO,GAAW,EAAtB;AACA,MAAIC,aAAa,GAAK,EAAtB;AACA,MAAIC,eAAe,GAAG,EAAtB;AACA,MAAIC,WAAW,GAAO,EAAtB,CA3E4B,CA6E5B;;AACA,MAAIC,KAAK,GAAS,IAAlB;AACA,MAAIC,SAAS,GAAK,IAAlB;AAEA,MAAIpB,UAAU,GAAO,IAAIqB,KAAJ,CAAU,EAAV,CAArB;AACA,MAAIC,KAAK,GAAY,IAAID,KAAJ,CAAU,EAAV,CAArB;AAEA,MAAIE,YAAY,GAAG;AACjBC,IAAAA,IAAI,EAAU,IADG;AAEjBxB,IAAAA,UAAU,EAAIA,UAFG;AAGjBsB,IAAAA,KAAK,EAASA,KAHG;AAIjBvB,IAAAA,MAAM,EAAQ;AAJG,GAAnB;AAOA,MAAIqB,SAAS,GAAG,IAAhB;AAEA,MAAIK,SAAS,GAAG,CAAE3D,EAAE,CAAC2B,kBAAL,EAAyB3B,EAAE,CAAC4B,mBAA5B,CAAhB;AAEA,MAAIf,MAAM,GAAGd,OAAO,CAACiC,YAAR,IAAwB/D,YAAY,CAAC6B,MAAD,EAASsC,aAAT,CAAjD,CA/F4B,CAiG5B;;AACA,MAAIwB,KAAK,GAAG;AACV5D,IAAAA,EAAE,EAAYA,EADJ;AAEV6D,IAAAA,WAAW,EAAG,KAFJ;AAGVC,IAAAA,UAAU,EAAI/D,OAAO,CAAC+D,UAAR,IAAsB,CAH1B;AAIVhE,IAAAA,MAAM,EAAQA,MAJJ;AAKV2B,IAAAA,SAAS,EAAKA,SALJ;AAMVZ,IAAAA,MAAM,EAAQA,MANJ;AAOV+B,IAAAA,IAAI,EAAUA,IAPJ;AAQVmB,IAAAA,UAAU,EAAI,IARJ;AASVf,IAAAA,MAAM,EAAQA,MATJ;AAUVxB,IAAAA,MAAM,EAAQA,MAVJ;AAWVyB,IAAAA,OAAO,EAAOA,OAXJ;AAYVe,IAAAA,KAAK,EAASL,SAZJ;AAaVM,IAAAA,MAAM,EAAQlE,OAAO,CAACmE,WAAR,IAAuB,CAAC,CAAD,EAAG,CAAH,EAAK,CAAL,CAb3B;AAcVC,IAAAA,UAAU,EAAIpE,OAAO,CAACoE,UAAR,IAAsB,EAd1B;AAeVC,IAAAA,KAAK,EAASrE,OAAO,CAACqE,KAAR,IAAiB,IAfrB;AAgBVC,IAAAA,IAAI,EAAUtE,OAAO,CAACsE,IAAR,IAAiB,IAhBrB;AAiBVC,IAAAA,IAAI,EAAUvE,OAAO,CAACuE,IAAR,IAAiBjE,IAAI,CAACkE,EAAL,GAAQ,CAjB7B;AAkBVC,IAAAA,UAAU,EAAIzE,OAAO,CAACyE,UAAR,IAAsB,CAAC,CAAD,EAAG,CAAH,EAAK,CAAL,EAAO,CAAP,CAlB1B;AAmBVC,IAAAA,UAAU,EAAI7D,WAAW,CAACb,OAAO,CAAC0E,UAAT,CAnBf;AAoBVC,IAAAA,UAAU,EAAI9D,WAAW,CAACb,OAAO,CAAC2E,UAAT,CApBf;AAqBVC,IAAAA,SAAS,EAAK,CAAC,CAAC5E,OAAO,CAAC4E,SArBd;AAsBVC,IAAAA,UAAU,EAAIhE,WAAW,CAACb,OAAO,CAAC6E,UAAT,CAtBf;AAuBVC,IAAAA,YAAY,EAAEjE,WAAW,CAACb,OAAO,CAAC8E,YAAT,CAvBf;AAwBVC,IAAAA,UAAU,EAAI,CAAC,CAAC/E,OAAO,CAAC+E,UAxBd;AAyBVC,IAAAA,QAAQ,EAAMhF,OAAO,CAACgF,QAAR,IAAoB,IAzBxB;AA0BVC,IAAAA,QAAQ,EAAMjF,OAAO,CAACiF,QAAR,IAAoB,IA1BxB;AA2BVC,IAAAA,OAAO,EAAOlF,OAAO,CAACkF,OAAR,IAAoB,IA3BxB;AA4BVxB,IAAAA,YAAY,EAAEA,YA5BJ;AA6BVyB,IAAAA,aAAa,EAAE,IA7BL;AA8BVC,IAAAA,aAAa,EAAE,IA9BL;AA+BVC,IAAAA,QAAQ,EAAE,KA/BA;AAiCVC,IAAAA,cAAc,EAAE,YAAW;AACzB,aAAO;AACLlF,QAAAA,CAAC,EAAE,KAAK8D,MAAL,CAAY,CAAZ,CADE;AAEL7D,QAAAA,CAAC,EAAE,KAAK6D,MAAL,CAAY,CAAZ,CAFE;AAGLqB,QAAAA,CAAC,EAAE,KAAKrB,MAAL,CAAY,CAAZ;AAHE,OAAP;AAKD,KAvCS;AAyCVsB,IAAAA,cAAc,EAAE,UAASC,WAAT,EAAsB;AACpC,WAAKvB,MAAL,CAAY,CAAZ,IAAiBuB,WAAW,CAACrF,CAA7B;AACA,WAAK8D,MAAL,CAAY,CAAZ,IAAiBuB,WAAW,CAACpF,CAA7B;AACA,WAAK6D,MAAL,CAAY,CAAZ,IAAiBuB,WAAW,CAACF,CAA7B;AACAhC,MAAAA,SAAS,GAAG,IAAZ;AACD,KA9CS;AAgDVmC,IAAAA,SAAS,EAAE,UAASC,SAAT,EAAoBC,KAApB,EAA2B;AACpC,WAAKnE,MAAL,CAAY,CAAZ,EAAekE,SAAf,IAA4BC,KAAK,CAACC,GAAlC;AACA,WAAKpE,MAAL,CAAY,CAAZ,EAAekE,SAAf,IAA4BC,KAAK,CAACE,GAAlC;AACD,KAnDS;AAqDVC,IAAAA,aAAa,EAAE,UAAStB,UAAT,EAAqB;AAClC,WAAKA,UAAL,GAAkBA,UAAlB;AACD,KAvDS;AAyDVuB,IAAAA,SAAS,EAAE,YAAW;AACpB,WAAK/F,EAAL,CAAQwE,UAAR,CACE,KAAKA,UAAL,CAAgB,CAAhB,CADF,EAEE,KAAKA,UAAL,CAAgB,CAAhB,CAFF,EAGE,KAAKA,UAAL,CAAgB,CAAhB,CAHF,EAIE,KAAKA,UAAL,CAAgB,CAAhB,CAJF;AAOA,WAAKxE,EAAL,CAAQgG,KAAR,CACE,KAAKhG,EAAL,CAAQiG,gBAAR,GACA,KAAKjG,EAAL,CAAQkG,gBAFV;AAID;AArES,GAAZ;AAwEA,MAAIC,SAAS,GAAG,CAAGnG,EAAE,CAAC2B,kBAAH,GAAsBiC,KAAK,CAACE,UAA7B,GAAyC,CAA3C,EAA+C9D,EAAE,CAAC4B,mBAAH,GAAuBgC,KAAK,CAACE,UAA9B,GAA0C,CAAxF,CAAhB;;AAEA,WAASsC,cAAT,GAA0B;AACxB,QAAGxC,KAAK,CAACwB,QAAT,EAAmB;AACjB;AACD;;AACD,QAAG,CAACxB,KAAK,CAACa,UAAV,EAAsB;AACpB;AACD;;AACD,QAAI4B,MAAM,GAAGvG,MAAM,CAACwG,UAApB;AACA,QAAIC,KAAK,GAAI,CAAb;AACA,QAAIC,MAAM,GAAG,CAAb;;AACA,QAAGH,MAAM,IAAIA,MAAM,KAAKvF,QAAQ,CAACI,IAAjC,EAAuC;AACrCqF,MAAAA,KAAK,GAAIF,MAAM,CAACI,WAAhB;AACAD,MAAAA,MAAM,GAAGH,MAAM,CAACK,YAAhB;AACD,KAHD,MAGO;AACLH,MAAAA,KAAK,GAAII,MAAM,CAACC,UAAhB;AACAJ,MAAAA,MAAM,GAAGG,MAAM,CAACE,WAAhB;AACD;;AACD,QAAIC,SAAS,GAAIzG,IAAI,CAACM,IAAL,CAAU4F,KAAK,GAAI3C,KAAK,CAACE,UAAzB,IAAqC,CAAtD;AACA,QAAIiD,UAAU,GAAG1G,IAAI,CAACM,IAAL,CAAU6F,MAAM,GAAG5C,KAAK,CAACE,UAAzB,IAAqC,CAAtD;;AACA,QAAGgD,SAAS,KAAKhH,MAAM,CAACyG,KAArB,IAA8BQ,UAAU,KAAKjH,MAAM,CAAC0G,MAAvD,EAA+D;AAC7D1G,MAAAA,MAAM,CAACyG,KAAP,GAAiBO,SAAjB;AACAhH,MAAAA,MAAM,CAAC0G,MAAP,GAAiBO,UAAjB;AACA,UAAIC,KAAK,GAAGlH,MAAM,CAACkH,KAAnB;AACAA,MAAAA,KAAK,CAACC,QAAN,GAAiBD,KAAK,CAACC,QAAN,IAAkB,UAAnC;AACAD,MAAAA,KAAK,CAACE,IAAN,GAAiB,KAAjB;AACAF,MAAAA,KAAK,CAACG,GAAN,GAAiB,KAAjB;AACAH,MAAAA,KAAK,CAACT,KAAN,GAAiBA,KAAK,GAAI,IAA1B;AACAS,MAAAA,KAAK,CAACR,MAAN,GAAiBA,MAAM,GAAG,IAA1B;AACAnD,MAAAA,KAAK,GAAG,IAAR;AACD;AACF;;AACD,MAAGO,KAAK,CAACa,UAAT,EAAqB;AACnB2B,IAAAA,cAAc;AACf;;AACDO,EAAAA,MAAM,CAACS,gBAAP,CAAwB,QAAxB,EAAkChB,cAAlC;;AAEA,WAASiB,cAAT,GAA0B;AACxB,QAAIC,OAAO,GAAGrE,OAAO,CAACsE,MAAtB;AACA,QAAIC,OAAO,GAAGpE,WAAW,CAACmE,MAA1B;;AACA,SAAI,IAAIE,CAAC,GAAC,CAAV,EAAaA,CAAC,GAACD,OAAf,EAAwB,EAAEC,CAA1B,EAA6B;AAC3BtE,MAAAA,eAAe,CAACsE,CAAD,CAAf,GAAqB,CAArB;AACD;;AACDC,IAAAA,QAAQ,EACR,KAAI,IAAID,CAAC,GAAC,CAAV,EAAaA,CAAC,GAACH,OAAf,EAAwB,EAAEG,CAA1B,EAA6B;AAC3B,UAAIE,GAAG,GAAG1E,OAAO,CAACwE,CAAD,CAAjB;AACA,UAAIG,SAAS,GAAGD,GAAG,CAACE,SAApB;;AACA,UAAG,CAACD,SAAJ,EAAe;AACb1E,QAAAA,aAAa,CAACuE,CAAD,CAAb,GAAmB,CAAC,CAApB;AACA;AACD;;AACD,WAAI,IAAIK,CAAC,GAAC,CAAV,EAAaA,CAAC,GAACN,OAAf,EAAwB,EAAEM,CAA1B,EAA6B;AAC3B,YAAG3E,eAAe,CAAC2E,CAAD,CAAf,GAAqBF,SAArB,GAAiC,GAApC,EAAyC;AACvC1E,UAAAA,aAAa,CAACuE,CAAD,CAAb,GAAmBK,CAAnB;AACAH,UAAAA,GAAG,CAACI,WAAJ,CAAgB5E,eAAe,CAAC2E,CAAD,CAAf,GAAmB,CAAnC;AACA3E,UAAAA,eAAe,CAAC2E,CAAD,CAAf,IAAsBF,SAAtB;AACA,mBAASF,QAAT;AACD;AACF,OAd0B,CAe3B;;;AACA,UAAIM,OAAO,GAAG1J,YAAY,CAAC0B,EAAD,EAAK2D,SAAL,CAA1B;AACAT,MAAAA,aAAa,CAACuE,CAAD,CAAb,GAAmBD,OAAnB;AACApE,MAAAA,WAAW,CAAC6E,IAAZ,CAAiBD,OAAjB;AACA7E,MAAAA,eAAe,CAAC8E,IAAhB,CAAqBL,SAArB;AACAD,MAAAA,GAAG,CAACI,WAAJ,CAAgB,CAAhB;AACAP,MAAAA,OAAO,IAAI,CAAX;AACD;;AACD,WAAMA,OAAO,GAAG,CAAV,IAAerE,eAAe,CAACqE,OAAO,GAAC,CAAT,CAAf,KAA+B,CAApD,EAAuD;AACrDrE,MAAAA,eAAe,CAAC+E,GAAhB;AACA9E,MAAAA,WAAW,CAAC8E,GAAZ,GAAkBC,OAAlB;AACD;AACF;;AAEDvE,EAAAA,KAAK,CAACwE,MAAN,GAAe,UAASrI,OAAT,EAAkB;AAE/B,QAAG6D,KAAK,CAACwB,QAAT,EAAmB;AACjB;AACD;;AACDrF,IAAAA,OAAO,GAAGA,OAAO,IAAI,EAArB;AACAsD,IAAAA,KAAK,GAAG,IAAR;AACAC,IAAAA,SAAS,GAAG,IAAZ;AACD,GARD;;AAUAM,EAAAA,KAAK,CAACyE,GAAN,GAAY,UAASV,GAAT,EAAc;AACxB,QAAG/D,KAAK,CAACwB,QAAT,EAAmB;AACjB;AACD;;AACDuC,IAAAA,GAAG,CAAC/E,IAAJ,GAAWA,IAAX;AACAK,IAAAA,OAAO,CAACgF,IAAR,CAAaN,GAAb;AACAzE,IAAAA,aAAa,CAAC+E,IAAd,CAAmB,CAAC,CAApB;AACA5E,IAAAA,KAAK,GAAG,IAAR;AACAC,IAAAA,SAAS,GAAG,IAAZ;AACA+D,IAAAA,cAAc;AACf,GAVD;;AAYAzD,EAAAA,KAAK,CAAC0E,MAAN,GAAe,UAASX,GAAT,EAAc;AAC3B,QAAG/D,KAAK,CAACwB,QAAT,EAAmB;AACjB;AACD;;AACD,QAAImD,GAAG,GAAGtF,OAAO,CAACuF,OAAR,CAAgBb,GAAhB,CAAV;;AACA,QAAGY,GAAG,GAAG,CAAT,EAAY;AACV;AACD;;AACDtF,IAAAA,OAAO,CAACwF,MAAR,CAAeF,GAAf,EAAoB,CAApB;AACArF,IAAAA,aAAa,CAACgF,GAAd;AACA7E,IAAAA,KAAK,GAAG,IAAR;AACAC,IAAAA,SAAS,GAAG,IAAZ;AACA+D,IAAAA,cAAc;AACf,GAbD;;AAeAzD,EAAAA,KAAK,CAACuE,OAAN,GAAgB,YAAW;AACzB,QAAGvE,KAAK,CAACwB,QAAT,EAAmB;AACjB;AACD;;AAEDxB,IAAAA,KAAK,CAACwB,QAAN,GAAiB,IAAjB;AAEAuB,IAAAA,MAAM,CAAC+B,mBAAP,CAA2B,QAA3B,EAAqCtC,cAArC;AACAtG,IAAAA,MAAM,CAAC4I,mBAAP,CAA2B,kBAA3B,EAA+CC,gBAA/C;AACA/E,IAAAA,KAAK,CAACuB,aAAN,CAAoByD,OAApB,GAA8B,KAA9B;;AAEA,QAAGhF,KAAK,CAACC,WAAT,EAAsB;AACpB;AACD,KAbwB,CAezB;;;AACAjB,IAAAA,IAAI,CAACuF,OAAL;AACAnF,IAAAA,MAAM,CAACmF,OAAP;;AACA,SAAI,IAAIV,CAAC,GAAC,CAAV,EAAaA,CAAC,GAACxE,OAAO,CAACsE,MAAvB,EAA+B,EAAEE,CAAjC,EAAoC;AAClCxE,MAAAA,OAAO,CAACwE,CAAD,CAAP,CAAWU,OAAX;AACD,KApBwB,CAsBzB;;;AACAzG,IAAAA,WAAW,CAACyG,OAAZ;;AACA,SAAI,IAAIV,CAAC,GAAC,CAAV,EAAaA,CAAC,GAACrE,WAAW,CAACmE,MAA3B,EAAmC,EAAEE,CAArC,EAAwC;AACtCrE,MAAAA,WAAW,CAACqE,CAAD,CAAX,CAAeU,OAAf;AACD,KA1BwB,CA4BzB;;;AACArG,IAAAA,WAAW,CAACqG,OAAZ,GA7ByB,CA+BzB;;AACAnI,IAAAA,EAAE,GAAG,IAAL;AACA4C,IAAAA,IAAI,GAAG,IAAP;AACAI,IAAAA,MAAM,GAAG,IAAT;AACAC,IAAAA,OAAO,GAAG,EAAV;AACD,GApCD,CAzR4B,CA+T5B;;;AACAW,EAAAA,KAAK,CAACiF,cAAN,GAAuB,KAAvB;AACAjF,EAAAA,KAAK,CAACkF,YAAN,GAAqB,CAArB;;AAEAlF,EAAAA,KAAK,CAACmF,oBAAN,GAA6B,YAAW;AAEtCnF,IAAAA,KAAK,CAACuB,aAAN,GAAsB1G,WAAW,CAACqB,MAAD,EAAS,UAASkJ,OAAT,EAAkB7I,CAAlB,EAAqBC,CAArB,EAAwB;AAChE,UAAGwD,KAAK,CAACwB,QAAT,EAAmB;AACjB;AACD;;AAED,UAAIoC,OAAO,GAAGpE,WAAW,CAACmE,MAA1B;AACA,UAAID,OAAO,GAAGrE,OAAO,CAACsE,MAAtB;AACA,UAAI0B,OAAO,GAAGxH,SAAS,CAAC9B,MAAxB;AAEA8B,MAAAA,SAAS,CAACnC,QAAV,GAAqBC,QAArB;AACAkC,MAAAA,SAAS,CAACrC,KAAV,CAAgB,CAAhB,IAAqBe,CAArB;AACAsB,MAAAA,SAAS,CAACrC,KAAV,CAAgB,CAAhB,IAAqBgB,CAArB;AACAqB,MAAAA,SAAS,CAAC9B,MAAV,GAAmB,IAAnB;AACA8B,MAAAA,SAAS,CAACpC,MAAV,GAAmB,IAAnB;AACAoC,MAAAA,SAAS,CAAChC,cAAV,GAA2BgC,SAAS,CAAC/B,YAAV,GAAyB,IAApD;AAEA,UAAIwJ,MAAM,GAAG,KAAb;;AAEA,UAAGF,OAAO,IAAIpF,KAAK,CAACkF,YAApB,EAAkC;AAChClF,QAAAA,KAAK,CAACiF,cAAN,GAAuB,IAAvB;AACD,OAFD,MAEO;AACL,YAAGjF,KAAK,CAACiF,cAAT,EAAyB;AACvBvF,UAAAA,SAAS,GAAG,IAAZ;AACD;;AACDM,QAAAA,KAAK,CAACiF,cAAN,GAAuB,KAAvB;;AAEA,aAAI,IAAIpB,CAAC,GAAC,CAAV,EAAaA,CAAC,GAACD,OAAf,EAAwB,EAAEC,CAA1B,EAA6B;AAC3B,cAAI0B,MAAM,GAAG/F,WAAW,CAACqE,CAAD,CAAX,CAAe2B,KAAf,CAAqBjJ,CAArB,EAAwBgG,SAAS,CAAC,CAAD,CAAT,GAAe/F,CAAf,GAAmB,CAA3C,EAA8CwD,KAAK,CAACO,UAApD,CAAb;;AACA,cAAGgF,MAAH,EAAW;AACT,gBAAGA,MAAM,CAAC7J,QAAP,GAAkBmC,SAAS,CAACnC,QAA/B,EAAyC;AACvC;AACD;;AACD,iBAAI,IAAIwI,CAAC,GAAC,CAAV,EAAaA,CAAC,GAACR,OAAf,EAAwB,EAAEQ,CAA1B,EAA6B;AAC3B,kBAAIH,GAAG,GAAG1E,OAAO,CAAC6E,CAAD,CAAjB;;AACA,kBAAG5E,aAAa,CAAC4E,CAAD,CAAb,KAAqBL,CAAxB,EAA2B;AACzB;AACD;;AACD,kBAAI4B,OAAO,GAAG1B,GAAG,CAAC2B,IAAJ,CAASH,MAAT,CAAd;;AACA,kBAAGE,OAAH,EAAY;AACV5H,gBAAAA,SAAS,CAACuH,OAAV,GAA2BA,OAA3B;AACAvH,gBAAAA,SAAS,CAACpC,MAAV,GAA2B8J,MAAM,CAACI,KAAlC;AACA9H,gBAAAA,SAAS,CAACnC,QAAV,GAA2B6J,MAAM,CAAC7J,QAAlC;AACAmC,gBAAAA,SAAS,CAAC9B,MAAV,GAA2BgI,GAA3B;AACAlG,gBAAAA,SAAS,CAACjC,KAAV,GAA2B6J,OAAO,CAAC/J,QAAnC;AACAmC,gBAAAA,SAAS,CAAC/B,YAAV,GAA2B2J,OAAO,CAACpC,QAAnC;AACAxF,gBAAAA,SAAS,CAAChC,cAAV,GAA2B4J,OAAO,CAAC5J,cAAnC;AACAgC,gBAAAA,SAAS,CAAC7B,IAAV,GAA2ByJ,OAA3B;AACAH,gBAAAA,MAAM,GAAG,IAAT;AACD;AACF;AACF;AACF;AACF;;AAED,UAAGD,OAAO,IAAIA,OAAO,KAAKxH,SAAS,CAAC9B,MAApC,EAA4C;AAC1C,YAAGsJ,OAAO,CAACO,SAAX,EAAsB;AACpBP,UAAAA,OAAO,CAACO,SAAR,CAAkB,IAAlB;AACD;;AACDnG,QAAAA,KAAK,GAAG,IAAR;AACD;;AACD,UAAG5B,SAAS,CAAC9B,MAAb,EAAqB;AACnB,YAAG8B,SAAS,CAAC9B,MAAV,CAAiB6J,SAApB,EAA+B;AAC7B/H,UAAAA,SAAS,CAAC9B,MAAV,CAAiB6J,SAAjB,CAA2B/H,SAAS,CAAC7B,IAArC;AACD;;AACDyD,QAAAA,KAAK,GAAG,IAAR;AACD;;AAED6F,MAAAA,MAAM,GAAGA,MAAM,IAAKzH,SAAS,CAAC9B,MAAV,KAAqBsJ,OAAzC;;AACA,UAAGC,MAAM,IAAItF,KAAK,CAACmB,QAAnB,EAA6B;AAC3BnB,QAAAA,KAAK,CAACmB,QAAN,CAAetD,SAAf;AACD;;AAED,UAAIuH,OAAO,GAAG,CAAX,IAAiB,EAAEpF,KAAK,CAACkF,YAAN,GAAqB,CAAvB,CAAjB,IAA8ClF,KAAK,CAACqB,OAAvD,EAAgE;AAC9DrB,QAAAA,KAAK,CAACqB,OAAN,CAAcxD,SAAd;AACD;;AACDmC,MAAAA,KAAK,CAACkF,YAAN,GAAqBE,OAArB;AACD,KA5EgC,CAAjC;AA6ED,GA/ED;;AAiFA,WAASL,gBAAT,GAA4B;AAC1B,QAAG/E,KAAK,CAACC,WAAT,EAAsB;AACpB,aAAO,IAAP;AACD;;AACD,QAAG7D,EAAE,CAACyJ,aAAH,EAAH,EAAuB;AACrB7F,MAAAA,KAAK,CAACC,WAAN,GAAoB,IAApB;AACAD,MAAAA,KAAK,CAACuB,aAAN,CAAoByD,OAApB,GAA8B,KAA9B;AACAhF,MAAAA,KAAK,CAACnC,SAAN,CAAgB9B,MAAhB,GAAyB,IAAzB;;AACA,UAAGiE,KAAK,CAACsB,aAAT,EAAwB;AACtBtB,QAAAA,KAAK,CAACsB,aAAN;AACD;AACF;AACF;;AAEDpF,EAAAA,MAAM,CAACsH,gBAAP,CAAwB,kBAAxB,EAA4CuB,gBAA5C,EAla4B,CAoa5B;;AACA,WAASe,UAAT,GAAsB;AACpB,QAAGf,gBAAgB,EAAnB,EAAuB;AACrB;AACD;;AAED3I,IAAAA,EAAE,CAAC2J,SAAH,CAAa,IAAb,EAAmB,IAAnB,EAAyB,IAAzB,EAA+B,IAA/B;AACA3J,IAAAA,EAAE,CAAC4J,SAAH,CAAa,IAAb;AACA5J,IAAAA,EAAE,CAAC8C,OAAH,CAAW9C,EAAE,CAAC6J,KAAd;AACA7J,IAAAA,EAAE,CAAC6C,MAAH,CAAU7C,EAAE,CAAC8J,UAAb;AACA9J,IAAAA,EAAE,CAAC+J,SAAH,CAAa/J,EAAE,CAACgK,MAAhB;AAEA,QAAI1C,OAAO,GAAGrE,OAAO,CAACsE,MAAtB;AACA,QAAIC,OAAO,GAAGpE,WAAW,CAACmE,MAA1B;;AACA,SAAI,IAAIO,CAAC,GAAC,CAAV,EAAaA,CAAC,GAACN,OAAf,EAAwB,EAAEM,CAA1B,EAA6B;AAC3B,UAAImC,GAAG,GAAG7G,WAAW,CAAC0E,CAAD,CAArB;AACAmC,MAAAA,GAAG,CAACjG,KAAJ,GAAYmC,SAAZ;AACA8D,MAAAA,GAAG,CAACC,KAAJ;;AACA,WAAI,IAAIzC,CAAC,GAAC,CAAV,EAAaA,CAAC,GAACH,OAAf,EAAwB,EAAEG,CAA1B,EAA6B;AAC3B,YAAGvE,aAAa,CAACuE,CAAD,CAAb,KAAqBK,CAAxB,EAA2B;AACzB;AACD;;AACD,YAAIH,GAAG,GAAG1E,OAAO,CAACwE,CAAD,CAAjB;;AACA,YAAGE,GAAG,CAACwC,QAAP,EAAiB;AACfxC,UAAAA,GAAG,CAAC7D,UAAJ,GAAiB,CAAjB;AACA6D,UAAAA,GAAG,CAACwC,QAAJ,CAAa1G,YAAb;AACD;AACF;;AACDwG,MAAAA,GAAG,CAACG,GAAJ;AACD;AACF;;AAED,MAAIC,OAAO,GAAG,CACZ,CAAE9K,QAAF,EAAYA,QAAZ,EAAsBA,QAAtB,CADY,EAEZ,CAAC,CAACA,QAAF,EAAW,CAACA,QAAZ,EAAqB,CAACA,QAAtB,CAFY,CAAd;AAIA,MAAI+K,UAAU,GAAG,CAACD,OAAO,CAAC,CAAD,CAAP,CAAWE,KAAX,EAAD,EAAqBF,OAAO,CAAC,CAAD,CAAP,CAAWE,KAAX,EAArB,CAAjB;;AAEA,WAASC,MAAT,GAAkB;AAChB,QAAG7B,gBAAgB,EAAnB,EAAuB;AACrB;AACD;;AAEDvC,IAAAA,cAAc,GALE,CAOhB;;AACA,QAAIqE,WAAW,GAAG7G,KAAK,CAAC/C,MAAN,CAAa6J,IAAb,EAAlB;AACAjH,IAAAA,YAAY,CAACC,IAAb,GAAoBE,KAAK,CAAC/C,MAAN,CAAa8J,MAAjC;AACAtH,IAAAA,KAAK,GAAOA,KAAK,IAAIoH,WAArB;AACAnH,IAAAA,SAAS,GAAGA,SAAS,IAAImH,WAAzB,CAXgB,CAad;;AACF7H,IAAAA,IAAI,CAACkB,UAAL,GAAoBF,KAAK,CAACE,UAA1B;AACAd,IAAAA,MAAM,CAACc,UAAP,GAAoBF,KAAK,CAACE,UAA1B,CAfgB,CAiBhB;;AACA,QAAIwD,OAAO,GAAGrE,OAAO,CAACsE,MAAtB;AACA,QAAIqD,EAAE,GAAGP,OAAO,CAAC,CAAD,CAAhB;AACA,QAAIQ,EAAE,GAAGR,OAAO,CAAC,CAAD,CAAhB;AACAO,IAAAA,EAAE,CAAC,CAAD,CAAF,GAAQA,EAAE,CAAC,CAAD,CAAF,GAAQA,EAAE,CAAC,CAAD,CAAF,GAASrL,QAAzB;AACAsL,IAAAA,EAAE,CAAC,CAAD,CAAF,GAAQA,EAAE,CAAC,CAAD,CAAF,GAAQA,EAAE,CAAC,CAAD,CAAF,GAAQ,CAACtL,QAAzB;;AACA,SAAI,IAAIkI,CAAC,GAAC,CAAV,EAAaA,CAAC,GAACH,OAAf,EAAwB,EAAEG,CAA1B,EAA6B;AAC3B,UAAIE,GAAG,GAAG1E,OAAO,CAACwE,CAAD,CAAjB,CAD2B,CAG3B;;AACAE,MAAAA,GAAG,CAAC7D,UAAJ,GAAiBF,KAAK,CAACE,UAAvB;AACA6D,MAAAA,GAAG,CAAC/E,IAAJ,GAAWgB,KAAK,CAAChB,IAAjB;AAEAS,MAAAA,KAAK,GAAGA,KAAK,IAAI,CAAC,CAACsE,GAAG,CAACtE,KAAvB;AACAC,MAAAA,SAAS,GAAGA,SAAS,IAAI,CAAC,CAACqE,GAAG,CAACtE,KAA/B;AACA,UAAIyH,GAAG,GAAGnD,GAAG,CAACnG,MAAd;;AACA,UAAGsJ,GAAH,EAAQ;AACN,YAAIC,GAAG,GAAGD,GAAG,CAAC,CAAD,CAAb;AACA,YAAIE,GAAG,GAAGF,GAAG,CAAC,CAAD,CAAb;;AACA,aAAI,IAAIhD,CAAC,GAAC,CAAV,EAAaA,CAAC,GAAC,CAAf,EAAkB,EAAEA,CAApB,EAAuB;AACrB8C,UAAAA,EAAE,CAAC9C,CAAD,CAAF,GAAQzH,IAAI,CAACuF,GAAL,CAASgF,EAAE,CAAC9C,CAAD,CAAX,EAAgBiD,GAAG,CAACjD,CAAD,CAAnB,CAAR;AACA+C,UAAAA,EAAE,CAAC/C,CAAD,CAAF,GAAQzH,IAAI,CAACwF,GAAL,CAASgF,EAAE,CAAC/C,CAAD,CAAX,EAAgBkD,GAAG,CAAClD,CAAD,CAAnB,CAAR;AACD;AACF;AACF,KAzCe,CA2ChB;;;AACA,QAAItG,MAAM,GAAGoC,KAAK,CAACpC,MAAnB;;AACA,QAAGoC,KAAK,CAACc,UAAT,EAAqB;AACnB,WAAI,IAAIoD,CAAC,GAAC,CAAV,EAAaA,CAAC,GAAC,CAAf,EAAkB,EAAEA,CAApB,EAAuB;AACrB,YAAG+C,EAAE,CAAC/C,CAAD,CAAF,GAAQ8C,EAAE,CAAC9C,CAAD,CAAb,EAAkB;AAChB8C,UAAAA,EAAE,CAAC9C,CAAD,CAAF,GAAQ,CAAC,CAAT;AACA+C,UAAAA,EAAE,CAAC/C,CAAD,CAAF,GAAQ,CAAR;AACD,SAHD,MAGO;AACL,cAAG8C,EAAE,CAAC9C,CAAD,CAAF,KAAU+C,EAAE,CAAC/C,CAAD,CAAf,EAAoB;AAClB8C,YAAAA,EAAE,CAAC9C,CAAD,CAAF,IAAS,CAAT;AACA+C,YAAAA,EAAE,CAAC/C,CAAD,CAAF,IAAS,CAAT;AACD;;AACD,cAAImD,OAAO,GAAG,QAAQJ,EAAE,CAAC/C,CAAD,CAAF,GAAQ8C,EAAE,CAAC9C,CAAD,CAAlB,CAAd;AACA8C,UAAAA,EAAE,CAAC9C,CAAD,CAAF,GAAQ8C,EAAE,CAAC9C,CAAD,CAAF,GAAQmD,OAAhB;AACAJ,UAAAA,EAAE,CAAC/C,CAAD,CAAF,GAAQ+C,EAAE,CAAC/C,CAAD,CAAF,GAAQmD,OAAhB;AACD;;AACDzJ,QAAAA,MAAM,CAAC,CAAD,CAAN,CAAUsG,CAAV,IAAe8C,EAAE,CAAC9C,CAAD,CAAjB;AACAtG,QAAAA,MAAM,CAAC,CAAD,CAAN,CAAUsG,CAAV,IAAe+C,EAAE,CAAC/C,CAAD,CAAjB;AACD;AACF;;AAED,QAAIoD,aAAa,GAAG,KAApB;;AACA,SAAI,IAAIpD,CAAC,GAAC,CAAV,EAAaA,CAAC,GAAC,CAAf,EAAkB,EAAEA,CAApB,EAAuB;AACnBoD,MAAAA,aAAa,GAAGA,aAAa,IACxBZ,UAAU,CAAC,CAAD,CAAV,CAAcxC,CAAd,MAAqBtG,MAAM,CAAC,CAAD,CAAN,CAAUsG,CAAV,CADV,IAEXwC,UAAU,CAAC,CAAD,CAAV,CAAcxC,CAAd,MAAqBtG,MAAM,CAAC,CAAD,CAAN,CAAUsG,CAAV,CAF1B;AAGAwC,MAAAA,UAAU,CAAC,CAAD,CAAV,CAAcxC,CAAd,IAAmBtG,MAAM,CAAC,CAAD,CAAN,CAAUsG,CAAV,CAAnB;AACAwC,MAAAA,UAAU,CAAC,CAAD,CAAV,CAAcxC,CAAd,IAAmBtG,MAAM,CAAC,CAAD,CAAN,CAAUsG,CAAV,CAAnB;AACH,KAvEe,CAyEhB;;;AACAxE,IAAAA,SAAS,GAAGA,SAAS,IAAI4H,aAAzB;AACA7H,IAAAA,KAAK,GAAGA,KAAK,IAAI6H,aAAjB;;AAEA,QAAG,CAAC7H,KAAJ,EAAW;AACT;AACD;;AAED,QAAG6H,aAAH,EAAkB;AAChB,UAAIC,WAAW,GAAG,CAAC,CAAD,EAAG,CAAH,EAAK,CAAL,CAAlB;;AACA,WAAI,IAAI1D,CAAC,GAAC,CAAV,EAAaA,CAAC,GAAC,CAAf,EAAkB,EAAEA,CAApB,EAAuB;AACrB0D,QAAAA,WAAW,CAAC1D,CAAD,CAAX,GAAiBvH,YAAY,CAAC,CAACsB,MAAM,CAAC,CAAD,CAAN,CAAUiG,CAAV,IAAajG,MAAM,CAAC,CAAD,CAAN,CAAUiG,CAAV,CAAd,IAA8B,IAA/B,CAA7B;AACD;;AACD,UAAG7E,IAAI,CAACwI,SAAR,EAAmB;AACjBxI,QAAAA,IAAI,CAACwF,MAAL,CAAY;AACV5G,UAAAA,MAAM,EAAEA,MADE;AAEV2J,UAAAA,WAAW,EAAEA;AAFH,SAAZ;AAID,OALD,MAKO;AACLvI,QAAAA,IAAI,CAACwF,MAAL,CAAY;AACV5G,UAAAA,MAAM,EAAEA;AADE,SAAZ;AAGD;AACF,KAhGe,CAkGhB;;;AACA,QAAI+E,KAAK,GAAIvG,EAAE,CAAC2B,kBAAhB;AACA,QAAI6E,MAAM,GAAGxG,EAAE,CAAC4B,mBAAhB;AACA+B,IAAAA,SAAS,CAAC,CAAD,CAAT,GAAe4C,KAAf;AACA5C,IAAAA,SAAS,CAAC,CAAD,CAAT,GAAe6C,MAAf;AACAL,IAAAA,SAAS,CAAC,CAAD,CAAT,GAAe9F,IAAI,CAACwF,GAAL,CAASU,KAAK,GAAC3C,KAAK,CAACE,UAArB,EAAiC,CAAjC,IAAoC,CAAnD;AACAqC,IAAAA,SAAS,CAAC,CAAD,CAAT,GAAe9F,IAAI,CAACwF,GAAL,CAASW,MAAM,GAAC5C,KAAK,CAACE,UAAtB,EAAkC,CAAlC,IAAqC,CAApD,CAxGgB,CA0GhB;;AACAuH,IAAAA,gBAAgB,CAACzH,KAAD,EAAQ7B,OAAR,CAAhB,CA3GgB,CA6GhB;;AACA,SAAI,IAAI0F,CAAC,GAAC,CAAV,EAAaA,CAAC,GAACH,OAAf,EAAwB,EAAEG,CAA1B,EAA6B;AAC3B,UAAIE,GAAG,GAAG1E,OAAO,CAACwE,CAAD,CAAjB,CAD2B,CAG3B;;AACAE,MAAAA,GAAG,CAAC2D,UAAJ,GAAiB9J,MAAjB,CAJ2B,CAM3B;;AACA,UAAGoC,KAAK,CAACiB,YAAT,EAAuB;AACrB8C,QAAAA,GAAG,CAAC4D,UAAJ,GAAiB/J,MAAjB;AACD;AACF,KAxHe,CAyHhB;;;AACA,QAAGC,SAAS,CAAC9B,MAAb,EAAqB;AACnB,UAAGiE,KAAK,CAACkB,UAAT,EAAqB;AACnB9B,QAAAA,MAAM,CAACiE,QAAP,GAAkBxF,SAAS,CAAChC,cAA5B;AACD,OAFD,MAEO;AACLuD,QAAAA,MAAM,CAACiE,QAAP,GAAkBxF,SAAS,CAAC/B,YAA5B;AACD;;AACDsD,MAAAA,MAAM,CAACxB,MAAP,GAAgBA,MAAhB;AACD,KAjIe,CAmIhB;;;AACA,QAAG8B,SAAH,EAAc;AACZA,MAAAA,SAAS,GAAG,KAAZ;AACAoG,MAAAA,UAAU;AACX,KAvIe,CAyIhB;;;AACA9F,IAAAA,KAAK,CAACG,UAAN,GAAmB3F,UAAU,CAACwF,KAAK,CAAChB,IAAP,EAAaa,YAAb,EAA2B8C,KAA3B,EAAkCC,MAAlC,CAA7B,CA1IgB,CA4IhB;;AACA,QAAG5C,KAAK,CAACoB,QAAT,EAAmB;AACjBpB,MAAAA,KAAK,CAACoB,QAAN;AACD,KA/Ie,CAiJhB;;;AACAhF,IAAAA,EAAE,CAACwL,eAAH,CAAmBxL,EAAE,CAACyL,WAAtB,EAAmC,IAAnC;AACAzL,IAAAA,EAAE,CAAC0L,QAAH,CAAY,CAAZ,EAAe,CAAf,EAAkBnF,KAAlB,EAAyBC,MAAzB,EAnJgB,CAqJhB;AACA;AACA;AACA;AAEA;;AACA5C,IAAAA,KAAK,CAACmC,SAAN;AAEA/F,IAAAA,EAAE,CAAC4J,SAAH,CAAa,IAAb;AACA5J,IAAAA,EAAE,CAAC2J,SAAH,CAAa,IAAb,EAAmB,IAAnB,EAAyB,IAAzB,EAA+B,IAA/B;AACA3J,IAAAA,EAAE,CAAC6C,MAAH,CAAU7C,EAAE,CAAC8J,UAAb;AACA9J,IAAAA,EAAE,CAAC+J,SAAH,CAAa/J,EAAE,CAACgK,MAAhB;AACAhK,IAAAA,EAAE,CAAC8C,OAAH,CAAW9C,EAAE,CAAC6J,KAAd;AACA7J,IAAAA,EAAE,CAAC8C,OAAH,CAAW9C,EAAE,CAAC2L,SAAd,EAlKgB,CAkKU;AAE1B;;AACA,QAAIC,cAAc,GAAG,KAArB;;AACA,QAAGhJ,IAAI,CAACC,MAAR,EAAgB;AACd+I,MAAAA,cAAc,GAAGA,cAAc,IAAIhJ,IAAI,CAACiJ,aAAL,EAAnC;AACAjJ,MAAAA,IAAI,CAACkJ,IAAL,CAAUrI,YAAV;AACD;;AACDT,IAAAA,MAAM,CAACJ,IAAP,GAAcA,IAAd;;AACA,QAAGnB,SAAS,CAAC9B,MAAb,EAAqB;AACnBqD,MAAAA,MAAM,CAAC8I,IAAP,CAAYrI,YAAZ;AACD;;AAEDzD,IAAAA,EAAE,CAAC8C,OAAH,CAAW9C,EAAE,CAAC2L,SAAd,EA/KgB,CA+KU;;AAE1B,SAAI,IAAIlE,CAAC,GAAC,CAAV,EAAaA,CAAC,GAACH,OAAf,EAAwB,EAAEG,CAA1B,EAA6B;AAC3B,UAAIE,GAAG,GAAG1E,OAAO,CAACwE,CAAD,CAAjB;AACAE,MAAAA,GAAG,CAAC/E,IAAJ,GAAWA,IAAX;AACA+E,MAAAA,GAAG,CAAC7D,UAAJ,GAAiBF,KAAK,CAACE,UAAvB;;AACA,UAAG6D,GAAG,CAACoE,QAAJ,IAAgBpE,GAAG,CAACoE,QAAJ,EAAnB,EAAmC;AACjCpE,QAAAA,GAAG,CAACmE,IAAJ,CAASrI,YAAT;AACD;;AACD,UAAGkE,GAAG,CAACkE,aAAJ,IAAqBlE,GAAG,CAACkE,aAAJ,EAAxB,EAA6C;AAC3CD,QAAAA,cAAc,GAAG,IAAjB;AACD;AACF;;AAED,QAAGA,cAAH,EAAmB;AACjB;AACAlK,MAAAA,WAAW,CAACsC,KAAZ,GAAoBL,SAApB;AACAjC,MAAAA,WAAW,CAACsK,IAAZ;AACAhM,MAAAA,EAAE,CAACgG,KAAH,CAAShG,EAAE,CAACkG,gBAAZ;AACAlG,MAAAA,EAAE,CAAC2J,SAAH,CAAa,KAAb,EAAoB,KAApB,EAA2B,KAA3B,EAAkC,KAAlC;AACA3J,MAAAA,EAAE,CAAC4J,SAAH,CAAa,IAAb;AACA5J,MAAAA,EAAE,CAAC+J,SAAH,CAAa/J,EAAE,CAACiM,IAAhB,EAPiB,CASjB;;AACA,UAAGrJ,IAAI,CAACC,MAAL,IAAeD,IAAI,CAACiJ,aAAL,EAAlB,EAAwC;AACtCjJ,QAAAA,IAAI,CAACsJ,eAAL,CAAqBzI,YAArB;AACD;;AACD,WAAI,IAAIgE,CAAC,GAAC,CAAV,EAAaA,CAAC,GAACH,OAAf,EAAwB,EAAEG,CAA1B,EAA6B;AAC3B,YAAIE,GAAG,GAAG1E,OAAO,CAACwE,CAAD,CAAjB;;AACA,YAAGE,GAAG,CAACoE,QAAJ,IAAgBpE,GAAG,CAACoE,QAAJ,EAAnB,EAAmC;AACjCpE,UAAAA,GAAG,CAACmE,IAAJ,CAASrI,YAAT;AACD;AACF,OAlBgB,CAoBjB;;;AACAzD,MAAAA,EAAE,CAAC6C,MAAH,CAAU7C,EAAE,CAAC6J,KAAb;AACA7J,MAAAA,EAAE,CAACmM,aAAH,CAAiBnM,EAAE,CAACoM,QAApB;AACApM,MAAAA,EAAE,CAACqM,SAAH,CAAarM,EAAE,CAACsM,GAAhB,EAAqBtM,EAAE,CAACuM,mBAAxB;AACAvM,MAAAA,EAAE,CAAC2J,SAAH,CAAa,IAAb,EAAmB,IAAnB,EAAyB,IAAzB,EAA+B,IAA/B;AACA3J,MAAAA,EAAE,CAAC4J,SAAH,CAAa,KAAb;AACA5J,MAAAA,EAAE,CAACwE,UAAH,CAAc,CAAd,EAAgB,CAAhB,EAAkB,CAAlB,EAAoB,CAApB;AACAxE,MAAAA,EAAE,CAACgG,KAAH,CAAShG,EAAE,CAACiG,gBAAZ;;AAEA,UAAGrD,IAAI,CAACiJ,aAAL,EAAH,EAAyB;AACvBjJ,QAAAA,IAAI,CAACsJ,eAAL,CAAqBzI,YAArB;AACD;;AAED,WAAI,IAAIgE,CAAC,GAAC,CAAV,EAAaA,CAAC,GAACH,OAAf,EAAwB,EAAEG,CAA1B,EAA6B;AAC3B,YAAIE,GAAG,GAAG1E,OAAO,CAACwE,CAAD,CAAjB;;AACA,YAAGE,GAAG,CAACkE,aAAJ,IAAqBlE,GAAG,CAACkE,aAAJ,EAAxB,EAA6C;AAC3ClE,UAAAA,GAAG,CAACuE,eAAJ,CAAoBzI,YAApB;AACD;AACF,OAtCgB,CAwCjB;;;AACAzD,MAAAA,EAAE,CAACwL,eAAH,CAAmBxL,EAAE,CAACyL,WAAtB,EAAmC,IAAnC,EAzCiB,CA2CjB;;AACAzL,MAAAA,EAAE,CAACqM,SAAH,CAAarM,EAAE,CAACsM,GAAhB,EAAqBtM,EAAE,CAACuM,mBAAxB;AACAvM,MAAAA,EAAE,CAAC8C,OAAH,CAAW9C,EAAE,CAAC8J,UAAd;AACAhI,MAAAA,WAAW,CAACkK,IAAZ;AACAtK,MAAAA,WAAW,CAAC8K,KAAZ,CAAkB,CAAlB,EAAqBR,IAArB,CAA0B,CAA1B;AACAlK,MAAAA,WAAW,CAAC2K,QAAZ,CAAqB/K,WAArB,GAAmC,CAAnC;AACAlD,MAAAA,YAAY,CAACwB,EAAD,CAAZ,CAjDiB,CAmDjB;;AACAA,MAAAA,EAAE,CAAC8C,OAAH,CAAW9C,EAAE,CAAC6J,KAAd;AACD,KAlPe,CAoPhB;;;AACAxG,IAAAA,KAAK,GAAG,KAAR;;AACA,SAAI,IAAIoE,CAAC,GAAC,CAAV,EAAaA,CAAC,GAACH,OAAf,EAAwB,EAAEG,CAA1B,EAA6B;AAC3BxE,MAAAA,OAAO,CAACwE,CAAD,CAAP,CAAWpE,KAAX,GAAmB,KAAnB;AACD;AACF,GAnsB2B,CAqsB5B;;;AACA,WAASqJ,MAAT,GAAkB;AAChB,QAAG9I,KAAK,CAACwB,QAAN,IAAkBxB,KAAK,CAACC,WAA3B,EAAwC;AACtC;AACD,KAHe,CAIhB;;;AACA2G,IAAAA,MAAM;AACNmC,IAAAA,qBAAqB,CAACD,MAAD,CAArB;AACD;;AAED9I,EAAAA,KAAK,CAACmF,oBAAN;AACA2D,EAAAA,MAAM,GAhtBsB,CAktB5B;;AACA9I,EAAAA,KAAK,CAAC4G,MAAN,GAAe,YAAW;AACxB,QAAG5G,KAAK,CAACwB,QAAT,EAAmB;AACjB;AACD;;AACD/B,IAAAA,KAAK,GAAG,IAAR;AACAmH,IAAAA,MAAM;AACP,GAND;;AAQA,SAAO5G,KAAP;AACD;;AAED,SAASyH,gBAAT,CAA0BzH,KAA1B,EAAiC7B,OAAjC,EAA0C;AACxC,MAAIP,MAAM,GAAGoC,KAAK,CAACpC,MAAnB;AACA,MAAIiC,YAAY,GAAGG,KAAK,CAACH,YAAzB;AACA,MAAIvB,UAAU,GAAGuB,YAAY,CAACvB,UAA9B;AACA,MAAIsB,KAAK,GAAGC,YAAY,CAACD,KAAzB;AAEA,MAAI+C,KAAK,GAAG3C,KAAK,CAAC5D,EAAN,CAAS2B,kBAArB;AACA,MAAI6E,MAAM,GAAG5C,KAAK,CAAC5D,EAAN,CAAS4B,mBAAtB;AACA,MAAIwC,KAAK,GAAGR,KAAK,CAACQ,KAAlB;AACA,MAAIC,IAAI,GAAGT,KAAK,CAACS,IAAjB;AACA,MAAIC,IAAI,GAAGV,KAAK,CAACU,IAAjB;AAEA,MAAIsI,CAAC,GAAGrG,KAAK,GAAGC,MAAhB;;AAEA,MAAGzE,OAAH,EAAY;AACVpD,IAAAA,KAAK,CAACuD,UAAD,EACH,CAAC0K,CADE,EAEHA,CAFG,EAGH,CAAC,CAHE,EAIH,CAJG,EAKHxI,KALG,EAMHC,IANG,CAAL;AAQAZ,IAAAA,YAAY,CAACxB,MAAb,GAAsB,IAAtB;AACD,GAVD,MAUO;AACLvD,IAAAA,WAAW,CAACwD,UAAD,EACToC,IADS,EAETsI,CAFS,EAGTxI,KAHS,EAITC,IAJS,CAAX;AAMAZ,IAAAA,YAAY,CAACxB,MAAb,GAAsB,KAAtB;AACD,GAhCuC,CAkCxC;;;AACA,OAAI,IAAIwF,CAAC,GAAC,CAAV,EAAaA,CAAC,GAAC,EAAf,EAAmB,EAAEA,CAArB,EAAwB;AACtBjE,IAAAA,KAAK,CAACiE,CAAD,CAAL,GAAW,CAAX;AACD;;AACDjE,EAAAA,KAAK,CAAC,EAAD,CAAL,GAAY,CAAZ;AAEA,MAAIqJ,IAAI,GAAG,CAAX;;AACA,OAAI,IAAIpF,CAAC,GAAC,CAAV,EAAaA,CAAC,GAAC,CAAf,EAAkB,EAAEA,CAApB,EAAuB;AACrBoF,IAAAA,IAAI,GAAGxM,IAAI,CAACwF,GAAL,CAASgH,IAAT,EAAerL,MAAM,CAAC,CAAD,CAAN,CAAUiG,CAAV,IAAejG,MAAM,CAAC,CAAD,CAAN,CAAUiG,CAAV,CAA9B,CAAP;AACD;;AAED,OAAI,IAAIA,CAAC,GAAC,CAAV,EAAaA,CAAC,GAAC,CAAf,EAAkB,EAAEA,CAApB,EAAuB;AACrB,QAAG7D,KAAK,CAACe,SAAT,EAAoB;AAClBnB,MAAAA,KAAK,CAAC,IAAEiE,CAAH,CAAL,GAAa7D,KAAK,CAACK,MAAN,CAAawD,CAAb,KAAmBjG,MAAM,CAAC,CAAD,CAAN,CAAUiG,CAAV,IAAejG,MAAM,CAAC,CAAD,CAAN,CAAUiG,CAAV,CAAlC,CAAb;AACD,KAFD,MAEO;AACLjE,MAAAA,KAAK,CAAC,IAAEiE,CAAH,CAAL,GAAa,IAAIoF,IAAjB;AACD;;AACD,QAAGjJ,KAAK,CAACgB,UAAT,EAAqB;AACnBpB,MAAAA,KAAK,CAAC,KAAGiE,CAAJ,CAAL,GAAc,CAACjE,KAAK,CAAC,IAAEiE,CAAH,CAAN,GAAc,GAAd,IAAqBjG,MAAM,CAAC,CAAD,CAAN,CAAUiG,CAAV,IAAejG,MAAM,CAAC,CAAD,CAAN,CAAUiG,CAAV,CAApC,CAAd;AACD;AACF;AACF","sourcesContent":["'use strict'\n\nvar createCamera = require('./camera.js')\nvar createAxes   = require('gl-axes3d')\nvar axesRanges   = require('gl-axes3d/properties')\nvar createSpikes = require('gl-spikes3d')\nvar createSelect = require('gl-select-static')\nvar createFBO    = require('gl-fbo')\nvar drawTriangle = require('a-big-triangle')\nvar mouseChange  = require('mouse-change')\nvar perspective  = require('gl-mat4/perspective')\nvar ortho        = require('gl-mat4/ortho')\nvar createShader = require('./lib/shader')\nvar isMobile = require('is-mobile')({ tablet: true, featureDetect: true })\n\nmodule.exports = {\n  createScene: createScene,\n  createCamera: createCamera\n}\n\nfunction MouseSelect() {\n  this.mouse          = [-1,-1]\n  this.screen         = null\n  this.distance       = Infinity\n  this.index          = null\n  this.dataCoordinate = null\n  this.dataPosition   = null\n  this.object         = null\n  this.data           = null\n}\n\nfunction getContext(canvas, options) {\n  var gl = null\n  try {\n    gl = canvas.getContext('webgl', options)\n    if(!gl) {\n      gl = canvas.getContext('experimental-webgl', options)\n    }\n  } catch(e) {\n    return null\n  }\n  return gl\n}\n\nfunction roundUpPow10(x) {\n  var y = Math.round(Math.log(Math.abs(x)) / Math.log(10))\n  if(y < 0) {\n    var base = Math.round(Math.pow(10, -y))\n    return Math.ceil(x*base) / base\n  } else if(y > 0) {\n    var base = Math.round(Math.pow(10, y))\n    return Math.ceil(x/base) * base\n  }\n  return Math.ceil(x)\n}\n\nfunction defaultBool(x) {\n  if(typeof x === 'boolean') {\n    return x\n  }\n  return true\n}\n\nfunction createScene(options) {\n  options = options || {}\n  options.camera = options.camera || {}\n\n  var canvas = options.canvas\n  if(!canvas) {\n    canvas = document.createElement('canvas')\n    if(options.container) {\n      var container = options.container\n      container.appendChild(canvas)\n    } else {\n      document.body.appendChild(canvas)\n    }\n  }\n\n  var gl = options.gl\n  if(!gl) {\n    if(options.glOptions) {\n      isMobile = !!options.glOptions.preserveDrawingBuffer\n    }\n\n    gl = getContext(canvas,\n      options.glOptions || {\n        premultipliedAlpha: true,\n        antialias: true,\n        preserveDrawingBuffer: isMobile\n      })\n  }\n  if(!gl) {\n    throw new Error('webgl not supported')\n  }\n\n  //Initial bounds\n  var bounds = options.bounds || [[-10,-10,-10], [10,10,10]]\n\n  //Create selection\n  var selection = new MouseSelect()\n\n  //Accumulation buffer\n  var accumBuffer = createFBO(gl,\n    gl.drawingBufferWidth, gl.drawingBufferHeight, {\n      preferFloat: !isMobile\n    })\n\n  var accumShader = createShader(gl)\n\n  var isOrtho =\n    (options.cameraObject && options.cameraObject._ortho === true) ||\n    (options.camera.projection && options.camera.projection.type === 'orthographic') ||\n    false\n\n  //Create a camera\n  var cameraOptions = {\n    eye:     options.camera.eye     || [2,0,0],\n    center:  options.camera.center  || [0,0,0],\n    up:      options.camera.up      || [0,1,0],\n    zoomMin: options.camera.zoomMax || 0.1,\n    zoomMax: options.camera.zoomMin || 100,\n    mode:    options.camera.mode    || 'turntable',\n    _ortho:  isOrtho\n  }\n\n  //Create axes\n  var axesOptions = options.axes || {}\n  var axes = createAxes(gl, axesOptions)\n  axes.enable = !axesOptions.disable\n\n  //Create spikes\n  var spikeOptions = options.spikes || {}\n  var spikes = createSpikes(gl, spikeOptions)\n\n  //Object list is empty initially\n  var objects         = []\n  var pickBufferIds   = []\n  var pickBufferCount = []\n  var pickBuffers     = []\n\n  //Dirty flag, skip redraw if scene static\n  var dirty       = true\n  var pickDirty   = true\n\n  var projection     = new Array(16)\n  var model          = new Array(16)\n\n  var cameraParams = {\n    view:         null,\n    projection:   projection,\n    model:        model,\n    _ortho:       false\n  }\n\n  var pickDirty = true\n\n  var viewShape = [ gl.drawingBufferWidth, gl.drawingBufferHeight ]\n\n  var camera = options.cameraObject || createCamera(canvas, cameraOptions)\n\n  //Create scene object\n  var scene = {\n    gl:           gl,\n    contextLost:  false,\n    pixelRatio:   options.pixelRatio || 1,\n    canvas:       canvas,\n    selection:    selection,\n    camera:       camera,\n    axes:         axes,\n    axesPixels:   null,\n    spikes:       spikes,\n    bounds:       bounds,\n    objects:      objects,\n    shape:        viewShape,\n    aspect:       options.aspectRatio || [1,1,1],\n    pickRadius:   options.pickRadius || 10,\n    zNear:        options.zNear || 0.01,\n    zFar:         options.zFar  || 1000,\n    fovy:         options.fovy  || Math.PI/4,\n    clearColor:   options.clearColor || [0,0,0,0],\n    autoResize:   defaultBool(options.autoResize),\n    autoBounds:   defaultBool(options.autoBounds),\n    autoScale:    !!options.autoScale,\n    autoCenter:   defaultBool(options.autoCenter),\n    clipToBounds: defaultBool(options.clipToBounds),\n    snapToData:   !!options.snapToData,\n    onselect:     options.onselect || null,\n    onrender:     options.onrender || null,\n    onclick:      options.onclick  || null,\n    cameraParams: cameraParams,\n    oncontextloss: null,\n    mouseListener: null,\n    _stopped: false,\n\n    getAspectratio: function() {\n      return {\n        x: this.aspect[0],\n        y: this.aspect[1],\n        z: this.aspect[2]\n      }\n    },\n\n    setAspectratio: function(aspectratio) {\n      this.aspect[0] = aspectratio.x\n      this.aspect[1] = aspectratio.y\n      this.aspect[2] = aspectratio.z\n      pickDirty = true\n    },\n\n    setBounds: function(axisIndex, range) {\n      this.bounds[0][axisIndex] = range.min\n      this.bounds[1][axisIndex] = range.max\n    },\n\n    setClearColor: function(clearColor) {\n      this.clearColor = clearColor\n    },\n\n    clearRGBA: function() {\n      this.gl.clearColor(\n        this.clearColor[0],\n        this.clearColor[1],\n        this.clearColor[2],\n        this.clearColor[3]\n      )\n\n      this.gl.clear(\n        this.gl.COLOR_BUFFER_BIT |\n        this.gl.DEPTH_BUFFER_BIT\n      )\n    }\n  }\n\n  var pickShape = [ (gl.drawingBufferWidth/scene.pixelRatio)|0, (gl.drawingBufferHeight/scene.pixelRatio)|0 ]\n\n  function resizeListener() {\n    if(scene._stopped) {\n      return\n    }\n    if(!scene.autoResize) {\n      return\n    }\n    var parent = canvas.parentNode\n    var width  = 1\n    var height = 1\n    if(parent && parent !== document.body) {\n      width  = parent.clientWidth\n      height = parent.clientHeight\n    } else {\n      width  = window.innerWidth\n      height = window.innerHeight\n    }\n    var nextWidth  = Math.ceil(width  * scene.pixelRatio)|0\n    var nextHeight = Math.ceil(height * scene.pixelRatio)|0\n    if(nextWidth !== canvas.width || nextHeight !== canvas.height) {\n      canvas.width   = nextWidth\n      canvas.height  = nextHeight\n      var style = canvas.style\n      style.position = style.position || 'absolute'\n      style.left     = '0px'\n      style.top      = '0px'\n      style.width    = width  + 'px'\n      style.height   = height + 'px'\n      dirty = true\n    }\n  }\n  if(scene.autoResize) {\n    resizeListener()\n  }\n  window.addEventListener('resize', resizeListener)\n\n  function reallocPickIds() {\n    var numObjs = objects.length\n    var numPick = pickBuffers.length\n    for(var i=0; i<numPick; ++i) {\n      pickBufferCount[i] = 0\n    }\n    obj_loop:\n    for(var i=0; i<numObjs; ++i) {\n      var obj = objects[i]\n      var pickCount = obj.pickSlots\n      if(!pickCount) {\n        pickBufferIds[i] = -1\n        continue\n      }\n      for(var j=0; j<numPick; ++j) {\n        if(pickBufferCount[j] + pickCount < 255) {\n          pickBufferIds[i] = j\n          obj.setPickBase(pickBufferCount[j]+1)\n          pickBufferCount[j] += pickCount\n          continue obj_loop\n        }\n      }\n      //Create new pick buffer\n      var nbuffer = createSelect(gl, viewShape)\n      pickBufferIds[i] = numPick\n      pickBuffers.push(nbuffer)\n      pickBufferCount.push(pickCount)\n      obj.setPickBase(1)\n      numPick += 1\n    }\n    while(numPick > 0 && pickBufferCount[numPick-1] === 0) {\n      pickBufferCount.pop()\n      pickBuffers.pop().dispose()\n    }\n  }\n\n  scene.update = function(options) {\n\n    if(scene._stopped) {\n      return\n    }\n    options = options || {}\n    dirty = true\n    pickDirty = true\n  }\n\n  scene.add = function(obj) {\n    if(scene._stopped) {\n      return\n    }\n    obj.axes = axes\n    objects.push(obj)\n    pickBufferIds.push(-1)\n    dirty = true\n    pickDirty = true\n    reallocPickIds()\n  }\n\n  scene.remove = function(obj) {\n    if(scene._stopped) {\n      return\n    }\n    var idx = objects.indexOf(obj)\n    if(idx < 0) {\n      return\n    }\n    objects.splice(idx, 1)\n    pickBufferIds.pop()\n    dirty = true\n    pickDirty = true\n    reallocPickIds()\n  }\n\n  scene.dispose = function() {\n    if(scene._stopped) {\n      return\n    }\n\n    scene._stopped = true\n\n    window.removeEventListener('resize', resizeListener)\n    canvas.removeEventListener('webglcontextlost', checkContextLoss)\n    scene.mouseListener.enabled = false\n\n    if(scene.contextLost) {\n      return\n    }\n\n    //Destroy objects\n    axes.dispose()\n    spikes.dispose()\n    for(var i=0; i<objects.length; ++i) {\n      objects[i].dispose()\n    }\n\n    //Clean up buffers\n    accumBuffer.dispose()\n    for(var i=0; i<pickBuffers.length; ++i) {\n      pickBuffers[i].dispose()\n    }\n\n    //Clean up shaders\n    accumShader.dispose()\n\n    //Release all references\n    gl = null\n    axes = null\n    spikes = null\n    objects = []\n  }\n\n  //Update mouse position\n  scene._mouseRotating = false\n  scene._prevButtons = 0\n\n  scene.enableMouseListeners = function() {\n\n    scene.mouseListener = mouseChange(canvas, function(buttons, x, y) {\n      if(scene._stopped) {\n        return\n      }\n\n      var numPick = pickBuffers.length\n      var numObjs = objects.length\n      var prevObj = selection.object\n\n      selection.distance = Infinity\n      selection.mouse[0] = x\n      selection.mouse[1] = y\n      selection.object = null\n      selection.screen = null\n      selection.dataCoordinate = selection.dataPosition = null\n\n      var change = false\n\n      if(buttons && scene._prevButtons) {\n        scene._mouseRotating = true\n      } else {\n        if(scene._mouseRotating) {\n          pickDirty = true\n        }\n        scene._mouseRotating = false\n\n        for(var i=0; i<numPick; ++i) {\n          var result = pickBuffers[i].query(x, pickShape[1] - y - 1, scene.pickRadius)\n          if(result) {\n            if(result.distance > selection.distance) {\n              continue\n            }\n            for(var j=0; j<numObjs; ++j) {\n              var obj = objects[j]\n              if(pickBufferIds[j] !== i) {\n                continue\n              }\n              var objPick = obj.pick(result)\n              if(objPick) {\n                selection.buttons        = buttons\n                selection.screen         = result.coord\n                selection.distance       = result.distance\n                selection.object         = obj\n                selection.index          = objPick.distance\n                selection.dataPosition   = objPick.position\n                selection.dataCoordinate = objPick.dataCoordinate\n                selection.data           = objPick\n                change = true\n              }\n            }\n          }\n        }\n      }\n\n      if(prevObj && prevObj !== selection.object) {\n        if(prevObj.highlight) {\n          prevObj.highlight(null)\n        }\n        dirty = true\n      }\n      if(selection.object) {\n        if(selection.object.highlight) {\n          selection.object.highlight(selection.data)\n        }\n        dirty = true\n      }\n\n      change = change || (selection.object !== prevObj)\n      if(change && scene.onselect) {\n        scene.onselect(selection)\n      }\n\n      if((buttons & 1) && !(scene._prevButtons & 1) && scene.onclick) {\n        scene.onclick(selection)\n      }\n      scene._prevButtons = buttons\n    })\n  }\n\n  function checkContextLoss() {\n    if(scene.contextLost) {\n      return true\n    }\n    if(gl.isContextLost()) {\n      scene.contextLost = true\n      scene.mouseListener.enabled = false\n      scene.selection.object = null\n      if(scene.oncontextloss) {\n        scene.oncontextloss()\n      }\n    }\n  }\n\n  canvas.addEventListener('webglcontextlost', checkContextLoss)\n\n  //Render the scene for mouse picking\n  function renderPick() {\n    if(checkContextLoss()) {\n      return\n    }\n\n    gl.colorMask(true, true, true, true)\n    gl.depthMask(true)\n    gl.disable(gl.BLEND)\n    gl.enable(gl.DEPTH_TEST)\n    gl.depthFunc(gl.LEQUAL)\n\n    var numObjs = objects.length\n    var numPick = pickBuffers.length\n    for(var j=0; j<numPick; ++j) {\n      var buf = pickBuffers[j]\n      buf.shape = pickShape\n      buf.begin()\n      for(var i=0; i<numObjs; ++i) {\n        if(pickBufferIds[i] !== j) {\n          continue\n        }\n        var obj = objects[i]\n        if(obj.drawPick) {\n          obj.pixelRatio = 1\n          obj.drawPick(cameraParams)\n        }\n      }\n      buf.end()\n    }\n  }\n\n  var nBounds = [\n    [ Infinity, Infinity, Infinity],\n    [-Infinity,-Infinity,-Infinity]]\n\n  var prevBounds = [nBounds[0].slice(), nBounds[1].slice()]\n\n  function redraw() {\n    if(checkContextLoss()) {\n      return\n    }\n\n    resizeListener()\n\n    //Tick camera\n    var cameraMoved = scene.camera.tick()\n    cameraParams.view = scene.camera.matrix\n    dirty     = dirty || cameraMoved\n    pickDirty = pickDirty || cameraMoved\n\n      //Set pixel ratio\n    axes.pixelRatio   = scene.pixelRatio\n    spikes.pixelRatio = scene.pixelRatio\n\n    //Check if any objects changed, recalculate bounds\n    var numObjs = objects.length\n    var lo = nBounds[0]\n    var hi = nBounds[1]\n    lo[0] = lo[1] = lo[2] =  Infinity\n    hi[0] = hi[1] = hi[2] = -Infinity\n    for(var i=0; i<numObjs; ++i) {\n      var obj = objects[i]\n\n      //Set the axes properties for each object\n      obj.pixelRatio = scene.pixelRatio\n      obj.axes = scene.axes\n\n      dirty = dirty || !!obj.dirty\n      pickDirty = pickDirty || !!obj.dirty\n      var obb = obj.bounds\n      if(obb) {\n        var olo = obb[0]\n        var ohi = obb[1]\n        for(var j=0; j<3; ++j) {\n          lo[j] = Math.min(lo[j], olo[j])\n          hi[j] = Math.max(hi[j], ohi[j])\n        }\n      }\n    }\n\n    //Recalculate bounds\n    var bounds = scene.bounds\n    if(scene.autoBounds) {\n      for(var j=0; j<3; ++j) {\n        if(hi[j] < lo[j]) {\n          lo[j] = -1\n          hi[j] = 1\n        } else {\n          if(lo[j] === hi[j]) {\n            lo[j] -= 1\n            hi[j] += 1\n          }\n          var padding = 0.05 * (hi[j] - lo[j])\n          lo[j] = lo[j] - padding\n          hi[j] = hi[j] + padding\n        }\n        bounds[0][j] = lo[j]\n        bounds[1][j] = hi[j]\n      }\n    }\n\n    var boundsChanged = false\n    for(var j=0; j<3; ++j) {\n        boundsChanged = boundsChanged ||\n            (prevBounds[0][j] !== bounds[0][j])  ||\n            (prevBounds[1][j] !== bounds[1][j])\n        prevBounds[0][j] = bounds[0][j]\n        prevBounds[1][j] = bounds[1][j]\n    }\n\n    //Recalculate bounds\n    pickDirty = pickDirty || boundsChanged\n    dirty = dirty || boundsChanged\n\n    if(!dirty) {\n      return\n    }\n\n    if(boundsChanged) {\n      var tickSpacing = [0,0,0]\n      for(var i=0; i<3; ++i) {\n        tickSpacing[i] = roundUpPow10((bounds[1][i]-bounds[0][i]) / 10.0)\n      }\n      if(axes.autoTicks) {\n        axes.update({\n          bounds: bounds,\n          tickSpacing: tickSpacing\n        })\n      } else {\n        axes.update({\n          bounds: bounds\n        })\n      }\n    }\n\n    //Get scene\n    var width  = gl.drawingBufferWidth\n    var height = gl.drawingBufferHeight\n    viewShape[0] = width\n    viewShape[1] = height\n    pickShape[0] = Math.max(width/scene.pixelRatio, 1)|0\n    pickShape[1] = Math.max(height/scene.pixelRatio, 1)|0\n\n    //Compute camera parameters\n    calcCameraParams(scene, isOrtho)\n\n    //Apply axes/clip bounds\n    for(var i=0; i<numObjs; ++i) {\n      var obj = objects[i]\n\n      //Set axes bounds\n      obj.axesBounds = bounds\n\n      //Set clip bounds\n      if(scene.clipToBounds) {\n        obj.clipBounds = bounds\n      }\n    }\n    //Set spike parameters\n    if(selection.object) {\n      if(scene.snapToData) {\n        spikes.position = selection.dataCoordinate\n      } else {\n        spikes.position = selection.dataPosition\n      }\n      spikes.bounds = bounds\n    }\n\n    //If state changed, then redraw pick buffers\n    if(pickDirty) {\n      pickDirty = false\n      renderPick()\n    }\n\n    //Recalculate pixel data\n    scene.axesPixels = axesRanges(scene.axes, cameraParams, width, height)\n\n    //Call render callback\n    if(scene.onrender) {\n      scene.onrender()\n    }\n\n    //Read value\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null)\n    gl.viewport(0, 0, width, height)\n\n    //General strategy: 3 steps\n    //  1. render non-transparent objects\n    //  2. accumulate transparent objects into separate fbo\n    //  3. composite final scene\n\n    //Clear FBO\n    scene.clearRGBA()\n\n    gl.depthMask(true)\n    gl.colorMask(true, true, true, true)\n    gl.enable(gl.DEPTH_TEST)\n    gl.depthFunc(gl.LEQUAL)\n    gl.disable(gl.BLEND)\n    gl.disable(gl.CULL_FACE)  //most visualization surfaces are 2 sided\n\n    //Render opaque pass\n    var hasTransparent = false\n    if(axes.enable) {\n      hasTransparent = hasTransparent || axes.isTransparent()\n      axes.draw(cameraParams)\n    }\n    spikes.axes = axes\n    if(selection.object) {\n      spikes.draw(cameraParams)\n    }\n\n    gl.disable(gl.CULL_FACE)  //most visualization surfaces are 2 sided\n\n    for(var i=0; i<numObjs; ++i) {\n      var obj = objects[i]\n      obj.axes = axes\n      obj.pixelRatio = scene.pixelRatio\n      if(obj.isOpaque && obj.isOpaque()) {\n        obj.draw(cameraParams)\n      }\n      if(obj.isTransparent && obj.isTransparent()) {\n        hasTransparent = true\n      }\n    }\n\n    if(hasTransparent) {\n      //Render transparent pass\n      accumBuffer.shape = viewShape\n      accumBuffer.bind()\n      gl.clear(gl.DEPTH_BUFFER_BIT)\n      gl.colorMask(false, false, false, false)\n      gl.depthMask(true)\n      gl.depthFunc(gl.LESS)\n\n      //Render forward facing objects\n      if(axes.enable && axes.isTransparent()) {\n        axes.drawTransparent(cameraParams)\n      }\n      for(var i=0; i<numObjs; ++i) {\n        var obj = objects[i]\n        if(obj.isOpaque && obj.isOpaque()) {\n          obj.draw(cameraParams)\n        }\n      }\n\n      //Render transparent pass\n      gl.enable(gl.BLEND)\n      gl.blendEquation(gl.FUNC_ADD)\n      gl.blendFunc(gl.ONE, gl.ONE_MINUS_SRC_ALPHA)\n      gl.colorMask(true, true, true, true)\n      gl.depthMask(false)\n      gl.clearColor(0,0,0,0)\n      gl.clear(gl.COLOR_BUFFER_BIT)\n\n      if(axes.isTransparent()) {\n        axes.drawTransparent(cameraParams)\n      }\n\n      for(var i=0; i<numObjs; ++i) {\n        var obj = objects[i]\n        if(obj.isTransparent && obj.isTransparent()) {\n          obj.drawTransparent(cameraParams)\n        }\n      }\n\n      //Unbind framebuffer\n      gl.bindFramebuffer(gl.FRAMEBUFFER, null)\n\n      //Draw composite pass\n      gl.blendFunc(gl.ONE, gl.ONE_MINUS_SRC_ALPHA)\n      gl.disable(gl.DEPTH_TEST)\n      accumShader.bind()\n      accumBuffer.color[0].bind(0)\n      accumShader.uniforms.accumBuffer = 0\n      drawTriangle(gl)\n\n      //Turn off blending\n      gl.disable(gl.BLEND)\n    }\n\n    //Clear dirty flags\n    dirty = false\n    for(var i=0; i<numObjs; ++i) {\n      objects[i].dirty = false\n    }\n  }\n\n  //Draw the whole scene\n  function render() {\n    if(scene._stopped || scene.contextLost) {\n      return\n    }\n    // this order is important: ios safari sometimes has sync raf\n    redraw()\n    requestAnimationFrame(render)\n  }\n\n  scene.enableMouseListeners()\n  render()\n\n  //Force redraw of whole scene\n  scene.redraw = function() {\n    if(scene._stopped) {\n      return\n    }\n    dirty = true\n    redraw()\n  }\n\n  return scene\n}\n\nfunction calcCameraParams(scene, isOrtho) {\n  var bounds = scene.bounds\n  var cameraParams = scene.cameraParams\n  var projection = cameraParams.projection\n  var model = cameraParams.model\n\n  var width = scene.gl.drawingBufferWidth\n  var height = scene.gl.drawingBufferHeight\n  var zNear = scene.zNear\n  var zFar = scene.zFar\n  var fovy = scene.fovy\n\n  var r = width / height\n\n  if(isOrtho) {\n    ortho(projection,\n      -r,\n      r,\n      -1,\n      1,\n      zNear,\n      zFar\n    )\n    cameraParams._ortho = true\n  } else {\n    perspective(projection,\n      fovy,\n      r,\n      zNear,\n      zFar\n    )\n    cameraParams._ortho = false\n  }\n\n  //Compute model matrix\n  for(var i=0; i<16; ++i) {\n    model[i] = 0\n  }\n  model[15] = 1\n\n  var maxS = 0\n  for(var i=0; i<3; ++i) {\n    maxS = Math.max(maxS, bounds[1][i] - bounds[0][i])\n  }\n\n  for(var i=0; i<3; ++i) {\n    if(scene.autoScale) {\n      model[5*i] = scene.aspect[i] / (bounds[1][i] - bounds[0][i])\n    } else {\n      model[5*i] = 1 / maxS\n    }\n    if(scene.autoCenter) {\n      model[12+i] = -model[5*i] * 0.5 * (bounds[0][i] + bounds[1][i])\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"script"}