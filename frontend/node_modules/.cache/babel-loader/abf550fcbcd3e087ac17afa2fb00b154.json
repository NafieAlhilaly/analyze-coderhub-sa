{"ast":null,"code":"'use strict';\n\nvar d3 = require('@plotly/d3');\n\nvar Drawing = require('../../components/drawing');\n\nvar Lib = require('../../lib');\n\nvar strScale = Lib.strScale;\nvar strTranslate = Lib.strTranslate;\n\nvar svgTextUtils = require('../../lib/svg_text_utils');\n\nvar barPlot = require('../bar/plot');\n\nvar toMoveInsideBar = barPlot.toMoveInsideBar;\n\nvar uniformText = require('../bar/uniform_text');\n\nvar recordMinTextSize = uniformText.recordMinTextSize;\nvar clearMinTextSize = uniformText.clearMinTextSize;\n\nvar pieHelpers = require('../pie/helpers');\n\nvar piePlot = require('../pie/plot');\n\nvar attachFxHandlers = piePlot.attachFxHandlers;\nvar determineInsideTextFont = piePlot.determineInsideTextFont;\nvar layoutAreas = piePlot.layoutAreas;\nvar prerenderTitles = piePlot.prerenderTitles;\nvar positionTitleOutside = piePlot.positionTitleOutside;\nvar formatSliceLabel = piePlot.formatSliceLabel;\n\nmodule.exports = function plot(gd, cdModule) {\n  var fullLayout = gd._fullLayout;\n  clearMinTextSize('funnelarea', fullLayout);\n  prerenderTitles(cdModule, gd);\n  layoutAreas(cdModule, fullLayout._size);\n  Lib.makeTraceGroups(fullLayout._funnelarealayer, cdModule, 'trace').each(function (cd) {\n    var plotGroup = d3.select(this);\n    var cd0 = cd[0];\n    var trace = cd0.trace;\n    setCoords(cd);\n    plotGroup.each(function () {\n      var slices = d3.select(this).selectAll('g.slice').data(cd);\n      slices.enter().append('g').classed('slice', true);\n      slices.exit().remove();\n      slices.each(function (pt, i) {\n        if (pt.hidden) {\n          d3.select(this).selectAll('path,g').remove();\n          return;\n        } // to have consistent event data compared to other traces\n\n\n        pt.pointNumber = pt.i;\n        pt.curveNumber = trace.index;\n        var cx = cd0.cx;\n        var cy = cd0.cy;\n        var sliceTop = d3.select(this);\n        var slicePath = sliceTop.selectAll('path.surface').data([pt]);\n        slicePath.enter().append('path').classed('surface', true).style({\n          'pointer-events': 'all'\n        });\n        sliceTop.call(attachFxHandlers, gd, cd);\n        var shape = 'M' + (cx + pt.TR[0]) + ',' + (cy + pt.TR[1]) + line(pt.TR, pt.BR) + line(pt.BR, pt.BL) + line(pt.BL, pt.TL) + 'Z';\n        slicePath.attr('d', shape); // add text\n\n        formatSliceLabel(gd, pt, cd0);\n        var textPosition = pieHelpers.castOption(trace.textposition, pt.pts);\n        var sliceTextGroup = sliceTop.selectAll('g.slicetext').data(pt.text && textPosition !== 'none' ? [0] : []);\n        sliceTextGroup.enter().append('g').classed('slicetext', true);\n        sliceTextGroup.exit().remove();\n        sliceTextGroup.each(function () {\n          var sliceText = Lib.ensureSingle(d3.select(this), 'text', '', function (s) {\n            // prohibit tex interpretation until we can handle\n            // tex and regular text together\n            s.attr('data-notex', 1);\n          });\n          var font = Lib.ensureUniformFontSize(gd, determineInsideTextFont(trace, pt, fullLayout.font));\n          sliceText.text(pt.text).attr({\n            'class': 'slicetext',\n            transform: '',\n            'text-anchor': 'middle'\n          }).call(Drawing.font, font).call(svgTextUtils.convertToTspans, gd); // position the text relative to the slice\n\n          var textBB = Drawing.bBox(sliceText.node());\n          var transform;\n          var x0, x1;\n          var y0 = Math.min(pt.BL[1], pt.BR[1]) + cy;\n          var y1 = Math.max(pt.TL[1], pt.TR[1]) + cy;\n          x0 = Math.max(pt.TL[0], pt.BL[0]) + cx;\n          x1 = Math.min(pt.TR[0], pt.BR[0]) + cx;\n          transform = toMoveInsideBar(x0, x1, y0, y1, textBB, {\n            isHorizontal: true,\n            constrained: true,\n            angle: 0,\n            anchor: 'middle'\n          });\n          transform.fontSize = font.size;\n          recordMinTextSize(trace.type, transform, fullLayout);\n          cd[i].transform = transform;\n          sliceText.attr('transform', Lib.getTextTransform(transform));\n        });\n      }); // add the title\n\n      var titleTextGroup = d3.select(this).selectAll('g.titletext').data(trace.title.text ? [0] : []);\n      titleTextGroup.enter().append('g').classed('titletext', true);\n      titleTextGroup.exit().remove();\n      titleTextGroup.each(function () {\n        var titleText = Lib.ensureSingle(d3.select(this), 'text', '', function (s) {\n          // prohibit tex interpretation as above\n          s.attr('data-notex', 1);\n        });\n        var txt = trace.title.text;\n\n        if (trace._meta) {\n          txt = Lib.templateString(txt, trace._meta);\n        }\n\n        titleText.text(txt).attr({\n          'class': 'titletext',\n          transform: '',\n          'text-anchor': 'middle'\n        }).call(Drawing.font, trace.title.font).call(svgTextUtils.convertToTspans, gd);\n        var transform = positionTitleOutside(cd0, fullLayout._size);\n        titleText.attr('transform', strTranslate(transform.x, transform.y) + strScale(Math.min(1, transform.scale)) + strTranslate(transform.tx, transform.ty));\n      });\n    });\n  });\n};\n\nfunction line(a, b) {\n  var dx = b[0] - a[0];\n  var dy = b[1] - a[1];\n  return 'l' + dx + ',' + dy;\n}\n\nfunction getBetween(a, b) {\n  return [0.5 * (a[0] + b[0]), 0.5 * (a[1] + b[1])];\n}\n\nfunction setCoords(cd) {\n  if (!cd.length) return;\n  var cd0 = cd[0];\n  var trace = cd0.trace;\n  var aspectratio = trace.aspectratio;\n  var h = trace.baseratio;\n  if (h > 0.999) h = 0.999; // TODO: may handle this case separately\n\n  var h2 = Math.pow(h, 2);\n  var v1 = cd0.vTotal;\n  var v0 = v1 * h2 / (1 - h2);\n  var totalValues = v1;\n  var sumSteps = v0 / v1;\n\n  function calcPos() {\n    var q = Math.sqrt(sumSteps);\n    return {\n      x: q,\n      y: -q\n    };\n  }\n\n  function getPoint() {\n    var pos = calcPos();\n    return [pos.x, pos.y];\n  }\n\n  var p;\n  var allPoints = [];\n  allPoints.push(getPoint());\n  var i, cdi;\n\n  for (i = cd.length - 1; i > -1; i--) {\n    cdi = cd[i];\n    if (cdi.hidden) continue;\n    var step = cdi.v / totalValues;\n    sumSteps += step;\n    allPoints.push(getPoint());\n  }\n\n  var minY = Infinity;\n  var maxY = -Infinity;\n\n  for (i = 0; i < allPoints.length; i++) {\n    p = allPoints[i];\n    minY = Math.min(minY, p[1]);\n    maxY = Math.max(maxY, p[1]);\n  } // center the shape\n\n\n  for (i = 0; i < allPoints.length; i++) {\n    allPoints[i][1] -= (maxY + minY) / 2;\n  }\n\n  var lastX = allPoints[allPoints.length - 1][0]; // get pie r\n\n  var r = cd0.r;\n  var rY = (maxY - minY) / 2;\n  var scaleX = r / lastX;\n  var scaleY = r / rY * aspectratio; // set funnelarea r\n\n  cd0.r = scaleY * rY; // scale the shape\n\n  for (i = 0; i < allPoints.length; i++) {\n    allPoints[i][0] *= scaleX;\n    allPoints[i][1] *= scaleY;\n  } // record first position\n\n\n  p = allPoints[0];\n  var prevLeft = [-p[0], p[1]];\n  var prevRight = [p[0], p[1]];\n  var n = 0; // note we skip the very first point.\n\n  for (i = cd.length - 1; i > -1; i--) {\n    cdi = cd[i];\n    if (cdi.hidden) continue;\n    n += 1;\n    var x = allPoints[n][0];\n    var y = allPoints[n][1];\n    cdi.TL = [-x, y];\n    cdi.TR = [x, y];\n    cdi.BL = prevLeft;\n    cdi.BR = prevRight;\n    cdi.pxmid = getBetween(cdi.TR, cdi.BR);\n    prevLeft = cdi.TL;\n    prevRight = cdi.TR;\n  }\n}","map":{"version":3,"sources":["C:/Projects/reactApp/analyse_coderhub/node_modules/plotly.js/src/traces/funnelarea/plot.js"],"names":["d3","require","Drawing","Lib","strScale","strTranslate","svgTextUtils","barPlot","toMoveInsideBar","uniformText","recordMinTextSize","clearMinTextSize","pieHelpers","piePlot","attachFxHandlers","determineInsideTextFont","layoutAreas","prerenderTitles","positionTitleOutside","formatSliceLabel","module","exports","plot","gd","cdModule","fullLayout","_fullLayout","_size","makeTraceGroups","_funnelarealayer","each","cd","plotGroup","select","cd0","trace","setCoords","slices","selectAll","data","enter","append","classed","exit","remove","pt","i","hidden","pointNumber","curveNumber","index","cx","cy","sliceTop","slicePath","style","call","shape","TR","line","BR","BL","TL","attr","textPosition","castOption","textposition","pts","sliceTextGroup","text","sliceText","ensureSingle","s","font","ensureUniformFontSize","transform","convertToTspans","textBB","bBox","node","x0","x1","y0","Math","min","y1","max","isHorizontal","constrained","angle","anchor","fontSize","size","type","getTextTransform","titleTextGroup","title","titleText","txt","_meta","templateString","x","y","scale","tx","ty","a","b","dx","dy","getBetween","length","aspectratio","h","baseratio","h2","pow","v1","vTotal","v0","totalValues","sumSteps","calcPos","q","sqrt","getPoint","pos","p","allPoints","push","cdi","step","v","minY","Infinity","maxY","lastX","r","rY","scaleX","scaleY","prevLeft","prevRight","n","pxmid"],"mappings":"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","sourcesContent":["'use strict';\n\nvar d3 = require('@plotly/d3');\n\nvar Drawing = require('../../components/drawing');\nvar Lib = require('../../lib');\nvar strScale = Lib.strScale;\nvar strTranslate = Lib.strTranslate;\nvar svgTextUtils = require('../../lib/svg_text_utils');\n\nvar barPlot = require('../bar/plot');\nvar toMoveInsideBar = barPlot.toMoveInsideBar;\nvar uniformText = require('../bar/uniform_text');\nvar recordMinTextSize = uniformText.recordMinTextSize;\nvar clearMinTextSize = uniformText.clearMinTextSize;\nvar pieHelpers = require('../pie/helpers');\nvar piePlot = require('../pie/plot');\n\nvar attachFxHandlers = piePlot.attachFxHandlers;\nvar determineInsideTextFont = piePlot.determineInsideTextFont;\n\nvar layoutAreas = piePlot.layoutAreas;\nvar prerenderTitles = piePlot.prerenderTitles;\nvar positionTitleOutside = piePlot.positionTitleOutside;\nvar formatSliceLabel = piePlot.formatSliceLabel;\n\nmodule.exports = function plot(gd, cdModule) {\n    var fullLayout = gd._fullLayout;\n\n    clearMinTextSize('funnelarea', fullLayout);\n\n    prerenderTitles(cdModule, gd);\n    layoutAreas(cdModule, fullLayout._size);\n\n    Lib.makeTraceGroups(fullLayout._funnelarealayer, cdModule, 'trace').each(function(cd) {\n        var plotGroup = d3.select(this);\n        var cd0 = cd[0];\n        var trace = cd0.trace;\n\n        setCoords(cd);\n\n        plotGroup.each(function() {\n            var slices = d3.select(this).selectAll('g.slice').data(cd);\n\n            slices.enter().append('g')\n                .classed('slice', true);\n            slices.exit().remove();\n\n            slices.each(function(pt, i) {\n                if(pt.hidden) {\n                    d3.select(this).selectAll('path,g').remove();\n                    return;\n                }\n\n                // to have consistent event data compared to other traces\n                pt.pointNumber = pt.i;\n                pt.curveNumber = trace.index;\n\n                var cx = cd0.cx;\n                var cy = cd0.cy;\n                var sliceTop = d3.select(this);\n                var slicePath = sliceTop.selectAll('path.surface').data([pt]);\n\n                slicePath.enter().append('path')\n                    .classed('surface', true)\n                    .style({'pointer-events': 'all'});\n\n                sliceTop.call(attachFxHandlers, gd, cd);\n\n                var shape =\n                    'M' + (cx + pt.TR[0]) + ',' + (cy + pt.TR[1]) +\n                    line(pt.TR, pt.BR) +\n                    line(pt.BR, pt.BL) +\n                    line(pt.BL, pt.TL) +\n                    'Z';\n\n                slicePath.attr('d', shape);\n\n                // add text\n                formatSliceLabel(gd, pt, cd0);\n                var textPosition = pieHelpers.castOption(trace.textposition, pt.pts);\n                var sliceTextGroup = sliceTop.selectAll('g.slicetext')\n                    .data(pt.text && (textPosition !== 'none') ? [0] : []);\n\n                sliceTextGroup.enter().append('g')\n                    .classed('slicetext', true);\n                sliceTextGroup.exit().remove();\n\n                sliceTextGroup.each(function() {\n                    var sliceText = Lib.ensureSingle(d3.select(this), 'text', '', function(s) {\n                        // prohibit tex interpretation until we can handle\n                        // tex and regular text together\n                        s.attr('data-notex', 1);\n                    });\n\n                    var font = Lib.ensureUniformFontSize(gd, determineInsideTextFont(trace, pt, fullLayout.font));\n\n                    sliceText.text(pt.text)\n                        .attr({\n                            'class': 'slicetext',\n                            transform: '',\n                            'text-anchor': 'middle'\n                        })\n                        .call(Drawing.font, font)\n                        .call(svgTextUtils.convertToTspans, gd);\n\n                    // position the text relative to the slice\n                    var textBB = Drawing.bBox(sliceText.node());\n                    var transform;\n\n                    var x0, x1;\n                    var y0 = Math.min(pt.BL[1], pt.BR[1]) + cy;\n                    var y1 = Math.max(pt.TL[1], pt.TR[1]) + cy;\n\n                    x0 = Math.max(pt.TL[0], pt.BL[0]) + cx;\n                    x1 = Math.min(pt.TR[0], pt.BR[0]) + cx;\n\n                    transform = toMoveInsideBar(x0, x1, y0, y1, textBB, {\n                        isHorizontal: true,\n                        constrained: true,\n                        angle: 0,\n                        anchor: 'middle'\n                    });\n\n                    transform.fontSize = font.size;\n                    recordMinTextSize(trace.type, transform, fullLayout);\n                    cd[i].transform = transform;\n\n                    sliceText.attr('transform', Lib.getTextTransform(transform));\n                });\n            });\n\n            // add the title\n            var titleTextGroup = d3.select(this).selectAll('g.titletext')\n                .data(trace.title.text ? [0] : []);\n\n            titleTextGroup.enter().append('g')\n                .classed('titletext', true);\n            titleTextGroup.exit().remove();\n\n            titleTextGroup.each(function() {\n                var titleText = Lib.ensureSingle(d3.select(this), 'text', '', function(s) {\n                    // prohibit tex interpretation as above\n                    s.attr('data-notex', 1);\n                });\n\n                var txt = trace.title.text;\n                if(trace._meta) {\n                    txt = Lib.templateString(txt, trace._meta);\n                }\n\n                titleText.text(txt)\n                    .attr({\n                        'class': 'titletext',\n                        transform: '',\n                        'text-anchor': 'middle',\n                    })\n                .call(Drawing.font, trace.title.font)\n                .call(svgTextUtils.convertToTspans, gd);\n\n                var transform = positionTitleOutside(cd0, fullLayout._size);\n\n                titleText.attr('transform',\n                    strTranslate(transform.x, transform.y) +\n                    strScale(Math.min(1, transform.scale)) +\n                    strTranslate(transform.tx, transform.ty));\n            });\n        });\n    });\n};\n\nfunction line(a, b) {\n    var dx = b[0] - a[0];\n    var dy = b[1] - a[1];\n\n    return 'l' + dx + ',' + dy;\n}\n\nfunction getBetween(a, b) {\n    return [\n        0.5 * (a[0] + b[0]),\n        0.5 * (a[1] + b[1])\n    ];\n}\n\nfunction setCoords(cd) {\n    if(!cd.length) return;\n\n    var cd0 = cd[0];\n    var trace = cd0.trace;\n\n    var aspectratio = trace.aspectratio;\n\n    var h = trace.baseratio;\n    if(h > 0.999) h = 0.999; // TODO: may handle this case separately\n    var h2 = Math.pow(h, 2);\n\n    var v1 = cd0.vTotal;\n    var v0 = v1 * h2 / (1 - h2);\n\n    var totalValues = v1;\n    var sumSteps = v0 / v1;\n\n    function calcPos() {\n        var q = Math.sqrt(sumSteps);\n        return {\n            x: q,\n            y: -q\n        };\n    }\n\n    function getPoint() {\n        var pos = calcPos();\n        return [pos.x, pos.y];\n    }\n\n    var p;\n    var allPoints = [];\n    allPoints.push(getPoint());\n\n    var i, cdi;\n    for(i = cd.length - 1; i > -1; i--) {\n        cdi = cd[i];\n        if(cdi.hidden) continue;\n\n        var step = cdi.v / totalValues;\n        sumSteps += step;\n\n        allPoints.push(getPoint());\n    }\n\n    var minY = Infinity;\n    var maxY = -Infinity;\n    for(i = 0; i < allPoints.length; i++) {\n        p = allPoints[i];\n        minY = Math.min(minY, p[1]);\n        maxY = Math.max(maxY, p[1]);\n    }\n\n    // center the shape\n    for(i = 0; i < allPoints.length; i++) {\n        allPoints[i][1] -= (maxY + minY) / 2;\n    }\n\n    var lastX = allPoints[allPoints.length - 1][0];\n\n    // get pie r\n    var r = cd0.r;\n\n    var rY = (maxY - minY) / 2;\n    var scaleX = r / lastX;\n    var scaleY = r / rY * aspectratio;\n\n    // set funnelarea r\n    cd0.r = scaleY * rY;\n\n    // scale the shape\n    for(i = 0; i < allPoints.length; i++) {\n        allPoints[i][0] *= scaleX;\n        allPoints[i][1] *= scaleY;\n    }\n\n    // record first position\n    p = allPoints[0];\n    var prevLeft = [-p[0], p[1]];\n    var prevRight = [p[0], p[1]];\n\n    var n = 0; // note we skip the very first point.\n    for(i = cd.length - 1; i > -1; i--) {\n        cdi = cd[i];\n        if(cdi.hidden) continue;\n\n        n += 1;\n        var x = allPoints[n][0];\n        var y = allPoints[n][1];\n\n        cdi.TL = [-x, y];\n        cdi.TR = [x, y];\n\n        cdi.BL = prevLeft;\n        cdi.BR = prevRight;\n\n        cdi.pxmid = getBetween(cdi.TR, cdi.BR);\n\n        prevLeft = cdi.TL;\n        prevRight = cdi.TR;\n    }\n}\n"]},"metadata":{},"sourceType":"script"}