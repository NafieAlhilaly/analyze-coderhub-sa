{"ast":null,"code":"'use strict';\n\nmodule.exports = createSelectBuffer;\n\nvar createFBO = require('gl-fbo');\n\nvar pool = require('typedarray-pool');\n\nvar ndarray = require('ndarray');\n\nvar nextPow2 = require('bit-twiddle').nextPow2;\n\nvar selectRange = function (arr, x, y) {\n  var closestD2 = 1e8;\n  var closestX = -1;\n  var closestY = -1;\n  var ni = arr.shape[0];\n  var nj = arr.shape[1];\n\n  for (var i = 0; i < ni; i++) {\n    for (var j = 0; j < nj; j++) {\n      var r = arr.get(i, j, 0);\n      var g = arr.get(i, j, 1);\n      var b = arr.get(i, j, 2);\n      var a = arr.get(i, j, 3);\n\n      if (r < 255 || g < 255 || b < 255 || a < 255) {\n        var dx = x - i;\n        var dy = y - j;\n        var d2 = dx * dx + dy * dy;\n\n        if (d2 < closestD2) {\n          closestD2 = d2;\n          closestX = i;\n          closestY = j;\n        }\n      }\n    }\n  }\n\n  return [closestX, closestY, closestD2];\n};\n\nfunction SelectResult(x, y, id, value, distance) {\n  this.coord = [x, y];\n  this.id = id;\n  this.value = value;\n  this.distance = distance;\n}\n\nfunction SelectBuffer(gl, fbo, buffer) {\n  this.gl = gl;\n  this.fbo = fbo;\n  this.buffer = buffer;\n  this._readTimeout = null;\n  var self = this;\n\n  this._readCallback = function () {\n    if (!self.gl) {\n      return;\n    }\n\n    fbo.bind();\n    gl.readPixels(0, 0, fbo.shape[0], fbo.shape[1], gl.RGBA, gl.UNSIGNED_BYTE, self.buffer);\n    self._readTimeout = null;\n  };\n}\n\nvar proto = SelectBuffer.prototype;\nObject.defineProperty(proto, 'shape', {\n  get: function () {\n    if (!this.gl) {\n      return [0, 0];\n    }\n\n    return this.fbo.shape.slice();\n  },\n  set: function (v) {\n    if (!this.gl) {\n      return;\n    }\n\n    this.fbo.shape = v;\n    var c = this.fbo.shape[0];\n    var r = this.fbo.shape[1];\n\n    if (r * c * 4 > this.buffer.length) {\n      pool.free(this.buffer);\n      var buffer = this.buffer = pool.mallocUint8(nextPow2(r * c * 4));\n\n      for (var i = 0; i < r * c * 4; ++i) {\n        buffer[i] = 0xff;\n      }\n    }\n\n    return v;\n  }\n});\n\nproto.begin = function () {\n  var gl = this.gl;\n  var shape = this.shape;\n\n  if (!gl) {\n    return;\n  }\n\n  this.fbo.bind();\n  gl.clearColor(1, 1, 1, 1);\n  gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n};\n\nproto.end = function () {\n  var gl = this.gl;\n\n  if (!gl) {\n    return;\n  }\n\n  gl.bindFramebuffer(gl.FRAMEBUFFER, null);\n\n  if (!this._readTimeout) {\n    clearTimeout(this._readTimeout);\n  }\n\n  this._readTimeout = setTimeout(this._readCallback, 1);\n};\n\nproto.query = function (x, y, radius) {\n  if (!this.gl) {\n    return null;\n  }\n\n  var shape = this.fbo.shape.slice();\n  x = x | 0;\n  y = y | 0;\n\n  if (typeof radius !== 'number') {\n    radius = 1.0;\n  }\n\n  var x0 = Math.min(Math.max(x - radius, 0), shape[0]) | 0;\n  var x1 = Math.min(Math.max(x + radius, 0), shape[0]) | 0;\n  var y0 = Math.min(Math.max(y - radius, 0), shape[1]) | 0;\n  var y1 = Math.min(Math.max(y + radius, 0), shape[1]) | 0;\n\n  if (x1 <= x0 || y1 <= y0) {\n    return null;\n  }\n\n  var dims = [x1 - x0, y1 - y0];\n  var region = ndarray(this.buffer, [dims[0], dims[1], 4], [4, shape[0] * 4, 1], 4 * (x0 + shape[0] * y0));\n  var closest = selectRange(region.hi(dims[0], dims[1], 1), radius, radius);\n  var dx = closest[0];\n  var dy = closest[1];\n\n  if (dx < 0 || Math.pow(this.radius, 2) < closest[2]) {\n    return null;\n  }\n\n  var c0 = region.get(dx, dy, 0);\n  var c1 = region.get(dx, dy, 1);\n  var c2 = region.get(dx, dy, 2);\n  var c3 = region.get(dx, dy, 3);\n  return new SelectResult(dx + x0 | 0, dy + y0 | 0, c0, [c1, c2, c3], Math.sqrt(closest[2]));\n};\n\nproto.dispose = function () {\n  if (!this.gl) {\n    return;\n  }\n\n  this.fbo.dispose();\n  pool.free(this.buffer);\n  this.gl = null;\n\n  if (this._readTimeout) {\n    clearTimeout(this._readTimeout);\n  }\n};\n\nfunction createSelectBuffer(gl, shape) {\n  var width = shape[0];\n  var height = shape[1];\n  var options = {};\n  var fbo = createFBO(gl, width, height, options);\n  var buffer = pool.mallocUint8(width * height * 4);\n  return new SelectBuffer(gl, fbo, buffer);\n}","map":{"version":3,"sources":["C:/Projects/reactApp/frontend/node_modules/gl-select-static/select.js"],"names":["module","exports","createSelectBuffer","createFBO","require","pool","ndarray","nextPow2","selectRange","arr","x","y","closestD2","closestX","closestY","ni","shape","nj","i","j","r","get","g","b","a","dx","dy","d2","SelectResult","id","value","distance","coord","SelectBuffer","gl","fbo","buffer","_readTimeout","self","_readCallback","bind","readPixels","RGBA","UNSIGNED_BYTE","proto","prototype","Object","defineProperty","slice","set","v","c","length","free","mallocUint8","begin","clearColor","clear","COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","end","bindFramebuffer","FRAMEBUFFER","clearTimeout","setTimeout","query","radius","x0","Math","min","max","x1","y0","y1","dims","region","closest","hi","pow","c0","c1","c2","c3","sqrt","dispose","width","height","options"],"mappings":"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","sourcesContent":["'use strict'\n\nmodule.exports = createSelectBuffer\n\nvar createFBO = require('gl-fbo')\nvar pool      = require('typedarray-pool')\nvar ndarray   = require('ndarray')\nvar nextPow2  = require('bit-twiddle').nextPow2\n\nvar selectRange = function(arr, x, y) {\n  var closestD2 = 1e8\n  var closestX = -1\n  var closestY = -1\n\n  var ni = arr.shape[0]\n  var nj = arr.shape[1]\n  for(var i = 0; i < ni; i++) {\n    for(var j = 0; j < nj; j++) {\n      var r = arr.get(i, j, 0)\n      var g = arr.get(i, j, 1)\n      var b = arr.get(i, j, 2)\n      var a = arr.get(i, j, 3)\n\n      if(r < 255 || g < 255 || b < 255 || a < 255) {\n        var dx = x - i\n        var dy = y - j\n        var d2 = dx*dx + dy*dy\n        if(d2 < closestD2) {\n          closestD2 = d2\n          closestX = i\n          closestY = j\n        }\n      }\n    }\n  }\n\n  return [closestX, closestY, closestD2]\n}\n\nfunction SelectResult(x, y, id, value, distance) {\n  this.coord = [x, y]\n  this.id = id\n  this.value = value\n  this.distance = distance\n}\n\nfunction SelectBuffer(gl, fbo, buffer) {\n  this.gl     = gl\n  this.fbo    = fbo\n  this.buffer = buffer\n  this._readTimeout = null\n  var self = this\n\n  this._readCallback = function() {\n    if(!self.gl) {\n      return\n    }\n    fbo.bind()\n    gl.readPixels(0,0,fbo.shape[0],fbo.shape[1],gl.RGBA,gl.UNSIGNED_BYTE,self.buffer)\n    self._readTimeout = null\n  }\n}\n\nvar proto = SelectBuffer.prototype\n\nObject.defineProperty(proto, 'shape', {\n  get: function() {\n    if(!this.gl) {\n      return [0,0]\n    }\n    return this.fbo.shape.slice()\n  },\n  set: function(v) {\n    if(!this.gl) {\n      return\n    }\n    this.fbo.shape = v\n    var c = this.fbo.shape[0]\n    var r = this.fbo.shape[1]\n    if(r*c*4 > this.buffer.length) {\n      pool.free(this.buffer)\n      var buffer = this.buffer = pool.mallocUint8(nextPow2(r*c*4))\n      for(var i=0; i<r*c*4; ++i) {\n        buffer[i] = 0xff\n      }\n    }\n    return v\n  }\n})\n\nproto.begin = function() {\n  var gl = this.gl\n  var shape = this.shape\n  if(!gl) {\n    return\n  }\n\n  this.fbo.bind()\n  gl.clearColor(1,1,1,1)\n  gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT)\n}\n\nproto.end = function() {\n  var gl = this.gl\n  if(!gl) {\n    return\n  }\n  gl.bindFramebuffer(gl.FRAMEBUFFER, null)\n  if(!this._readTimeout) {\n    clearTimeout(this._readTimeout)\n  }\n  this._readTimeout = setTimeout(this._readCallback, 1)\n}\n\nproto.query = function(x, y, radius) {\n  if(!this.gl) {\n    return null\n  }\n\n  var shape = this.fbo.shape.slice()\n\n  x = x|0\n  y = y|0\n  if(typeof radius !== 'number') {\n    radius = 1.0\n  }\n\n  var x0 = Math.min(Math.max(x - radius, 0), shape[0])|0\n  var x1 = Math.min(Math.max(x + radius, 0), shape[0])|0\n  var y0 = Math.min(Math.max(y - radius, 0), shape[1])|0\n  var y1 = Math.min(Math.max(y + radius, 0), shape[1])|0\n\n  if(x1 <= x0 || y1 <= y0) {\n    return null\n  }\n\n  var dims   = [x1-x0,y1-y0]\n  var region = ndarray(\n    this.buffer,\n    [dims[0], dims[1], 4],\n    [4, shape[0]*4, 1],\n    4*(x0 + shape[0]*y0));\n\n  var closest = selectRange(region.hi(dims[0],dims[1],1), radius, radius)\n  var dx = closest[0]\n  var dy = closest[1]\n  if(dx < 0 || Math.pow(this.radius, 2) < closest[2]) {\n    return null\n  }\n\n  var c0 = region.get(dx, dy, 0)\n  var c1 = region.get(dx, dy, 1)\n  var c2 = region.get(dx, dy, 2)\n  var c3 = region.get(dx, dy, 3)\n\n  return new SelectResult(\n     (dx + x0)|0,\n     (dy + y0)|0,\n     c0,\n     [c1, c2, c3],\n     Math.sqrt(closest[2]))\n}\n\nproto.dispose = function() {\n  if(!this.gl) {\n    return\n  }\n  this.fbo.dispose()\n  pool.free(this.buffer)\n  this.gl = null\n  if(this._readTimeout) {\n    clearTimeout(this._readTimeout)\n  }\n}\n\nfunction createSelectBuffer(gl, shape) {\n  var width = shape[0]\n  var height = shape[1]\n  var options = {}\n  var fbo = createFBO(gl, width, height, options)\n  var buffer = pool.mallocUint8(width*height*4)\n  return new SelectBuffer(gl, fbo, buffer)\n}\n"]},"metadata":{},"sourceType":"script"}