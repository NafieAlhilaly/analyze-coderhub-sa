{"ast":null,"code":"'use strict';\n\nvar createTexture = require('gl-texture2d');\n\nmodule.exports = createFBO;\nvar colorAttachmentArrays = null;\nvar FRAMEBUFFER_UNSUPPORTED;\nvar FRAMEBUFFER_INCOMPLETE_ATTACHMENT;\nvar FRAMEBUFFER_INCOMPLETE_DIMENSIONS;\nvar FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT;\n\nfunction saveFBOState(gl) {\n  var fbo = gl.getParameter(gl.FRAMEBUFFER_BINDING);\n  var rbo = gl.getParameter(gl.RENDERBUFFER_BINDING);\n  var tex = gl.getParameter(gl.TEXTURE_BINDING_2D);\n  return [fbo, rbo, tex];\n}\n\nfunction restoreFBOState(gl, data) {\n  gl.bindFramebuffer(gl.FRAMEBUFFER, data[0]);\n  gl.bindRenderbuffer(gl.RENDERBUFFER, data[1]);\n  gl.bindTexture(gl.TEXTURE_2D, data[2]);\n}\n\nfunction lazyInitColorAttachments(gl, ext) {\n  var maxColorAttachments = gl.getParameter(ext.MAX_COLOR_ATTACHMENTS_WEBGL);\n  colorAttachmentArrays = new Array(maxColorAttachments + 1);\n\n  for (var i = 0; i <= maxColorAttachments; ++i) {\n    var x = new Array(maxColorAttachments);\n\n    for (var j = 0; j < i; ++j) {\n      x[j] = gl.COLOR_ATTACHMENT0 + j;\n    }\n\n    for (var j = i; j < maxColorAttachments; ++j) {\n      x[j] = gl.NONE;\n    }\n\n    colorAttachmentArrays[i] = x;\n  }\n} //Throw an appropriate error\n\n\nfunction throwFBOError(status) {\n  switch (status) {\n    case FRAMEBUFFER_UNSUPPORTED:\n      throw new Error('gl-fbo: Framebuffer unsupported');\n\n    case FRAMEBUFFER_INCOMPLETE_ATTACHMENT:\n      throw new Error('gl-fbo: Framebuffer incomplete attachment');\n\n    case FRAMEBUFFER_INCOMPLETE_DIMENSIONS:\n      throw new Error('gl-fbo: Framebuffer incomplete dimensions');\n\n    case FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:\n      throw new Error('gl-fbo: Framebuffer incomplete missing attachment');\n\n    default:\n      throw new Error('gl-fbo: Framebuffer failed for unspecified reason');\n  }\n} //Initialize a texture object\n\n\nfunction initTexture(gl, width, height, type, format, attachment) {\n  if (!type) {\n    return null;\n  }\n\n  var result = createTexture(gl, width, height, format, type);\n  result.magFilter = gl.NEAREST;\n  result.minFilter = gl.NEAREST;\n  result.mipSamples = 1;\n  result.bind();\n  gl.framebufferTexture2D(gl.FRAMEBUFFER, attachment, gl.TEXTURE_2D, result.handle, 0);\n  return result;\n} //Initialize a render buffer object\n\n\nfunction initRenderBuffer(gl, width, height, component, attachment) {\n  var result = gl.createRenderbuffer();\n  gl.bindRenderbuffer(gl.RENDERBUFFER, result);\n  gl.renderbufferStorage(gl.RENDERBUFFER, component, width, height);\n  gl.framebufferRenderbuffer(gl.FRAMEBUFFER, attachment, gl.RENDERBUFFER, result);\n  return result;\n} //Rebuild the frame buffer\n\n\nfunction rebuildFBO(fbo) {\n  //Save FBO state\n  var state = saveFBOState(fbo.gl);\n  var gl = fbo.gl;\n  var handle = fbo.handle = gl.createFramebuffer();\n  var width = fbo._shape[0];\n  var height = fbo._shape[1];\n  var numColors = fbo.color.length;\n  var ext = fbo._ext;\n  var useStencil = fbo._useStencil;\n  var useDepth = fbo._useDepth;\n  var colorType = fbo._colorType; //Bind the fbo\n\n  gl.bindFramebuffer(gl.FRAMEBUFFER, handle); //Allocate color buffers\n\n  for (var i = 0; i < numColors; ++i) {\n    fbo.color[i] = initTexture(gl, width, height, colorType, gl.RGBA, gl.COLOR_ATTACHMENT0 + i);\n  }\n\n  if (numColors === 0) {\n    fbo._color_rb = initRenderBuffer(gl, width, height, gl.RGBA4, gl.COLOR_ATTACHMENT0);\n\n    if (ext) {\n      ext.drawBuffersWEBGL(colorAttachmentArrays[0]);\n    }\n  } else if (numColors > 1) {\n    ext.drawBuffersWEBGL(colorAttachmentArrays[numColors]);\n  } //Allocate depth/stencil buffers\n\n\n  var WEBGL_depth_texture = gl.getExtension('WEBGL_depth_texture');\n\n  if (WEBGL_depth_texture) {\n    if (useStencil) {\n      fbo.depth = initTexture(gl, width, height, WEBGL_depth_texture.UNSIGNED_INT_24_8_WEBGL, gl.DEPTH_STENCIL, gl.DEPTH_STENCIL_ATTACHMENT);\n    } else if (useDepth) {\n      fbo.depth = initTexture(gl, width, height, gl.UNSIGNED_SHORT, gl.DEPTH_COMPONENT, gl.DEPTH_ATTACHMENT);\n    }\n  } else {\n    if (useDepth && useStencil) {\n      fbo._depth_rb = initRenderBuffer(gl, width, height, gl.DEPTH_STENCIL, gl.DEPTH_STENCIL_ATTACHMENT);\n    } else if (useDepth) {\n      fbo._depth_rb = initRenderBuffer(gl, width, height, gl.DEPTH_COMPONENT16, gl.DEPTH_ATTACHMENT);\n    } else if (useStencil) {\n      fbo._depth_rb = initRenderBuffer(gl, width, height, gl.STENCIL_INDEX, gl.STENCIL_ATTACHMENT);\n    }\n  } //Check frame buffer state\n\n\n  var status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);\n\n  if (status !== gl.FRAMEBUFFER_COMPLETE) {\n    //Release all partially allocated resources\n    fbo._destroyed = true; //Release all resources\n\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null);\n    gl.deleteFramebuffer(fbo.handle);\n    fbo.handle = null;\n\n    if (fbo.depth) {\n      fbo.depth.dispose();\n      fbo.depth = null;\n    }\n\n    if (fbo._depth_rb) {\n      gl.deleteRenderbuffer(fbo._depth_rb);\n      fbo._depth_rb = null;\n    }\n\n    for (var i = 0; i < fbo.color.length; ++i) {\n      fbo.color[i].dispose();\n      fbo.color[i] = null;\n    }\n\n    if (fbo._color_rb) {\n      gl.deleteRenderbuffer(fbo._color_rb);\n      fbo._color_rb = null;\n    }\n\n    restoreFBOState(gl, state); //Throw the frame buffer error\n\n    throwFBOError(status);\n  } //Everything ok, let's get on with life\n\n\n  restoreFBOState(gl, state);\n}\n\nfunction Framebuffer(gl, width, height, colorType, numColors, useDepth, useStencil, ext) {\n  //Handle and set properties\n  this.gl = gl;\n  this._shape = [width | 0, height | 0];\n  this._destroyed = false;\n  this._ext = ext; //Allocate buffers\n\n  this.color = new Array(numColors);\n\n  for (var i = 0; i < numColors; ++i) {\n    this.color[i] = null;\n  }\n\n  this._color_rb = null;\n  this.depth = null;\n  this._depth_rb = null; //Save depth and stencil flags\n\n  this._colorType = colorType;\n  this._useDepth = useDepth;\n  this._useStencil = useStencil; //Shape vector for resizing\n\n  var parent = this;\n  var shapeVector = [width | 0, height | 0];\n  Object.defineProperties(shapeVector, {\n    0: {\n      get: function get() {\n        return parent._shape[0];\n      },\n      set: function set(w) {\n        return parent.width = w;\n      }\n    },\n    1: {\n      get: function get() {\n        return parent._shape[1];\n      },\n      set: function set(h) {\n        return parent.height = h;\n      }\n    }\n  });\n  this._shapeVector = shapeVector; //Initialize all attachments\n\n  rebuildFBO(this);\n}\n\nvar proto = Framebuffer.prototype;\n\nfunction reshapeFBO(fbo, w, h) {\n  //If fbo is invalid, just skip this\n  if (fbo._destroyed) {\n    throw new Error('gl-fbo: Can\\'t resize destroyed FBO');\n  } //Don't resize if no change in shape\n\n\n  if (fbo._shape[0] === w && fbo._shape[1] === h) {\n    return;\n  }\n\n  var gl = fbo.gl; //Check parameter ranges\n\n  var maxFBOSize = gl.getParameter(gl.MAX_RENDERBUFFER_SIZE);\n\n  if (w < 0 || w > maxFBOSize || h < 0 || h > maxFBOSize) {\n    throw new Error('gl-fbo: Can\\'t resize FBO, invalid dimensions');\n  } //Update shape\n\n\n  fbo._shape[0] = w;\n  fbo._shape[1] = h; //Save framebuffer state\n\n  var state = saveFBOState(gl); //Resize framebuffer attachments\n\n  for (var i = 0; i < fbo.color.length; ++i) {\n    fbo.color[i].shape = fbo._shape;\n  }\n\n  if (fbo._color_rb) {\n    gl.bindRenderbuffer(gl.RENDERBUFFER, fbo._color_rb);\n    gl.renderbufferStorage(gl.RENDERBUFFER, gl.RGBA4, fbo._shape[0], fbo._shape[1]);\n  }\n\n  if (fbo.depth) {\n    fbo.depth.shape = fbo._shape;\n  }\n\n  if (fbo._depth_rb) {\n    gl.bindRenderbuffer(gl.RENDERBUFFER, fbo._depth_rb);\n\n    if (fbo._useDepth && fbo._useStencil) {\n      gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_STENCIL, fbo._shape[0], fbo._shape[1]);\n    } else if (fbo._useDepth) {\n      gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, fbo._shape[0], fbo._shape[1]);\n    } else if (fbo._useStencil) {\n      gl.renderbufferStorage(gl.RENDERBUFFER, gl.STENCIL_INDEX, fbo._shape[0], fbo._shape[1]);\n    }\n  } //Check FBO status after resize, if something broke then die in a fire\n\n\n  gl.bindFramebuffer(gl.FRAMEBUFFER, fbo.handle);\n  var status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);\n\n  if (status !== gl.FRAMEBUFFER_COMPLETE) {\n    fbo.dispose();\n    restoreFBOState(gl, state);\n    throwFBOError(status);\n  } //Restore framebuffer state\n\n\n  restoreFBOState(gl, state);\n}\n\nObject.defineProperties(proto, {\n  'shape': {\n    get: function get() {\n      if (this._destroyed) {\n        return [0, 0];\n      }\n\n      return this._shapeVector;\n    },\n    set: function set(x) {\n      if (!Array.isArray(x)) {\n        x = [x | 0, x | 0];\n      }\n\n      if (x.length !== 2) {\n        throw new Error('gl-fbo: Shape vector must be length 2');\n      }\n\n      var w = x[0] | 0;\n      var h = x[1] | 0;\n      reshapeFBO(this, w, h);\n      return [w, h];\n    },\n    enumerable: false\n  },\n  'width': {\n    get: function get() {\n      if (this._destroyed) {\n        return 0;\n      }\n\n      return this._shape[0];\n    },\n    set: function set(w) {\n      w = w | 0;\n      reshapeFBO(this, w, this._shape[1]);\n      return w;\n    },\n    enumerable: false\n  },\n  'height': {\n    get: function get() {\n      if (this._destroyed) {\n        return 0;\n      }\n\n      return this._shape[1];\n    },\n    set: function set(h) {\n      h = h | 0;\n      reshapeFBO(this, this._shape[0], h);\n      return h;\n    },\n    enumerable: false\n  }\n});\n\nproto.bind = function () {\n  if (this._destroyed) {\n    return;\n  }\n\n  var gl = this.gl;\n  gl.bindFramebuffer(gl.FRAMEBUFFER, this.handle);\n  gl.viewport(0, 0, this._shape[0], this._shape[1]);\n};\n\nproto.dispose = function () {\n  if (this._destroyed) {\n    return;\n  }\n\n  this._destroyed = true;\n  var gl = this.gl;\n  gl.deleteFramebuffer(this.handle);\n  this.handle = null;\n\n  if (this.depth) {\n    this.depth.dispose();\n    this.depth = null;\n  }\n\n  if (this._depth_rb) {\n    gl.deleteRenderbuffer(this._depth_rb);\n    this._depth_rb = null;\n  }\n\n  for (var i = 0; i < this.color.length; ++i) {\n    this.color[i].dispose();\n    this.color[i] = null;\n  }\n\n  if (this._color_rb) {\n    gl.deleteRenderbuffer(this._color_rb);\n    this._color_rb = null;\n  }\n};\n\nfunction createFBO(gl, width, height, options) {\n  //Update frame buffer error code values\n  if (!FRAMEBUFFER_UNSUPPORTED) {\n    FRAMEBUFFER_UNSUPPORTED = gl.FRAMEBUFFER_UNSUPPORTED;\n    FRAMEBUFFER_INCOMPLETE_ATTACHMENT = gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT;\n    FRAMEBUFFER_INCOMPLETE_DIMENSIONS = gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS;\n    FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT = gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT;\n  } //Lazily initialize color attachment arrays\n\n\n  var WEBGL_draw_buffers = gl.getExtension('WEBGL_draw_buffers');\n\n  if (!colorAttachmentArrays && WEBGL_draw_buffers) {\n    lazyInitColorAttachments(gl, WEBGL_draw_buffers);\n  } //Special case: Can accept an array as argument\n\n\n  if (Array.isArray(width)) {\n    options = height;\n    height = width[1] | 0;\n    width = width[0] | 0;\n  }\n\n  if (typeof width !== 'number') {\n    throw new Error('gl-fbo: Missing shape parameter');\n  } //Validate width/height properties\n\n\n  var maxFBOSize = gl.getParameter(gl.MAX_RENDERBUFFER_SIZE);\n\n  if (width < 0 || width > maxFBOSize || height < 0 || height > maxFBOSize) {\n    throw new Error('gl-fbo: Parameters are too large for FBO');\n  } //Handle each option type\n\n\n  options = options || {}; //Figure out number of color buffers to use\n\n  var numColors = 1;\n\n  if ('color' in options) {\n    numColors = Math.max(options.color | 0, 0);\n\n    if (numColors < 0) {\n      throw new Error('gl-fbo: Must specify a nonnegative number of colors');\n    }\n\n    if (numColors > 1) {\n      //Check if multiple render targets supported\n      if (!WEBGL_draw_buffers) {\n        throw new Error('gl-fbo: Multiple draw buffer extension not supported');\n      } else if (numColors > gl.getParameter(WEBGL_draw_buffers.MAX_COLOR_ATTACHMENTS_WEBGL)) {\n        throw new Error('gl-fbo: Context does not support ' + numColors + ' draw buffers');\n      }\n    }\n  } //Determine whether to use floating point textures\n\n\n  var colorType = gl.UNSIGNED_BYTE;\n  var OES_texture_float = gl.getExtension('OES_texture_float');\n\n  if (options.float && numColors > 0) {\n    if (!OES_texture_float) {\n      throw new Error('gl-fbo: Context does not support floating point textures');\n    }\n\n    colorType = gl.FLOAT;\n  } else if (options.preferFloat && numColors > 0) {\n    if (OES_texture_float) {\n      colorType = gl.FLOAT;\n    }\n  } //Check if we should use depth buffer\n\n\n  var useDepth = true;\n\n  if ('depth' in options) {\n    useDepth = !!options.depth;\n  } //Check if we should use a stencil buffer\n\n\n  var useStencil = false;\n\n  if ('stencil' in options) {\n    useStencil = !!options.stencil;\n  }\n\n  return new Framebuffer(gl, width, height, colorType, numColors, useDepth, useStencil, WEBGL_draw_buffers);\n}","map":{"version":3,"sources":["C:/Projects/reactApp/frontend/node_modules/gl-fbo/fbo.js"],"names":["createTexture","require","module","exports","createFBO","colorAttachmentArrays","FRAMEBUFFER_UNSUPPORTED","FRAMEBUFFER_INCOMPLETE_ATTACHMENT","FRAMEBUFFER_INCOMPLETE_DIMENSIONS","FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT","saveFBOState","gl","fbo","getParameter","FRAMEBUFFER_BINDING","rbo","RENDERBUFFER_BINDING","tex","TEXTURE_BINDING_2D","restoreFBOState","data","bindFramebuffer","FRAMEBUFFER","bindRenderbuffer","RENDERBUFFER","bindTexture","TEXTURE_2D","lazyInitColorAttachments","ext","maxColorAttachments","MAX_COLOR_ATTACHMENTS_WEBGL","Array","i","x","j","COLOR_ATTACHMENT0","NONE","throwFBOError","status","Error","initTexture","width","height","type","format","attachment","result","magFilter","NEAREST","minFilter","mipSamples","bind","framebufferTexture2D","handle","initRenderBuffer","component","createRenderbuffer","renderbufferStorage","framebufferRenderbuffer","rebuildFBO","state","createFramebuffer","_shape","numColors","color","length","_ext","useStencil","_useStencil","useDepth","_useDepth","colorType","_colorType","RGBA","_color_rb","RGBA4","drawBuffersWEBGL","WEBGL_depth_texture","getExtension","depth","UNSIGNED_INT_24_8_WEBGL","DEPTH_STENCIL","DEPTH_STENCIL_ATTACHMENT","UNSIGNED_SHORT","DEPTH_COMPONENT","DEPTH_ATTACHMENT","_depth_rb","DEPTH_COMPONENT16","STENCIL_INDEX","STENCIL_ATTACHMENT","checkFramebufferStatus","FRAMEBUFFER_COMPLETE","_destroyed","deleteFramebuffer","dispose","deleteRenderbuffer","Framebuffer","parent","shapeVector","Object","defineProperties","get","set","w","h","_shapeVector","proto","prototype","reshapeFBO","maxFBOSize","MAX_RENDERBUFFER_SIZE","shape","isArray","enumerable","viewport","options","WEBGL_draw_buffers","Math","max","UNSIGNED_BYTE","OES_texture_float","float","FLOAT","preferFloat","stencil"],"mappings":"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","sourcesContent":["'use strict'\n\nvar createTexture = require('gl-texture2d')\n\nmodule.exports = createFBO\n\nvar colorAttachmentArrays = null\nvar FRAMEBUFFER_UNSUPPORTED\nvar FRAMEBUFFER_INCOMPLETE_ATTACHMENT\nvar FRAMEBUFFER_INCOMPLETE_DIMENSIONS\nvar FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT\n\nfunction saveFBOState(gl) {\n  var fbo = gl.getParameter(gl.FRAMEBUFFER_BINDING)\n  var rbo = gl.getParameter(gl.RENDERBUFFER_BINDING)\n  var tex = gl.getParameter(gl.TEXTURE_BINDING_2D)\n  return [fbo, rbo, tex]\n}\n\nfunction restoreFBOState(gl, data) {\n  gl.bindFramebuffer(gl.FRAMEBUFFER, data[0])\n  gl.bindRenderbuffer(gl.RENDERBUFFER, data[1])\n  gl.bindTexture(gl.TEXTURE_2D, data[2])\n}\n\nfunction lazyInitColorAttachments(gl, ext) {\n  var maxColorAttachments = gl.getParameter(ext.MAX_COLOR_ATTACHMENTS_WEBGL)\n  colorAttachmentArrays = new Array(maxColorAttachments + 1)\n  for(var i=0; i<=maxColorAttachments; ++i) {\n    var x = new Array(maxColorAttachments)\n    for(var j=0; j<i; ++j) {\n      x[j] = gl.COLOR_ATTACHMENT0 + j\n    }\n    for(var j=i; j<maxColorAttachments; ++j) {\n      x[j] = gl.NONE\n    }\n    colorAttachmentArrays[i] = x\n  }\n}\n\n//Throw an appropriate error\nfunction throwFBOError(status) {\n  switch(status){\n    case FRAMEBUFFER_UNSUPPORTED:\n      throw new Error('gl-fbo: Framebuffer unsupported')\n    case FRAMEBUFFER_INCOMPLETE_ATTACHMENT:\n      throw new Error('gl-fbo: Framebuffer incomplete attachment')\n    case FRAMEBUFFER_INCOMPLETE_DIMENSIONS:\n      throw new Error('gl-fbo: Framebuffer incomplete dimensions')\n    case FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:\n      throw new Error('gl-fbo: Framebuffer incomplete missing attachment')\n    default:\n      throw new Error('gl-fbo: Framebuffer failed for unspecified reason')\n  }\n}\n\n//Initialize a texture object\nfunction initTexture(gl, width, height, type, format, attachment) {\n  if(!type) {\n    return null\n  }\n  var result = createTexture(gl, width, height, format, type)\n  result.magFilter = gl.NEAREST\n  result.minFilter = gl.NEAREST\n  result.mipSamples = 1\n  result.bind()\n  gl.framebufferTexture2D(gl.FRAMEBUFFER, attachment, gl.TEXTURE_2D, result.handle, 0)\n  return result\n}\n\n//Initialize a render buffer object\nfunction initRenderBuffer(gl, width, height, component, attachment) {\n  var result = gl.createRenderbuffer()\n  gl.bindRenderbuffer(gl.RENDERBUFFER, result)\n  gl.renderbufferStorage(gl.RENDERBUFFER, component, width, height)\n  gl.framebufferRenderbuffer(gl.FRAMEBUFFER, attachment, gl.RENDERBUFFER, result)\n  return result\n}\n\n//Rebuild the frame buffer\nfunction rebuildFBO(fbo) {\n\n  //Save FBO state\n  var state = saveFBOState(fbo.gl)\n\n  var gl = fbo.gl\n  var handle = fbo.handle = gl.createFramebuffer()\n  var width = fbo._shape[0]\n  var height = fbo._shape[1]\n  var numColors = fbo.color.length\n  var ext = fbo._ext\n  var useStencil = fbo._useStencil\n  var useDepth = fbo._useDepth\n  var colorType = fbo._colorType\n\n  //Bind the fbo\n  gl.bindFramebuffer(gl.FRAMEBUFFER, handle)\n\n  //Allocate color buffers\n  for(var i=0; i<numColors; ++i) {\n    fbo.color[i] = initTexture(gl, width, height, colorType, gl.RGBA, gl.COLOR_ATTACHMENT0 + i)\n  }\n  if(numColors === 0) {\n    fbo._color_rb = initRenderBuffer(gl, width, height, gl.RGBA4, gl.COLOR_ATTACHMENT0)\n    if(ext) {\n      ext.drawBuffersWEBGL(colorAttachmentArrays[0])\n    }\n  } else if(numColors > 1) {\n    ext.drawBuffersWEBGL(colorAttachmentArrays[numColors])\n  }\n\n  //Allocate depth/stencil buffers\n  var WEBGL_depth_texture = gl.getExtension('WEBGL_depth_texture')\n  if(WEBGL_depth_texture) {\n    if(useStencil) {\n      fbo.depth = initTexture(gl, width, height,\n                          WEBGL_depth_texture.UNSIGNED_INT_24_8_WEBGL,\n                          gl.DEPTH_STENCIL,\n                          gl.DEPTH_STENCIL_ATTACHMENT)\n    } else if(useDepth) {\n      fbo.depth = initTexture(gl, width, height,\n                          gl.UNSIGNED_SHORT,\n                          gl.DEPTH_COMPONENT,\n                          gl.DEPTH_ATTACHMENT)\n    }\n  } else {\n    if(useDepth && useStencil) {\n      fbo._depth_rb = initRenderBuffer(gl, width, height, gl.DEPTH_STENCIL, gl.DEPTH_STENCIL_ATTACHMENT)\n    } else if(useDepth) {\n      fbo._depth_rb = initRenderBuffer(gl, width, height, gl.DEPTH_COMPONENT16, gl.DEPTH_ATTACHMENT)\n    } else if(useStencil) {\n      fbo._depth_rb = initRenderBuffer(gl, width, height, gl.STENCIL_INDEX, gl.STENCIL_ATTACHMENT)\n    }\n  }\n\n  //Check frame buffer state\n  var status = gl.checkFramebufferStatus(gl.FRAMEBUFFER)\n  if(status !== gl.FRAMEBUFFER_COMPLETE) {\n\n    //Release all partially allocated resources\n    fbo._destroyed = true\n\n    //Release all resources\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null)\n    gl.deleteFramebuffer(fbo.handle)\n    fbo.handle = null\n    if(fbo.depth) {\n      fbo.depth.dispose()\n      fbo.depth = null\n    }\n    if(fbo._depth_rb) {\n      gl.deleteRenderbuffer(fbo._depth_rb)\n      fbo._depth_rb = null\n    }\n    for(var i=0; i<fbo.color.length; ++i) {\n      fbo.color[i].dispose()\n      fbo.color[i] = null\n    }\n    if(fbo._color_rb) {\n      gl.deleteRenderbuffer(fbo._color_rb)\n      fbo._color_rb = null\n    }\n\n    restoreFBOState(gl, state)\n\n    //Throw the frame buffer error\n    throwFBOError(status)\n  }\n\n  //Everything ok, let's get on with life\n  restoreFBOState(gl, state)\n}\n\nfunction Framebuffer(gl, width, height, colorType, numColors, useDepth, useStencil, ext) {\n\n  //Handle and set properties\n  this.gl = gl\n  this._shape = [width|0, height|0]\n  this._destroyed = false\n  this._ext = ext\n\n  //Allocate buffers\n  this.color = new Array(numColors)\n  for(var i=0; i<numColors; ++i) {\n    this.color[i] = null\n  }\n  this._color_rb = null\n  this.depth = null\n  this._depth_rb = null\n\n  //Save depth and stencil flags\n  this._colorType = colorType\n  this._useDepth = useDepth\n  this._useStencil = useStencil\n\n  //Shape vector for resizing\n  var parent = this\n  var shapeVector = [width|0, height|0]\n  Object.defineProperties(shapeVector, {\n    0: {\n      get: function() {\n        return parent._shape[0]\n      },\n      set: function(w) {\n        return parent.width = w\n      }\n    },\n    1: {\n      get: function() {\n        return parent._shape[1]\n      },\n      set: function(h) {\n        return parent.height = h\n      }\n    }\n  })\n  this._shapeVector = shapeVector\n\n  //Initialize all attachments\n  rebuildFBO(this)\n}\n\nvar proto = Framebuffer.prototype\n\nfunction reshapeFBO(fbo, w, h) {\n  //If fbo is invalid, just skip this\n  if(fbo._destroyed) {\n    throw new Error('gl-fbo: Can\\'t resize destroyed FBO')\n  }\n\n  //Don't resize if no change in shape\n  if( (fbo._shape[0] === w) &&\n      (fbo._shape[1] === h) ) {\n    return\n  }\n\n  var gl = fbo.gl\n\n  //Check parameter ranges\n  var maxFBOSize = gl.getParameter(gl.MAX_RENDERBUFFER_SIZE)\n  if( w < 0 || w > maxFBOSize ||\n      h < 0 || h > maxFBOSize) {\n    throw new Error('gl-fbo: Can\\'t resize FBO, invalid dimensions')\n  }\n\n  //Update shape\n  fbo._shape[0] = w\n  fbo._shape[1] = h\n\n  //Save framebuffer state\n  var state = saveFBOState(gl)\n\n  //Resize framebuffer attachments\n  for(var i=0; i<fbo.color.length; ++i) {\n    fbo.color[i].shape = fbo._shape\n  }\n  if(fbo._color_rb) {\n    gl.bindRenderbuffer(gl.RENDERBUFFER, fbo._color_rb)\n    gl.renderbufferStorage(gl.RENDERBUFFER, gl.RGBA4, fbo._shape[0], fbo._shape[1])\n  }\n  if(fbo.depth) {\n    fbo.depth.shape = fbo._shape\n  }\n  if(fbo._depth_rb) {\n    gl.bindRenderbuffer(gl.RENDERBUFFER, fbo._depth_rb)\n    if(fbo._useDepth && fbo._useStencil) {\n      gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_STENCIL, fbo._shape[0], fbo._shape[1])\n    } else if(fbo._useDepth) {\n      gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, fbo._shape[0], fbo._shape[1])\n    } else if(fbo._useStencil) {\n      gl.renderbufferStorage(gl.RENDERBUFFER, gl.STENCIL_INDEX, fbo._shape[0], fbo._shape[1])\n    }\n  }\n\n  //Check FBO status after resize, if something broke then die in a fire\n  gl.bindFramebuffer(gl.FRAMEBUFFER, fbo.handle)\n  var status = gl.checkFramebufferStatus(gl.FRAMEBUFFER)\n  if(status !== gl.FRAMEBUFFER_COMPLETE) {\n    fbo.dispose()\n    restoreFBOState(gl, state)\n    throwFBOError(status)\n  }\n\n  //Restore framebuffer state\n  restoreFBOState(gl, state)\n}\n\nObject.defineProperties(proto, {\n  'shape': {\n    get: function() {\n      if(this._destroyed) {\n        return [0,0]\n      }\n      return this._shapeVector\n    },\n    set: function(x) {\n      if(!Array.isArray(x)) {\n        x = [x|0, x|0]\n      }\n      if(x.length !== 2) {\n        throw new Error('gl-fbo: Shape vector must be length 2')\n      }\n\n      var w = x[0]|0\n      var h = x[1]|0\n      reshapeFBO(this, w, h)\n\n      return [w, h]\n    },\n    enumerable: false\n  },\n  'width': {\n    get: function() {\n      if(this._destroyed) {\n        return 0\n      }\n      return this._shape[0]\n    },\n    set: function(w) {\n      w = w|0\n      reshapeFBO(this, w, this._shape[1])\n      return w\n    },\n    enumerable: false\n  },\n  'height': {\n    get: function() {\n      if(this._destroyed) {\n        return 0\n      }\n      return this._shape[1]\n    },\n    set: function(h) {\n      h = h|0\n      reshapeFBO(this, this._shape[0], h)\n      return h\n    },\n    enumerable: false\n  }\n})\n\nproto.bind = function() {\n  if(this._destroyed) {\n    return\n  }\n  var gl = this.gl\n  gl.bindFramebuffer(gl.FRAMEBUFFER, this.handle)\n  gl.viewport(0, 0, this._shape[0], this._shape[1])\n}\n\nproto.dispose = function() {\n  if(this._destroyed) {\n    return\n  }\n  this._destroyed = true\n  var gl = this.gl\n  gl.deleteFramebuffer(this.handle)\n  this.handle = null\n  if(this.depth) {\n    this.depth.dispose()\n    this.depth = null\n  }\n  if(this._depth_rb) {\n    gl.deleteRenderbuffer(this._depth_rb)\n    this._depth_rb = null\n  }\n  for(var i=0; i<this.color.length; ++i) {\n    this.color[i].dispose()\n    this.color[i] = null\n  }\n  if(this._color_rb) {\n    gl.deleteRenderbuffer(this._color_rb)\n    this._color_rb = null\n  }\n}\n\nfunction createFBO(gl, width, height, options) {\n\n  //Update frame buffer error code values\n  if(!FRAMEBUFFER_UNSUPPORTED) {\n    FRAMEBUFFER_UNSUPPORTED = gl.FRAMEBUFFER_UNSUPPORTED\n    FRAMEBUFFER_INCOMPLETE_ATTACHMENT = gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT\n    FRAMEBUFFER_INCOMPLETE_DIMENSIONS = gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS\n    FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT = gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT\n  }\n\n  //Lazily initialize color attachment arrays\n  var WEBGL_draw_buffers = gl.getExtension('WEBGL_draw_buffers')\n  if(!colorAttachmentArrays && WEBGL_draw_buffers) {\n    lazyInitColorAttachments(gl, WEBGL_draw_buffers)\n  }\n\n  //Special case: Can accept an array as argument\n  if(Array.isArray(width)) {\n    options = height\n    height = width[1]|0\n    width = width[0]|0\n  }\n\n  if(typeof width !== 'number') {\n    throw new Error('gl-fbo: Missing shape parameter')\n  }\n\n  //Validate width/height properties\n  var maxFBOSize = gl.getParameter(gl.MAX_RENDERBUFFER_SIZE)\n  if(width < 0 || width > maxFBOSize || height < 0 || height > maxFBOSize) {\n    throw new Error('gl-fbo: Parameters are too large for FBO')\n  }\n\n  //Handle each option type\n  options = options || {}\n\n  //Figure out number of color buffers to use\n  var numColors = 1\n  if('color' in options) {\n    numColors = Math.max(options.color|0, 0)\n    if(numColors < 0) {\n      throw new Error('gl-fbo: Must specify a nonnegative number of colors')\n    }\n    if(numColors > 1) {\n      //Check if multiple render targets supported\n      if(!WEBGL_draw_buffers) {\n        throw new Error('gl-fbo: Multiple draw buffer extension not supported')\n      } else if(numColors > gl.getParameter(WEBGL_draw_buffers.MAX_COLOR_ATTACHMENTS_WEBGL)) {\n        throw new Error('gl-fbo: Context does not support ' + numColors + ' draw buffers')\n      }\n    }\n  }\n\n  //Determine whether to use floating point textures\n  var colorType = gl.UNSIGNED_BYTE\n  var OES_texture_float = gl.getExtension('OES_texture_float')\n  if(options.float && numColors > 0) {\n    if(!OES_texture_float) {\n      throw new Error('gl-fbo: Context does not support floating point textures')\n    }\n    colorType = gl.FLOAT\n  } else if(options.preferFloat && numColors > 0) {\n    if(OES_texture_float) {\n      colorType = gl.FLOAT\n    }\n  }\n\n  //Check if we should use depth buffer\n  var useDepth = true\n  if('depth' in options) {\n    useDepth = !!options.depth\n  }\n\n  //Check if we should use a stencil buffer\n  var useStencil = false\n  if('stencil' in options) {\n    useStencil = !!options.stencil\n  }\n\n  return new Framebuffer(\n    gl,\n    width,\n    height,\n    colorType,\n    numColors,\n    useDepth,\n    useStencil,\n    WEBGL_draw_buffers)\n}\n"]},"metadata":{},"sourceType":"script"}