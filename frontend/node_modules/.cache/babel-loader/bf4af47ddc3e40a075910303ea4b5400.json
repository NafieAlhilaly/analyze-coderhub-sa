{"ast":null,"code":"'use strict';\n\nvar ndarray = require('ndarray');\n\nvar ops = require('ndarray-ops');\n\nvar pool = require('typedarray-pool');\n\nmodule.exports = createTexture2D;\nvar linearTypes = null;\nvar filterTypes = null;\nvar wrapTypes = null;\n\nfunction lazyInitLinearTypes(gl) {\n  linearTypes = [gl.LINEAR, gl.NEAREST_MIPMAP_LINEAR, gl.LINEAR_MIPMAP_NEAREST, gl.LINEAR_MIPMAP_NEAREST];\n  filterTypes = [gl.NEAREST, gl.LINEAR, gl.NEAREST_MIPMAP_NEAREST, gl.NEAREST_MIPMAP_LINEAR, gl.LINEAR_MIPMAP_NEAREST, gl.LINEAR_MIPMAP_LINEAR];\n  wrapTypes = [gl.REPEAT, gl.CLAMP_TO_EDGE, gl.MIRRORED_REPEAT];\n}\n\nfunction acceptTextureDOM(obj) {\n  return 'undefined' != typeof HTMLCanvasElement && obj instanceof HTMLCanvasElement || 'undefined' != typeof HTMLImageElement && obj instanceof HTMLImageElement || 'undefined' != typeof HTMLVideoElement && obj instanceof HTMLVideoElement || 'undefined' != typeof ImageData && obj instanceof ImageData;\n}\n\nvar convertFloatToUint8 = function convertFloatToUint8(out, inp) {\n  ops.muls(out, inp, 255.0);\n};\n\nfunction reshapeTexture(tex, w, h) {\n  var gl = tex.gl;\n  var maxSize = gl.getParameter(gl.MAX_TEXTURE_SIZE);\n\n  if (w < 0 || w > maxSize || h < 0 || h > maxSize) {\n    throw new Error('gl-texture2d: Invalid texture size');\n  }\n\n  tex._shape = [w, h];\n  tex.bind();\n  gl.texImage2D(gl.TEXTURE_2D, 0, tex.format, w, h, 0, tex.format, tex.type, null);\n  tex._mipLevels = [0];\n  return tex;\n}\n\nfunction Texture2D(gl, handle, width, height, format, type) {\n  this.gl = gl;\n  this.handle = handle;\n  this.format = format;\n  this.type = type;\n  this._shape = [width, height];\n  this._mipLevels = [0];\n  this._magFilter = gl.NEAREST;\n  this._minFilter = gl.NEAREST;\n  this._wrapS = gl.CLAMP_TO_EDGE;\n  this._wrapT = gl.CLAMP_TO_EDGE;\n  this._anisoSamples = 1;\n  var parent = this;\n  var wrapVector = [this._wrapS, this._wrapT];\n  Object.defineProperties(wrapVector, [{\n    get: function get() {\n      return parent._wrapS;\n    },\n    set: function set(v) {\n      return parent.wrapS = v;\n    }\n  }, {\n    get: function get() {\n      return parent._wrapT;\n    },\n    set: function set(v) {\n      return parent.wrapT = v;\n    }\n  }]);\n  this._wrapVector = wrapVector;\n  var shapeVector = [this._shape[0], this._shape[1]];\n  Object.defineProperties(shapeVector, [{\n    get: function get() {\n      return parent._shape[0];\n    },\n    set: function set(v) {\n      return parent.width = v;\n    }\n  }, {\n    get: function get() {\n      return parent._shape[1];\n    },\n    set: function set(v) {\n      return parent.height = v;\n    }\n  }]);\n  this._shapeVector = shapeVector;\n}\n\nvar proto = Texture2D.prototype;\nObject.defineProperties(proto, {\n  minFilter: {\n    get: function get() {\n      return this._minFilter;\n    },\n    set: function set(v) {\n      this.bind();\n      var gl = this.gl;\n\n      if (this.type === gl.FLOAT && linearTypes.indexOf(v) >= 0) {\n        if (!gl.getExtension('OES_texture_float_linear')) {\n          v = gl.NEAREST;\n        }\n      }\n\n      if (filterTypes.indexOf(v) < 0) {\n        throw new Error('gl-texture2d: Unknown filter mode ' + v);\n      }\n\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, v);\n      return this._minFilter = v;\n    }\n  },\n  magFilter: {\n    get: function get() {\n      return this._magFilter;\n    },\n    set: function set(v) {\n      this.bind();\n      var gl = this.gl;\n\n      if (this.type === gl.FLOAT && linearTypes.indexOf(v) >= 0) {\n        if (!gl.getExtension('OES_texture_float_linear')) {\n          v = gl.NEAREST;\n        }\n      }\n\n      if (filterTypes.indexOf(v) < 0) {\n        throw new Error('gl-texture2d: Unknown filter mode ' + v);\n      }\n\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, v);\n      return this._magFilter = v;\n    }\n  },\n  mipSamples: {\n    get: function get() {\n      return this._anisoSamples;\n    },\n    set: function set(i) {\n      var psamples = this._anisoSamples;\n      this._anisoSamples = Math.max(i, 1) | 0;\n\n      if (psamples !== this._anisoSamples) {\n        var ext = this.gl.getExtension('EXT_texture_filter_anisotropic');\n\n        if (ext) {\n          this.gl.texParameterf(this.gl.TEXTURE_2D, ext.TEXTURE_MAX_ANISOTROPY_EXT, this._anisoSamples);\n        }\n      }\n\n      return this._anisoSamples;\n    }\n  },\n  wrapS: {\n    get: function get() {\n      return this._wrapS;\n    },\n    set: function set(v) {\n      this.bind();\n\n      if (wrapTypes.indexOf(v) < 0) {\n        throw new Error('gl-texture2d: Unknown wrap mode ' + v);\n      }\n\n      this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_S, v);\n      return this._wrapS = v;\n    }\n  },\n  wrapT: {\n    get: function get() {\n      return this._wrapT;\n    },\n    set: function set(v) {\n      this.bind();\n\n      if (wrapTypes.indexOf(v) < 0) {\n        throw new Error('gl-texture2d: Unknown wrap mode ' + v);\n      }\n\n      this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_T, v);\n      return this._wrapT = v;\n    }\n  },\n  wrap: {\n    get: function get() {\n      return this._wrapVector;\n    },\n    set: function set(v) {\n      if (!Array.isArray(v)) {\n        v = [v, v];\n      }\n\n      if (v.length !== 2) {\n        throw new Error('gl-texture2d: Must specify wrap mode for rows and columns');\n      }\n\n      for (var i = 0; i < 2; ++i) {\n        if (wrapTypes.indexOf(v[i]) < 0) {\n          throw new Error('gl-texture2d: Unknown wrap mode ' + v);\n        }\n      }\n\n      this._wrapS = v[0];\n      this._wrapT = v[1];\n      var gl = this.gl;\n      this.bind();\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, this._wrapS);\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, this._wrapT);\n      return v;\n    }\n  },\n  shape: {\n    get: function get() {\n      return this._shapeVector;\n    },\n    set: function set(x) {\n      if (!Array.isArray(x)) {\n        x = [x | 0, x | 0];\n      } else {\n        if (x.length !== 2) {\n          throw new Error('gl-texture2d: Invalid texture shape');\n        }\n      }\n\n      reshapeTexture(this, x[0] | 0, x[1] | 0);\n      return [x[0] | 0, x[1] | 0];\n    }\n  },\n  width: {\n    get: function get() {\n      return this._shape[0];\n    },\n    set: function set(w) {\n      w = w | 0;\n      reshapeTexture(this, w, this._shape[1]);\n      return w;\n    }\n  },\n  height: {\n    get: function get() {\n      return this._shape[1];\n    },\n    set: function set(h) {\n      h = h | 0;\n      reshapeTexture(this, this._shape[0], h);\n      return h;\n    }\n  }\n});\n\nproto.bind = function (unit) {\n  var gl = this.gl;\n\n  if (unit !== undefined) {\n    gl.activeTexture(gl.TEXTURE0 + (unit | 0));\n  }\n\n  gl.bindTexture(gl.TEXTURE_2D, this.handle);\n\n  if (unit !== undefined) {\n    return unit | 0;\n  }\n\n  return gl.getParameter(gl.ACTIVE_TEXTURE) - gl.TEXTURE0;\n};\n\nproto.dispose = function () {\n  this.gl.deleteTexture(this.handle);\n};\n\nproto.generateMipmap = function () {\n  this.bind();\n  this.gl.generateMipmap(this.gl.TEXTURE_2D); //Update mip levels\n\n  var l = Math.min(this._shape[0], this._shape[1]);\n\n  for (var i = 0; l > 0; ++i, l >>>= 1) {\n    if (this._mipLevels.indexOf(i) < 0) {\n      this._mipLevels.push(i);\n    }\n  }\n};\n\nproto.setPixels = function (data, x_off, y_off, mip_level) {\n  var gl = this.gl;\n  this.bind();\n\n  if (Array.isArray(x_off)) {\n    mip_level = y_off;\n    y_off = x_off[1] | 0;\n    x_off = x_off[0] | 0;\n  } else {\n    x_off = x_off || 0;\n    y_off = y_off || 0;\n  }\n\n  mip_level = mip_level || 0;\n  var directData = acceptTextureDOM(data) ? data : data.raw;\n\n  if (directData) {\n    var needsMip = this._mipLevels.indexOf(mip_level) < 0;\n\n    if (needsMip) {\n      gl.texImage2D(gl.TEXTURE_2D, 0, this.format, this.format, this.type, directData);\n\n      this._mipLevels.push(mip_level);\n    } else {\n      gl.texSubImage2D(gl.TEXTURE_2D, mip_level, x_off, y_off, this.format, this.type, directData);\n    }\n  } else if (data.shape && data.stride && data.data) {\n    if (data.shape.length < 2 || x_off + data.shape[1] > this._shape[1] >>> mip_level || y_off + data.shape[0] > this._shape[0] >>> mip_level || x_off < 0 || y_off < 0) {\n      throw new Error('gl-texture2d: Texture dimensions are out of bounds');\n    }\n\n    texSubImageArray(gl, x_off, y_off, mip_level, this.format, this.type, this._mipLevels, data);\n  } else {\n    throw new Error('gl-texture2d: Unsupported data type');\n  }\n};\n\nfunction isPacked(shape, stride) {\n  if (shape.length === 3) {\n    return stride[2] === 1 && stride[1] === shape[0] * shape[2] && stride[0] === shape[2];\n  }\n\n  return stride[0] === 1 && stride[1] === shape[0];\n}\n\nfunction texSubImageArray(gl, x_off, y_off, mip_level, cformat, ctype, mipLevels, array) {\n  var dtype = array.dtype;\n  var shape = array.shape.slice();\n\n  if (shape.length < 2 || shape.length > 3) {\n    throw new Error('gl-texture2d: Invalid ndarray, must be 2d or 3d');\n  }\n\n  var type = 0,\n      format = 0;\n  var packed = isPacked(shape, array.stride.slice());\n\n  if (dtype === 'float32') {\n    type = gl.FLOAT;\n  } else if (dtype === 'float64') {\n    type = gl.FLOAT;\n    packed = false;\n    dtype = 'float32';\n  } else if (dtype === 'uint8') {\n    type = gl.UNSIGNED_BYTE;\n  } else {\n    type = gl.UNSIGNED_BYTE;\n    packed = false;\n    dtype = 'uint8';\n  }\n\n  var channels = 1;\n\n  if (shape.length === 2) {\n    format = gl.LUMINANCE;\n    shape = [shape[0], shape[1], 1];\n    array = ndarray(array.data, shape, [array.stride[0], array.stride[1], 1], array.offset);\n  } else if (shape.length === 3) {\n    if (shape[2] === 1) {\n      format = gl.ALPHA;\n    } else if (shape[2] === 2) {\n      format = gl.LUMINANCE_ALPHA;\n    } else if (shape[2] === 3) {\n      format = gl.RGB;\n    } else if (shape[2] === 4) {\n      format = gl.RGBA;\n    } else {\n      throw new Error('gl-texture2d: Invalid shape for pixel coords');\n    }\n\n    channels = shape[2];\n  } else {\n    throw new Error('gl-texture2d: Invalid shape for texture');\n  } //For 1-channel textures allow conversion between formats\n\n\n  if ((format === gl.LUMINANCE || format === gl.ALPHA) && (cformat === gl.LUMINANCE || cformat === gl.ALPHA)) {\n    format = cformat;\n  }\n\n  if (format !== cformat) {\n    throw new Error('gl-texture2d: Incompatible texture format for setPixels');\n  }\n\n  var size = array.size;\n  var needsMip = mipLevels.indexOf(mip_level) < 0;\n\n  if (needsMip) {\n    mipLevels.push(mip_level);\n  }\n\n  if (type === ctype && packed) {\n    //Array data types are compatible, can directly copy into texture\n    if (array.offset === 0 && array.data.length === size) {\n      if (needsMip) {\n        gl.texImage2D(gl.TEXTURE_2D, mip_level, cformat, shape[0], shape[1], 0, cformat, ctype, array.data);\n      } else {\n        gl.texSubImage2D(gl.TEXTURE_2D, mip_level, x_off, y_off, shape[0], shape[1], cformat, ctype, array.data);\n      }\n    } else {\n      if (needsMip) {\n        gl.texImage2D(gl.TEXTURE_2D, mip_level, cformat, shape[0], shape[1], 0, cformat, ctype, array.data.subarray(array.offset, array.offset + size));\n      } else {\n        gl.texSubImage2D(gl.TEXTURE_2D, mip_level, x_off, y_off, shape[0], shape[1], cformat, ctype, array.data.subarray(array.offset, array.offset + size));\n      }\n    }\n  } else {\n    //Need to do type conversion to pack data into buffer\n    var pack_buffer;\n\n    if (ctype === gl.FLOAT) {\n      pack_buffer = pool.mallocFloat32(size);\n    } else {\n      pack_buffer = pool.mallocUint8(size);\n    }\n\n    var pack_view = ndarray(pack_buffer, shape, [shape[2], shape[2] * shape[0], 1]);\n\n    if (type === gl.FLOAT && ctype === gl.UNSIGNED_BYTE) {\n      convertFloatToUint8(pack_view, array);\n    } else {\n      ops.assign(pack_view, array);\n    }\n\n    if (needsMip) {\n      gl.texImage2D(gl.TEXTURE_2D, mip_level, cformat, shape[0], shape[1], 0, cformat, ctype, pack_buffer.subarray(0, size));\n    } else {\n      gl.texSubImage2D(gl.TEXTURE_2D, mip_level, x_off, y_off, shape[0], shape[1], cformat, ctype, pack_buffer.subarray(0, size));\n    }\n\n    if (ctype === gl.FLOAT) {\n      pool.freeFloat32(pack_buffer);\n    } else {\n      pool.freeUint8(pack_buffer);\n    }\n  }\n}\n\nfunction initTexture(gl) {\n  var tex = gl.createTexture();\n  gl.bindTexture(gl.TEXTURE_2D, tex);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n  return tex;\n}\n\nfunction createTextureShape(gl, width, height, format, type) {\n  var maxTextureSize = gl.getParameter(gl.MAX_TEXTURE_SIZE);\n\n  if (width < 0 || width > maxTextureSize || height < 0 || height > maxTextureSize) {\n    throw new Error('gl-texture2d: Invalid texture shape');\n  }\n\n  if (type === gl.FLOAT && !gl.getExtension('OES_texture_float')) {\n    throw new Error('gl-texture2d: Floating point textures not supported on this platform');\n  }\n\n  var tex = initTexture(gl);\n  gl.texImage2D(gl.TEXTURE_2D, 0, format, width, height, 0, format, type, null);\n  return new Texture2D(gl, tex, width, height, format, type);\n}\n\nfunction createTextureDOM(gl, directData, width, height, format, type) {\n  var tex = initTexture(gl);\n  gl.texImage2D(gl.TEXTURE_2D, 0, format, format, type, directData);\n  return new Texture2D(gl, tex, width, height, format, type);\n} //Creates a texture from an ndarray\n\n\nfunction createTextureArray(gl, array) {\n  var dtype = array.dtype;\n  var shape = array.shape.slice();\n  var maxSize = gl.getParameter(gl.MAX_TEXTURE_SIZE);\n\n  if (shape[0] < 0 || shape[0] > maxSize || shape[1] < 0 || shape[1] > maxSize) {\n    throw new Error('gl-texture2d: Invalid texture size');\n  }\n\n  var packed = isPacked(shape, array.stride.slice());\n  var type = 0;\n\n  if (dtype === 'float32') {\n    type = gl.FLOAT;\n  } else if (dtype === 'float64') {\n    type = gl.FLOAT;\n    packed = false;\n    dtype = 'float32';\n  } else if (dtype === 'uint8') {\n    type = gl.UNSIGNED_BYTE;\n  } else {\n    type = gl.UNSIGNED_BYTE;\n    packed = false;\n    dtype = 'uint8';\n  }\n\n  var format = 0;\n\n  if (shape.length === 2) {\n    format = gl.LUMINANCE;\n    shape = [shape[0], shape[1], 1];\n    array = ndarray(array.data, shape, [array.stride[0], array.stride[1], 1], array.offset);\n  } else if (shape.length === 3) {\n    if (shape[2] === 1) {\n      format = gl.ALPHA;\n    } else if (shape[2] === 2) {\n      format = gl.LUMINANCE_ALPHA;\n    } else if (shape[2] === 3) {\n      format = gl.RGB;\n    } else if (shape[2] === 4) {\n      format = gl.RGBA;\n    } else {\n      throw new Error('gl-texture2d: Invalid shape for pixel coords');\n    }\n  } else {\n    throw new Error('gl-texture2d: Invalid shape for texture');\n  }\n\n  if (type === gl.FLOAT && !gl.getExtension('OES_texture_float')) {\n    type = gl.UNSIGNED_BYTE;\n    packed = false;\n  }\n\n  var buffer, buf_store;\n  var size = array.size;\n\n  if (!packed) {\n    var stride = [shape[2], shape[2] * shape[0], 1];\n    buf_store = pool.malloc(size, dtype);\n    var buf_array = ndarray(buf_store, shape, stride, 0);\n\n    if ((dtype === 'float32' || dtype === 'float64') && type === gl.UNSIGNED_BYTE) {\n      convertFloatToUint8(buf_array, array);\n    } else {\n      ops.assign(buf_array, array);\n    }\n\n    buffer = buf_store.subarray(0, size);\n  } else if (array.offset === 0 && array.data.length === size) {\n    buffer = array.data;\n  } else {\n    buffer = array.data.subarray(array.offset, array.offset + size);\n  }\n\n  var tex = initTexture(gl);\n  gl.texImage2D(gl.TEXTURE_2D, 0, format, shape[0], shape[1], 0, format, type, buffer);\n\n  if (!packed) {\n    pool.free(buf_store);\n  }\n\n  return new Texture2D(gl, tex, shape[0], shape[1], format, type);\n}\n\nfunction createTexture2D(gl) {\n  if (arguments.length <= 1) {\n    throw new Error('gl-texture2d: Missing arguments for texture2d constructor');\n  }\n\n  if (!linearTypes) {\n    lazyInitLinearTypes(gl);\n  }\n\n  if (typeof arguments[1] === 'number') {\n    return createTextureShape(gl, arguments[1], arguments[2], arguments[3] || gl.RGBA, arguments[4] || gl.UNSIGNED_BYTE);\n  }\n\n  if (Array.isArray(arguments[1])) {\n    return createTextureShape(gl, arguments[1][0] | 0, arguments[1][1] | 0, arguments[2] || gl.RGBA, arguments[3] || gl.UNSIGNED_BYTE);\n  }\n\n  if (typeof arguments[1] === 'object') {\n    var obj = arguments[1];\n    var directData = acceptTextureDOM(obj) ? obj : obj.raw;\n\n    if (directData) {\n      return createTextureDOM(gl, directData, obj.width | 0, obj.height | 0, arguments[2] || gl.RGBA, arguments[3] || gl.UNSIGNED_BYTE);\n    } else if (obj.shape && obj.data && obj.stride) {\n      return createTextureArray(gl, obj);\n    }\n  }\n\n  throw new Error('gl-texture2d: Invalid arguments for texture2d constructor');\n}","map":{"version":3,"sources":["C:/Projects/reactApp/frontend/node_modules/gl-texture2d/texture.js"],"names":["ndarray","require","ops","pool","module","exports","createTexture2D","linearTypes","filterTypes","wrapTypes","lazyInitLinearTypes","gl","LINEAR","NEAREST_MIPMAP_LINEAR","LINEAR_MIPMAP_NEAREST","NEAREST","NEAREST_MIPMAP_NEAREST","LINEAR_MIPMAP_LINEAR","REPEAT","CLAMP_TO_EDGE","MIRRORED_REPEAT","acceptTextureDOM","obj","HTMLCanvasElement","HTMLImageElement","HTMLVideoElement","ImageData","convertFloatToUint8","out","inp","muls","reshapeTexture","tex","w","h","maxSize","getParameter","MAX_TEXTURE_SIZE","Error","_shape","bind","texImage2D","TEXTURE_2D","format","type","_mipLevels","Texture2D","handle","width","height","_magFilter","_minFilter","_wrapS","_wrapT","_anisoSamples","parent","wrapVector","Object","defineProperties","get","set","v","wrapS","wrapT","_wrapVector","shapeVector","_shapeVector","proto","prototype","minFilter","FLOAT","indexOf","getExtension","texParameteri","TEXTURE_MIN_FILTER","magFilter","TEXTURE_MAG_FILTER","mipSamples","i","psamples","Math","max","ext","texParameterf","TEXTURE_MAX_ANISOTROPY_EXT","TEXTURE_WRAP_S","TEXTURE_WRAP_T","wrap","Array","isArray","length","shape","x","unit","undefined","activeTexture","TEXTURE0","bindTexture","ACTIVE_TEXTURE","dispose","deleteTexture","generateMipmap","l","min","push","setPixels","data","x_off","y_off","mip_level","directData","raw","needsMip","texSubImage2D","stride","texSubImageArray","isPacked","cformat","ctype","mipLevels","array","dtype","slice","packed","UNSIGNED_BYTE","channels","LUMINANCE","offset","ALPHA","LUMINANCE_ALPHA","RGB","RGBA","size","subarray","pack_buffer","mallocFloat32","mallocUint8","pack_view","assign","freeFloat32","freeUint8","initTexture","createTexture","createTextureShape","maxTextureSize","createTextureDOM","createTextureArray","buffer","buf_store","malloc","buf_array","free","arguments"],"mappings":"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","sourcesContent":["'use strict'\n\nvar ndarray = require('ndarray')\nvar ops     = require('ndarray-ops')\nvar pool    = require('typedarray-pool')\n\nmodule.exports = createTexture2D\n\nvar linearTypes = null\nvar filterTypes = null\nvar wrapTypes   = null\n\nfunction lazyInitLinearTypes(gl) {\n  linearTypes = [\n    gl.LINEAR,\n    gl.NEAREST_MIPMAP_LINEAR,\n    gl.LINEAR_MIPMAP_NEAREST,\n    gl.LINEAR_MIPMAP_NEAREST\n  ]\n  filterTypes = [\n    gl.NEAREST,\n    gl.LINEAR,\n    gl.NEAREST_MIPMAP_NEAREST,\n    gl.NEAREST_MIPMAP_LINEAR,\n    gl.LINEAR_MIPMAP_NEAREST,\n    gl.LINEAR_MIPMAP_LINEAR\n  ]\n  wrapTypes = [\n    gl.REPEAT,\n    gl.CLAMP_TO_EDGE,\n    gl.MIRRORED_REPEAT\n  ]\n}\n\nfunction acceptTextureDOM (obj) {\n  return (\n    ('undefined' != typeof HTMLCanvasElement && obj instanceof HTMLCanvasElement) ||\n    ('undefined' != typeof HTMLImageElement && obj instanceof HTMLImageElement) ||\n    ('undefined' != typeof HTMLVideoElement && obj instanceof HTMLVideoElement) ||\n    ('undefined' != typeof ImageData && obj instanceof ImageData))\n}\n\nvar convertFloatToUint8 = function(out, inp) {\n  ops.muls(out, inp, 255.0)\n}\n\nfunction reshapeTexture(tex, w, h) {\n  var gl = tex.gl\n  var maxSize = gl.getParameter(gl.MAX_TEXTURE_SIZE)\n  if(w < 0 || w > maxSize || h < 0 || h > maxSize) {\n    throw new Error('gl-texture2d: Invalid texture size')\n  }\n  tex._shape = [w, h]\n  tex.bind()\n  gl.texImage2D(gl.TEXTURE_2D, 0, tex.format, w, h, 0, tex.format, tex.type, null)\n  tex._mipLevels = [0]\n  return tex\n}\n\nfunction Texture2D(gl, handle, width, height, format, type) {\n  this.gl = gl\n  this.handle = handle\n  this.format = format\n  this.type = type\n  this._shape = [width, height]\n  this._mipLevels = [0]\n  this._magFilter = gl.NEAREST\n  this._minFilter = gl.NEAREST\n  this._wrapS = gl.CLAMP_TO_EDGE\n  this._wrapT = gl.CLAMP_TO_EDGE\n  this._anisoSamples = 1\n\n  var parent = this\n  var wrapVector = [this._wrapS, this._wrapT]\n  Object.defineProperties(wrapVector, [\n    {\n      get: function() {\n        return parent._wrapS\n      },\n      set: function(v) {\n        return parent.wrapS = v\n      }\n    },\n    {\n      get: function() {\n        return parent._wrapT\n      },\n      set: function(v) {\n        return parent.wrapT = v\n      }\n    }\n  ])\n  this._wrapVector = wrapVector\n\n  var shapeVector = [this._shape[0], this._shape[1]]\n  Object.defineProperties(shapeVector, [\n    {\n      get: function() {\n        return parent._shape[0]\n      },\n      set: function(v) {\n        return parent.width = v\n      }\n    },\n    {\n      get: function() {\n        return parent._shape[1]\n      },\n      set: function(v) {\n        return parent.height = v\n      }\n    }\n  ])\n  this._shapeVector = shapeVector\n}\n\nvar proto = Texture2D.prototype\n\nObject.defineProperties(proto, {\n  minFilter: {\n    get: function() {\n      return this._minFilter\n    },\n    set: function(v) {\n      this.bind()\n      var gl = this.gl\n      if(this.type === gl.FLOAT && linearTypes.indexOf(v) >= 0) {\n        if(!gl.getExtension('OES_texture_float_linear')) {\n          v = gl.NEAREST\n        }\n      }\n      if(filterTypes.indexOf(v) < 0) {\n        throw new Error('gl-texture2d: Unknown filter mode ' + v)\n      }\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, v)\n      return this._minFilter = v\n    }\n  },\n  magFilter: {\n    get: function() {\n      return this._magFilter\n    },\n    set: function(v) {\n      this.bind()\n      var gl = this.gl\n      if(this.type === gl.FLOAT && linearTypes.indexOf(v) >= 0) {\n        if(!gl.getExtension('OES_texture_float_linear')) {\n          v = gl.NEAREST\n        }\n      }\n      if(filterTypes.indexOf(v) < 0) {\n        throw new Error('gl-texture2d: Unknown filter mode ' + v)\n      }\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, v)\n      return this._magFilter = v\n    }\n  },\n  mipSamples: {\n    get: function() {\n      return this._anisoSamples\n    },\n    set: function(i) {\n      var psamples = this._anisoSamples\n      this._anisoSamples = Math.max(i, 1)|0\n      if(psamples !== this._anisoSamples) {\n        var ext = this.gl.getExtension('EXT_texture_filter_anisotropic')\n        if(ext) {\n          this.gl.texParameterf(this.gl.TEXTURE_2D, ext.TEXTURE_MAX_ANISOTROPY_EXT, this._anisoSamples)\n        }\n      }\n      return this._anisoSamples\n    }\n  },\n  wrapS: {\n    get: function() {\n      return this._wrapS\n    },\n    set: function(v) {\n      this.bind()\n      if(wrapTypes.indexOf(v) < 0) {\n        throw new Error('gl-texture2d: Unknown wrap mode ' + v)\n      }\n      this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_S, v)\n      return this._wrapS = v\n    }\n  },\n  wrapT: {\n    get: function() {\n      return this._wrapT\n    },\n    set: function(v) {\n      this.bind()\n      if(wrapTypes.indexOf(v) < 0) {\n        throw new Error('gl-texture2d: Unknown wrap mode ' + v)\n      }\n      this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_T, v)\n      return this._wrapT = v\n    }\n  },\n  wrap: {\n    get: function() {\n      return this._wrapVector\n    },\n    set: function(v) {\n      if(!Array.isArray(v)) {\n        v = [v,v]\n      }\n      if(v.length !== 2) {\n        throw new Error('gl-texture2d: Must specify wrap mode for rows and columns')\n      }\n      for(var i=0; i<2; ++i) {\n        if(wrapTypes.indexOf(v[i]) < 0) {\n          throw new Error('gl-texture2d: Unknown wrap mode ' + v)\n        }\n      }\n      this._wrapS = v[0]\n      this._wrapT = v[1]\n\n      var gl = this.gl\n      this.bind()\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, this._wrapS)\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, this._wrapT)\n\n      return v\n    }\n  },\n  shape: {\n    get: function() {\n      return this._shapeVector\n    },\n    set: function(x) {\n      if(!Array.isArray(x)) {\n        x = [x|0,x|0]\n      } else {\n        if(x.length !== 2) {\n          throw new Error('gl-texture2d: Invalid texture shape')\n        }\n      }\n      reshapeTexture(this, x[0]|0, x[1]|0)\n      return [x[0]|0, x[1]|0]\n    }\n  },\n  width: {\n    get: function() {\n      return this._shape[0]\n    },\n    set: function(w) {\n      w = w|0\n      reshapeTexture(this, w, this._shape[1])\n      return w\n    }\n  },\n  height: {\n    get: function() {\n      return this._shape[1]\n    },\n    set: function(h) {\n      h = h|0\n      reshapeTexture(this, this._shape[0], h)\n      return h\n    }\n  }\n})\n\nproto.bind = function(unit) {\n  var gl = this.gl\n  if(unit !== undefined) {\n    gl.activeTexture(gl.TEXTURE0 + (unit|0))\n  }\n  gl.bindTexture(gl.TEXTURE_2D, this.handle)\n  if(unit !== undefined) {\n    return (unit|0)\n  }\n  return gl.getParameter(gl.ACTIVE_TEXTURE) - gl.TEXTURE0\n}\n\nproto.dispose = function() {\n  this.gl.deleteTexture(this.handle)\n}\n\nproto.generateMipmap = function() {\n  this.bind()\n  this.gl.generateMipmap(this.gl.TEXTURE_2D)\n\n  //Update mip levels\n  var l = Math.min(this._shape[0], this._shape[1])\n  for(var i=0; l>0; ++i, l>>>=1) {\n    if(this._mipLevels.indexOf(i) < 0) {\n      this._mipLevels.push(i)\n    }\n  }\n}\n\nproto.setPixels = function(data, x_off, y_off, mip_level) {\n  var gl = this.gl\n  this.bind()\n  if(Array.isArray(x_off)) {\n    mip_level = y_off\n    y_off = x_off[1]|0\n    x_off = x_off[0]|0\n  } else {\n    x_off = x_off || 0\n    y_off = y_off || 0\n  }\n  mip_level = mip_level || 0\n  var directData = acceptTextureDOM(data) ? data : data.raw\n  if(directData) {\n    var needsMip = this._mipLevels.indexOf(mip_level) < 0\n    if(needsMip) {\n      gl.texImage2D(gl.TEXTURE_2D, 0, this.format, this.format, this.type, directData)\n      this._mipLevels.push(mip_level)\n    } else {\n      gl.texSubImage2D(gl.TEXTURE_2D, mip_level, x_off, y_off, this.format, this.type, directData)\n    }\n  } else if(data.shape && data.stride && data.data) {\n    if(data.shape.length < 2 ||\n       x_off + data.shape[1] > this._shape[1]>>>mip_level ||\n       y_off + data.shape[0] > this._shape[0]>>>mip_level ||\n       x_off < 0 ||\n       y_off < 0) {\n      throw new Error('gl-texture2d: Texture dimensions are out of bounds')\n    }\n    texSubImageArray(gl, x_off, y_off, mip_level, this.format, this.type, this._mipLevels, data)\n  } else {\n    throw new Error('gl-texture2d: Unsupported data type')\n  }\n}\n\n\nfunction isPacked(shape, stride) {\n  if(shape.length === 3) {\n    return  (stride[2] === 1) &&\n            (stride[1] === shape[0]*shape[2]) &&\n            (stride[0] === shape[2])\n  }\n  return  (stride[0] === 1) &&\n          (stride[1] === shape[0])\n}\n\nfunction texSubImageArray(gl, x_off, y_off, mip_level, cformat, ctype, mipLevels, array) {\n  var dtype = array.dtype\n  var shape = array.shape.slice()\n  if(shape.length < 2 || shape.length > 3) {\n    throw new Error('gl-texture2d: Invalid ndarray, must be 2d or 3d')\n  }\n  var type = 0, format = 0\n  var packed = isPacked(shape, array.stride.slice())\n  if(dtype === 'float32') {\n    type = gl.FLOAT\n  } else if(dtype === 'float64') {\n    type = gl.FLOAT\n    packed = false\n    dtype = 'float32'\n  } else if(dtype === 'uint8') {\n    type = gl.UNSIGNED_BYTE\n  } else {\n    type = gl.UNSIGNED_BYTE\n    packed = false\n    dtype = 'uint8'\n  }\n  var channels = 1\n  if(shape.length === 2) {\n    format = gl.LUMINANCE\n    shape = [shape[0], shape[1], 1]\n    array = ndarray(array.data, shape, [array.stride[0], array.stride[1], 1], array.offset)\n  } else if(shape.length === 3) {\n    if(shape[2] === 1) {\n      format = gl.ALPHA\n    } else if(shape[2] === 2) {\n      format = gl.LUMINANCE_ALPHA\n    } else if(shape[2] === 3) {\n      format = gl.RGB\n    } else if(shape[2] === 4) {\n      format = gl.RGBA\n    } else {\n      throw new Error('gl-texture2d: Invalid shape for pixel coords')\n    }\n    channels = shape[2]\n  } else {\n    throw new Error('gl-texture2d: Invalid shape for texture')\n  }\n  //For 1-channel textures allow conversion between formats\n  if((format  === gl.LUMINANCE || format  === gl.ALPHA) &&\n     (cformat === gl.LUMINANCE || cformat === gl.ALPHA)) {\n    format = cformat\n  }\n  if(format !== cformat) {\n    throw new Error('gl-texture2d: Incompatible texture format for setPixels')\n  }\n  var size = array.size\n  var needsMip = mipLevels.indexOf(mip_level) < 0\n  if(needsMip) {\n    mipLevels.push(mip_level)\n  }\n  if(type === ctype && packed) {\n    //Array data types are compatible, can directly copy into texture\n    if(array.offset === 0 && array.data.length === size) {\n      if(needsMip) {\n        gl.texImage2D(gl.TEXTURE_2D, mip_level, cformat, shape[0], shape[1], 0, cformat, ctype, array.data)\n      } else {\n        gl.texSubImage2D(gl.TEXTURE_2D, mip_level, x_off, y_off, shape[0], shape[1], cformat, ctype, array.data)\n      }\n    } else {\n      if(needsMip) {\n        gl.texImage2D(gl.TEXTURE_2D, mip_level, cformat, shape[0], shape[1], 0, cformat, ctype, array.data.subarray(array.offset, array.offset+size))\n      } else {\n        gl.texSubImage2D(gl.TEXTURE_2D, mip_level, x_off, y_off, shape[0], shape[1], cformat, ctype, array.data.subarray(array.offset, array.offset+size))\n      }\n    }\n  } else {\n    //Need to do type conversion to pack data into buffer\n    var pack_buffer\n    if(ctype === gl.FLOAT) {\n      pack_buffer = pool.mallocFloat32(size)\n    } else {\n      pack_buffer = pool.mallocUint8(size)\n    }\n    var pack_view = ndarray(pack_buffer, shape, [shape[2], shape[2]*shape[0], 1])\n    if(type === gl.FLOAT && ctype === gl.UNSIGNED_BYTE) {\n      convertFloatToUint8(pack_view, array)\n    } else {\n      ops.assign(pack_view, array)\n    }\n    if(needsMip) {\n      gl.texImage2D(gl.TEXTURE_2D, mip_level, cformat, shape[0], shape[1], 0, cformat, ctype, pack_buffer.subarray(0, size))\n    } else {\n      gl.texSubImage2D(gl.TEXTURE_2D, mip_level, x_off, y_off, shape[0], shape[1], cformat, ctype, pack_buffer.subarray(0, size))\n    }\n    if(ctype === gl.FLOAT) {\n      pool.freeFloat32(pack_buffer)\n    } else {\n      pool.freeUint8(pack_buffer)\n    }\n  }\n}\n\nfunction initTexture(gl) {\n  var tex = gl.createTexture()\n  gl.bindTexture(gl.TEXTURE_2D, tex)\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST)\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST)\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE)\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE)\n  return tex\n}\n\nfunction createTextureShape(gl, width, height, format, type) {\n  var maxTextureSize = gl.getParameter(gl.MAX_TEXTURE_SIZE)\n  if(width < 0 || width > maxTextureSize || height < 0 || height  > maxTextureSize) {\n    throw new Error('gl-texture2d: Invalid texture shape')\n  }\n  if(type === gl.FLOAT && !gl.getExtension('OES_texture_float')) {\n    throw new Error('gl-texture2d: Floating point textures not supported on this platform')\n  }\n  var tex = initTexture(gl)\n  gl.texImage2D(gl.TEXTURE_2D, 0, format, width, height, 0, format, type, null)\n  return new Texture2D(gl, tex, width, height, format, type)\n}\n\nfunction createTextureDOM(gl, directData, width, height, format, type) {\n  var tex = initTexture(gl)\n  gl.texImage2D(gl.TEXTURE_2D, 0, format, format, type, directData)\n  return new Texture2D(gl, tex, width, height, format, type)\n}\n\n//Creates a texture from an ndarray\nfunction createTextureArray(gl, array) {\n  var dtype = array.dtype\n  var shape = array.shape.slice()\n  var maxSize = gl.getParameter(gl.MAX_TEXTURE_SIZE)\n  if(shape[0] < 0 || shape[0] > maxSize || shape[1] < 0 || shape[1] > maxSize) {\n    throw new Error('gl-texture2d: Invalid texture size')\n  }\n  var packed = isPacked(shape, array.stride.slice())\n  var type = 0\n  if(dtype === 'float32') {\n    type = gl.FLOAT\n  } else if(dtype === 'float64') {\n    type = gl.FLOAT\n    packed = false\n    dtype = 'float32'\n  } else if(dtype === 'uint8') {\n    type = gl.UNSIGNED_BYTE\n  } else {\n    type = gl.UNSIGNED_BYTE\n    packed = false\n    dtype = 'uint8'\n  }\n  var format = 0\n  if(shape.length === 2) {\n    format = gl.LUMINANCE\n    shape = [shape[0], shape[1], 1]\n    array = ndarray(array.data, shape, [array.stride[0], array.stride[1], 1], array.offset)\n  } else if(shape.length === 3) {\n    if(shape[2] === 1) {\n      format = gl.ALPHA\n    } else if(shape[2] === 2) {\n      format = gl.LUMINANCE_ALPHA\n    } else if(shape[2] === 3) {\n      format = gl.RGB\n    } else if(shape[2] === 4) {\n      format = gl.RGBA\n    } else {\n      throw new Error('gl-texture2d: Invalid shape for pixel coords')\n    }\n  } else {\n    throw new Error('gl-texture2d: Invalid shape for texture')\n  }\n  if(type === gl.FLOAT && !gl.getExtension('OES_texture_float')) {\n    type = gl.UNSIGNED_BYTE\n    packed = false\n  }\n  var buffer, buf_store\n  var size = array.size\n  if(!packed) {\n    var stride = [shape[2], shape[2]*shape[0], 1]\n    buf_store = pool.malloc(size, dtype)\n    var buf_array = ndarray(buf_store, shape, stride, 0)\n    if((dtype === 'float32' || dtype === 'float64') && type === gl.UNSIGNED_BYTE) {\n      convertFloatToUint8(buf_array, array)\n    } else {\n      ops.assign(buf_array, array)\n    }\n    buffer = buf_store.subarray(0, size)\n  } else if (array.offset === 0 && array.data.length === size) {\n    buffer = array.data\n  } else {\n    buffer = array.data.subarray(array.offset, array.offset + size)\n  }\n  var tex = initTexture(gl)\n  gl.texImage2D(gl.TEXTURE_2D, 0, format, shape[0], shape[1], 0, format, type, buffer)\n  if(!packed) {\n    pool.free(buf_store)\n  }\n  return new Texture2D(gl, tex, shape[0], shape[1], format, type)\n}\n\nfunction createTexture2D(gl) {\n  if(arguments.length <= 1) {\n    throw new Error('gl-texture2d: Missing arguments for texture2d constructor')\n  }\n  if(!linearTypes) {\n    lazyInitLinearTypes(gl)\n  }\n  if(typeof arguments[1] === 'number') {\n    return createTextureShape(gl, arguments[1], arguments[2], arguments[3]||gl.RGBA, arguments[4]||gl.UNSIGNED_BYTE)\n  }\n  if(Array.isArray(arguments[1])) {\n    return createTextureShape(gl, arguments[1][0]|0, arguments[1][1]|0, arguments[2]||gl.RGBA, arguments[3]||gl.UNSIGNED_BYTE)\n  }\n  if(typeof arguments[1] === 'object') {\n    var obj = arguments[1]\n    var directData = acceptTextureDOM(obj) ? obj : obj.raw\n    if (directData) {\n      return createTextureDOM(gl, directData, obj.width|0, obj.height|0, arguments[2]||gl.RGBA, arguments[3]||gl.UNSIGNED_BYTE)\n    } else if(obj.shape && obj.data && obj.stride) {\n      return createTextureArray(gl, obj)\n    }\n  }\n  throw new Error('gl-texture2d: Invalid arguments for texture2d constructor')\n}\n"]},"metadata":{},"sourceType":"script"}