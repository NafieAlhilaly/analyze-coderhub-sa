{"ast":null,"code":"'use strict';\n\nvar d3 = require('@plotly/d3');\n\nvar Lib = require('../../lib');\n\nvar strTranslate = Lib.strTranslate;\n\nvar xmlnsNamespaces = require('../../constants/xmlns_namespaces');\n\nvar constants = require('./constants');\n\nvar unsupportedBrowsers = Lib.isIOS() || Lib.isSafari() || Lib.isIE();\n\nmodule.exports = function plot(gd, plotinfo, cdimage, imageLayer) {\n  var xa = plotinfo.xaxis;\n  var ya = plotinfo.yaxis;\n  var supportsPixelatedImage = !(unsupportedBrowsers || gd._context._exportedPlot);\n  Lib.makeTraceGroups(imageLayer, cdimage, 'im').each(function (cd) {\n    var plotGroup = d3.select(this);\n    var cd0 = cd[0];\n    var trace = cd0.trace;\n    var realImage = (trace.zsmooth === 'fast' || trace.zsmooth === false && supportsPixelatedImage) && !trace._hasZ && trace._hasSource && xa.type === 'linear' && ya.type === 'linear';\n    trace._realImage = realImage;\n    var z = cd0.z;\n    var x0 = cd0.x0;\n    var y0 = cd0.y0;\n    var w = cd0.w;\n    var h = cd0.h;\n    var dx = trace.dx;\n    var dy = trace.dy;\n    var left, right, temp, top, bottom, i; // in case of log of a negative\n\n    i = 0;\n\n    while (left === undefined && i < w) {\n      left = xa.c2p(x0 + i * dx);\n      i++;\n    }\n\n    i = w;\n\n    while (right === undefined && i > 0) {\n      right = xa.c2p(x0 + i * dx);\n      i--;\n    }\n\n    i = 0;\n\n    while (top === undefined && i < h) {\n      top = ya.c2p(y0 + i * dy);\n      i++;\n    }\n\n    i = h;\n\n    while (bottom === undefined && i > 0) {\n      bottom = ya.c2p(y0 + i * dy);\n      i--;\n    }\n\n    if (right < left) {\n      temp = right;\n      right = left;\n      left = temp;\n    }\n\n    if (bottom < top) {\n      temp = top;\n      top = bottom;\n      bottom = temp;\n    } // Reduce image size when zoomed in to save memory\n\n\n    if (!realImage) {\n      var extra = 0.5; // half the axis size\n\n      left = Math.max(-extra * xa._length, left);\n      right = Math.min((1 + extra) * xa._length, right);\n      top = Math.max(-extra * ya._length, top);\n      bottom = Math.min((1 + extra) * ya._length, bottom);\n    }\n\n    var imageWidth = Math.round(right - left);\n    var imageHeight = Math.round(bottom - top); // if image is entirely off-screen, don't even draw it\n\n    var isOffScreen = imageWidth <= 0 || imageHeight <= 0;\n\n    if (isOffScreen) {\n      var noImage = plotGroup.selectAll('image').data([]);\n      noImage.exit().remove();\n      return;\n    } // Create a new canvas and draw magnified pixels on it\n\n\n    function drawMagnifiedPixelsOnCanvas(readPixel) {\n      var canvas = document.createElement('canvas');\n      canvas.width = imageWidth;\n      canvas.height = imageHeight;\n      var context = canvas.getContext('2d');\n\n      var ipx = function (i) {\n        return Lib.constrain(Math.round(xa.c2p(x0 + i * dx) - left), 0, imageWidth);\n      };\n\n      var jpx = function (j) {\n        return Lib.constrain(Math.round(ya.c2p(y0 + j * dy) - top), 0, imageHeight);\n      };\n\n      var cr = constants.colormodel[trace.colormodel];\n      var colormodel = cr.colormodel || trace.colormodel;\n      var fmt = cr.fmt;\n      var c;\n\n      for (i = 0; i < cd0.w; i++) {\n        var ipx0 = ipx(i);\n        var ipx1 = ipx(i + 1);\n        if (ipx1 === ipx0 || isNaN(ipx1) || isNaN(ipx0)) continue;\n\n        for (var j = 0; j < cd0.h; j++) {\n          var jpx0 = jpx(j);\n          var jpx1 = jpx(j + 1);\n          if (jpx1 === jpx0 || isNaN(jpx1) || isNaN(jpx0) || !readPixel(i, j)) continue;\n          c = trace._scaler(readPixel(i, j));\n\n          if (c) {\n            context.fillStyle = colormodel + '(' + fmt(c).join(',') + ')';\n          } else {\n            // Return a transparent pixel\n            context.fillStyle = 'rgba(0,0,0,0)';\n          }\n\n          context.fillRect(ipx0, jpx0, ipx1 - ipx0, jpx1 - jpx0);\n        }\n      }\n\n      return canvas;\n    }\n\n    var image3 = plotGroup.selectAll('image').data([cd]);\n    image3.enter().append('svg:image').attr({\n      xmlns: xmlnsNamespaces.svg,\n      preserveAspectRatio: 'none'\n    });\n    image3.exit().remove();\n    var style = trace.zsmooth === false ? constants.pixelatedStyle : '';\n\n    if (realImage) {\n      var xRange = Lib.simpleMap(xa.range, xa.r2l);\n      var yRange = Lib.simpleMap(ya.range, ya.r2l);\n      var flipX = xRange[1] < xRange[0];\n      var flipY = yRange[1] > yRange[0];\n\n      if (flipX || flipY) {\n        var tx = left + imageWidth / 2;\n        var ty = top + imageHeight / 2;\n        style += 'transform:' + strTranslate(tx + 'px', ty + 'px') + 'scale(' + (flipX ? -1 : 1) + ',' + (flipY ? -1 : 1) + ')' + strTranslate(-tx + 'px', -ty + 'px') + ';';\n      }\n    }\n\n    image3.attr('style', style);\n    var p = new Promise(function (resolve) {\n      if (trace._hasZ) {\n        resolve();\n      } else if (trace._hasSource) {\n        // Check if canvas already exists and has the right data\n        if (trace._canvas && trace._canvas.el.width === w && trace._canvas.el.height === h && trace._canvas.source === trace.source) {\n          resolve();\n        } else {\n          // Create a canvas and transfer image onto it to access pixel information\n          var canvas = document.createElement('canvas');\n          canvas.width = w;\n          canvas.height = h;\n          var context = canvas.getContext('2d');\n          trace._image = trace._image || new Image();\n          var image = trace._image;\n\n          image.onload = function () {\n            context.drawImage(image, 0, 0);\n            trace._canvas = {\n              el: canvas,\n              source: trace.source\n            };\n            resolve();\n          };\n\n          image.setAttribute('src', trace.source);\n        }\n      }\n    }).then(function () {\n      var href, canvas;\n\n      if (trace._hasZ) {\n        canvas = drawMagnifiedPixelsOnCanvas(function (i, j) {\n          return z[j][i];\n        });\n        href = canvas.toDataURL('image/png');\n      } else if (trace._hasSource) {\n        if (realImage) {\n          href = trace.source;\n        } else {\n          var context = trace._canvas.el.getContext('2d');\n\n          var data = context.getImageData(0, 0, w, h).data;\n          canvas = drawMagnifiedPixelsOnCanvas(function (i, j) {\n            var index = 4 * (j * w + i);\n            return [data[index], data[index + 1], data[index + 2], data[index + 3]];\n          });\n          href = canvas.toDataURL('image/png');\n        }\n      }\n\n      image3.attr({\n        'xlink:href': href,\n        height: imageHeight,\n        width: imageWidth,\n        x: left,\n        y: top\n      });\n    });\n\n    gd._promises.push(p);\n  });\n};","map":{"version":3,"sources":["C:/Projects/reactApp/analyse_coderhub/node_modules/plotly.js/src/traces/image/plot.js"],"names":["d3","require","Lib","strTranslate","xmlnsNamespaces","constants","unsupportedBrowsers","isIOS","isSafari","isIE","module","exports","plot","gd","plotinfo","cdimage","imageLayer","xa","xaxis","ya","yaxis","supportsPixelatedImage","_context","_exportedPlot","makeTraceGroups","each","cd","plotGroup","select","cd0","trace","realImage","zsmooth","_hasZ","_hasSource","type","_realImage","z","x0","y0","w","h","dx","dy","left","right","temp","top","bottom","i","undefined","c2p","extra","Math","max","_length","min","imageWidth","round","imageHeight","isOffScreen","noImage","selectAll","data","exit","remove","drawMagnifiedPixelsOnCanvas","readPixel","canvas","document","createElement","width","height","context","getContext","ipx","constrain","jpx","j","cr","colormodel","fmt","c","ipx0","ipx1","isNaN","jpx0","jpx1","_scaler","fillStyle","join","fillRect","image3","enter","append","attr","xmlns","svg","preserveAspectRatio","style","pixelatedStyle","xRange","simpleMap","range","r2l","yRange","flipX","flipY","tx","ty","p","Promise","resolve","_canvas","el","source","_image","Image","image","onload","drawImage","setAttribute","then","href","toDataURL","getImageData","index","x","y","_promises","push"],"mappings":"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","sourcesContent":["'use strict';\n\nvar d3 = require('@plotly/d3');\nvar Lib = require('../../lib');\nvar strTranslate = Lib.strTranslate;\nvar xmlnsNamespaces = require('../../constants/xmlns_namespaces');\nvar constants = require('./constants');\n\nvar unsupportedBrowsers = Lib.isIOS() || Lib.isSafari() || Lib.isIE();\n\nmodule.exports = function plot(gd, plotinfo, cdimage, imageLayer) {\n    var xa = plotinfo.xaxis;\n    var ya = plotinfo.yaxis;\n\n    var supportsPixelatedImage = !(unsupportedBrowsers || gd._context._exportedPlot);\n\n    Lib.makeTraceGroups(imageLayer, cdimage, 'im').each(function(cd) {\n        var plotGroup = d3.select(this);\n        var cd0 = cd[0];\n        var trace = cd0.trace;\n        var realImage = (\n            ((trace.zsmooth === 'fast') || (trace.zsmooth === false && supportsPixelatedImage)) &&\n            !trace._hasZ && trace._hasSource && xa.type === 'linear' && ya.type === 'linear'\n        );\n        trace._realImage = realImage;\n\n        var z = cd0.z;\n        var x0 = cd0.x0;\n        var y0 = cd0.y0;\n        var w = cd0.w;\n        var h = cd0.h;\n        var dx = trace.dx;\n        var dy = trace.dy;\n\n        var left, right, temp, top, bottom, i;\n        // in case of log of a negative\n        i = 0;\n        while(left === undefined && i < w) {\n            left = xa.c2p(x0 + i * dx);\n            i++;\n        }\n        i = w;\n        while(right === undefined && i > 0) {\n            right = xa.c2p(x0 + i * dx);\n            i--;\n        }\n        i = 0;\n        while(top === undefined && i < h) {\n            top = ya.c2p(y0 + i * dy);\n            i++;\n        }\n        i = h;\n        while(bottom === undefined && i > 0) {\n            bottom = ya.c2p(y0 + i * dy);\n            i--;\n        }\n\n        if(right < left) {\n            temp = right;\n            right = left;\n            left = temp;\n        }\n\n        if(bottom < top) {\n            temp = top;\n            top = bottom;\n            bottom = temp;\n        }\n\n        // Reduce image size when zoomed in to save memory\n        if(!realImage) {\n            var extra = 0.5; // half the axis size\n            left = Math.max(-extra * xa._length, left);\n            right = Math.min((1 + extra) * xa._length, right);\n            top = Math.max(-extra * ya._length, top);\n            bottom = Math.min((1 + extra) * ya._length, bottom);\n        }\n\n        var imageWidth = Math.round(right - left);\n        var imageHeight = Math.round(bottom - top);\n\n        // if image is entirely off-screen, don't even draw it\n        var isOffScreen = (imageWidth <= 0 || imageHeight <= 0);\n        if(isOffScreen) {\n            var noImage = plotGroup.selectAll('image').data([]);\n            noImage.exit().remove();\n            return;\n        }\n\n        // Create a new canvas and draw magnified pixels on it\n        function drawMagnifiedPixelsOnCanvas(readPixel) {\n            var canvas = document.createElement('canvas');\n            canvas.width = imageWidth;\n            canvas.height = imageHeight;\n            var context = canvas.getContext('2d');\n\n            var ipx = function(i) {return Lib.constrain(Math.round(xa.c2p(x0 + i * dx) - left), 0, imageWidth);};\n            var jpx = function(j) {return Lib.constrain(Math.round(ya.c2p(y0 + j * dy) - top), 0, imageHeight);};\n\n            var cr = constants.colormodel[trace.colormodel];\n            var colormodel = (cr.colormodel || trace.colormodel);\n            var fmt = cr.fmt;\n            var c;\n            for(i = 0; i < cd0.w; i++) {\n                var ipx0 = ipx(i); var ipx1 = ipx(i + 1);\n                if(ipx1 === ipx0 || isNaN(ipx1) || isNaN(ipx0)) continue;\n                for(var j = 0; j < cd0.h; j++) {\n                    var jpx0 = jpx(j); var jpx1 = jpx(j + 1);\n                    if(jpx1 === jpx0 || isNaN(jpx1) || isNaN(jpx0) || !readPixel(i, j)) continue;\n                    c = trace._scaler(readPixel(i, j));\n                    if(c) {\n                        context.fillStyle = colormodel + '(' + fmt(c).join(',') + ')';\n                    } else {\n                        // Return a transparent pixel\n                        context.fillStyle = 'rgba(0,0,0,0)';\n                    }\n                    context.fillRect(ipx0, jpx0, ipx1 - ipx0, jpx1 - jpx0);\n                }\n            }\n\n            return canvas;\n        }\n\n        var image3 = plotGroup.selectAll('image')\n            .data([cd]);\n\n        image3.enter().append('svg:image').attr({\n            xmlns: xmlnsNamespaces.svg,\n            preserveAspectRatio: 'none'\n        });\n\n        image3.exit().remove();\n\n        var style = (trace.zsmooth === false) ? constants.pixelatedStyle : '';\n\n        if(realImage) {\n            var xRange = Lib.simpleMap(xa.range, xa.r2l);\n            var yRange = Lib.simpleMap(ya.range, ya.r2l);\n\n            var flipX = xRange[1] < xRange[0];\n            var flipY = yRange[1] > yRange[0];\n            if(flipX || flipY) {\n                var tx = left + imageWidth / 2;\n                var ty = top + imageHeight / 2;\n                style += 'transform:' +\n                    strTranslate(tx + 'px', ty + 'px') +\n                    'scale(' + (flipX ? -1 : 1) + ',' + (flipY ? -1 : 1) + ')' +\n                    strTranslate(-tx + 'px', -ty + 'px') + ';';\n            }\n        }\n        image3.attr('style', style);\n\n        var p = new Promise(function(resolve) {\n            if(trace._hasZ) {\n                resolve();\n            } else if(trace._hasSource) {\n                // Check if canvas already exists and has the right data\n                if(\n                    trace._canvas &&\n                    trace._canvas.el.width === w &&\n                    trace._canvas.el.height === h &&\n                    trace._canvas.source === trace.source\n                ) {\n                    resolve();\n                } else {\n                    // Create a canvas and transfer image onto it to access pixel information\n                    var canvas = document.createElement('canvas');\n                    canvas.width = w;\n                    canvas.height = h;\n                    var context = canvas.getContext('2d');\n\n                    trace._image = trace._image || new Image();\n                    var image = trace._image;\n                    image.onload = function() {\n                        context.drawImage(image, 0, 0);\n                        trace._canvas = {\n                            el: canvas,\n                            source: trace.source\n                        };\n                        resolve();\n                    };\n                    image.setAttribute('src', trace.source);\n                }\n            }\n        })\n        .then(function() {\n            var href, canvas;\n            if(trace._hasZ) {\n                canvas = drawMagnifiedPixelsOnCanvas(function(i, j) {return z[j][i];});\n                href = canvas.toDataURL('image/png');\n            } else if(trace._hasSource) {\n                if(realImage) {\n                    href = trace.source;\n                } else {\n                    var context = trace._canvas.el.getContext('2d');\n                    var data = context.getImageData(0, 0, w, h).data;\n                    canvas = drawMagnifiedPixelsOnCanvas(function(i, j) {\n                        var index = 4 * (j * w + i);\n                        return [\n                            data[index],\n                            data[index + 1],\n                            data[index + 2],\n                            data[index + 3]\n                        ];\n                    });\n                    href = canvas.toDataURL('image/png');\n                }\n            }\n\n            image3.attr({\n                'xlink:href': href,\n                height: imageHeight,\n                width: imageWidth,\n                x: left,\n                y: top\n            });\n        });\n\n        gd._promises.push(p);\n    });\n};\n"]},"metadata":{},"sourceType":"script"}