{"ast":null,"code":"'use strict';\n\nmodule.exports = createHeatmap2D;\n\nvar bsearch = require('binary-search-bounds');\n\nvar iota = require('iota-array');\n\nvar pool = require('typedarray-pool');\n\nvar createShader = require('gl-shader');\n\nvar createBuffer = require('gl-buffer');\n\nvar shaders = require('./lib/shaders');\n\nfunction GLHeatmap2D(plot, shader, pickShader, positionBuffer, weightBuffer, colorBuffer, idBuffer) {\n  this.plot = plot;\n  this.shader = shader;\n  this.pickShader = pickShader;\n  this.positionBuffer = positionBuffer;\n  this.weightBuffer = weightBuffer;\n  this.colorBuffer = colorBuffer;\n  this.idBuffer = idBuffer;\n  this.xData = [];\n  this.yData = [];\n  this.shape = [0, 0];\n  this.bounds = [Infinity, Infinity, -Infinity, -Infinity];\n  this.pickOffset = 0;\n}\n\nvar proto = GLHeatmap2D.prototype;\nvar WEIGHTS = [0, 0, 1, 0, 0, 1, 1, 0, 1, 1, 0, 1];\n\nproto.draw = function () {\n  var MATRIX = [1, 0, 0, 0, 1, 0, 0, 0, 1];\n  return function () {\n    var plot = this.plot;\n    var shader = this.shader;\n    var bounds = this.bounds;\n    var numVertices = this.numVertices;\n\n    if (numVertices <= 0) {\n      return;\n    }\n\n    var gl = plot.gl;\n    var dataBox = plot.dataBox;\n    var boundX = bounds[2] - bounds[0];\n    var boundY = bounds[3] - bounds[1];\n    var dataX = dataBox[2] - dataBox[0];\n    var dataY = dataBox[3] - dataBox[1];\n    MATRIX[0] = 2.0 * boundX / dataX;\n    MATRIX[4] = 2.0 * boundY / dataY;\n    MATRIX[6] = 2.0 * (bounds[0] - dataBox[0]) / dataX - 1.0;\n    MATRIX[7] = 2.0 * (bounds[1] - dataBox[1]) / dataY - 1.0;\n    shader.bind();\n    var uniforms = shader.uniforms;\n    uniforms.viewTransform = MATRIX;\n    uniforms.shape = this.shape;\n    var attributes = shader.attributes;\n    this.positionBuffer.bind();\n    attributes.position.pointer();\n    this.weightBuffer.bind();\n    attributes.weight.pointer(gl.UNSIGNED_BYTE, false);\n    this.colorBuffer.bind();\n    attributes.color.pointer(gl.UNSIGNED_BYTE, true);\n    gl.drawArrays(gl.TRIANGLES, 0, numVertices);\n  };\n}();\n\nproto.drawPick = function () {\n  var MATRIX = [1, 0, 0, 0, 1, 0, 0, 0, 1];\n  var PICK_VECTOR = [0, 0, 0, 0];\n  return function (pickOffset) {\n    var plot = this.plot;\n    var shader = this.pickShader;\n    var bounds = this.bounds;\n    var numVertices = this.numVertices;\n\n    if (numVertices <= 0) {\n      return;\n    }\n\n    var gl = plot.gl;\n    var dataBox = plot.dataBox;\n    var boundX = bounds[2] - bounds[0];\n    var boundY = bounds[3] - bounds[1];\n    var dataX = dataBox[2] - dataBox[0];\n    var dataY = dataBox[3] - dataBox[1];\n    MATRIX[0] = 2.0 * boundX / dataX;\n    MATRIX[4] = 2.0 * boundY / dataY;\n    MATRIX[6] = 2.0 * (bounds[0] - dataBox[0]) / dataX - 1.0;\n    MATRIX[7] = 2.0 * (bounds[1] - dataBox[1]) / dataY - 1.0;\n\n    for (var i = 0; i < 4; ++i) {\n      PICK_VECTOR[i] = pickOffset >> i * 8 & 0xff;\n    }\n\n    this.pickOffset = pickOffset;\n    shader.bind();\n    var uniforms = shader.uniforms;\n    uniforms.viewTransform = MATRIX;\n    uniforms.pickOffset = PICK_VECTOR;\n    uniforms.shape = this.shape;\n    var attributes = shader.attributes;\n    this.positionBuffer.bind();\n    attributes.position.pointer();\n    this.weightBuffer.bind();\n    attributes.weight.pointer(gl.UNSIGNED_BYTE, false);\n    this.idBuffer.bind();\n    attributes.pickId.pointer(gl.UNSIGNED_BYTE, false);\n    gl.drawArrays(gl.TRIANGLES, 0, numVertices);\n    return pickOffset + this.shape[0] * this.shape[1];\n  };\n}();\n\nproto.pick = function (x, y, value) {\n  var pickOffset = this.pickOffset;\n  var pointCount = this.shape[0] * this.shape[1];\n\n  if (value < pickOffset || value >= pickOffset + pointCount) {\n    return null;\n  }\n\n  var pointId = value - pickOffset;\n  var xData = this.xData;\n  var yData = this.yData;\n  return {\n    object: this,\n    pointId: pointId,\n    dataCoord: [xData[pointId % this.shape[0]], yData[pointId / this.shape[0] | 0]]\n  };\n};\n\nproto.update = function (options) {\n  options = options || {};\n  var shape = options.shape || [0, 0];\n  var x = options.x || iota(shape[0]);\n  var y = options.y || iota(shape[1]);\n  var z = options.z || new Float32Array(shape[0] * shape[1]);\n  var isSmooth = options.zsmooth !== false;\n  this.xData = x;\n  this.yData = y;\n  var colorLevels = options.colorLevels || [0];\n  var colorValues = options.colorValues || [0, 0, 0, 1];\n  var colorCount = colorLevels.length;\n  var bounds = this.bounds;\n  var lox, loy, hix, hiy;\n\n  if (isSmooth) {\n    lox = bounds[0] = x[0];\n    loy = bounds[1] = y[0];\n    hix = bounds[2] = x[x.length - 1];\n    hiy = bounds[3] = y[y.length - 1];\n  } else {\n    // To get squares to centre on data values\n    lox = bounds[0] = x[0] + (x[1] - x[0]) / 2; // starting x value\n\n    loy = bounds[1] = y[0] + (y[1] - y[0]) / 2; // starting y value\n    // Bounds needs to add half a square on each end\n\n    hix = bounds[2] = x[x.length - 1] + (x[x.length - 1] - x[x.length - 2]) / 2;\n    hiy = bounds[3] = y[y.length - 1] + (y[y.length - 1] - y[y.length - 2]) / 2; // N.B. Resolution = 1 / range\n  }\n\n  var xs = 1.0 / (hix - lox);\n  var ys = 1.0 / (hiy - loy);\n  var numX = shape[0];\n  var numY = shape[1];\n  this.shape = [numX, numY];\n  var numVerts = (isSmooth ? (numX - 1) * (numY - 1) : numX * numY) * (WEIGHTS.length >>> 1);\n  this.numVertices = numVerts;\n  var colors = pool.mallocUint8(numVerts * 4);\n  var positions = pool.mallocFloat32(numVerts * 2);\n  var weights = pool.mallocUint8(numVerts * 2);\n  var ids = pool.mallocUint32(numVerts);\n  var ptr = 0;\n  var ni = isSmooth ? numX - 1 : numX;\n  var nj = isSmooth ? numY - 1 : numY;\n\n  for (var j = 0; j < nj; ++j) {\n    var yc0, yc1;\n\n    if (isSmooth) {\n      yc0 = ys * (y[j] - loy);\n      yc1 = ys * (y[j + 1] - loy);\n    } else {\n      yc0 = j < numY - 1 ? ys * (y[j] - (y[j + 1] - y[j]) / 2 - loy) : ys * (y[j] - (y[j] - y[j - 1]) / 2 - loy);\n      yc1 = j < numY - 1 ? ys * (y[j] + (y[j + 1] - y[j]) / 2 - loy) : ys * (y[j] + (y[j] - y[j - 1]) / 2 - loy);\n    }\n\n    for (var i = 0; i < ni; ++i) {\n      var xc0, xc1;\n\n      if (isSmooth) {\n        xc0 = xs * (x[i] - lox);\n        xc1 = xs * (x[i + 1] - lox);\n      } else {\n        xc0 = i < numX - 1 ? xs * (x[i] - (x[i + 1] - x[i]) / 2 - lox) : xs * (x[i] - (x[i] - x[i - 1]) / 2 - lox);\n        xc1 = i < numX - 1 ? xs * (x[i] + (x[i + 1] - x[i]) / 2 - lox) : xs * (x[i] + (x[i] - x[i - 1]) / 2 - lox);\n      }\n\n      for (var dd = 0; dd < WEIGHTS.length; dd += 2) {\n        var dx = WEIGHTS[dd];\n        var dy = WEIGHTS[dd + 1];\n        var offset = isSmooth ? (j + dy) * numX + (i + dx) : j * numX + i;\n        var zc = z[offset];\n        var colorIdx = bsearch.le(colorLevels, zc);\n        var r, g, b, a;\n\n        if (colorIdx < 0) {\n          r = colorValues[0];\n          g = colorValues[1];\n          b = colorValues[2];\n          a = colorValues[3];\n        } else if (colorIdx === colorCount - 1) {\n          r = colorValues[4 * colorCount - 4];\n          g = colorValues[4 * colorCount - 3];\n          b = colorValues[4 * colorCount - 2];\n          a = colorValues[4 * colorCount - 1];\n        } else {\n          var t = (zc - colorLevels[colorIdx]) / (colorLevels[colorIdx + 1] - colorLevels[colorIdx]);\n          var ti = 1.0 - t;\n          var i0 = 4 * colorIdx;\n          var i1 = 4 * (colorIdx + 1);\n          r = ti * colorValues[i0] + t * colorValues[i1];\n          g = ti * colorValues[i0 + 1] + t * colorValues[i1 + 1];\n          b = ti * colorValues[i0 + 2] + t * colorValues[i1 + 2];\n          a = ti * colorValues[i0 + 3] + t * colorValues[i1 + 3];\n        }\n\n        colors[4 * ptr] = 255 * r;\n        colors[4 * ptr + 1] = 255 * g;\n        colors[4 * ptr + 2] = 255 * b;\n        colors[4 * ptr + 3] = 255 * a;\n        positions[2 * ptr] = xc0 * .5 + xc1 * .5;\n        positions[2 * ptr + 1] = yc0 * .5 + yc1 * .5;\n        weights[2 * ptr] = dx;\n        weights[2 * ptr + 1] = dy;\n        ids[ptr] = j * numX + i;\n        ptr += 1;\n      }\n    }\n  }\n\n  this.positionBuffer.update(positions);\n  this.weightBuffer.update(weights);\n  this.colorBuffer.update(colors);\n  this.idBuffer.update(ids);\n  pool.free(positions);\n  pool.free(colors);\n  pool.free(weights);\n  pool.free(ids);\n};\n\nproto.dispose = function () {\n  this.shader.dispose();\n  this.pickShader.dispose();\n  this.positionBuffer.dispose();\n  this.weightBuffer.dispose();\n  this.colorBuffer.dispose();\n  this.idBuffer.dispose();\n  this.plot.removeObject(this);\n};\n\nfunction createHeatmap2D(plot, options) {\n  var gl = plot.gl;\n  var shader = createShader(gl, shaders.vertex, shaders.fragment);\n  var pickShader = createShader(gl, shaders.pickVertex, shaders.pickFragment);\n  var positionBuffer = createBuffer(gl);\n  var weightBuffer = createBuffer(gl);\n  var colorBuffer = createBuffer(gl);\n  var idBuffer = createBuffer(gl);\n  var heatmap = new GLHeatmap2D(plot, shader, pickShader, positionBuffer, weightBuffer, colorBuffer, idBuffer);\n  heatmap.update(options);\n  plot.addObject(heatmap);\n  return heatmap;\n}","map":{"version":3,"sources":["C:/Projects/reactApp/frontend/node_modules/gl-heatmap2d/heatmap.js"],"names":["module","exports","createHeatmap2D","bsearch","require","iota","pool","createShader","createBuffer","shaders","GLHeatmap2D","plot","shader","pickShader","positionBuffer","weightBuffer","colorBuffer","idBuffer","xData","yData","shape","bounds","Infinity","pickOffset","proto","prototype","WEIGHTS","draw","MATRIX","numVertices","gl","dataBox","boundX","boundY","dataX","dataY","bind","uniforms","viewTransform","attributes","position","pointer","weight","UNSIGNED_BYTE","color","drawArrays","TRIANGLES","drawPick","PICK_VECTOR","i","pickId","pick","x","y","value","pointCount","pointId","object","dataCoord","update","options","z","Float32Array","isSmooth","zsmooth","colorLevels","colorValues","colorCount","length","lox","loy","hix","hiy","xs","ys","numX","numY","numVerts","colors","mallocUint8","positions","mallocFloat32","weights","ids","mallocUint32","ptr","ni","nj","j","yc0","yc1","xc0","xc1","dd","dx","dy","offset","zc","colorIdx","le","r","g","b","a","t","ti","i0","i1","free","dispose","removeObject","vertex","fragment","pickVertex","pickFragment","heatmap","addObject"],"mappings":"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","sourcesContent":["'use strict'\n\nmodule.exports = createHeatmap2D\n\nvar bsearch = require('binary-search-bounds')\nvar iota = require('iota-array')\nvar pool = require('typedarray-pool')\nvar createShader = require('gl-shader')\nvar createBuffer = require('gl-buffer')\n\nvar shaders = require('./lib/shaders')\n\nfunction GLHeatmap2D (\n  plot,\n  shader,\n  pickShader,\n  positionBuffer,\n  weightBuffer,\n  colorBuffer,\n  idBuffer) {\n  this.plot = plot\n  this.shader = shader\n  this.pickShader = pickShader\n  this.positionBuffer = positionBuffer\n  this.weightBuffer = weightBuffer\n  this.colorBuffer = colorBuffer\n  this.idBuffer = idBuffer\n  this.xData = []\n  this.yData = []\n  this.shape = [0, 0]\n  this.bounds = [Infinity, Infinity, -Infinity, -Infinity]\n  this.pickOffset = 0\n}\n\nvar proto = GLHeatmap2D.prototype\n\nvar WEIGHTS = [\n  0, 0,\n  1, 0,\n  0, 1,\n  1, 0,\n  1, 1,\n  0, 1\n]\n\nproto.draw = (function () {\n  var MATRIX = [\n    1, 0, 0,\n    0, 1, 0,\n    0, 0, 1\n  ]\n\n  return function () {\n    var plot = this.plot\n    var shader = this.shader\n    var bounds = this.bounds\n    var numVertices = this.numVertices\n\n    if (numVertices <= 0) {\n      return\n    }\n\n    var gl = plot.gl\n    var dataBox = plot.dataBox\n\n    var boundX = bounds[2] - bounds[0]\n    var boundY = bounds[3] - bounds[1]\n    var dataX = dataBox[2] - dataBox[0]\n    var dataY = dataBox[3] - dataBox[1]\n\n    MATRIX[0] = 2.0 * boundX / dataX\n    MATRIX[4] = 2.0 * boundY / dataY\n    MATRIX[6] = 2.0 * (bounds[0] - dataBox[0]) / dataX - 1.0\n    MATRIX[7] = 2.0 * (bounds[1] - dataBox[1]) / dataY - 1.0\n\n    shader.bind()\n\n    var uniforms = shader.uniforms\n    uniforms.viewTransform = MATRIX\n\n    uniforms.shape = this.shape\n\n    var attributes = shader.attributes\n    this.positionBuffer.bind()\n    attributes.position.pointer()\n\n    this.weightBuffer.bind()\n    attributes.weight.pointer(gl.UNSIGNED_BYTE, false)\n\n    this.colorBuffer.bind()\n    attributes.color.pointer(gl.UNSIGNED_BYTE, true)\n\n    gl.drawArrays(gl.TRIANGLES, 0, numVertices)\n  }\n})()\n\nproto.drawPick = (function () {\n  var MATRIX = [\n    1, 0, 0,\n    0, 1, 0,\n    0, 0, 1\n  ]\n\n  var PICK_VECTOR = [0, 0, 0, 0]\n\n  return function (pickOffset) {\n    var plot = this.plot\n    var shader = this.pickShader\n    var bounds = this.bounds\n    var numVertices = this.numVertices\n\n    if (numVertices <= 0) {\n      return\n    }\n\n    var gl = plot.gl\n    var dataBox = plot.dataBox\n\n    var boundX = bounds[2] - bounds[0]\n    var boundY = bounds[3] - bounds[1]\n    var dataX = dataBox[2] - dataBox[0]\n    var dataY = dataBox[3] - dataBox[1]\n\n    MATRIX[0] = 2.0 * boundX / dataX\n    MATRIX[4] = 2.0 * boundY / dataY\n    MATRIX[6] = 2.0 * (bounds[0] - dataBox[0]) / dataX - 1.0\n    MATRIX[7] = 2.0 * (bounds[1] - dataBox[1]) / dataY - 1.0\n\n    for (var i = 0; i < 4; ++i) {\n      PICK_VECTOR[i] = (pickOffset >> (i * 8)) & 0xff\n    }\n\n    this.pickOffset = pickOffset\n\n    shader.bind()\n\n    var uniforms = shader.uniforms\n    uniforms.viewTransform = MATRIX\n    uniforms.pickOffset = PICK_VECTOR\n    uniforms.shape = this.shape\n\n    var attributes = shader.attributes\n    this.positionBuffer.bind()\n    attributes.position.pointer()\n\n    this.weightBuffer.bind()\n    attributes.weight.pointer(gl.UNSIGNED_BYTE, false)\n\n    this.idBuffer.bind()\n    attributes.pickId.pointer(gl.UNSIGNED_BYTE, false)\n\n    gl.drawArrays(gl.TRIANGLES, 0, numVertices)\n\n    return pickOffset + this.shape[0] * this.shape[1]\n  }\n})()\n\nproto.pick = function (x, y, value) {\n  var pickOffset = this.pickOffset\n  var pointCount = this.shape[0] * this.shape[1]\n  if (value < pickOffset || value >= pickOffset + pointCount) {\n    return null\n  }\n  var pointId = value - pickOffset\n  var xData = this.xData\n  var yData = this.yData\n  return {\n    object: this,\n    pointId: pointId,\n    dataCoord: [\n      xData[pointId % this.shape[0]],\n      yData[(pointId / this.shape[0]) | 0]]\n  }\n}\n\nproto.update = function (options) {\n  options = options || {}\n\n  var shape = options.shape || [0, 0]\n\n  var x = options.x || iota(shape[0])\n  var y = options.y || iota(shape[1])\n  var z = options.z || new Float32Array(shape[0] * shape[1])\n\n  var isSmooth = options.zsmooth !== false\n\n  this.xData = x\n  this.yData = y\n\n  var colorLevels = options.colorLevels || [0]\n  var colorValues = options.colorValues || [0, 0, 0, 1]\n  var colorCount = colorLevels.length\n\n  var bounds = this.bounds\n  var lox, loy, hix, hiy\n  if (isSmooth) {\n    lox = bounds[0] = x[0]\n    loy = bounds[1] = y[0]\n    hix = bounds[2] = x[x.length - 1]\n    hiy = bounds[3] = y[y.length - 1]\n  } else {\n    // To get squares to centre on data values\n    lox = bounds[0] = x[0] + (x[1] - x[0]) / 2 // starting x value\n    loy = bounds[1] = y[0] + (y[1] - y[0]) / 2 // starting y value\n\n    // Bounds needs to add half a square on each end\n    hix = bounds[2] = x[x.length - 1] + (x[x.length - 1] - x[x.length - 2]) / 2\n    hiy = bounds[3] = y[y.length - 1] + (y[y.length - 1] - y[y.length - 2]) / 2\n\n    // N.B. Resolution = 1 / range\n  }\n  var xs = 1.0 / (hix - lox)\n  var ys = 1.0 / (hiy - loy)\n\n  var numX = shape[0]\n  var numY = shape[1]\n\n  this.shape = [numX, numY]\n\n  var numVerts = (\n    isSmooth ? (numX - 1) * (numY - 1) : numX * numY\n  ) * (WEIGHTS.length >>> 1)\n\n  this.numVertices = numVerts\n\n  var colors = pool.mallocUint8(numVerts * 4)\n  var positions = pool.mallocFloat32(numVerts * 2)\n  var weights   = pool.mallocUint8 (numVerts * 2)\n  var ids = pool.mallocUint32(numVerts)\n\n  var ptr = 0\n\n  var ni = isSmooth ? numX - 1 : numX\n  var nj = isSmooth ? numY - 1 : numY\n\n  for (var j = 0; j < nj; ++j) {\n    var yc0, yc1\n\n    if (isSmooth) {\n      yc0 =  ys * (y[j] - loy)\n      yc1 =  ys * (y[j + 1] - loy)\n    } else {\n      yc0 = j < numY - 1 ? ys * (y[j] - (y[j + 1] - y[j])/2 - loy) : ys * (y[j] - (y[j] - y[j - 1])/2 - loy)\n      yc1 = j < numY - 1 ? ys * (y[j] + (y[j + 1] - y[j])/2 - loy) : ys * (y[j] + (y[j] - y[j - 1])/2 - loy)\n    }\n\n    for (var i = 0; i < ni; ++i) {\n      var xc0, xc1\n\n      if (isSmooth) {\n        xc0 = xs * (x[i] - lox)\n        xc1 = xs * (x[i + 1] - lox)\n      } else {\n        xc0 = i < numX - 1 ? xs * (x[i] - (x[i + 1] - x[i])/2 - lox) : xs * (x[i] - (x[i] - x[i - 1])/2 - lox)\n        xc1 = i < numX - 1 ? xs * (x[i] + (x[i + 1] - x[i])/2 - lox) : xs * (x[i] + (x[i] - x[i - 1])/2 - lox)\n      }\n\n      for (var dd = 0; dd < WEIGHTS.length; dd += 2) {\n        var dx = WEIGHTS[dd]\n        var dy = WEIGHTS[dd + 1]\n        var offset = isSmooth ? (j + dy) * numX + (i + dx) : j * numX + i\n        var zc = z[offset]\n        var colorIdx = bsearch.le(colorLevels, zc)\n        var r, g, b, a\n        if (colorIdx < 0) {\n          r = colorValues[0]\n          g = colorValues[1]\n          b = colorValues[2]\n          a = colorValues[3]\n        } else if (colorIdx === colorCount - 1) {\n          r = colorValues[4 * colorCount - 4]\n          g = colorValues[4 * colorCount - 3]\n          b = colorValues[4 * colorCount - 2]\n          a = colorValues[4 * colorCount - 1]\n        } else {\n          var t = (zc - colorLevels[colorIdx]) /\n            (colorLevels[colorIdx + 1] - colorLevels[colorIdx])\n          var ti = 1.0 - t\n          var i0 = 4 * colorIdx\n          var i1 = 4 * (colorIdx + 1)\n          r = ti * colorValues[i0] + t * colorValues[i1]\n          g = ti * colorValues[i0 + 1] + t * colorValues[i1 + 1]\n          b = ti * colorValues[i0 + 2] + t * colorValues[i1 + 2]\n          a = ti * colorValues[i0 + 3] + t * colorValues[i1 + 3]\n        }\n\n        colors[4 * ptr] = 255 * r\n        colors[4 * ptr + 1] = 255 * g\n        colors[4 * ptr + 2] = 255 * b\n        colors[4 * ptr + 3] = 255 * a\n\n        positions[2*ptr] = xc0*.5 + xc1*.5;\n        positions[2*ptr+1] = yc0*.5 + yc1*.5;\n\n        weights[2*ptr] = dx;\n        weights[2*ptr+1] = dy;\n\n        ids[ptr] = j * numX + i\n\n        ptr += 1\n      }\n    }\n  }\n\n  this.positionBuffer.update(positions)\n  this.weightBuffer.update(weights)\n  this.colorBuffer.update(colors)\n  this.idBuffer.update(ids)\n\n  pool.free(positions)\n  pool.free(colors)\n  pool.free(weights)\n  pool.free(ids)\n}\n\nproto.dispose = function () {\n  this.shader.dispose()\n  this.pickShader.dispose()\n  this.positionBuffer.dispose()\n  this.weightBuffer.dispose()\n  this.colorBuffer.dispose()\n  this.idBuffer.dispose()\n  this.plot.removeObject(this)\n}\n\nfunction createHeatmap2D (plot, options) {\n  var gl = plot.gl\n\n  var shader = createShader(gl, shaders.vertex, shaders.fragment)\n  var pickShader = createShader(gl, shaders.pickVertex, shaders.pickFragment)\n\n  var positionBuffer = createBuffer(gl)\n  var weightBuffer   = createBuffer(gl)\n  var colorBuffer = createBuffer(gl)\n  var idBuffer = createBuffer(gl)\n\n  var heatmap = new GLHeatmap2D(\n    plot,\n    shader,\n    pickShader,\n    positionBuffer,\n    weightBuffer,\n    colorBuffer,\n    idBuffer)\n\n  heatmap.update(options)\n  plot.addObject(heatmap)\n\n  return heatmap\n}\n"]},"metadata":{},"sourceType":"script"}