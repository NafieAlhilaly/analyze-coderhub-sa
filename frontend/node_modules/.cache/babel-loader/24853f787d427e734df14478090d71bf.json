{"ast":null,"code":"'use strict';\n\nvar Lib = require('../../lib');\n\nvar sanitizeHTML = require('../../lib/svg_text_utils').sanitizeHTML;\n\nvar convertTextOpts = require('./convert_text_opts');\n\nvar constants = require('./constants');\n\nfunction MapboxLayer(subplot, index) {\n  this.subplot = subplot;\n  this.uid = subplot.uid + '-' + index;\n  this.index = index;\n  this.idSource = 'source-' + this.uid;\n  this.idLayer = constants.layoutLayerPrefix + this.uid; // some state variable to check if a remove/add step is needed\n\n  this.sourceType = null;\n  this.source = null;\n  this.layerType = null;\n  this.below = null; // is layer currently visible\n\n  this.visible = false;\n}\n\nvar proto = MapboxLayer.prototype;\n\nproto.update = function update(opts) {\n  if (!this.visible) {\n    // IMPORTANT: must create source before layer to not cause errors\n    this.updateSource(opts);\n    this.updateLayer(opts);\n  } else if (this.needsNewImage(opts)) {\n    this.updateImage(opts);\n  } else if (this.needsNewSource(opts)) {\n    // IMPORTANT: must delete layer before source to not cause errors\n    this.removeLayer();\n    this.updateSource(opts);\n    this.updateLayer(opts);\n  } else if (this.needsNewLayer(opts)) {\n    this.updateLayer(opts);\n  } else {\n    this.updateStyle(opts);\n  }\n\n  this.visible = isVisible(opts);\n};\n\nproto.needsNewImage = function (opts) {\n  var map = this.subplot.map;\n  return map.getSource(this.idSource) && this.sourceType === 'image' && opts.sourcetype === 'image' && (this.source !== opts.source || JSON.stringify(this.coordinates) !== JSON.stringify(opts.coordinates));\n};\n\nproto.needsNewSource = function (opts) {\n  // for some reason changing layer to 'fill' or 'symbol'\n  // w/o changing the source throws an exception in mapbox-gl 0.18 ;\n  // stay safe and make new source on type changes\n  return this.sourceType !== opts.sourcetype || JSON.stringify(this.source) !== JSON.stringify(opts.source) || this.layerType !== opts.type;\n};\n\nproto.needsNewLayer = function (opts) {\n  return this.layerType !== opts.type || this.below !== this.subplot.belowLookup['layout-' + this.index];\n};\n\nproto.lookupBelow = function () {\n  return this.subplot.belowLookup['layout-' + this.index];\n};\n\nproto.updateImage = function (opts) {\n  var map = this.subplot.map;\n  map.getSource(this.idSource).updateImage({\n    url: opts.source,\n    coordinates: opts.coordinates\n  }); // Since the `updateImage` control flow doesn't call updateLayer,\n  // We need to take care of moving the image layer to match the location\n  // where updateLayer would have placed it.\n\n  var _below = this.findFollowingMapboxLayerId(this.lookupBelow());\n\n  if (_below !== null) {\n    this.subplot.map.moveLayer(this.idLayer, _below);\n  }\n};\n\nproto.updateSource = function (opts) {\n  var map = this.subplot.map;\n  if (map.getSource(this.idSource)) map.removeSource(this.idSource);\n  this.sourceType = opts.sourcetype;\n  this.source = opts.source;\n  if (!isVisible(opts)) return;\n  var sourceOpts = convertSourceOpts(opts);\n  map.addSource(this.idSource, sourceOpts);\n};\n\nproto.findFollowingMapboxLayerId = function (below) {\n  if (below === 'traces') {\n    var mapLayers = this.subplot.getMapLayers(); // find id of first plotly trace layer\n\n    for (var i = 0; i < mapLayers.length; i++) {\n      var layerId = mapLayers[i].id;\n\n      if (typeof layerId === 'string' && layerId.indexOf(constants.traceLayerPrefix) === 0) {\n        below = layerId;\n        break;\n      }\n    }\n  }\n\n  return below;\n};\n\nproto.updateLayer = function (opts) {\n  var subplot = this.subplot;\n  var convertedOpts = convertOpts(opts);\n  var below = this.lookupBelow();\n\n  var _below = this.findFollowingMapboxLayerId(below);\n\n  this.removeLayer();\n\n  if (isVisible(opts)) {\n    subplot.addLayer({\n      id: this.idLayer,\n      source: this.idSource,\n      'source-layer': opts.sourcelayer || '',\n      type: opts.type,\n      minzoom: opts.minzoom,\n      maxzoom: opts.maxzoom,\n      layout: convertedOpts.layout,\n      paint: convertedOpts.paint\n    }, _below);\n  }\n\n  this.layerType = opts.type;\n  this.below = below;\n};\n\nproto.updateStyle = function (opts) {\n  if (isVisible(opts)) {\n    var convertedOpts = convertOpts(opts);\n    this.subplot.setOptions(this.idLayer, 'setLayoutProperty', convertedOpts.layout);\n    this.subplot.setOptions(this.idLayer, 'setPaintProperty', convertedOpts.paint);\n  }\n};\n\nproto.removeLayer = function () {\n  var map = this.subplot.map;\n\n  if (map.getLayer(this.idLayer)) {\n    map.removeLayer(this.idLayer);\n  }\n};\n\nproto.dispose = function () {\n  var map = this.subplot.map;\n  if (map.getLayer(this.idLayer)) map.removeLayer(this.idLayer);\n  if (map.getSource(this.idSource)) map.removeSource(this.idSource);\n};\n\nfunction isVisible(opts) {\n  if (!opts.visible) return false;\n  var source = opts.source;\n\n  if (Array.isArray(source) && source.length > 0) {\n    for (var i = 0; i < source.length; i++) {\n      if (typeof source[i] !== 'string' || source[i].length === 0) {\n        return false;\n      }\n    }\n\n    return true;\n  }\n\n  return Lib.isPlainObject(source) || typeof source === 'string' && source.length > 0;\n}\n\nfunction convertOpts(opts) {\n  var layout = {};\n  var paint = {};\n\n  switch (opts.type) {\n    case 'circle':\n      Lib.extendFlat(paint, {\n        'circle-radius': opts.circle.radius,\n        'circle-color': opts.color,\n        'circle-opacity': opts.opacity\n      });\n      break;\n\n    case 'line':\n      Lib.extendFlat(paint, {\n        'line-width': opts.line.width,\n        'line-color': opts.color,\n        'line-opacity': opts.opacity,\n        'line-dasharray': opts.line.dash\n      });\n      break;\n\n    case 'fill':\n      Lib.extendFlat(paint, {\n        'fill-color': opts.color,\n        'fill-outline-color': opts.fill.outlinecolor,\n        'fill-opacity': opts.opacity // no way to pass specify outline width at the moment\n\n      });\n      break;\n\n    case 'symbol':\n      var symbol = opts.symbol;\n      var textOpts = convertTextOpts(symbol.textposition, symbol.iconsize);\n      Lib.extendFlat(layout, {\n        'icon-image': symbol.icon + '-15',\n        'icon-size': symbol.iconsize / 10,\n        'text-field': symbol.text,\n        'text-size': symbol.textfont.size,\n        'text-anchor': textOpts.anchor,\n        'text-offset': textOpts.offset,\n        'symbol-placement': symbol.placement // TODO font family\n        // 'text-font': symbol.textfont.family.split(', '),\n\n      });\n      Lib.extendFlat(paint, {\n        'icon-color': opts.color,\n        'text-color': symbol.textfont.color,\n        'text-opacity': opts.opacity\n      });\n      break;\n\n    case 'raster':\n      Lib.extendFlat(paint, {\n        'raster-fade-duration': 0,\n        'raster-opacity': opts.opacity\n      });\n      break;\n  }\n\n  return {\n    layout: layout,\n    paint: paint\n  };\n}\n\nfunction convertSourceOpts(opts) {\n  var sourceType = opts.sourcetype;\n  var source = opts.source;\n  var sourceOpts = {\n    type: sourceType\n  };\n  var field;\n\n  if (sourceType === 'geojson') {\n    field = 'data';\n  } else if (sourceType === 'vector') {\n    field = typeof source === 'string' ? 'url' : 'tiles';\n  } else if (sourceType === 'raster') {\n    field = 'tiles';\n    sourceOpts.tileSize = 256;\n  } else if (sourceType === 'image') {\n    field = 'url';\n    sourceOpts.coordinates = opts.coordinates;\n  }\n\n  sourceOpts[field] = source;\n\n  if (opts.sourceattribution) {\n    sourceOpts.attribution = sanitizeHTML(opts.sourceattribution);\n  }\n\n  return sourceOpts;\n}\n\nmodule.exports = function createMapboxLayer(subplot, index, opts) {\n  var mapboxLayer = new MapboxLayer(subplot, index);\n  mapboxLayer.update(opts);\n  return mapboxLayer;\n};","map":{"version":3,"sources":["C:/Projects/reactApp/frontend/node_modules/plotly.js/src/plots/mapbox/layers.js"],"names":["Lib","require","sanitizeHTML","convertTextOpts","constants","MapboxLayer","subplot","index","uid","idSource","idLayer","layoutLayerPrefix","sourceType","source","layerType","below","visible","proto","prototype","update","opts","updateSource","updateLayer","needsNewImage","updateImage","needsNewSource","removeLayer","needsNewLayer","updateStyle","isVisible","map","getSource","sourcetype","JSON","stringify","coordinates","type","belowLookup","lookupBelow","url","_below","findFollowingMapboxLayerId","moveLayer","removeSource","sourceOpts","convertSourceOpts","addSource","mapLayers","getMapLayers","i","length","layerId","id","indexOf","traceLayerPrefix","convertedOpts","convertOpts","addLayer","sourcelayer","minzoom","maxzoom","layout","paint","setOptions","getLayer","dispose","Array","isArray","isPlainObject","extendFlat","circle","radius","color","opacity","line","width","dash","fill","outlinecolor","symbol","textOpts","textposition","iconsize","icon","text","textfont","size","anchor","offset","placement","field","tileSize","sourceattribution","attribution","module","exports","createMapboxLayer","mapboxLayer"],"mappings":"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","sourcesContent":["'use strict';\n\nvar Lib = require('../../lib');\nvar sanitizeHTML = require('../../lib/svg_text_utils').sanitizeHTML;\nvar convertTextOpts = require('./convert_text_opts');\nvar constants = require('./constants');\n\nfunction MapboxLayer(subplot, index) {\n    this.subplot = subplot;\n\n    this.uid = subplot.uid + '-' + index;\n    this.index = index;\n\n    this.idSource = 'source-' + this.uid;\n    this.idLayer = constants.layoutLayerPrefix + this.uid;\n\n    // some state variable to check if a remove/add step is needed\n    this.sourceType = null;\n    this.source = null;\n    this.layerType = null;\n    this.below = null;\n\n    // is layer currently visible\n    this.visible = false;\n}\n\nvar proto = MapboxLayer.prototype;\n\nproto.update = function update(opts) {\n    if(!this.visible) {\n        // IMPORTANT: must create source before layer to not cause errors\n        this.updateSource(opts);\n        this.updateLayer(opts);\n    } else if(this.needsNewImage(opts)) {\n        this.updateImage(opts);\n    } else if(this.needsNewSource(opts)) {\n        // IMPORTANT: must delete layer before source to not cause errors\n        this.removeLayer();\n        this.updateSource(opts);\n        this.updateLayer(opts);\n    } else if(this.needsNewLayer(opts)) {\n        this.updateLayer(opts);\n    } else {\n        this.updateStyle(opts);\n    }\n\n    this.visible = isVisible(opts);\n};\n\nproto.needsNewImage = function(opts) {\n    var map = this.subplot.map;\n    return (\n        map.getSource(this.idSource) &&\n        this.sourceType === 'image' &&\n        opts.sourcetype === 'image' &&\n        (this.source !== opts.source ||\n            JSON.stringify(this.coordinates) !==\n            JSON.stringify(opts.coordinates))\n    );\n};\n\nproto.needsNewSource = function(opts) {\n    // for some reason changing layer to 'fill' or 'symbol'\n    // w/o changing the source throws an exception in mapbox-gl 0.18 ;\n    // stay safe and make new source on type changes\n    return (\n        this.sourceType !== opts.sourcetype ||\n        JSON.stringify(this.source) !== JSON.stringify(opts.source) ||\n        this.layerType !== opts.type\n    );\n};\n\nproto.needsNewLayer = function(opts) {\n    return (\n        this.layerType !== opts.type ||\n        this.below !== this.subplot.belowLookup['layout-' + this.index]\n    );\n};\n\nproto.lookupBelow = function() {\n    return this.subplot.belowLookup['layout-' + this.index];\n};\n\nproto.updateImage = function(opts) {\n    var map = this.subplot.map;\n    map.getSource(this.idSource).updateImage({\n        url: opts.source, coordinates: opts.coordinates\n    });\n\n    // Since the `updateImage` control flow doesn't call updateLayer,\n    // We need to take care of moving the image layer to match the location\n    // where updateLayer would have placed it.\n    var _below = this.findFollowingMapboxLayerId(this.lookupBelow());\n    if(_below !== null) {\n        this.subplot.map.moveLayer(this.idLayer, _below);\n    }\n};\n\nproto.updateSource = function(opts) {\n    var map = this.subplot.map;\n\n    if(map.getSource(this.idSource)) map.removeSource(this.idSource);\n\n    this.sourceType = opts.sourcetype;\n    this.source = opts.source;\n\n    if(!isVisible(opts)) return;\n\n    var sourceOpts = convertSourceOpts(opts);\n\n    map.addSource(this.idSource, sourceOpts);\n};\n\nproto.findFollowingMapboxLayerId = function(below) {\n    if(below === 'traces') {\n        var mapLayers = this.subplot.getMapLayers();\n\n        // find id of first plotly trace layer\n        for(var i = 0; i < mapLayers.length; i++) {\n            var layerId = mapLayers[i].id;\n            if(typeof layerId === 'string' &&\n                layerId.indexOf(constants.traceLayerPrefix) === 0\n            ) {\n                below = layerId;\n                break;\n            }\n        }\n    }\n    return below;\n};\n\nproto.updateLayer = function(opts) {\n    var subplot = this.subplot;\n    var convertedOpts = convertOpts(opts);\n    var below = this.lookupBelow();\n    var _below = this.findFollowingMapboxLayerId(below);\n\n    this.removeLayer();\n\n    if(isVisible(opts)) {\n        subplot.addLayer({\n            id: this.idLayer,\n            source: this.idSource,\n            'source-layer': opts.sourcelayer || '',\n            type: opts.type,\n            minzoom: opts.minzoom,\n            maxzoom: opts.maxzoom,\n            layout: convertedOpts.layout,\n            paint: convertedOpts.paint\n        }, _below);\n    }\n\n    this.layerType = opts.type;\n    this.below = below;\n};\n\nproto.updateStyle = function(opts) {\n    if(isVisible(opts)) {\n        var convertedOpts = convertOpts(opts);\n        this.subplot.setOptions(this.idLayer, 'setLayoutProperty', convertedOpts.layout);\n        this.subplot.setOptions(this.idLayer, 'setPaintProperty', convertedOpts.paint);\n    }\n};\n\nproto.removeLayer = function() {\n    var map = this.subplot.map;\n    if(map.getLayer(this.idLayer)) {\n        map.removeLayer(this.idLayer);\n    }\n};\n\nproto.dispose = function() {\n    var map = this.subplot.map;\n    if(map.getLayer(this.idLayer)) map.removeLayer(this.idLayer);\n    if(map.getSource(this.idSource)) map.removeSource(this.idSource);\n};\n\nfunction isVisible(opts) {\n    if(!opts.visible) return false;\n\n    var source = opts.source;\n\n    if(Array.isArray(source) && source.length > 0) {\n        for(var i = 0; i < source.length; i++) {\n            if(typeof source[i] !== 'string' || source[i].length === 0) {\n                return false;\n            }\n        }\n        return true;\n    }\n\n    return Lib.isPlainObject(source) ||\n        (typeof source === 'string' && source.length > 0);\n}\n\nfunction convertOpts(opts) {\n    var layout = {};\n    var paint = {};\n\n    switch(opts.type) {\n        case 'circle':\n            Lib.extendFlat(paint, {\n                'circle-radius': opts.circle.radius,\n                'circle-color': opts.color,\n                'circle-opacity': opts.opacity\n            });\n            break;\n\n        case 'line':\n            Lib.extendFlat(paint, {\n                'line-width': opts.line.width,\n                'line-color': opts.color,\n                'line-opacity': opts.opacity,\n                'line-dasharray': opts.line.dash\n            });\n            break;\n\n        case 'fill':\n            Lib.extendFlat(paint, {\n                'fill-color': opts.color,\n                'fill-outline-color': opts.fill.outlinecolor,\n                'fill-opacity': opts.opacity\n\n                // no way to pass specify outline width at the moment\n            });\n            break;\n\n        case 'symbol':\n            var symbol = opts.symbol;\n            var textOpts = convertTextOpts(symbol.textposition, symbol.iconsize);\n\n            Lib.extendFlat(layout, {\n                'icon-image': symbol.icon + '-15',\n                'icon-size': symbol.iconsize / 10,\n\n                'text-field': symbol.text,\n                'text-size': symbol.textfont.size,\n                'text-anchor': textOpts.anchor,\n                'text-offset': textOpts.offset,\n                'symbol-placement': symbol.placement,\n\n                // TODO font family\n                // 'text-font': symbol.textfont.family.split(', '),\n            });\n\n            Lib.extendFlat(paint, {\n                'icon-color': opts.color,\n                'text-color': symbol.textfont.color,\n                'text-opacity': opts.opacity\n            });\n            break;\n        case 'raster':\n            Lib.extendFlat(paint, {\n                'raster-fade-duration': 0,\n                'raster-opacity': opts.opacity\n            });\n            break;\n    }\n\n    return {\n        layout: layout,\n        paint: paint\n    };\n}\n\nfunction convertSourceOpts(opts) {\n    var sourceType = opts.sourcetype;\n    var source = opts.source;\n    var sourceOpts = {type: sourceType};\n    var field;\n\n    if(sourceType === 'geojson') {\n        field = 'data';\n    } else if(sourceType === 'vector') {\n        field = typeof source === 'string' ? 'url' : 'tiles';\n    } else if(sourceType === 'raster') {\n        field = 'tiles';\n        sourceOpts.tileSize = 256;\n    } else if(sourceType === 'image') {\n        field = 'url';\n        sourceOpts.coordinates = opts.coordinates;\n    }\n\n    sourceOpts[field] = source;\n\n    if(opts.sourceattribution) {\n        sourceOpts.attribution = sanitizeHTML(opts.sourceattribution);\n    }\n\n    return sourceOpts;\n}\n\nmodule.exports = function createMapboxLayer(subplot, index, opts) {\n    var mapboxLayer = new MapboxLayer(subplot, index);\n\n    mapboxLayer.update(opts);\n\n    return mapboxLayer;\n};\n"]},"metadata":{},"sourceType":"script"}