{"ast":null,"code":"'use strict';\n\nvar d3 = require('@plotly/d3');\n\nvar Plots = require('../../plots/plots');\n\nvar Fx = require('../../components/fx');\n\nvar Color = require('../../components/color');\n\nvar Drawing = require('../../components/drawing');\n\nvar Lib = require('../../lib');\n\nvar strScale = Lib.strScale;\nvar strTranslate = Lib.strTranslate;\n\nvar svgTextUtils = require('../../lib/svg_text_utils');\n\nvar uniformText = require('../bar/uniform_text');\n\nvar recordMinTextSize = uniformText.recordMinTextSize;\nvar clearMinTextSize = uniformText.clearMinTextSize;\n\nvar TEXTPAD = require('../bar/constants').TEXTPAD;\n\nvar helpers = require('./helpers');\n\nvar eventData = require('./event_data');\n\nvar isValidTextValue = require('../../lib').isValidTextValue;\n\nfunction plot(gd, cdModule) {\n  var fullLayout = gd._fullLayout;\n  var gs = fullLayout._size;\n  clearMinTextSize('pie', fullLayout);\n  prerenderTitles(cdModule, gd);\n  layoutAreas(cdModule, gs);\n  var plotGroups = Lib.makeTraceGroups(fullLayout._pielayer, cdModule, 'trace').each(function (cd) {\n    var plotGroup = d3.select(this);\n    var cd0 = cd[0];\n    var trace = cd0.trace;\n    setCoords(cd); // TODO: miter might look better but can sometimes cause problems\n    // maybe miter with a small-ish stroke-miterlimit?\n\n    plotGroup.attr('stroke-linejoin', 'round');\n    plotGroup.each(function () {\n      var slices = d3.select(this).selectAll('g.slice').data(cd);\n      slices.enter().append('g').classed('slice', true);\n      slices.exit().remove();\n      var quadrants = [[[], []], // y<0: x<0, x>=0\n      [[], []] // y>=0: x<0, x>=0\n      ];\n      var hasOutsideText = false;\n      slices.each(function (pt, i) {\n        if (pt.hidden) {\n          d3.select(this).selectAll('path,g').remove();\n          return;\n        } // to have consistent event data compared to other traces\n\n\n        pt.pointNumber = pt.i;\n        pt.curveNumber = trace.index;\n        quadrants[pt.pxmid[1] < 0 ? 0 : 1][pt.pxmid[0] < 0 ? 0 : 1].push(pt);\n        var cx = cd0.cx;\n        var cy = cd0.cy;\n        var sliceTop = d3.select(this);\n        var slicePath = sliceTop.selectAll('path.surface').data([pt]);\n        slicePath.enter().append('path').classed('surface', true).style({\n          'pointer-events': 'all'\n        });\n        sliceTop.call(attachFxHandlers, gd, cd);\n\n        if (trace.pull) {\n          var pull = +helpers.castOption(trace.pull, pt.pts) || 0;\n\n          if (pull > 0) {\n            cx += pull * pt.pxmid[0];\n            cy += pull * pt.pxmid[1];\n          }\n        }\n\n        pt.cxFinal = cx;\n        pt.cyFinal = cy;\n\n        function arc(start, finish, cw, scale) {\n          var dx = scale * (finish[0] - start[0]);\n          var dy = scale * (finish[1] - start[1]);\n          return 'a' + scale * cd0.r + ',' + scale * cd0.r + ' 0 ' + pt.largeArc + (cw ? ' 1 ' : ' 0 ') + dx + ',' + dy;\n        }\n\n        var hole = trace.hole;\n\n        if (pt.v === cd0.vTotal) {\n          // 100% fails bcs arc start and end are identical\n          var outerCircle = 'M' + (cx + pt.px0[0]) + ',' + (cy + pt.px0[1]) + arc(pt.px0, pt.pxmid, true, 1) + arc(pt.pxmid, pt.px0, true, 1) + 'Z';\n\n          if (hole) {\n            slicePath.attr('d', 'M' + (cx + hole * pt.px0[0]) + ',' + (cy + hole * pt.px0[1]) + arc(pt.px0, pt.pxmid, false, hole) + arc(pt.pxmid, pt.px0, false, hole) + 'Z' + outerCircle);\n          } else slicePath.attr('d', outerCircle);\n        } else {\n          var outerArc = arc(pt.px0, pt.px1, true, 1);\n\n          if (hole) {\n            var rim = 1 - hole;\n            slicePath.attr('d', 'M' + (cx + hole * pt.px1[0]) + ',' + (cy + hole * pt.px1[1]) + arc(pt.px1, pt.px0, false, hole) + 'l' + rim * pt.px0[0] + ',' + rim * pt.px0[1] + outerArc + 'Z');\n          } else {\n            slicePath.attr('d', 'M' + cx + ',' + cy + 'l' + pt.px0[0] + ',' + pt.px0[1] + outerArc + 'Z');\n          }\n        } // add text\n\n\n        formatSliceLabel(gd, pt, cd0);\n        var textPosition = helpers.castOption(trace.textposition, pt.pts);\n        var sliceTextGroup = sliceTop.selectAll('g.slicetext').data(pt.text && textPosition !== 'none' ? [0] : []);\n        sliceTextGroup.enter().append('g').classed('slicetext', true);\n        sliceTextGroup.exit().remove();\n        sliceTextGroup.each(function () {\n          var sliceText = Lib.ensureSingle(d3.select(this), 'text', '', function (s) {\n            // prohibit tex interpretation until we can handle\n            // tex and regular text together\n            s.attr('data-notex', 1);\n          });\n          var font = Lib.ensureUniformFontSize(gd, textPosition === 'outside' ? determineOutsideTextFont(trace, pt, fullLayout.font) : determineInsideTextFont(trace, pt, fullLayout.font));\n          sliceText.text(pt.text).attr({\n            'class': 'slicetext',\n            transform: '',\n            'text-anchor': 'middle'\n          }).call(Drawing.font, font).call(svgTextUtils.convertToTspans, gd); // position the text relative to the slice\n\n          var textBB = Drawing.bBox(sliceText.node());\n          var transform;\n\n          if (textPosition === 'outside') {\n            transform = transformOutsideText(textBB, pt);\n          } else {\n            transform = transformInsideText(textBB, pt, cd0);\n\n            if (textPosition === 'auto' && transform.scale < 1) {\n              var newFont = Lib.ensureUniformFontSize(gd, trace.outsidetextfont);\n              sliceText.call(Drawing.font, newFont);\n              textBB = Drawing.bBox(sliceText.node());\n              transform = transformOutsideText(textBB, pt);\n            }\n          }\n\n          var textPosAngle = transform.textPosAngle;\n          var textXY = textPosAngle === undefined ? pt.pxmid : getCoords(cd0.r, textPosAngle);\n          transform.targetX = cx + textXY[0] * transform.rCenter + (transform.x || 0);\n          transform.targetY = cy + textXY[1] * transform.rCenter + (transform.y || 0);\n          computeTransform(transform, textBB); // save some stuff to use later ensure no labels overlap\n\n          if (transform.outside) {\n            var targetY = transform.targetY;\n            pt.yLabelMin = targetY - textBB.height / 2;\n            pt.yLabelMid = targetY;\n            pt.yLabelMax = targetY + textBB.height / 2;\n            pt.labelExtraX = 0;\n            pt.labelExtraY = 0;\n            hasOutsideText = true;\n          }\n\n          transform.fontSize = font.size;\n          recordMinTextSize(trace.type, transform, fullLayout);\n          cd[i].transform = transform;\n          sliceText.attr('transform', Lib.getTextTransform(transform));\n        });\n      }); // add the title\n\n      var titleTextGroup = d3.select(this).selectAll('g.titletext').data(trace.title.text ? [0] : []);\n      titleTextGroup.enter().append('g').classed('titletext', true);\n      titleTextGroup.exit().remove();\n      titleTextGroup.each(function () {\n        var titleText = Lib.ensureSingle(d3.select(this), 'text', '', function (s) {\n          // prohibit tex interpretation as above\n          s.attr('data-notex', 1);\n        });\n        var txt = trace.title.text;\n\n        if (trace._meta) {\n          txt = Lib.templateString(txt, trace._meta);\n        }\n\n        titleText.text(txt).attr({\n          'class': 'titletext',\n          transform: '',\n          'text-anchor': 'middle'\n        }).call(Drawing.font, trace.title.font).call(svgTextUtils.convertToTspans, gd);\n        var transform;\n\n        if (trace.title.position === 'middle center') {\n          transform = positionTitleInside(cd0);\n        } else {\n          transform = positionTitleOutside(cd0, gs);\n        }\n\n        titleText.attr('transform', strTranslate(transform.x, transform.y) + strScale(Math.min(1, transform.scale)) + strTranslate(transform.tx, transform.ty));\n      }); // now make sure no labels overlap (at least within one pie)\n\n      if (hasOutsideText) scootLabels(quadrants, trace);\n      plotTextLines(slices, trace);\n\n      if (hasOutsideText && trace.automargin) {\n        // TODO if we ever want to improve perf,\n        // we could reuse the textBB computed above together\n        // with the sliceText transform info\n        var traceBbox = Drawing.bBox(plotGroup.node());\n        var domain = trace.domain;\n        var vpw = gs.w * (domain.x[1] - domain.x[0]);\n        var vph = gs.h * (domain.y[1] - domain.y[0]);\n        var xgap = (0.5 * vpw - cd0.r) / gs.w;\n        var ygap = (0.5 * vph - cd0.r) / gs.h;\n        Plots.autoMargin(gd, 'pie.' + trace.uid + '.automargin', {\n          xl: domain.x[0] - xgap,\n          xr: domain.x[1] + xgap,\n          yb: domain.y[0] - ygap,\n          yt: domain.y[1] + ygap,\n          l: Math.max(cd0.cx - cd0.r - traceBbox.left, 0),\n          r: Math.max(traceBbox.right - (cd0.cx + cd0.r), 0),\n          b: Math.max(traceBbox.bottom - (cd0.cy + cd0.r), 0),\n          t: Math.max(cd0.cy - cd0.r - traceBbox.top, 0),\n          pad: 5\n        });\n      }\n    });\n  }); // This is for a bug in Chrome (as of 2015-07-22, and does not affect FF)\n  // if insidetextfont and outsidetextfont are different sizes, sometimes the size\n  // of an \"em\" gets taken from the wrong element at first so lines are\n  // spaced wrong. You just have to tell it to try again later and it gets fixed.\n  // I have no idea why we haven't seen this in other contexts. Also, sometimes\n  // it gets the initial draw correct but on redraw it gets confused.\n\n  setTimeout(function () {\n    plotGroups.selectAll('tspan').each(function () {\n      var s = d3.select(this);\n      if (s.attr('dy')) s.attr('dy', s.attr('dy'));\n    });\n  }, 0);\n} // TODO add support for transition\n\n\nfunction plotTextLines(slices, trace) {\n  slices.each(function (pt) {\n    var sliceTop = d3.select(this);\n\n    if (!pt.labelExtraX && !pt.labelExtraY) {\n      sliceTop.select('path.textline').remove();\n      return;\n    } // first move the text to its new location\n\n\n    var sliceText = sliceTop.select('g.slicetext text');\n    pt.transform.targetX += pt.labelExtraX;\n    pt.transform.targetY += pt.labelExtraY;\n    sliceText.attr('transform', Lib.getTextTransform(pt.transform)); // then add a line to the new location\n\n    var lineStartX = pt.cxFinal + pt.pxmid[0];\n    var lineStartY = pt.cyFinal + pt.pxmid[1];\n    var textLinePath = 'M' + lineStartX + ',' + lineStartY;\n    var finalX = (pt.yLabelMax - pt.yLabelMin) * (pt.pxmid[0] < 0 ? -1 : 1) / 4;\n\n    if (pt.labelExtraX) {\n      var yFromX = pt.labelExtraX * pt.pxmid[1] / pt.pxmid[0];\n      var yNet = pt.yLabelMid + pt.labelExtraY - (pt.cyFinal + pt.pxmid[1]);\n\n      if (Math.abs(yFromX) > Math.abs(yNet)) {\n        textLinePath += 'l' + yNet * pt.pxmid[0] / pt.pxmid[1] + ',' + yNet + 'H' + (lineStartX + pt.labelExtraX + finalX);\n      } else {\n        textLinePath += 'l' + pt.labelExtraX + ',' + yFromX + 'v' + (yNet - yFromX) + 'h' + finalX;\n      }\n    } else {\n      textLinePath += 'V' + (pt.yLabelMid + pt.labelExtraY) + 'h' + finalX;\n    }\n\n    Lib.ensureSingle(sliceTop, 'path', 'textline').call(Color.stroke, trace.outsidetextfont.color).attr({\n      'stroke-width': Math.min(2, trace.outsidetextfont.size / 8),\n      d: textLinePath,\n      fill: 'none'\n    });\n  });\n}\n\nfunction attachFxHandlers(sliceTop, gd, cd) {\n  var cd0 = cd[0];\n  var cx = cd0.cx;\n  var cy = cd0.cy;\n  var trace = cd0.trace;\n  var isFunnelArea = trace.type === 'funnelarea'; // hover state vars\n  // have we drawn a hover label, so it should be cleared later\n\n  if (!('_hasHoverLabel' in trace)) trace._hasHoverLabel = false; // have we emitted a hover event, so later an unhover event should be emitted\n  // note that click events do not depend on this - you can still get them\n  // with hovermode: false or if you were earlier dragging, then clicked\n  // in the same slice that you moused up in\n\n  if (!('_hasHoverEvent' in trace)) trace._hasHoverEvent = false;\n  sliceTop.on('mouseover', function (pt) {\n    // in case fullLayout or fullData has changed without a replot\n    var fullLayout2 = gd._fullLayout;\n    var trace2 = gd._fullData[trace.index];\n    if (gd._dragging || fullLayout2.hovermode === false) return;\n    var hoverinfo = trace2.hoverinfo;\n\n    if (Array.isArray(hoverinfo)) {\n      // super hacky: we need to pull out the *first* hoverinfo from\n      // pt.pts, then put it back into an array in a dummy trace\n      // and call castHoverinfo on that.\n      // TODO: do we want to have Fx.castHoverinfo somehow handle this?\n      // it already takes an array for index, for 2D, so this seems tricky.\n      hoverinfo = Fx.castHoverinfo({\n        hoverinfo: [helpers.castOption(hoverinfo, pt.pts)],\n        _module: trace._module\n      }, fullLayout2, 0);\n    }\n\n    if (hoverinfo === 'all') hoverinfo = 'label+text+value+percent+name'; // in case we dragged over the pie from another subplot,\n    // or if hover is turned off\n\n    if (trace2.hovertemplate || hoverinfo !== 'none' && hoverinfo !== 'skip' && hoverinfo) {\n      var rInscribed = pt.rInscribed || 0;\n      var hoverCenterX = cx + pt.pxmid[0] * (1 - rInscribed);\n      var hoverCenterY = cy + pt.pxmid[1] * (1 - rInscribed);\n      var separators = fullLayout2.separators;\n      var text = [];\n      if (hoverinfo && hoverinfo.indexOf('label') !== -1) text.push(pt.label);\n      pt.text = helpers.castOption(trace2.hovertext || trace2.text, pt.pts);\n\n      if (hoverinfo && hoverinfo.indexOf('text') !== -1) {\n        var tx = pt.text;\n        if (Lib.isValidTextValue(tx)) text.push(tx);\n      }\n\n      pt.value = pt.v;\n      pt.valueLabel = helpers.formatPieValue(pt.v, separators);\n      if (hoverinfo && hoverinfo.indexOf('value') !== -1) text.push(pt.valueLabel);\n      pt.percent = pt.v / cd0.vTotal;\n      pt.percentLabel = helpers.formatPiePercent(pt.percent, separators);\n      if (hoverinfo && hoverinfo.indexOf('percent') !== -1) text.push(pt.percentLabel);\n      var hoverLabel = trace2.hoverlabel;\n      var hoverFont = hoverLabel.font;\n      var bbox = [];\n      Fx.loneHover({\n        trace: trace,\n        x0: hoverCenterX - rInscribed * cd0.r,\n        x1: hoverCenterX + rInscribed * cd0.r,\n        y: hoverCenterY,\n        _x0: isFunnelArea ? cx + pt.TL[0] : hoverCenterX - rInscribed * cd0.r,\n        _x1: isFunnelArea ? cx + pt.TR[0] : hoverCenterX + rInscribed * cd0.r,\n        _y0: isFunnelArea ? cy + pt.TL[1] : hoverCenterY - rInscribed * cd0.r,\n        _y1: isFunnelArea ? cy + pt.BL[1] : hoverCenterY + rInscribed * cd0.r,\n        text: text.join('<br>'),\n        name: trace2.hovertemplate || hoverinfo.indexOf('name') !== -1 ? trace2.name : undefined,\n        idealAlign: pt.pxmid[0] < 0 ? 'left' : 'right',\n        color: helpers.castOption(hoverLabel.bgcolor, pt.pts) || pt.color,\n        borderColor: helpers.castOption(hoverLabel.bordercolor, pt.pts),\n        fontFamily: helpers.castOption(hoverFont.family, pt.pts),\n        fontSize: helpers.castOption(hoverFont.size, pt.pts),\n        fontColor: helpers.castOption(hoverFont.color, pt.pts),\n        nameLength: helpers.castOption(hoverLabel.namelength, pt.pts),\n        textAlign: helpers.castOption(hoverLabel.align, pt.pts),\n        hovertemplate: helpers.castOption(trace2.hovertemplate, pt.pts),\n        hovertemplateLabels: pt,\n        eventData: [eventData(pt, trace2)]\n      }, {\n        container: fullLayout2._hoverlayer.node(),\n        outerContainer: fullLayout2._paper.node(),\n        gd: gd,\n        inOut_bbox: bbox\n      });\n      pt.bbox = bbox[0];\n      trace._hasHoverLabel = true;\n    }\n\n    trace._hasHoverEvent = true;\n    gd.emit('plotly_hover', {\n      points: [eventData(pt, trace2)],\n      event: d3.event\n    });\n  });\n  sliceTop.on('mouseout', function (evt) {\n    var fullLayout2 = gd._fullLayout;\n    var trace2 = gd._fullData[trace.index];\n    var pt = d3.select(this).datum();\n\n    if (trace._hasHoverEvent) {\n      evt.originalEvent = d3.event;\n      gd.emit('plotly_unhover', {\n        points: [eventData(pt, trace2)],\n        event: d3.event\n      });\n      trace._hasHoverEvent = false;\n    }\n\n    if (trace._hasHoverLabel) {\n      Fx.loneUnhover(fullLayout2._hoverlayer.node());\n      trace._hasHoverLabel = false;\n    }\n  });\n  sliceTop.on('click', function (pt) {\n    // TODO: this does not support right-click. If we want to support it, we\n    // would likely need to change pie to use dragElement instead of straight\n    // mapbox event binding. Or perhaps better, make a simple wrapper with the\n    // right mousedown, mousemove, and mouseup handlers just for a left/right click\n    // mapbox would use this too.\n    var fullLayout2 = gd._fullLayout;\n    var trace2 = gd._fullData[trace.index];\n    if (gd._dragging || fullLayout2.hovermode === false) return;\n    gd._hoverdata = [eventData(pt, trace2)];\n    Fx.click(gd, d3.event);\n  });\n}\n\nfunction determineOutsideTextFont(trace, pt, layoutFont) {\n  var color = helpers.castOption(trace.outsidetextfont.color, pt.pts) || helpers.castOption(trace.textfont.color, pt.pts) || layoutFont.color;\n  var family = helpers.castOption(trace.outsidetextfont.family, pt.pts) || helpers.castOption(trace.textfont.family, pt.pts) || layoutFont.family;\n  var size = helpers.castOption(trace.outsidetextfont.size, pt.pts) || helpers.castOption(trace.textfont.size, pt.pts) || layoutFont.size;\n  return {\n    color: color,\n    family: family,\n    size: size\n  };\n}\n\nfunction determineInsideTextFont(trace, pt, layoutFont) {\n  var customColor = helpers.castOption(trace.insidetextfont.color, pt.pts);\n\n  if (!customColor && trace._input.textfont) {\n    // Why not simply using trace.textfont? Because if not set, it\n    // defaults to layout.font which has a default color. But if\n    // textfont.color and insidetextfont.color don't supply a value,\n    // a contrasting color shall be used.\n    customColor = helpers.castOption(trace._input.textfont.color, pt.pts);\n  }\n\n  var family = helpers.castOption(trace.insidetextfont.family, pt.pts) || helpers.castOption(trace.textfont.family, pt.pts) || layoutFont.family;\n  var size = helpers.castOption(trace.insidetextfont.size, pt.pts) || helpers.castOption(trace.textfont.size, pt.pts) || layoutFont.size;\n  return {\n    color: customColor || Color.contrast(pt.color),\n    family: family,\n    size: size\n  };\n}\n\nfunction prerenderTitles(cdModule, gd) {\n  var cd0, trace; // Determine the width and height of the title for each pie.\n\n  for (var i = 0; i < cdModule.length; i++) {\n    cd0 = cdModule[i][0];\n    trace = cd0.trace;\n\n    if (trace.title.text) {\n      var txt = trace.title.text;\n\n      if (trace._meta) {\n        txt = Lib.templateString(txt, trace._meta);\n      }\n\n      var dummyTitle = Drawing.tester.append('text').attr('data-notex', 1).text(txt).call(Drawing.font, trace.title.font).call(svgTextUtils.convertToTspans, gd);\n      var bBox = Drawing.bBox(dummyTitle.node(), true);\n      cd0.titleBox = {\n        width: bBox.width,\n        height: bBox.height\n      };\n      dummyTitle.remove();\n    }\n  }\n}\n\nfunction transformInsideText(textBB, pt, cd0) {\n  var r = cd0.r || pt.rpx1;\n  var rInscribed = pt.rInscribed;\n  var isEmpty = pt.startangle === pt.stopangle;\n\n  if (isEmpty) {\n    return {\n      rCenter: 1 - rInscribed,\n      scale: 0,\n      rotate: 0,\n      textPosAngle: 0\n    };\n  }\n\n  var ring = pt.ring;\n  var isCircle = ring === 1 && Math.abs(pt.startangle - pt.stopangle) === Math.PI * 2;\n  var halfAngle = pt.halfangle;\n  var midAngle = pt.midangle;\n  var orientation = cd0.trace.insidetextorientation;\n  var isHorizontal = orientation === 'horizontal';\n  var isTangential = orientation === 'tangential';\n  var isRadial = orientation === 'radial';\n  var isAuto = orientation === 'auto';\n  var allTransforms = [];\n  var newT;\n\n  if (!isAuto) {\n    // max size if text is placed (horizontally) at the top or bottom of the arc\n    var considerCrossing = function (angle, key) {\n      if (isCrossing(pt, angle)) {\n        var dStart = Math.abs(angle - pt.startangle);\n        var dStop = Math.abs(angle - pt.stopangle);\n        var closestEdge = dStart < dStop ? dStart : dStop;\n\n        if (key === 'tan') {\n          newT = calcTanTransform(textBB, r, ring, closestEdge, 0);\n        } else {\n          // case of 'rad'\n          newT = calcRadTransform(textBB, r, ring, closestEdge, Math.PI / 2);\n        }\n\n        newT.textPosAngle = angle;\n        allTransforms.push(newT);\n      }\n    }; // to cover all cases with trace.rotation added\n\n\n    var i;\n\n    if (isHorizontal || isTangential) {\n      // top\n      for (i = 4; i >= -4; i -= 2) considerCrossing(Math.PI * i, 'tan'); // bottom\n\n\n      for (i = 4; i >= -4; i -= 2) considerCrossing(Math.PI * (i + 1), 'tan');\n    }\n\n    if (isHorizontal || isRadial) {\n      // left\n      for (i = 4; i >= -4; i -= 2) considerCrossing(Math.PI * (i + 1.5), 'rad'); // right\n\n\n      for (i = 4; i >= -4; i -= 2) considerCrossing(Math.PI * (i + 0.5), 'rad');\n    }\n  }\n\n  if (isCircle || isAuto || isHorizontal) {\n    // max size text can be inserted inside without rotating it\n    // this inscribes the text rectangle in a circle, which is then inscribed\n    // in the slice, so it will be an underestimate, which some day we may want\n    // to improve so this case can get more use\n    var textDiameter = Math.sqrt(textBB.width * textBB.width + textBB.height * textBB.height);\n    newT = {\n      scale: rInscribed * r * 2 / textDiameter,\n      // and the center position and rotation in this case\n      rCenter: 1 - rInscribed,\n      rotate: 0\n    };\n    newT.textPosAngle = (pt.startangle + pt.stopangle) / 2;\n    if (newT.scale >= 1) return newT;\n    allTransforms.push(newT);\n  }\n\n  if (isAuto || isRadial) {\n    newT = calcRadTransform(textBB, r, ring, halfAngle, midAngle);\n    newT.textPosAngle = (pt.startangle + pt.stopangle) / 2;\n    allTransforms.push(newT);\n  }\n\n  if (isAuto || isTangential) {\n    newT = calcTanTransform(textBB, r, ring, halfAngle, midAngle);\n    newT.textPosAngle = (pt.startangle + pt.stopangle) / 2;\n    allTransforms.push(newT);\n  }\n\n  var id = 0;\n  var maxScale = 0;\n\n  for (var k = 0; k < allTransforms.length; k++) {\n    var s = allTransforms[k].scale;\n\n    if (maxScale < s) {\n      maxScale = s;\n      id = k;\n    }\n\n    if (!isAuto && maxScale >= 1) {\n      // respect test order for non-auto options\n      break;\n    }\n  }\n\n  return allTransforms[id];\n}\n\nfunction isCrossing(pt, angle) {\n  var start = pt.startangle;\n  var stop = pt.stopangle;\n  return start > angle && angle > stop || start < angle && angle < stop;\n}\n\nfunction calcRadTransform(textBB, r, ring, halfAngle, midAngle) {\n  r = Math.max(0, r - 2 * TEXTPAD); // max size if text is rotated radially\n\n  var a = textBB.width / textBB.height;\n  var s = calcMaxHalfSize(a, halfAngle, r, ring);\n  return {\n    scale: s * 2 / textBB.height,\n    rCenter: calcRCenter(a, s / r),\n    rotate: calcRotate(midAngle)\n  };\n}\n\nfunction calcTanTransform(textBB, r, ring, halfAngle, midAngle) {\n  r = Math.max(0, r - 2 * TEXTPAD); // max size if text is rotated tangentially\n\n  var a = textBB.height / textBB.width;\n  var s = calcMaxHalfSize(a, halfAngle, r, ring);\n  return {\n    scale: s * 2 / textBB.width,\n    rCenter: calcRCenter(a, s / r),\n    rotate: calcRotate(midAngle + Math.PI / 2)\n  };\n}\n\nfunction calcRCenter(a, b) {\n  return Math.cos(b) - a * b;\n}\n\nfunction calcRotate(t) {\n  return (180 / Math.PI * t + 720) % 180 - 90;\n}\n\nfunction calcMaxHalfSize(a, halfAngle, r, ring) {\n  var q = a + 1 / (2 * Math.tan(halfAngle));\n  return r * Math.min(1 / (Math.sqrt(q * q + 0.5) + q), ring / (Math.sqrt(a * a + ring / 2) + a));\n}\n\nfunction getInscribedRadiusFraction(pt, cd0) {\n  if (pt.v === cd0.vTotal && !cd0.trace.hole) return 1; // special case of 100% with no hole\n\n  return Math.min(1 / (1 + 1 / Math.sin(pt.halfangle)), pt.ring / 2);\n}\n\nfunction transformOutsideText(textBB, pt) {\n  var x = pt.pxmid[0];\n  var y = pt.pxmid[1];\n  var dx = textBB.width / 2;\n  var dy = textBB.height / 2;\n  if (x < 0) dx *= -1;\n  if (y < 0) dy *= -1;\n  return {\n    scale: 1,\n    rCenter: 1,\n    rotate: 0,\n    x: dx + Math.abs(dy) * (dx > 0 ? 1 : -1) / 2,\n    y: dy / (1 + x * x / (y * y)),\n    outside: true\n  };\n}\n\nfunction positionTitleInside(cd0) {\n  var textDiameter = Math.sqrt(cd0.titleBox.width * cd0.titleBox.width + cd0.titleBox.height * cd0.titleBox.height);\n  return {\n    x: cd0.cx,\n    y: cd0.cy,\n    scale: cd0.trace.hole * cd0.r * 2 / textDiameter,\n    tx: 0,\n    ty: -cd0.titleBox.height / 2 + cd0.trace.title.font.size\n  };\n}\n\nfunction positionTitleOutside(cd0, plotSize) {\n  var scaleX = 1;\n  var scaleY = 1;\n  var maxPull;\n  var trace = cd0.trace; // position of the baseline point of the text box in the plot, before scaling.\n  // we anchored the text in the middle, so the baseline is on the bottom middle\n  // of the first line of text.\n\n  var topMiddle = {\n    x: cd0.cx,\n    y: cd0.cy\n  }; // relative translation of the text box after scaling\n\n  var translate = {\n    tx: 0,\n    ty: 0\n  }; // we reason below as if the baseline is the top middle point of the text box.\n  // so we must add the font size to approximate the y-coord. of the top.\n  // note that this correction must happen after scaling.\n\n  translate.ty += trace.title.font.size;\n  maxPull = getMaxPull(trace);\n\n  if (trace.title.position.indexOf('top') !== -1) {\n    topMiddle.y -= (1 + maxPull) * cd0.r;\n    translate.ty -= cd0.titleBox.height;\n  } else if (trace.title.position.indexOf('bottom') !== -1) {\n    topMiddle.y += (1 + maxPull) * cd0.r;\n  }\n\n  var rx = applyAspectRatio(cd0.r, cd0.trace.aspectratio);\n  var maxWidth = plotSize.w * (trace.domain.x[1] - trace.domain.x[0]) / 2;\n\n  if (trace.title.position.indexOf('left') !== -1) {\n    // we start the text at the left edge of the pie\n    maxWidth = maxWidth + rx;\n    topMiddle.x -= (1 + maxPull) * rx;\n    translate.tx += cd0.titleBox.width / 2;\n  } else if (trace.title.position.indexOf('center') !== -1) {\n    maxWidth *= 2;\n  } else if (trace.title.position.indexOf('right') !== -1) {\n    maxWidth = maxWidth + rx;\n    topMiddle.x += (1 + maxPull) * rx;\n    translate.tx -= cd0.titleBox.width / 2;\n  }\n\n  scaleX = maxWidth / cd0.titleBox.width;\n  scaleY = getTitleSpace(cd0, plotSize) / cd0.titleBox.height;\n  return {\n    x: topMiddle.x,\n    y: topMiddle.y,\n    scale: Math.min(scaleX, scaleY),\n    tx: translate.tx,\n    ty: translate.ty\n  };\n}\n\nfunction applyAspectRatio(x, aspectratio) {\n  return x / (aspectratio === undefined ? 1 : aspectratio);\n}\n\nfunction getTitleSpace(cd0, plotSize) {\n  var trace = cd0.trace;\n  var pieBoxHeight = plotSize.h * (trace.domain.y[1] - trace.domain.y[0]); // use at most half of the plot for the title\n\n  return Math.min(cd0.titleBox.height, pieBoxHeight / 2);\n}\n\nfunction getMaxPull(trace) {\n  var maxPull = trace.pull;\n  if (!maxPull) return 0;\n  var j;\n\n  if (Array.isArray(maxPull)) {\n    maxPull = 0;\n\n    for (j = 0; j < trace.pull.length; j++) {\n      if (trace.pull[j] > maxPull) maxPull = trace.pull[j];\n    }\n  }\n\n  return maxPull;\n}\n\nfunction scootLabels(quadrants, trace) {\n  var xHalf, yHalf, equatorFirst, farthestX, farthestY, xDiffSign, yDiffSign, thisQuad, oppositeQuad, wholeSide, i, thisQuadOutside, firstOppositeOutsidePt;\n\n  function topFirst(a, b) {\n    return a.pxmid[1] - b.pxmid[1];\n  }\n\n  function bottomFirst(a, b) {\n    return b.pxmid[1] - a.pxmid[1];\n  }\n\n  function scootOneLabel(thisPt, prevPt) {\n    if (!prevPt) prevPt = {};\n    var prevOuterY = prevPt.labelExtraY + (yHalf ? prevPt.yLabelMax : prevPt.yLabelMin);\n    var thisInnerY = yHalf ? thisPt.yLabelMin : thisPt.yLabelMax;\n    var thisOuterY = yHalf ? thisPt.yLabelMax : thisPt.yLabelMin;\n    var thisSliceOuterY = thisPt.cyFinal + farthestY(thisPt.px0[1], thisPt.px1[1]);\n    var newExtraY = prevOuterY - thisInnerY;\n    var xBuffer, i, otherPt, otherOuterY, otherOuterX, newExtraX; // make sure this label doesn't overlap other labels\n    // this *only* has us move these labels vertically\n\n    if (newExtraY * yDiffSign > 0) thisPt.labelExtraY = newExtraY; // make sure this label doesn't overlap any slices\n\n    if (!Array.isArray(trace.pull)) return; // this can only happen with array pulls\n\n    for (i = 0; i < wholeSide.length; i++) {\n      otherPt = wholeSide[i]; // overlap can only happen if the other point is pulled more than this one\n\n      if (otherPt === thisPt || (helpers.castOption(trace.pull, thisPt.pts) || 0) >= (helpers.castOption(trace.pull, otherPt.pts) || 0)) {\n        continue;\n      }\n\n      if ((thisPt.pxmid[1] - otherPt.pxmid[1]) * yDiffSign > 0) {\n        // closer to the equator - by construction all of these happen first\n        // move the text vertically to get away from these slices\n        otherOuterY = otherPt.cyFinal + farthestY(otherPt.px0[1], otherPt.px1[1]);\n        newExtraY = otherOuterY - thisInnerY - thisPt.labelExtraY;\n        if (newExtraY * yDiffSign > 0) thisPt.labelExtraY += newExtraY;\n      } else if ((thisOuterY + thisPt.labelExtraY - thisSliceOuterY) * yDiffSign > 0) {\n        // farther from the equator - happens after we've done all the\n        // vertical moving we're going to do\n        // move horizontally to get away from these more polar slices\n        // if we're moving horz. based on a slice that's several slices away from this one\n        // then we need some extra space for the lines to labels between them\n        xBuffer = 3 * xDiffSign * Math.abs(i - wholeSide.indexOf(thisPt));\n        otherOuterX = otherPt.cxFinal + farthestX(otherPt.px0[0], otherPt.px1[0]);\n        newExtraX = otherOuterX + xBuffer - (thisPt.cxFinal + thisPt.pxmid[0]) - thisPt.labelExtraX;\n        if (newExtraX * xDiffSign > 0) thisPt.labelExtraX += newExtraX;\n      }\n    }\n  }\n\n  for (yHalf = 0; yHalf < 2; yHalf++) {\n    equatorFirst = yHalf ? topFirst : bottomFirst;\n    farthestY = yHalf ? Math.max : Math.min;\n    yDiffSign = yHalf ? 1 : -1;\n\n    for (xHalf = 0; xHalf < 2; xHalf++) {\n      farthestX = xHalf ? Math.max : Math.min;\n      xDiffSign = xHalf ? 1 : -1; // first sort the array\n      // note this is a copy of cd, so cd itself doesn't get sorted\n      // but we can still modify points in place.\n\n      thisQuad = quadrants[yHalf][xHalf];\n      thisQuad.sort(equatorFirst);\n      oppositeQuad = quadrants[1 - yHalf][xHalf];\n      wholeSide = oppositeQuad.concat(thisQuad);\n      thisQuadOutside = [];\n\n      for (i = 0; i < thisQuad.length; i++) {\n        if (thisQuad[i].yLabelMid !== undefined) thisQuadOutside.push(thisQuad[i]);\n      }\n\n      firstOppositeOutsidePt = false;\n\n      for (i = 0; yHalf && i < oppositeQuad.length; i++) {\n        if (oppositeQuad[i].yLabelMid !== undefined) {\n          firstOppositeOutsidePt = oppositeQuad[i];\n          break;\n        }\n      } // each needs to avoid the previous\n\n\n      for (i = 0; i < thisQuadOutside.length; i++) {\n        var prevPt = i && thisQuadOutside[i - 1]; // bottom half needs to avoid the first label of the top half\n        // top half we still need to call scootOneLabel on the first slice\n        // so we can avoid other slices, but we don't pass a prevPt\n\n        if (firstOppositeOutsidePt && !i) prevPt = firstOppositeOutsidePt;\n        scootOneLabel(thisQuadOutside[i], prevPt);\n      }\n    }\n  }\n}\n\nfunction layoutAreas(cdModule, plotSize) {\n  var scaleGroups = []; // figure out the center and maximum radius\n\n  for (var i = 0; i < cdModule.length; i++) {\n    var cd0 = cdModule[i][0];\n    var trace = cd0.trace;\n    var domain = trace.domain;\n    var width = plotSize.w * (domain.x[1] - domain.x[0]);\n    var height = plotSize.h * (domain.y[1] - domain.y[0]); // leave some space for the title, if it will be displayed outside\n\n    if (trace.title.text && trace.title.position !== 'middle center') {\n      height -= getTitleSpace(cd0, plotSize);\n    }\n\n    var rx = width / 2;\n    var ry = height / 2;\n\n    if (trace.type === 'funnelarea' && !trace.scalegroup) {\n      ry /= trace.aspectratio;\n    }\n\n    cd0.r = Math.min(rx, ry) / (1 + getMaxPull(trace));\n    cd0.cx = plotSize.l + plotSize.w * (trace.domain.x[1] + trace.domain.x[0]) / 2;\n    cd0.cy = plotSize.t + plotSize.h * (1 - trace.domain.y[0]) - height / 2;\n\n    if (trace.title.text && trace.title.position.indexOf('bottom') !== -1) {\n      cd0.cy -= getTitleSpace(cd0, plotSize);\n    }\n\n    if (trace.scalegroup && scaleGroups.indexOf(trace.scalegroup) === -1) {\n      scaleGroups.push(trace.scalegroup);\n    }\n  }\n\n  groupScale(cdModule, scaleGroups);\n}\n\nfunction groupScale(cdModule, scaleGroups) {\n  var cd0, i, trace; // scale those that are grouped\n\n  for (var k = 0; k < scaleGroups.length; k++) {\n    var min = Infinity;\n    var g = scaleGroups[k];\n\n    for (i = 0; i < cdModule.length; i++) {\n      cd0 = cdModule[i][0];\n      trace = cd0.trace;\n\n      if (trace.scalegroup === g) {\n        var area;\n\n        if (trace.type === 'pie') {\n          area = cd0.r * cd0.r;\n        } else if (trace.type === 'funnelarea') {\n          var rx, ry;\n\n          if (trace.aspectratio > 1) {\n            rx = cd0.r;\n            ry = rx / trace.aspectratio;\n          } else {\n            ry = cd0.r;\n            rx = ry * trace.aspectratio;\n          }\n\n          rx *= (1 + trace.baseratio) / 2;\n          area = rx * ry;\n        }\n\n        min = Math.min(min, area / cd0.vTotal);\n      }\n    }\n\n    for (i = 0; i < cdModule.length; i++) {\n      cd0 = cdModule[i][0];\n      trace = cd0.trace;\n\n      if (trace.scalegroup === g) {\n        var v = min * cd0.vTotal;\n\n        if (trace.type === 'funnelarea') {\n          v /= (1 + trace.baseratio) / 2;\n          v /= trace.aspectratio;\n        }\n\n        cd0.r = Math.sqrt(v);\n      }\n    }\n  }\n}\n\nfunction setCoords(cd) {\n  var cd0 = cd[0];\n  var r = cd0.r;\n  var trace = cd0.trace;\n  var currentAngle = helpers.getRotationAngle(trace.rotation);\n  var angleFactor = 2 * Math.PI / cd0.vTotal;\n  var firstPt = 'px0';\n  var lastPt = 'px1';\n  var i, cdi, currentCoords;\n\n  if (trace.direction === 'counterclockwise') {\n    for (i = 0; i < cd.length; i++) {\n      if (!cd[i].hidden) break; // find the first non-hidden slice\n    }\n\n    if (i === cd.length) return; // all slices hidden\n\n    currentAngle += angleFactor * cd[i].v;\n    angleFactor *= -1;\n    firstPt = 'px1';\n    lastPt = 'px0';\n  }\n\n  currentCoords = getCoords(r, currentAngle);\n\n  for (i = 0; i < cd.length; i++) {\n    cdi = cd[i];\n    if (cdi.hidden) continue;\n    cdi[firstPt] = currentCoords;\n    cdi.startangle = currentAngle;\n    currentAngle += angleFactor * cdi.v / 2;\n    cdi.pxmid = getCoords(r, currentAngle);\n    cdi.midangle = currentAngle;\n    currentAngle += angleFactor * cdi.v / 2;\n    currentCoords = getCoords(r, currentAngle);\n    cdi.stopangle = currentAngle;\n    cdi[lastPt] = currentCoords;\n    cdi.largeArc = cdi.v > cd0.vTotal / 2 ? 1 : 0;\n    cdi.halfangle = Math.PI * Math.min(cdi.v / cd0.vTotal, 0.5);\n    cdi.ring = 1 - trace.hole;\n    cdi.rInscribed = getInscribedRadiusFraction(cdi, cd0);\n  }\n}\n\nfunction getCoords(r, angle) {\n  return [r * Math.sin(angle), -r * Math.cos(angle)];\n}\n\nfunction formatSliceLabel(gd, pt, cd0) {\n  var fullLayout = gd._fullLayout;\n  var trace = cd0.trace; // look for textemplate\n\n  var texttemplate = trace.texttemplate; // now insert text\n\n  var textinfo = trace.textinfo;\n\n  if (!texttemplate && textinfo && textinfo !== 'none') {\n    var parts = textinfo.split('+');\n\n    var hasFlag = function (flag) {\n      return parts.indexOf(flag) !== -1;\n    };\n\n    var hasLabel = hasFlag('label');\n    var hasText = hasFlag('text');\n    var hasValue = hasFlag('value');\n    var hasPercent = hasFlag('percent');\n    var separators = fullLayout.separators;\n    var text;\n    text = hasLabel ? [pt.label] : [];\n\n    if (hasText) {\n      var tx = helpers.getFirstFilled(trace.text, pt.pts);\n      if (isValidTextValue(tx)) text.push(tx);\n    }\n\n    if (hasValue) text.push(helpers.formatPieValue(pt.v, separators));\n    if (hasPercent) text.push(helpers.formatPiePercent(pt.v / cd0.vTotal, separators));\n    pt.text = text.join('<br>');\n  }\n\n  function makeTemplateVariables(pt) {\n    return {\n      label: pt.label,\n      value: pt.v,\n      valueLabel: helpers.formatPieValue(pt.v, fullLayout.separators),\n      percent: pt.v / cd0.vTotal,\n      percentLabel: helpers.formatPiePercent(pt.v / cd0.vTotal, fullLayout.separators),\n      color: pt.color,\n      text: pt.text,\n      customdata: Lib.castOption(trace, pt.i, 'customdata')\n    };\n  }\n\n  if (texttemplate) {\n    var txt = Lib.castOption(trace, pt.i, 'texttemplate');\n\n    if (!txt) {\n      pt.text = '';\n    } else {\n      var obj = makeTemplateVariables(pt);\n      var ptTx = helpers.getFirstFilled(trace.text, pt.pts);\n      if (isValidTextValue(ptTx) || ptTx === '') obj.text = ptTx;\n      pt.text = Lib.texttemplateString(txt, obj, gd._fullLayout._d3locale, obj, trace._meta || {});\n    }\n  }\n}\n\nfunction computeTransform(transform, // inout\ntextBB // in\n) {\n  var a = transform.rotate * Math.PI / 180;\n  var cosA = Math.cos(a);\n  var sinA = Math.sin(a);\n  var midX = (textBB.left + textBB.right) / 2;\n  var midY = (textBB.top + textBB.bottom) / 2;\n  transform.textX = midX * cosA - midY * sinA;\n  transform.textY = midX * sinA + midY * cosA;\n  transform.noCenter = true;\n}\n\nmodule.exports = {\n  plot: plot,\n  formatSliceLabel: formatSliceLabel,\n  transformInsideText: transformInsideText,\n  determineInsideTextFont: determineInsideTextFont,\n  positionTitleOutside: positionTitleOutside,\n  prerenderTitles: prerenderTitles,\n  layoutAreas: layoutAreas,\n  attachFxHandlers: attachFxHandlers,\n  computeTransform: computeTransform\n};","map":{"version":3,"sources":["C:/Projects/reactApp/analyse_coderhub/node_modules/plotly.js/src/traces/pie/plot.js"],"names":["d3","require","Plots","Fx","Color","Drawing","Lib","strScale","strTranslate","svgTextUtils","uniformText","recordMinTextSize","clearMinTextSize","TEXTPAD","helpers","eventData","isValidTextValue","plot","gd","cdModule","fullLayout","_fullLayout","gs","_size","prerenderTitles","layoutAreas","plotGroups","makeTraceGroups","_pielayer","each","cd","plotGroup","select","cd0","trace","setCoords","attr","slices","selectAll","data","enter","append","classed","exit","remove","quadrants","hasOutsideText","pt","i","hidden","pointNumber","curveNumber","index","pxmid","push","cx","cy","sliceTop","slicePath","style","call","attachFxHandlers","pull","castOption","pts","cxFinal","cyFinal","arc","start","finish","cw","scale","dx","dy","r","largeArc","hole","v","vTotal","outerCircle","px0","outerArc","px1","rim","formatSliceLabel","textPosition","textposition","sliceTextGroup","text","sliceText","ensureSingle","s","font","ensureUniformFontSize","determineOutsideTextFont","determineInsideTextFont","transform","convertToTspans","textBB","bBox","node","transformOutsideText","transformInsideText","newFont","outsidetextfont","textPosAngle","textXY","undefined","getCoords","targetX","rCenter","x","targetY","y","computeTransform","outside","yLabelMin","height","yLabelMid","yLabelMax","labelExtraX","labelExtraY","fontSize","size","type","getTextTransform","titleTextGroup","title","titleText","txt","_meta","templateString","position","positionTitleInside","positionTitleOutside","Math","min","tx","ty","scootLabels","plotTextLines","automargin","traceBbox","domain","vpw","w","vph","h","xgap","ygap","autoMargin","uid","xl","xr","yb","yt","l","max","left","right","b","bottom","t","top","pad","setTimeout","lineStartX","lineStartY","textLinePath","finalX","yFromX","yNet","abs","stroke","color","d","fill","isFunnelArea","_hasHoverLabel","_hasHoverEvent","on","fullLayout2","trace2","_fullData","_dragging","hovermode","hoverinfo","Array","isArray","castHoverinfo","_module","hovertemplate","rInscribed","hoverCenterX","hoverCenterY","separators","indexOf","label","hovertext","value","valueLabel","formatPieValue","percent","percentLabel","formatPiePercent","hoverLabel","hoverlabel","hoverFont","bbox","loneHover","x0","x1","_x0","TL","_x1","TR","_y0","_y1","BL","join","name","idealAlign","bgcolor","borderColor","bordercolor","fontFamily","family","fontColor","nameLength","namelength","textAlign","align","hovertemplateLabels","container","_hoverlayer","outerContainer","_paper","inOut_bbox","emit","points","event","evt","datum","originalEvent","loneUnhover","_hoverdata","click","layoutFont","textfont","customColor","insidetextfont","_input","contrast","length","dummyTitle","tester","titleBox","width","rpx1","isEmpty","startangle","stopangle","rotate","ring","isCircle","PI","halfAngle","halfangle","midAngle","midangle","orientation","insidetextorientation","isHorizontal","isTangential","isRadial","isAuto","allTransforms","newT","considerCrossing","angle","key","isCrossing","dStart","dStop","closestEdge","calcTanTransform","calcRadTransform","textDiameter","sqrt","id","maxScale","k","stop","a","calcMaxHalfSize","calcRCenter","calcRotate","cos","q","tan","getInscribedRadiusFraction","sin","plotSize","scaleX","scaleY","maxPull","topMiddle","translate","getMaxPull","rx","applyAspectRatio","aspectratio","maxWidth","getTitleSpace","pieBoxHeight","j","xHalf","yHalf","equatorFirst","farthestX","farthestY","xDiffSign","yDiffSign","thisQuad","oppositeQuad","wholeSide","thisQuadOutside","firstOppositeOutsidePt","topFirst","bottomFirst","scootOneLabel","thisPt","prevPt","prevOuterY","thisInnerY","thisOuterY","thisSliceOuterY","newExtraY","xBuffer","otherPt","otherOuterY","otherOuterX","newExtraX","sort","concat","scaleGroups","ry","scalegroup","groupScale","Infinity","g","area","baseratio","currentAngle","getRotationAngle","rotation","angleFactor","firstPt","lastPt","cdi","currentCoords","direction","texttemplate","textinfo","parts","split","hasFlag","flag","hasLabel","hasText","hasValue","hasPercent","getFirstFilled","makeTemplateVariables","customdata","obj","ptTx","texttemplateString","_d3locale","cosA","sinA","midX","midY","textX","textY","noCenter","module","exports"],"mappings":"AAAA;;AAEA,IAAIA,EAAE,GAAGC,OAAO,CAAC,YAAD,CAAhB;;AAEA,IAAIC,KAAK,GAAGD,OAAO,CAAC,mBAAD,CAAnB;;AACA,IAAIE,EAAE,GAAGF,OAAO,CAAC,qBAAD,CAAhB;;AACA,IAAIG,KAAK,GAAGH,OAAO,CAAC,wBAAD,CAAnB;;AACA,IAAII,OAAO,GAAGJ,OAAO,CAAC,0BAAD,CAArB;;AACA,IAAIK,GAAG,GAAGL,OAAO,CAAC,WAAD,CAAjB;;AACA,IAAIM,QAAQ,GAAGD,GAAG,CAACC,QAAnB;AACA,IAAIC,YAAY,GAAGF,GAAG,CAACE,YAAvB;;AACA,IAAIC,YAAY,GAAGR,OAAO,CAAC,0BAAD,CAA1B;;AACA,IAAIS,WAAW,GAAGT,OAAO,CAAC,qBAAD,CAAzB;;AACA,IAAIU,iBAAiB,GAAGD,WAAW,CAACC,iBAApC;AACA,IAAIC,gBAAgB,GAAGF,WAAW,CAACE,gBAAnC;;AACA,IAAIC,OAAO,GAAGZ,OAAO,CAAC,kBAAD,CAAP,CAA4BY,OAA1C;;AAEA,IAAIC,OAAO,GAAGb,OAAO,CAAC,WAAD,CAArB;;AACA,IAAIc,SAAS,GAAGd,OAAO,CAAC,cAAD,CAAvB;;AACA,IAAIe,gBAAgB,GAAGf,OAAO,CAAC,WAAD,CAAP,CAAqBe,gBAA5C;;AAEA,SAASC,IAAT,CAAcC,EAAd,EAAkBC,QAAlB,EAA4B;AACxB,MAAIC,UAAU,GAAGF,EAAE,CAACG,WAApB;AACA,MAAIC,EAAE,GAAGF,UAAU,CAACG,KAApB;AAEAX,EAAAA,gBAAgB,CAAC,KAAD,EAAQQ,UAAR,CAAhB;AAEAI,EAAAA,eAAe,CAACL,QAAD,EAAWD,EAAX,CAAf;AACAO,EAAAA,WAAW,CAACN,QAAD,EAAWG,EAAX,CAAX;AAEA,MAAII,UAAU,GAAGpB,GAAG,CAACqB,eAAJ,CAAoBP,UAAU,CAACQ,SAA/B,EAA0CT,QAA1C,EAAoD,OAApD,EAA6DU,IAA7D,CAAkE,UAASC,EAAT,EAAa;AAC5F,QAAIC,SAAS,GAAG/B,EAAE,CAACgC,MAAH,CAAU,IAAV,CAAhB;AACA,QAAIC,GAAG,GAAGH,EAAE,CAAC,CAAD,CAAZ;AACA,QAAII,KAAK,GAAGD,GAAG,CAACC,KAAhB;AAEAC,IAAAA,SAAS,CAACL,EAAD,CAAT,CAL4F,CAO5F;AACA;;AACAC,IAAAA,SAAS,CAACK,IAAV,CAAe,iBAAf,EAAkC,OAAlC;AAEAL,IAAAA,SAAS,CAACF,IAAV,CAAe,YAAW;AACtB,UAAIQ,MAAM,GAAGrC,EAAE,CAACgC,MAAH,CAAU,IAAV,EAAgBM,SAAhB,CAA0B,SAA1B,EAAqCC,IAArC,CAA0CT,EAA1C,CAAb;AAEAO,MAAAA,MAAM,CAACG,KAAP,GAAeC,MAAf,CAAsB,GAAtB,EACKC,OADL,CACa,OADb,EACsB,IADtB;AAEAL,MAAAA,MAAM,CAACM,IAAP,GAAcC,MAAd;AAEA,UAAIC,SAAS,GAAG,CACZ,CAAC,EAAD,EAAK,EAAL,CADY,EACF;AACV,OAAC,EAAD,EAAK,EAAL,CAFY,CAEH;AAFG,OAAhB;AAIA,UAAIC,cAAc,GAAG,KAArB;AAEAT,MAAAA,MAAM,CAACR,IAAP,CAAY,UAASkB,EAAT,EAAaC,CAAb,EAAgB;AACxB,YAAGD,EAAE,CAACE,MAAN,EAAc;AACVjD,UAAAA,EAAE,CAACgC,MAAH,CAAU,IAAV,EAAgBM,SAAhB,CAA0B,QAA1B,EAAoCM,MAApC;AACA;AACH,SAJuB,CAMxB;;;AACAG,QAAAA,EAAE,CAACG,WAAH,GAAiBH,EAAE,CAACC,CAApB;AACAD,QAAAA,EAAE,CAACI,WAAH,GAAiBjB,KAAK,CAACkB,KAAvB;AAEAP,QAAAA,SAAS,CAACE,EAAE,CAACM,KAAH,CAAS,CAAT,IAAc,CAAd,GAAkB,CAAlB,GAAsB,CAAvB,CAAT,CAAmCN,EAAE,CAACM,KAAH,CAAS,CAAT,IAAc,CAAd,GAAkB,CAAlB,GAAsB,CAAzD,EAA4DC,IAA5D,CAAiEP,EAAjE;AAEA,YAAIQ,EAAE,GAAGtB,GAAG,CAACsB,EAAb;AACA,YAAIC,EAAE,GAAGvB,GAAG,CAACuB,EAAb;AACA,YAAIC,QAAQ,GAAGzD,EAAE,CAACgC,MAAH,CAAU,IAAV,CAAf;AACA,YAAI0B,SAAS,GAAGD,QAAQ,CAACnB,SAAT,CAAmB,cAAnB,EAAmCC,IAAnC,CAAwC,CAACQ,EAAD,CAAxC,CAAhB;AAEAW,QAAAA,SAAS,CAAClB,KAAV,GAAkBC,MAAlB,CAAyB,MAAzB,EACKC,OADL,CACa,SADb,EACwB,IADxB,EAEKiB,KAFL,CAEW;AAAC,4BAAkB;AAAnB,SAFX;AAIAF,QAAAA,QAAQ,CAACG,IAAT,CAAcC,gBAAd,EAAgC3C,EAAhC,EAAoCY,EAApC;;AAEA,YAAGI,KAAK,CAAC4B,IAAT,EAAe;AACX,cAAIA,IAAI,GAAG,CAAChD,OAAO,CAACiD,UAAR,CAAmB7B,KAAK,CAAC4B,IAAzB,EAA+Bf,EAAE,CAACiB,GAAlC,CAAD,IAA2C,CAAtD;;AACA,cAAGF,IAAI,GAAG,CAAV,EAAa;AACTP,YAAAA,EAAE,IAAIO,IAAI,GAAGf,EAAE,CAACM,KAAH,CAAS,CAAT,CAAb;AACAG,YAAAA,EAAE,IAAIM,IAAI,GAAGf,EAAE,CAACM,KAAH,CAAS,CAAT,CAAb;AACH;AACJ;;AAEDN,QAAAA,EAAE,CAACkB,OAAH,GAAaV,EAAb;AACAR,QAAAA,EAAE,CAACmB,OAAH,GAAaV,EAAb;;AAEA,iBAASW,GAAT,CAAaC,KAAb,EAAoBC,MAApB,EAA4BC,EAA5B,EAAgCC,KAAhC,EAAuC;AACnC,cAAIC,EAAE,GAAGD,KAAK,IAAIF,MAAM,CAAC,CAAD,CAAN,GAAYD,KAAK,CAAC,CAAD,CAArB,CAAd;AACA,cAAIK,EAAE,GAAGF,KAAK,IAAIF,MAAM,CAAC,CAAD,CAAN,GAAYD,KAAK,CAAC,CAAD,CAArB,CAAd;AAEA,iBAAO,MACFG,KAAK,GAAGtC,GAAG,CAACyC,CADV,GACe,GADf,GACsBH,KAAK,GAAGtC,GAAG,CAACyC,CADlC,GACuC,KADvC,GAEH3B,EAAE,CAAC4B,QAFA,IAEYL,EAAE,GAAG,KAAH,GAAW,KAFzB,IAEkCE,EAFlC,GAEuC,GAFvC,GAE6CC,EAFpD;AAGH;;AAED,YAAIG,IAAI,GAAG1C,KAAK,CAAC0C,IAAjB;;AACA,YAAG7B,EAAE,CAAC8B,CAAH,KAAS5C,GAAG,CAAC6C,MAAhB,EAAwB;AAAE;AACtB,cAAIC,WAAW,GAAG,OAAOxB,EAAE,GAAGR,EAAE,CAACiC,GAAH,CAAO,CAAP,CAAZ,IAAyB,GAAzB,IAAgCxB,EAAE,GAAGT,EAAE,CAACiC,GAAH,CAAO,CAAP,CAArC,IACdb,GAAG,CAACpB,EAAE,CAACiC,GAAJ,EAASjC,EAAE,CAACM,KAAZ,EAAmB,IAAnB,EAAyB,CAAzB,CADW,GAEdc,GAAG,CAACpB,EAAE,CAACM,KAAJ,EAAWN,EAAE,CAACiC,GAAd,EAAmB,IAAnB,EAAyB,CAAzB,CAFW,GAEmB,GAFrC;;AAGA,cAAGJ,IAAH,EAAS;AACLlB,YAAAA,SAAS,CAACtB,IAAV,CAAe,GAAf,EACI,OAAOmB,EAAE,GAAGqB,IAAI,GAAG7B,EAAE,CAACiC,GAAH,CAAO,CAAP,CAAnB,IAAgC,GAAhC,IAAuCxB,EAAE,GAAGoB,IAAI,GAAG7B,EAAE,CAACiC,GAAH,CAAO,CAAP,CAAnD,IACAb,GAAG,CAACpB,EAAE,CAACiC,GAAJ,EAASjC,EAAE,CAACM,KAAZ,EAAmB,KAAnB,EAA0BuB,IAA1B,CADH,GAEAT,GAAG,CAACpB,EAAE,CAACM,KAAJ,EAAWN,EAAE,CAACiC,GAAd,EAAmB,KAAnB,EAA0BJ,IAA1B,CAFH,GAGA,GAHA,GAGMG,WAJV;AAKH,WAND,MAMOrB,SAAS,CAACtB,IAAV,CAAe,GAAf,EAAoB2C,WAApB;AACV,SAXD,MAWO;AACH,cAAIE,QAAQ,GAAGd,GAAG,CAACpB,EAAE,CAACiC,GAAJ,EAASjC,EAAE,CAACmC,GAAZ,EAAiB,IAAjB,EAAuB,CAAvB,CAAlB;;AAEA,cAAGN,IAAH,EAAS;AACL,gBAAIO,GAAG,GAAG,IAAIP,IAAd;AACAlB,YAAAA,SAAS,CAACtB,IAAV,CAAe,GAAf,EACI,OAAOmB,EAAE,GAAGqB,IAAI,GAAG7B,EAAE,CAACmC,GAAH,CAAO,CAAP,CAAnB,IAAgC,GAAhC,IAAuC1B,EAAE,GAAGoB,IAAI,GAAG7B,EAAE,CAACmC,GAAH,CAAO,CAAP,CAAnD,IACAf,GAAG,CAACpB,EAAE,CAACmC,GAAJ,EAASnC,EAAE,CAACiC,GAAZ,EAAiB,KAAjB,EAAwBJ,IAAxB,CADH,GAEA,GAFA,GAEOO,GAAG,GAAGpC,EAAE,CAACiC,GAAH,CAAO,CAAP,CAFb,GAE0B,GAF1B,GAEiCG,GAAG,GAAGpC,EAAE,CAACiC,GAAH,CAAO,CAAP,CAFvC,GAGAC,QAHA,GAIA,GALJ;AAMH,WARD,MAQO;AACHvB,YAAAA,SAAS,CAACtB,IAAV,CAAe,GAAf,EACI,MAAMmB,EAAN,GAAW,GAAX,GAAiBC,EAAjB,GACA,GADA,GACMT,EAAE,CAACiC,GAAH,CAAO,CAAP,CADN,GACkB,GADlB,GACwBjC,EAAE,CAACiC,GAAH,CAAO,CAAP,CADxB,GAEAC,QAFA,GAGA,GAJJ;AAKH;AACJ,SAzEuB,CA2ExB;;;AACAG,QAAAA,gBAAgB,CAAClE,EAAD,EAAK6B,EAAL,EAASd,GAAT,CAAhB;AACA,YAAIoD,YAAY,GAAGvE,OAAO,CAACiD,UAAR,CAAmB7B,KAAK,CAACoD,YAAzB,EAAuCvC,EAAE,CAACiB,GAA1C,CAAnB;AACA,YAAIuB,cAAc,GAAG9B,QAAQ,CAACnB,SAAT,CAAmB,aAAnB,EAChBC,IADgB,CACXQ,EAAE,CAACyC,IAAH,IAAYH,YAAY,KAAK,MAA7B,GAAuC,CAAC,CAAD,CAAvC,GAA6C,EADlC,CAArB;AAGAE,QAAAA,cAAc,CAAC/C,KAAf,GAAuBC,MAAvB,CAA8B,GAA9B,EACKC,OADL,CACa,WADb,EAC0B,IAD1B;AAEA6C,QAAAA,cAAc,CAAC5C,IAAf,GAAsBC,MAAtB;AAEA2C,QAAAA,cAAc,CAAC1D,IAAf,CAAoB,YAAW;AAC3B,cAAI4D,SAAS,GAAGnF,GAAG,CAACoF,YAAJ,CAAiB1F,EAAE,CAACgC,MAAH,CAAU,IAAV,CAAjB,EAAkC,MAAlC,EAA0C,EAA1C,EAA8C,UAAS2D,CAAT,EAAY;AACtE;AACA;AACAA,YAAAA,CAAC,CAACvD,IAAF,CAAO,YAAP,EAAqB,CAArB;AACH,WAJe,CAAhB;AAMA,cAAIwD,IAAI,GAAGtF,GAAG,CAACuF,qBAAJ,CAA0B3E,EAA1B,EAA8BmE,YAAY,KAAK,SAAjB,GACrCS,wBAAwB,CAAC5D,KAAD,EAAQa,EAAR,EAAY3B,UAAU,CAACwE,IAAvB,CADa,GAErCG,uBAAuB,CAAC7D,KAAD,EAAQa,EAAR,EAAY3B,UAAU,CAACwE,IAAvB,CAFhB,CAAX;AAKAH,UAAAA,SAAS,CAACD,IAAV,CAAezC,EAAE,CAACyC,IAAlB,EACKpD,IADL,CACU;AACF,qBAAS,WADP;AAEF4D,YAAAA,SAAS,EAAE,EAFT;AAGF,2BAAe;AAHb,WADV,EAMKpC,IANL,CAMUvD,OAAO,CAACuF,IANlB,EAMwBA,IANxB,EAOKhC,IAPL,CAOUnD,YAAY,CAACwF,eAPvB,EAOwC/E,EAPxC,EAZ2B,CAqB3B;;AACA,cAAIgF,MAAM,GAAG7F,OAAO,CAAC8F,IAAR,CAAaV,SAAS,CAACW,IAAV,EAAb,CAAb;AACA,cAAIJ,SAAJ;;AAEA,cAAGX,YAAY,KAAK,SAApB,EAA+B;AAC3BW,YAAAA,SAAS,GAAGK,oBAAoB,CAACH,MAAD,EAASnD,EAAT,CAAhC;AACH,WAFD,MAEO;AACHiD,YAAAA,SAAS,GAAGM,mBAAmB,CAACJ,MAAD,EAASnD,EAAT,EAAad,GAAb,CAA/B;;AACA,gBAAGoD,YAAY,KAAK,MAAjB,IAA2BW,SAAS,CAACzB,KAAV,GAAkB,CAAhD,EAAmD;AAC/C,kBAAIgC,OAAO,GAAGjG,GAAG,CAACuF,qBAAJ,CAA0B3E,EAA1B,EAA8BgB,KAAK,CAACsE,eAApC,CAAd;AAEAf,cAAAA,SAAS,CAAC7B,IAAV,CAAevD,OAAO,CAACuF,IAAvB,EAA6BW,OAA7B;AACAL,cAAAA,MAAM,GAAG7F,OAAO,CAAC8F,IAAR,CAAaV,SAAS,CAACW,IAAV,EAAb,CAAT;AAEAJ,cAAAA,SAAS,GAAGK,oBAAoB,CAACH,MAAD,EAASnD,EAAT,CAAhC;AACH;AACJ;;AAED,cAAI0D,YAAY,GAAGT,SAAS,CAACS,YAA7B;AACA,cAAIC,MAAM,GAAGD,YAAY,KAAKE,SAAjB,GAA6B5D,EAAE,CAACM,KAAhC,GAAwCuD,SAAS,CAAC3E,GAAG,CAACyC,CAAL,EAAQ+B,YAAR,CAA9D;AACAT,UAAAA,SAAS,CAACa,OAAV,GAAoBtD,EAAE,GAAGmD,MAAM,CAAC,CAAD,CAAN,GAAYV,SAAS,CAACc,OAA3B,IAAsCd,SAAS,CAACe,CAAV,IAAe,CAArD,CAApB;AACAf,UAAAA,SAAS,CAACgB,OAAV,GAAoBxD,EAAE,GAAGkD,MAAM,CAAC,CAAD,CAAN,GAAYV,SAAS,CAACc,OAA3B,IAAsCd,SAAS,CAACiB,CAAV,IAAe,CAArD,CAApB;AACAC,UAAAA,gBAAgB,CAAClB,SAAD,EAAYE,MAAZ,CAAhB,CA3C2B,CA6C3B;;AACA,cAAGF,SAAS,CAACmB,OAAb,EAAsB;AAClB,gBAAIH,OAAO,GAAGhB,SAAS,CAACgB,OAAxB;AACAjE,YAAAA,EAAE,CAACqE,SAAH,GAAeJ,OAAO,GAAGd,MAAM,CAACmB,MAAP,GAAgB,CAAzC;AACAtE,YAAAA,EAAE,CAACuE,SAAH,GAAeN,OAAf;AACAjE,YAAAA,EAAE,CAACwE,SAAH,GAAeP,OAAO,GAAGd,MAAM,CAACmB,MAAP,GAAgB,CAAzC;AACAtE,YAAAA,EAAE,CAACyE,WAAH,GAAiB,CAAjB;AACAzE,YAAAA,EAAE,CAAC0E,WAAH,GAAiB,CAAjB;AACA3E,YAAAA,cAAc,GAAG,IAAjB;AACH;;AAEDkD,UAAAA,SAAS,CAAC0B,QAAV,GAAqB9B,IAAI,CAAC+B,IAA1B;AACAhH,UAAAA,iBAAiB,CAACuB,KAAK,CAAC0F,IAAP,EAAa5B,SAAb,EAAwB5E,UAAxB,CAAjB;AACAU,UAAAA,EAAE,CAACkB,CAAD,CAAF,CAAMgD,SAAN,GAAkBA,SAAlB;AAEAP,UAAAA,SAAS,CAACrD,IAAV,CAAe,WAAf,EAA4B9B,GAAG,CAACuH,gBAAJ,CAAqB7B,SAArB,CAA5B;AACH,SA7DD;AA8DH,OAnJD,EAbsB,CAkKtB;;AACA,UAAI8B,cAAc,GAAG9H,EAAE,CAACgC,MAAH,CAAU,IAAV,EAAgBM,SAAhB,CAA0B,aAA1B,EAChBC,IADgB,CACXL,KAAK,CAAC6F,KAAN,CAAYvC,IAAZ,GAAmB,CAAC,CAAD,CAAnB,GAAyB,EADd,CAArB;AAGAsC,MAAAA,cAAc,CAACtF,KAAf,GAAuBC,MAAvB,CAA8B,GAA9B,EACKC,OADL,CACa,WADb,EAC0B,IAD1B;AAEAoF,MAAAA,cAAc,CAACnF,IAAf,GAAsBC,MAAtB;AAEAkF,MAAAA,cAAc,CAACjG,IAAf,CAAoB,YAAW;AAC3B,YAAImG,SAAS,GAAG1H,GAAG,CAACoF,YAAJ,CAAiB1F,EAAE,CAACgC,MAAH,CAAU,IAAV,CAAjB,EAAkC,MAAlC,EAA0C,EAA1C,EAA8C,UAAS2D,CAAT,EAAY;AACtE;AACAA,UAAAA,CAAC,CAACvD,IAAF,CAAO,YAAP,EAAqB,CAArB;AACH,SAHe,CAAhB;AAKA,YAAI6F,GAAG,GAAG/F,KAAK,CAAC6F,KAAN,CAAYvC,IAAtB;;AACA,YAAGtD,KAAK,CAACgG,KAAT,EAAgB;AACZD,UAAAA,GAAG,GAAG3H,GAAG,CAAC6H,cAAJ,CAAmBF,GAAnB,EAAwB/F,KAAK,CAACgG,KAA9B,CAAN;AACH;;AAEDF,QAAAA,SAAS,CAACxC,IAAV,CAAeyC,GAAf,EACK7F,IADL,CACU;AACF,mBAAS,WADP;AAEF4D,UAAAA,SAAS,EAAE,EAFT;AAGF,yBAAe;AAHb,SADV,EAMCpC,IAND,CAMMvD,OAAO,CAACuF,IANd,EAMoB1D,KAAK,CAAC6F,KAAN,CAAYnC,IANhC,EAOChC,IAPD,CAOMnD,YAAY,CAACwF,eAPnB,EAOoC/E,EAPpC;AASA,YAAI8E,SAAJ;;AAEA,YAAG9D,KAAK,CAAC6F,KAAN,CAAYK,QAAZ,KAAyB,eAA5B,EAA6C;AACzCpC,UAAAA,SAAS,GAAGqC,mBAAmB,CAACpG,GAAD,CAA/B;AACH,SAFD,MAEO;AACH+D,UAAAA,SAAS,GAAGsC,oBAAoB,CAACrG,GAAD,EAAMX,EAAN,CAAhC;AACH;;AAED0G,QAAAA,SAAS,CAAC5F,IAAV,CAAe,WAAf,EACI5B,YAAY,CAACwF,SAAS,CAACe,CAAX,EAAcf,SAAS,CAACiB,CAAxB,CAAZ,GACA1G,QAAQ,CAACgI,IAAI,CAACC,GAAL,CAAS,CAAT,EAAYxC,SAAS,CAACzB,KAAtB,CAAD,CADR,GAEA/D,YAAY,CAACwF,SAAS,CAACyC,EAAX,EAAezC,SAAS,CAAC0C,EAAzB,CAHhB;AAIH,OAhCD,EA1KsB,CA4MtB;;AACA,UAAG5F,cAAH,EAAmB6F,WAAW,CAAC9F,SAAD,EAAYX,KAAZ,CAAX;AAEnB0G,MAAAA,aAAa,CAACvG,MAAD,EAASH,KAAT,CAAb;;AAEA,UAAGY,cAAc,IAAIZ,KAAK,CAAC2G,UAA3B,EAAuC;AACnC;AACA;AACA;AACA,YAAIC,SAAS,GAAGzI,OAAO,CAAC8F,IAAR,CAAapE,SAAS,CAACqE,IAAV,EAAb,CAAhB;AAEA,YAAI2C,MAAM,GAAG7G,KAAK,CAAC6G,MAAnB;AACA,YAAIC,GAAG,GAAG1H,EAAE,CAAC2H,CAAH,IAAQF,MAAM,CAAChC,CAAP,CAAS,CAAT,IAAcgC,MAAM,CAAChC,CAAP,CAAS,CAAT,CAAtB,CAAV;AACA,YAAImC,GAAG,GAAG5H,EAAE,CAAC6H,CAAH,IAAQJ,MAAM,CAAC9B,CAAP,CAAS,CAAT,IAAc8B,MAAM,CAAC9B,CAAP,CAAS,CAAT,CAAtB,CAAV;AACA,YAAImC,IAAI,GAAG,CAAC,MAAMJ,GAAN,GAAY/G,GAAG,CAACyC,CAAjB,IAAsBpD,EAAE,CAAC2H,CAApC;AACA,YAAII,IAAI,GAAG,CAAC,MAAMH,GAAN,GAAYjH,GAAG,CAACyC,CAAjB,IAAsBpD,EAAE,CAAC6H,CAApC;AAEAjJ,QAAAA,KAAK,CAACoJ,UAAN,CAAiBpI,EAAjB,EAAqB,SAASgB,KAAK,CAACqH,GAAf,GAAqB,aAA1C,EAAyD;AACrDC,UAAAA,EAAE,EAAET,MAAM,CAAChC,CAAP,CAAS,CAAT,IAAcqC,IADmC;AAErDK,UAAAA,EAAE,EAAEV,MAAM,CAAChC,CAAP,CAAS,CAAT,IAAcqC,IAFmC;AAGrDM,UAAAA,EAAE,EAAEX,MAAM,CAAC9B,CAAP,CAAS,CAAT,IAAcoC,IAHmC;AAIrDM,UAAAA,EAAE,EAAEZ,MAAM,CAAC9B,CAAP,CAAS,CAAT,IAAcoC,IAJmC;AAKrDO,UAAAA,CAAC,EAAErB,IAAI,CAACsB,GAAL,CAAS5H,GAAG,CAACsB,EAAJ,GAAStB,GAAG,CAACyC,CAAb,GAAiBoE,SAAS,CAACgB,IAApC,EAA0C,CAA1C,CALkD;AAMrDpF,UAAAA,CAAC,EAAE6D,IAAI,CAACsB,GAAL,CAASf,SAAS,CAACiB,KAAV,IAAmB9H,GAAG,CAACsB,EAAJ,GAAStB,GAAG,CAACyC,CAAhC,CAAT,EAA6C,CAA7C,CANkD;AAOrDsF,UAAAA,CAAC,EAAEzB,IAAI,CAACsB,GAAL,CAASf,SAAS,CAACmB,MAAV,IAAoBhI,GAAG,CAACuB,EAAJ,GAASvB,GAAG,CAACyC,CAAjC,CAAT,EAA8C,CAA9C,CAPkD;AAQrDwF,UAAAA,CAAC,EAAE3B,IAAI,CAACsB,GAAL,CAAS5H,GAAG,CAACuB,EAAJ,GAASvB,GAAG,CAACyC,CAAb,GAAiBoE,SAAS,CAACqB,GAApC,EAAyC,CAAzC,CARkD;AASrDC,UAAAA,GAAG,EAAE;AATgD,SAAzD;AAWH;AACJ,KAzOD;AA0OH,GArPgB,CAAjB,CATwB,CAgQxB;AACA;AACA;AACA;AACA;AACA;;AACAC,EAAAA,UAAU,CAAC,YAAW;AAClB3I,IAAAA,UAAU,CAACY,SAAX,CAAqB,OAArB,EAA8BT,IAA9B,CAAmC,YAAW;AAC1C,UAAI8D,CAAC,GAAG3F,EAAE,CAACgC,MAAH,CAAU,IAAV,CAAR;AACA,UAAG2D,CAAC,CAACvD,IAAF,CAAO,IAAP,CAAH,EAAiBuD,CAAC,CAACvD,IAAF,CAAO,IAAP,EAAauD,CAAC,CAACvD,IAAF,CAAO,IAAP,CAAb;AACpB,KAHD;AAIH,GALS,EAKP,CALO,CAAV;AAMH,C,CAED;;;AACA,SAASwG,aAAT,CAAuBvG,MAAvB,EAA+BH,KAA/B,EAAsC;AAClCG,EAAAA,MAAM,CAACR,IAAP,CAAY,UAASkB,EAAT,EAAa;AACrB,QAAIU,QAAQ,GAAGzD,EAAE,CAACgC,MAAH,CAAU,IAAV,CAAf;;AAEA,QAAG,CAACe,EAAE,CAACyE,WAAJ,IAAmB,CAACzE,EAAE,CAAC0E,WAA1B,EAAuC;AACnChE,MAAAA,QAAQ,CAACzB,MAAT,CAAgB,eAAhB,EAAiCY,MAAjC;AACA;AACH,KANoB,CAQrB;;;AACA,QAAI6C,SAAS,GAAGhC,QAAQ,CAACzB,MAAT,CAAgB,kBAAhB,CAAhB;AAEAe,IAAAA,EAAE,CAACiD,SAAH,CAAaa,OAAb,IAAwB9D,EAAE,CAACyE,WAA3B;AACAzE,IAAAA,EAAE,CAACiD,SAAH,CAAagB,OAAb,IAAwBjE,EAAE,CAAC0E,WAA3B;AAEAhC,IAAAA,SAAS,CAACrD,IAAV,CAAe,WAAf,EAA4B9B,GAAG,CAACuH,gBAAJ,CAAqB9E,EAAE,CAACiD,SAAxB,CAA5B,EAdqB,CAgBrB;;AACA,QAAIsE,UAAU,GAAGvH,EAAE,CAACkB,OAAH,GAAalB,EAAE,CAACM,KAAH,CAAS,CAAT,CAA9B;AACA,QAAIkH,UAAU,GAAGxH,EAAE,CAACmB,OAAH,GAAanB,EAAE,CAACM,KAAH,CAAS,CAAT,CAA9B;AACA,QAAImH,YAAY,GAAG,MAAMF,UAAN,GAAmB,GAAnB,GAAyBC,UAA5C;AACA,QAAIE,MAAM,GAAG,CAAC1H,EAAE,CAACwE,SAAH,GAAexE,EAAE,CAACqE,SAAnB,KAAiCrE,EAAE,CAACM,KAAH,CAAS,CAAT,IAAc,CAAd,GAAkB,CAAC,CAAnB,GAAuB,CAAxD,IAA6D,CAA1E;;AAEA,QAAGN,EAAE,CAACyE,WAAN,EAAmB;AACf,UAAIkD,MAAM,GAAG3H,EAAE,CAACyE,WAAH,GAAiBzE,EAAE,CAACM,KAAH,CAAS,CAAT,CAAjB,GAA+BN,EAAE,CAACM,KAAH,CAAS,CAAT,CAA5C;AACA,UAAIsH,IAAI,GAAG5H,EAAE,CAACuE,SAAH,GAAevE,EAAE,CAAC0E,WAAlB,IAAiC1E,EAAE,CAACmB,OAAH,GAAanB,EAAE,CAACM,KAAH,CAAS,CAAT,CAA9C,CAAX;;AAEA,UAAGkF,IAAI,CAACqC,GAAL,CAASF,MAAT,IAAmBnC,IAAI,CAACqC,GAAL,CAASD,IAAT,CAAtB,EAAsC;AAClCH,QAAAA,YAAY,IACR,MAAOG,IAAI,GAAG5H,EAAE,CAACM,KAAH,CAAS,CAAT,CAAP,GAAqBN,EAAE,CAACM,KAAH,CAAS,CAAT,CAA5B,GAA2C,GAA3C,GAAiDsH,IAAjD,GACA,GADA,IACOL,UAAU,GAAGvH,EAAE,CAACyE,WAAhB,GAA8BiD,MADrC,CADJ;AAGH,OAJD,MAIO;AACHD,QAAAA,YAAY,IAAI,MAAMzH,EAAE,CAACyE,WAAT,GAAuB,GAAvB,GAA6BkD,MAA7B,GACZ,GADY,IACLC,IAAI,GAAGD,MADF,IAEZ,GAFY,GAEND,MAFV;AAGH;AACJ,KAbD,MAaO;AACHD,MAAAA,YAAY,IACR,OAAOzH,EAAE,CAACuE,SAAH,GAAevE,EAAE,CAAC0E,WAAzB,IACA,GADA,GACMgD,MAFV;AAGH;;AAEDnK,IAAAA,GAAG,CAACoF,YAAJ,CAAiBjC,QAAjB,EAA2B,MAA3B,EAAmC,UAAnC,EACKG,IADL,CACUxD,KAAK,CAACyK,MADhB,EACwB3I,KAAK,CAACsE,eAAN,CAAsBsE,KAD9C,EAEK1I,IAFL,CAEU;AACF,sBAAgBmG,IAAI,CAACC,GAAL,CAAS,CAAT,EAAYtG,KAAK,CAACsE,eAAN,CAAsBmB,IAAtB,GAA6B,CAAzC,CADd;AAEFoD,MAAAA,CAAC,EAAEP,YAFD;AAGFQ,MAAAA,IAAI,EAAE;AAHJ,KAFV;AAOH,GAhDD;AAiDH;;AAED,SAASnH,gBAAT,CAA0BJ,QAA1B,EAAoCvC,EAApC,EAAwCY,EAAxC,EAA4C;AACxC,MAAIG,GAAG,GAAGH,EAAE,CAAC,CAAD,CAAZ;AACA,MAAIyB,EAAE,GAAGtB,GAAG,CAACsB,EAAb;AACA,MAAIC,EAAE,GAAGvB,GAAG,CAACuB,EAAb;AACA,MAAItB,KAAK,GAAGD,GAAG,CAACC,KAAhB;AACA,MAAI+I,YAAY,GAAG/I,KAAK,CAAC0F,IAAN,KAAe,YAAlC,CALwC,CAOxC;AACA;;AACA,MAAG,EAAE,oBAAoB1F,KAAtB,CAAH,EAAiCA,KAAK,CAACgJ,cAAN,GAAuB,KAAvB,CATO,CAUxC;AACA;AACA;AACA;;AACA,MAAG,EAAE,oBAAoBhJ,KAAtB,CAAH,EAAiCA,KAAK,CAACiJ,cAAN,GAAuB,KAAvB;AAEjC1H,EAAAA,QAAQ,CAAC2H,EAAT,CAAY,WAAZ,EAAyB,UAASrI,EAAT,EAAa;AAClC;AACA,QAAIsI,WAAW,GAAGnK,EAAE,CAACG,WAArB;AACA,QAAIiK,MAAM,GAAGpK,EAAE,CAACqK,SAAH,CAAarJ,KAAK,CAACkB,KAAnB,CAAb;AAEA,QAAGlC,EAAE,CAACsK,SAAH,IAAgBH,WAAW,CAACI,SAAZ,KAA0B,KAA7C,EAAoD;AAEpD,QAAIC,SAAS,GAAGJ,MAAM,CAACI,SAAvB;;AACA,QAAGC,KAAK,CAACC,OAAN,CAAcF,SAAd,CAAH,EAA6B;AACzB;AACA;AACA;AACA;AACA;AACAA,MAAAA,SAAS,GAAGvL,EAAE,CAAC0L,aAAH,CAAiB;AACzBH,QAAAA,SAAS,EAAE,CAAC5K,OAAO,CAACiD,UAAR,CAAmB2H,SAAnB,EAA8B3I,EAAE,CAACiB,GAAjC,CAAD,CADc;AAEzB8H,QAAAA,OAAO,EAAE5J,KAAK,CAAC4J;AAFU,OAAjB,EAGTT,WAHS,EAGI,CAHJ,CAAZ;AAIH;;AAED,QAAGK,SAAS,KAAK,KAAjB,EAAwBA,SAAS,GAAG,+BAAZ,CApBU,CAsBlC;AACA;;AACA,QAAGJ,MAAM,CAACS,aAAP,IAAyBL,SAAS,KAAK,MAAd,IAAwBA,SAAS,KAAK,MAAtC,IAAgDA,SAA5E,EAAwF;AACpF,UAAIM,UAAU,GAAGjJ,EAAE,CAACiJ,UAAH,IAAiB,CAAlC;AACA,UAAIC,YAAY,GAAG1I,EAAE,GAAGR,EAAE,CAACM,KAAH,CAAS,CAAT,KAAe,IAAI2I,UAAnB,CAAxB;AACA,UAAIE,YAAY,GAAG1I,EAAE,GAAGT,EAAE,CAACM,KAAH,CAAS,CAAT,KAAe,IAAI2I,UAAnB,CAAxB;AACA,UAAIG,UAAU,GAAGd,WAAW,CAACc,UAA7B;AACA,UAAI3G,IAAI,GAAG,EAAX;AAEA,UAAGkG,SAAS,IAAIA,SAAS,CAACU,OAAV,CAAkB,OAAlB,MAA+B,CAAC,CAAhD,EAAmD5G,IAAI,CAAClC,IAAL,CAAUP,EAAE,CAACsJ,KAAb;AACnDtJ,MAAAA,EAAE,CAACyC,IAAH,GAAU1E,OAAO,CAACiD,UAAR,CAAmBuH,MAAM,CAACgB,SAAP,IAAoBhB,MAAM,CAAC9F,IAA9C,EAAoDzC,EAAE,CAACiB,GAAvD,CAAV;;AACA,UAAG0H,SAAS,IAAIA,SAAS,CAACU,OAAV,CAAkB,MAAlB,MAA8B,CAAC,CAA/C,EAAkD;AAC9C,YAAI3D,EAAE,GAAG1F,EAAE,CAACyC,IAAZ;AACA,YAAGlF,GAAG,CAACU,gBAAJ,CAAqByH,EAArB,CAAH,EAA6BjD,IAAI,CAAClC,IAAL,CAAUmF,EAAV;AAChC;;AACD1F,MAAAA,EAAE,CAACwJ,KAAH,GAAWxJ,EAAE,CAAC8B,CAAd;AACA9B,MAAAA,EAAE,CAACyJ,UAAH,GAAgB1L,OAAO,CAAC2L,cAAR,CAAuB1J,EAAE,CAAC8B,CAA1B,EAA6BsH,UAA7B,CAAhB;AACA,UAAGT,SAAS,IAAIA,SAAS,CAACU,OAAV,CAAkB,OAAlB,MAA+B,CAAC,CAAhD,EAAmD5G,IAAI,CAAClC,IAAL,CAAUP,EAAE,CAACyJ,UAAb;AACnDzJ,MAAAA,EAAE,CAAC2J,OAAH,GAAa3J,EAAE,CAAC8B,CAAH,GAAO5C,GAAG,CAAC6C,MAAxB;AACA/B,MAAAA,EAAE,CAAC4J,YAAH,GAAkB7L,OAAO,CAAC8L,gBAAR,CAAyB7J,EAAE,CAAC2J,OAA5B,EAAqCP,UAArC,CAAlB;AACA,UAAGT,SAAS,IAAIA,SAAS,CAACU,OAAV,CAAkB,SAAlB,MAAiC,CAAC,CAAlD,EAAqD5G,IAAI,CAAClC,IAAL,CAAUP,EAAE,CAAC4J,YAAb;AAErD,UAAIE,UAAU,GAAGvB,MAAM,CAACwB,UAAxB;AACA,UAAIC,SAAS,GAAGF,UAAU,CAACjH,IAA3B;AAEA,UAAIoH,IAAI,GAAG,EAAX;AACA7M,MAAAA,EAAE,CAAC8M,SAAH,CAAa;AACT/K,QAAAA,KAAK,EAAEA,KADE;AAETgL,QAAAA,EAAE,EAAEjB,YAAY,GAAGD,UAAU,GAAG/J,GAAG,CAACyC,CAF3B;AAGTyI,QAAAA,EAAE,EAAElB,YAAY,GAAGD,UAAU,GAAG/J,GAAG,CAACyC,CAH3B;AAITuC,QAAAA,CAAC,EAAEiF,YAJM;AAKTkB,QAAAA,GAAG,EAAEnC,YAAY,GAAG1H,EAAE,GAAGR,EAAE,CAACsK,EAAH,CAAM,CAAN,CAAR,GAAmBpB,YAAY,GAAGD,UAAU,GAAG/J,GAAG,CAACyC,CAL3D;AAMT4I,QAAAA,GAAG,EAAErC,YAAY,GAAG1H,EAAE,GAAGR,EAAE,CAACwK,EAAH,CAAM,CAAN,CAAR,GAAmBtB,YAAY,GAAGD,UAAU,GAAG/J,GAAG,CAACyC,CAN3D;AAOT8I,QAAAA,GAAG,EAAEvC,YAAY,GAAGzH,EAAE,GAAGT,EAAE,CAACsK,EAAH,CAAM,CAAN,CAAR,GAAmBnB,YAAY,GAAGF,UAAU,GAAG/J,GAAG,CAACyC,CAP3D;AAQT+I,QAAAA,GAAG,EAAExC,YAAY,GAAGzH,EAAE,GAAGT,EAAE,CAAC2K,EAAH,CAAM,CAAN,CAAR,GAAmBxB,YAAY,GAAGF,UAAU,GAAG/J,GAAG,CAACyC,CAR3D;AASTc,QAAAA,IAAI,EAAEA,IAAI,CAACmI,IAAL,CAAU,MAAV,CATG;AAUTC,QAAAA,IAAI,EAAGtC,MAAM,CAACS,aAAP,IAAwBL,SAAS,CAACU,OAAV,CAAkB,MAAlB,MAA8B,CAAC,CAAxD,GAA6Dd,MAAM,CAACsC,IAApE,GAA2EjH,SAVxE;AAWTkH,QAAAA,UAAU,EAAE9K,EAAE,CAACM,KAAH,CAAS,CAAT,IAAc,CAAd,GAAkB,MAAlB,GAA2B,OAX9B;AAYTyH,QAAAA,KAAK,EAAEhK,OAAO,CAACiD,UAAR,CAAmB8I,UAAU,CAACiB,OAA9B,EAAuC/K,EAAE,CAACiB,GAA1C,KAAkDjB,EAAE,CAAC+H,KAZnD;AAaTiD,QAAAA,WAAW,EAAEjN,OAAO,CAACiD,UAAR,CAAmB8I,UAAU,CAACmB,WAA9B,EAA2CjL,EAAE,CAACiB,GAA9C,CAbJ;AAcTiK,QAAAA,UAAU,EAAEnN,OAAO,CAACiD,UAAR,CAAmBgJ,SAAS,CAACmB,MAA7B,EAAqCnL,EAAE,CAACiB,GAAxC,CAdH;AAeT0D,QAAAA,QAAQ,EAAE5G,OAAO,CAACiD,UAAR,CAAmBgJ,SAAS,CAACpF,IAA7B,EAAmC5E,EAAE,CAACiB,GAAtC,CAfD;AAgBTmK,QAAAA,SAAS,EAAErN,OAAO,CAACiD,UAAR,CAAmBgJ,SAAS,CAACjC,KAA7B,EAAoC/H,EAAE,CAACiB,GAAvC,CAhBF;AAiBToK,QAAAA,UAAU,EAAEtN,OAAO,CAACiD,UAAR,CAAmB8I,UAAU,CAACwB,UAA9B,EAA0CtL,EAAE,CAACiB,GAA7C,CAjBH;AAkBTsK,QAAAA,SAAS,EAAExN,OAAO,CAACiD,UAAR,CAAmB8I,UAAU,CAAC0B,KAA9B,EAAqCxL,EAAE,CAACiB,GAAxC,CAlBF;AAmBT+H,QAAAA,aAAa,EAAEjL,OAAO,CAACiD,UAAR,CAAmBuH,MAAM,CAACS,aAA1B,EAAyChJ,EAAE,CAACiB,GAA5C,CAnBN;AAoBTwK,QAAAA,mBAAmB,EAAEzL,EApBZ;AAqBThC,QAAAA,SAAS,EAAE,CAACA,SAAS,CAACgC,EAAD,EAAKuI,MAAL,CAAV;AArBF,OAAb,EAsBG;AACCmD,QAAAA,SAAS,EAAEpD,WAAW,CAACqD,WAAZ,CAAwBtI,IAAxB,EADZ;AAECuI,QAAAA,cAAc,EAAEtD,WAAW,CAACuD,MAAZ,CAAmBxI,IAAnB,EAFjB;AAGClF,QAAAA,EAAE,EAAEA,EAHL;AAIC2N,QAAAA,UAAU,EAAE7B;AAJb,OAtBH;AA4BAjK,MAAAA,EAAE,CAACiK,IAAH,GAAUA,IAAI,CAAC,CAAD,CAAd;AAEA9K,MAAAA,KAAK,CAACgJ,cAAN,GAAuB,IAAvB;AACH;;AAEDhJ,IAAAA,KAAK,CAACiJ,cAAN,GAAuB,IAAvB;AACAjK,IAAAA,EAAE,CAAC4N,IAAH,CAAQ,cAAR,EAAwB;AACpBC,MAAAA,MAAM,EAAE,CAAChO,SAAS,CAACgC,EAAD,EAAKuI,MAAL,CAAV,CADY;AAEpB0D,MAAAA,KAAK,EAAEhP,EAAE,CAACgP;AAFU,KAAxB;AAIH,GAtFD;AAwFAvL,EAAAA,QAAQ,CAAC2H,EAAT,CAAY,UAAZ,EAAwB,UAAS6D,GAAT,EAAc;AAClC,QAAI5D,WAAW,GAAGnK,EAAE,CAACG,WAArB;AACA,QAAIiK,MAAM,GAAGpK,EAAE,CAACqK,SAAH,CAAarJ,KAAK,CAACkB,KAAnB,CAAb;AACA,QAAIL,EAAE,GAAG/C,EAAE,CAACgC,MAAH,CAAU,IAAV,EAAgBkN,KAAhB,EAAT;;AAEA,QAAGhN,KAAK,CAACiJ,cAAT,EAAyB;AACrB8D,MAAAA,GAAG,CAACE,aAAJ,GAAoBnP,EAAE,CAACgP,KAAvB;AACA9N,MAAAA,EAAE,CAAC4N,IAAH,CAAQ,gBAAR,EAA0B;AACtBC,QAAAA,MAAM,EAAE,CAAChO,SAAS,CAACgC,EAAD,EAAKuI,MAAL,CAAV,CADc;AAEtB0D,QAAAA,KAAK,EAAEhP,EAAE,CAACgP;AAFY,OAA1B;AAIA9M,MAAAA,KAAK,CAACiJ,cAAN,GAAuB,KAAvB;AACH;;AAED,QAAGjJ,KAAK,CAACgJ,cAAT,EAAyB;AACrB/K,MAAAA,EAAE,CAACiP,WAAH,CAAe/D,WAAW,CAACqD,WAAZ,CAAwBtI,IAAxB,EAAf;AACAlE,MAAAA,KAAK,CAACgJ,cAAN,GAAuB,KAAvB;AACH;AACJ,GAlBD;AAoBAzH,EAAAA,QAAQ,CAAC2H,EAAT,CAAY,OAAZ,EAAqB,UAASrI,EAAT,EAAa;AAC9B;AACA;AACA;AACA;AACA;AACA,QAAIsI,WAAW,GAAGnK,EAAE,CAACG,WAArB;AACA,QAAIiK,MAAM,GAAGpK,EAAE,CAACqK,SAAH,CAAarJ,KAAK,CAACkB,KAAnB,CAAb;AAEA,QAAGlC,EAAE,CAACsK,SAAH,IAAgBH,WAAW,CAACI,SAAZ,KAA0B,KAA7C,EAAoD;AAEpDvK,IAAAA,EAAE,CAACmO,UAAH,GAAgB,CAACtO,SAAS,CAACgC,EAAD,EAAKuI,MAAL,CAAV,CAAhB;AACAnL,IAAAA,EAAE,CAACmP,KAAH,CAASpO,EAAT,EAAalB,EAAE,CAACgP,KAAhB;AACH,GAbD;AAcH;;AAED,SAASlJ,wBAAT,CAAkC5D,KAAlC,EAAyCa,EAAzC,EAA6CwM,UAA7C,EAAyD;AACrD,MAAIzE,KAAK,GACLhK,OAAO,CAACiD,UAAR,CAAmB7B,KAAK,CAACsE,eAAN,CAAsBsE,KAAzC,EAAgD/H,EAAE,CAACiB,GAAnD,KACAlD,OAAO,CAACiD,UAAR,CAAmB7B,KAAK,CAACsN,QAAN,CAAe1E,KAAlC,EAAyC/H,EAAE,CAACiB,GAA5C,CADA,IAEAuL,UAAU,CAACzE,KAHf;AAKA,MAAIoD,MAAM,GACNpN,OAAO,CAACiD,UAAR,CAAmB7B,KAAK,CAACsE,eAAN,CAAsB0H,MAAzC,EAAiDnL,EAAE,CAACiB,GAApD,KACAlD,OAAO,CAACiD,UAAR,CAAmB7B,KAAK,CAACsN,QAAN,CAAetB,MAAlC,EAA0CnL,EAAE,CAACiB,GAA7C,CADA,IAEAuL,UAAU,CAACrB,MAHf;AAKA,MAAIvG,IAAI,GACJ7G,OAAO,CAACiD,UAAR,CAAmB7B,KAAK,CAACsE,eAAN,CAAsBmB,IAAzC,EAA+C5E,EAAE,CAACiB,GAAlD,KACAlD,OAAO,CAACiD,UAAR,CAAmB7B,KAAK,CAACsN,QAAN,CAAe7H,IAAlC,EAAwC5E,EAAE,CAACiB,GAA3C,CADA,IAEAuL,UAAU,CAAC5H,IAHf;AAKA,SAAO;AACHmD,IAAAA,KAAK,EAAEA,KADJ;AAEHoD,IAAAA,MAAM,EAAEA,MAFL;AAGHvG,IAAAA,IAAI,EAAEA;AAHH,GAAP;AAKH;;AAED,SAAS5B,uBAAT,CAAiC7D,KAAjC,EAAwCa,EAAxC,EAA4CwM,UAA5C,EAAwD;AACpD,MAAIE,WAAW,GAAG3O,OAAO,CAACiD,UAAR,CAAmB7B,KAAK,CAACwN,cAAN,CAAqB5E,KAAxC,EAA+C/H,EAAE,CAACiB,GAAlD,CAAlB;;AACA,MAAG,CAACyL,WAAD,IAAgBvN,KAAK,CAACyN,MAAN,CAAaH,QAAhC,EAA0C;AACtC;AACA;AACA;AACA;AACAC,IAAAA,WAAW,GAAG3O,OAAO,CAACiD,UAAR,CAAmB7B,KAAK,CAACyN,MAAN,CAAaH,QAAb,CAAsB1E,KAAzC,EAAgD/H,EAAE,CAACiB,GAAnD,CAAd;AACH;;AAED,MAAIkK,MAAM,GACNpN,OAAO,CAACiD,UAAR,CAAmB7B,KAAK,CAACwN,cAAN,CAAqBxB,MAAxC,EAAgDnL,EAAE,CAACiB,GAAnD,KACAlD,OAAO,CAACiD,UAAR,CAAmB7B,KAAK,CAACsN,QAAN,CAAetB,MAAlC,EAA0CnL,EAAE,CAACiB,GAA7C,CADA,IAEAuL,UAAU,CAACrB,MAHf;AAKA,MAAIvG,IAAI,GACJ7G,OAAO,CAACiD,UAAR,CAAmB7B,KAAK,CAACwN,cAAN,CAAqB/H,IAAxC,EAA8C5E,EAAE,CAACiB,GAAjD,KACAlD,OAAO,CAACiD,UAAR,CAAmB7B,KAAK,CAACsN,QAAN,CAAe7H,IAAlC,EAAwC5E,EAAE,CAACiB,GAA3C,CADA,IAEAuL,UAAU,CAAC5H,IAHf;AAKA,SAAO;AACHmD,IAAAA,KAAK,EAAE2E,WAAW,IAAIrP,KAAK,CAACwP,QAAN,CAAe7M,EAAE,CAAC+H,KAAlB,CADnB;AAEHoD,IAAAA,MAAM,EAAEA,MAFL;AAGHvG,IAAAA,IAAI,EAAEA;AAHH,GAAP;AAKH;;AAED,SAASnG,eAAT,CAAyBL,QAAzB,EAAmCD,EAAnC,EAAuC;AACnC,MAAIe,GAAJ,EAASC,KAAT,CADmC,CAGnC;;AACA,OAAI,IAAIc,CAAC,GAAG,CAAZ,EAAeA,CAAC,GAAG7B,QAAQ,CAAC0O,MAA5B,EAAoC7M,CAAC,EAArC,EAAyC;AACrCf,IAAAA,GAAG,GAAGd,QAAQ,CAAC6B,CAAD,CAAR,CAAY,CAAZ,CAAN;AACAd,IAAAA,KAAK,GAAGD,GAAG,CAACC,KAAZ;;AAEA,QAAGA,KAAK,CAAC6F,KAAN,CAAYvC,IAAf,EAAqB;AACjB,UAAIyC,GAAG,GAAG/F,KAAK,CAAC6F,KAAN,CAAYvC,IAAtB;;AACA,UAAGtD,KAAK,CAACgG,KAAT,EAAgB;AACZD,QAAAA,GAAG,GAAG3H,GAAG,CAAC6H,cAAJ,CAAmBF,GAAnB,EAAwB/F,KAAK,CAACgG,KAA9B,CAAN;AACH;;AAED,UAAI4H,UAAU,GAAGzP,OAAO,CAAC0P,MAAR,CAAetN,MAAf,CAAsB,MAAtB,EACdL,IADc,CACT,YADS,EACK,CADL,EAEdoD,IAFc,CAETyC,GAFS,EAGdrE,IAHc,CAGTvD,OAAO,CAACuF,IAHC,EAGK1D,KAAK,CAAC6F,KAAN,CAAYnC,IAHjB,EAIdhC,IAJc,CAITnD,YAAY,CAACwF,eAJJ,EAIqB/E,EAJrB,CAAjB;AAKA,UAAIiF,IAAI,GAAG9F,OAAO,CAAC8F,IAAR,CAAa2J,UAAU,CAAC1J,IAAX,EAAb,EAAgC,IAAhC,CAAX;AACAnE,MAAAA,GAAG,CAAC+N,QAAJ,GAAe;AACXC,QAAAA,KAAK,EAAE9J,IAAI,CAAC8J,KADD;AAEX5I,QAAAA,MAAM,EAAElB,IAAI,CAACkB;AAFF,OAAf;AAIAyI,MAAAA,UAAU,CAAClN,MAAX;AACH;AACJ;AACJ;;AAED,SAAS0D,mBAAT,CAA6BJ,MAA7B,EAAqCnD,EAArC,EAAyCd,GAAzC,EAA8C;AAC1C,MAAIyC,CAAC,GAAGzC,GAAG,CAACyC,CAAJ,IAAS3B,EAAE,CAACmN,IAApB;AACA,MAAIlE,UAAU,GAAGjJ,EAAE,CAACiJ,UAApB;AAEA,MAAImE,OAAO,GAAGpN,EAAE,CAACqN,UAAH,KAAkBrN,EAAE,CAACsN,SAAnC;;AACA,MAAGF,OAAH,EAAY;AACR,WAAO;AACHrJ,MAAAA,OAAO,EAAE,IAAIkF,UADV;AAEHzH,MAAAA,KAAK,EAAE,CAFJ;AAGH+L,MAAAA,MAAM,EAAE,CAHL;AAIH7J,MAAAA,YAAY,EAAE;AAJX,KAAP;AAMH;;AAED,MAAI8J,IAAI,GAAGxN,EAAE,CAACwN,IAAd;AACA,MAAIC,QAAQ,GAAID,IAAI,KAAK,CAAV,IAAiBhI,IAAI,CAACqC,GAAL,CAAS7H,EAAE,CAACqN,UAAH,GAAgBrN,EAAE,CAACsN,SAA5B,MAA2C9H,IAAI,CAACkI,EAAL,GAAU,CAArF;AAEA,MAAIC,SAAS,GAAG3N,EAAE,CAAC4N,SAAnB;AACA,MAAIC,QAAQ,GAAG7N,EAAE,CAAC8N,QAAlB;AAEA,MAAIC,WAAW,GAAG7O,GAAG,CAACC,KAAJ,CAAU6O,qBAA5B;AACA,MAAIC,YAAY,GAAGF,WAAW,KAAK,YAAnC;AACA,MAAIG,YAAY,GAAGH,WAAW,KAAK,YAAnC;AACA,MAAII,QAAQ,GAAGJ,WAAW,KAAK,QAA/B;AACA,MAAIK,MAAM,GAAGL,WAAW,KAAK,MAA7B;AAEA,MAAIM,aAAa,GAAG,EAApB;AACA,MAAIC,IAAJ;;AAEA,MAAG,CAACF,MAAJ,EAAY;AACR;AAEA,QAAIG,gBAAgB,GAAG,UAASC,KAAT,EAAgBC,GAAhB,EAAqB;AACxC,UAAGC,UAAU,CAAC1O,EAAD,EAAKwO,KAAL,CAAb,EAA0B;AACtB,YAAIG,MAAM,GAAGnJ,IAAI,CAACqC,GAAL,CAAS2G,KAAK,GAAGxO,EAAE,CAACqN,UAApB,CAAb;AACA,YAAIuB,KAAK,GAAGpJ,IAAI,CAACqC,GAAL,CAAS2G,KAAK,GAAGxO,EAAE,CAACsN,SAApB,CAAZ;AAEA,YAAIuB,WAAW,GAAGF,MAAM,GAAGC,KAAT,GAAiBD,MAAjB,GAA0BC,KAA5C;;AAEA,YAAGH,GAAG,KAAK,KAAX,EAAkB;AACdH,UAAAA,IAAI,GAAGQ,gBAAgB,CAAC3L,MAAD,EAASxB,CAAT,EAAY6L,IAAZ,EAAkBqB,WAAlB,EAA+B,CAA/B,CAAvB;AACH,SAFD,MAEO;AAAE;AACLP,UAAAA,IAAI,GAAGS,gBAAgB,CAAC5L,MAAD,EAASxB,CAAT,EAAY6L,IAAZ,EAAkBqB,WAAlB,EAA+BrJ,IAAI,CAACkI,EAAL,GAAU,CAAzC,CAAvB;AACH;;AACDY,QAAAA,IAAI,CAAC5K,YAAL,GAAoB8K,KAApB;AAEAH,QAAAA,aAAa,CAAC9N,IAAd,CAAmB+N,IAAnB;AACH;AACJ,KAhBD,CAHQ,CAqBR;;;AACA,QAAIrO,CAAJ;;AACA,QAAGgO,YAAY,IAAIC,YAAnB,EAAiC;AAC7B;AACA,WAAIjO,CAAC,GAAG,CAAR,EAAWA,CAAC,IAAI,CAAC,CAAjB,EAAoBA,CAAC,IAAI,CAAzB,EAA4BsO,gBAAgB,CAAC/I,IAAI,CAACkI,EAAL,GAAUzN,CAAX,EAAc,KAAd,CAAhB,CAFC,CAG7B;;;AACA,WAAIA,CAAC,GAAG,CAAR,EAAWA,CAAC,IAAI,CAAC,CAAjB,EAAoBA,CAAC,IAAI,CAAzB,EAA4BsO,gBAAgB,CAAC/I,IAAI,CAACkI,EAAL,IAAWzN,CAAC,GAAG,CAAf,CAAD,EAAoB,KAApB,CAAhB;AAC/B;;AACD,QAAGgO,YAAY,IAAIE,QAAnB,EAA6B;AACzB;AACA,WAAIlO,CAAC,GAAG,CAAR,EAAWA,CAAC,IAAI,CAAC,CAAjB,EAAoBA,CAAC,IAAI,CAAzB,EAA4BsO,gBAAgB,CAAC/I,IAAI,CAACkI,EAAL,IAAWzN,CAAC,GAAG,GAAf,CAAD,EAAsB,KAAtB,CAAhB,CAFH,CAGzB;;;AACA,WAAIA,CAAC,GAAG,CAAR,EAAWA,CAAC,IAAI,CAAC,CAAjB,EAAoBA,CAAC,IAAI,CAAzB,EAA4BsO,gBAAgB,CAAC/I,IAAI,CAACkI,EAAL,IAAWzN,CAAC,GAAG,GAAf,CAAD,EAAsB,KAAtB,CAAhB;AAC/B;AACJ;;AAED,MAAGwN,QAAQ,IAAIW,MAAZ,IAAsBH,YAAzB,EAAuC;AACnC;AACA;AACA;AACA;AACA,QAAIe,YAAY,GAAGxJ,IAAI,CAACyJ,IAAL,CAAU9L,MAAM,CAAC+J,KAAP,GAAe/J,MAAM,CAAC+J,KAAtB,GAA8B/J,MAAM,CAACmB,MAAP,GAAgBnB,MAAM,CAACmB,MAA/D,CAAnB;AAEAgK,IAAAA,IAAI,GAAG;AACH9M,MAAAA,KAAK,EAAEyH,UAAU,GAAGtH,CAAb,GAAiB,CAAjB,GAAqBqN,YADzB;AAGH;AACAjL,MAAAA,OAAO,EAAE,IAAIkF,UAJV;AAKHsE,MAAAA,MAAM,EAAE;AALL,KAAP;AAQAe,IAAAA,IAAI,CAAC5K,YAAL,GAAoB,CAAC1D,EAAE,CAACqN,UAAH,GAAgBrN,EAAE,CAACsN,SAApB,IAAiC,CAArD;AACA,QAAGgB,IAAI,CAAC9M,KAAL,IAAc,CAAjB,EAAoB,OAAO8M,IAAP;AAEpBD,IAAAA,aAAa,CAAC9N,IAAd,CAAmB+N,IAAnB;AACH;;AAED,MAAGF,MAAM,IAAID,QAAb,EAAuB;AACnBG,IAAAA,IAAI,GAAGS,gBAAgB,CAAC5L,MAAD,EAASxB,CAAT,EAAY6L,IAAZ,EAAkBG,SAAlB,EAA6BE,QAA7B,CAAvB;AACAS,IAAAA,IAAI,CAAC5K,YAAL,GAAoB,CAAC1D,EAAE,CAACqN,UAAH,GAAgBrN,EAAE,CAACsN,SAApB,IAAiC,CAArD;AACAe,IAAAA,aAAa,CAAC9N,IAAd,CAAmB+N,IAAnB;AACH;;AAED,MAAGF,MAAM,IAAIF,YAAb,EAA2B;AACvBI,IAAAA,IAAI,GAAGQ,gBAAgB,CAAC3L,MAAD,EAASxB,CAAT,EAAY6L,IAAZ,EAAkBG,SAAlB,EAA6BE,QAA7B,CAAvB;AACAS,IAAAA,IAAI,CAAC5K,YAAL,GAAoB,CAAC1D,EAAE,CAACqN,UAAH,GAAgBrN,EAAE,CAACsN,SAApB,IAAiC,CAArD;AACAe,IAAAA,aAAa,CAAC9N,IAAd,CAAmB+N,IAAnB;AACH;;AAED,MAAIY,EAAE,GAAG,CAAT;AACA,MAAIC,QAAQ,GAAG,CAAf;;AACA,OAAI,IAAIC,CAAC,GAAG,CAAZ,EAAeA,CAAC,GAAGf,aAAa,CAACvB,MAAjC,EAAyCsC,CAAC,EAA1C,EAA8C;AAC1C,QAAIxM,CAAC,GAAGyL,aAAa,CAACe,CAAD,CAAb,CAAiB5N,KAAzB;;AACA,QAAG2N,QAAQ,GAAGvM,CAAd,EAAiB;AACbuM,MAAAA,QAAQ,GAAGvM,CAAX;AACAsM,MAAAA,EAAE,GAAGE,CAAL;AACH;;AAED,QAAG,CAAChB,MAAD,IAAWe,QAAQ,IAAI,CAA1B,EAA6B;AACzB;AACA;AACH;AACJ;;AACD,SAAOd,aAAa,CAACa,EAAD,CAApB;AACH;;AAED,SAASR,UAAT,CAAoB1O,EAApB,EAAwBwO,KAAxB,EAA+B;AAC3B,MAAInN,KAAK,GAAGrB,EAAE,CAACqN,UAAf;AACA,MAAIgC,IAAI,GAAGrP,EAAE,CAACsN,SAAd;AACA,SACKjM,KAAK,GAAGmN,KAAR,IAAiBA,KAAK,GAAGa,IAA1B,IACChO,KAAK,GAAGmN,KAAR,IAAiBA,KAAK,GAAGa,IAF9B;AAIH;;AAED,SAASN,gBAAT,CAA0B5L,MAA1B,EAAkCxB,CAAlC,EAAqC6L,IAArC,EAA2CG,SAA3C,EAAsDE,QAAtD,EAAgE;AAC5DlM,EAAAA,CAAC,GAAG6D,IAAI,CAACsB,GAAL,CAAS,CAAT,EAAYnF,CAAC,GAAG,IAAI7D,OAApB,CAAJ,CAD4D,CAG5D;;AACA,MAAIwR,CAAC,GAAGnM,MAAM,CAAC+J,KAAP,GAAe/J,MAAM,CAACmB,MAA9B;AACA,MAAI1B,CAAC,GAAG2M,eAAe,CAACD,CAAD,EAAI3B,SAAJ,EAAehM,CAAf,EAAkB6L,IAAlB,CAAvB;AACA,SAAO;AACHhM,IAAAA,KAAK,EAAEoB,CAAC,GAAG,CAAJ,GAAQO,MAAM,CAACmB,MADnB;AAEHP,IAAAA,OAAO,EAAEyL,WAAW,CAACF,CAAD,EAAI1M,CAAC,GAAGjB,CAAR,CAFjB;AAGH4L,IAAAA,MAAM,EAAEkC,UAAU,CAAC5B,QAAD;AAHf,GAAP;AAKH;;AAED,SAASiB,gBAAT,CAA0B3L,MAA1B,EAAkCxB,CAAlC,EAAqC6L,IAArC,EAA2CG,SAA3C,EAAsDE,QAAtD,EAAgE;AAC5DlM,EAAAA,CAAC,GAAG6D,IAAI,CAACsB,GAAL,CAAS,CAAT,EAAYnF,CAAC,GAAG,IAAI7D,OAApB,CAAJ,CAD4D,CAG5D;;AACA,MAAIwR,CAAC,GAAGnM,MAAM,CAACmB,MAAP,GAAgBnB,MAAM,CAAC+J,KAA/B;AACA,MAAItK,CAAC,GAAG2M,eAAe,CAACD,CAAD,EAAI3B,SAAJ,EAAehM,CAAf,EAAkB6L,IAAlB,CAAvB;AACA,SAAO;AACHhM,IAAAA,KAAK,EAAEoB,CAAC,GAAG,CAAJ,GAAQO,MAAM,CAAC+J,KADnB;AAEHnJ,IAAAA,OAAO,EAAEyL,WAAW,CAACF,CAAD,EAAI1M,CAAC,GAAGjB,CAAR,CAFjB;AAGH4L,IAAAA,MAAM,EAAEkC,UAAU,CAAC5B,QAAQ,GAAGrI,IAAI,CAACkI,EAAL,GAAU,CAAtB;AAHf,GAAP;AAKH;;AAED,SAAS8B,WAAT,CAAqBF,CAArB,EAAwBrI,CAAxB,EAA2B;AACvB,SAAOzB,IAAI,CAACkK,GAAL,CAASzI,CAAT,IAAcqI,CAAC,GAAGrI,CAAzB;AACH;;AAED,SAASwI,UAAT,CAAoBtI,CAApB,EAAuB;AACnB,SAAO,CAAC,MAAM3B,IAAI,CAACkI,EAAX,GAAgBvG,CAAhB,GAAoB,GAArB,IAA4B,GAA5B,GAAkC,EAAzC;AACH;;AAED,SAASoI,eAAT,CAAyBD,CAAzB,EAA4B3B,SAA5B,EAAuChM,CAAvC,EAA0C6L,IAA1C,EAAgD;AAC5C,MAAImC,CAAC,GAAGL,CAAC,GAAG,KAAK,IAAI9J,IAAI,CAACoK,GAAL,CAASjC,SAAT,CAAT,CAAZ;AACA,SAAOhM,CAAC,GAAG6D,IAAI,CAACC,GAAL,CACP,KAAKD,IAAI,CAACyJ,IAAL,CAAUU,CAAC,GAAGA,CAAJ,GAAQ,GAAlB,IAAyBA,CAA9B,CADO,EAEPnC,IAAI,IAAIhI,IAAI,CAACyJ,IAAL,CAAUK,CAAC,GAAGA,CAAJ,GAAQ9B,IAAI,GAAG,CAAzB,IAA8B8B,CAAlC,CAFG,CAAX;AAIH;;AAED,SAASO,0BAAT,CAAoC7P,EAApC,EAAwCd,GAAxC,EAA6C;AACzC,MAAGc,EAAE,CAAC8B,CAAH,KAAS5C,GAAG,CAAC6C,MAAb,IAAuB,CAAC7C,GAAG,CAACC,KAAJ,CAAU0C,IAArC,EAA2C,OAAO,CAAP,CADF,CACW;;AAEpD,SAAO2D,IAAI,CAACC,GAAL,CAAS,KAAK,IAAI,IAAID,IAAI,CAACsK,GAAL,CAAS9P,EAAE,CAAC4N,SAAZ,CAAb,CAAT,EAA+C5N,EAAE,CAACwN,IAAH,GAAU,CAAzD,CAAP;AACH;;AAED,SAASlK,oBAAT,CAA8BH,MAA9B,EAAsCnD,EAAtC,EAA0C;AACtC,MAAIgE,CAAC,GAAGhE,EAAE,CAACM,KAAH,CAAS,CAAT,CAAR;AACA,MAAI4D,CAAC,GAAGlE,EAAE,CAACM,KAAH,CAAS,CAAT,CAAR;AACA,MAAImB,EAAE,GAAG0B,MAAM,CAAC+J,KAAP,GAAe,CAAxB;AACA,MAAIxL,EAAE,GAAGyB,MAAM,CAACmB,MAAP,GAAgB,CAAzB;AAEA,MAAGN,CAAC,GAAG,CAAP,EAAUvC,EAAE,IAAI,CAAC,CAAP;AACV,MAAGyC,CAAC,GAAG,CAAP,EAAUxC,EAAE,IAAI,CAAC,CAAP;AAEV,SAAO;AACHF,IAAAA,KAAK,EAAE,CADJ;AAEHuC,IAAAA,OAAO,EAAE,CAFN;AAGHwJ,IAAAA,MAAM,EAAE,CAHL;AAIHvJ,IAAAA,CAAC,EAAEvC,EAAE,GAAG+D,IAAI,CAACqC,GAAL,CAASnG,EAAT,KAAgBD,EAAE,GAAG,CAAL,GAAS,CAAT,GAAa,CAAC,CAA9B,IAAmC,CAJxC;AAKHyC,IAAAA,CAAC,EAAExC,EAAE,IAAI,IAAIsC,CAAC,GAAGA,CAAJ,IAASE,CAAC,GAAGA,CAAb,CAAR,CALF;AAMHE,IAAAA,OAAO,EAAE;AANN,GAAP;AAQH;;AAED,SAASkB,mBAAT,CAA6BpG,GAA7B,EAAkC;AAC9B,MAAI8P,YAAY,GACZxJ,IAAI,CAACyJ,IAAL,CAAU/P,GAAG,CAAC+N,QAAJ,CAAaC,KAAb,GAAqBhO,GAAG,CAAC+N,QAAJ,CAAaC,KAAlC,GAA0ChO,GAAG,CAAC+N,QAAJ,CAAa3I,MAAb,GAAsBpF,GAAG,CAAC+N,QAAJ,CAAa3I,MAAvF,CADJ;AAEA,SAAO;AACHN,IAAAA,CAAC,EAAE9E,GAAG,CAACsB,EADJ;AAEH0D,IAAAA,CAAC,EAAEhF,GAAG,CAACuB,EAFJ;AAGHe,IAAAA,KAAK,EAAEtC,GAAG,CAACC,KAAJ,CAAU0C,IAAV,GAAiB3C,GAAG,CAACyC,CAArB,GAAyB,CAAzB,GAA6BqN,YAHjC;AAIHtJ,IAAAA,EAAE,EAAE,CAJD;AAKHC,IAAAA,EAAE,EAAE,CAAEzG,GAAG,CAAC+N,QAAJ,CAAa3I,MAAf,GAAwB,CAAxB,GAA4BpF,GAAG,CAACC,KAAJ,CAAU6F,KAAV,CAAgBnC,IAAhB,CAAqB+B;AALlD,GAAP;AAOH;;AAED,SAASW,oBAAT,CAA8BrG,GAA9B,EAAmC6Q,QAAnC,EAA6C;AACzC,MAAIC,MAAM,GAAG,CAAb;AACA,MAAIC,MAAM,GAAG,CAAb;AACA,MAAIC,OAAJ;AAEA,MAAI/Q,KAAK,GAAGD,GAAG,CAACC,KAAhB,CALyC,CAMzC;AACA;AACA;;AACA,MAAIgR,SAAS,GAAG;AACZnM,IAAAA,CAAC,EAAE9E,GAAG,CAACsB,EADK;AAEZ0D,IAAAA,CAAC,EAAEhF,GAAG,CAACuB;AAFK,GAAhB,CATyC,CAazC;;AACA,MAAI2P,SAAS,GAAG;AACZ1K,IAAAA,EAAE,EAAE,CADQ;AAEZC,IAAAA,EAAE,EAAE;AAFQ,GAAhB,CAdyC,CAmBzC;AACA;AACA;;AACAyK,EAAAA,SAAS,CAACzK,EAAV,IAAgBxG,KAAK,CAAC6F,KAAN,CAAYnC,IAAZ,CAAiB+B,IAAjC;AACAsL,EAAAA,OAAO,GAAGG,UAAU,CAAClR,KAAD,CAApB;;AAEA,MAAGA,KAAK,CAAC6F,KAAN,CAAYK,QAAZ,CAAqBgE,OAArB,CAA6B,KAA7B,MAAwC,CAAC,CAA5C,EAA+C;AAC3C8G,IAAAA,SAAS,CAACjM,CAAV,IAAe,CAAC,IAAIgM,OAAL,IAAgBhR,GAAG,CAACyC,CAAnC;AACAyO,IAAAA,SAAS,CAACzK,EAAV,IAAgBzG,GAAG,CAAC+N,QAAJ,CAAa3I,MAA7B;AACH,GAHD,MAGO,IAAGnF,KAAK,CAAC6F,KAAN,CAAYK,QAAZ,CAAqBgE,OAArB,CAA6B,QAA7B,MAA2C,CAAC,CAA/C,EAAkD;AACrD8G,IAAAA,SAAS,CAACjM,CAAV,IAAe,CAAC,IAAIgM,OAAL,IAAgBhR,GAAG,CAACyC,CAAnC;AACH;;AAED,MAAI2O,EAAE,GAAGC,gBAAgB,CAACrR,GAAG,CAACyC,CAAL,EAAQzC,GAAG,CAACC,KAAJ,CAAUqR,WAAlB,CAAzB;AAEA,MAAIC,QAAQ,GAAGV,QAAQ,CAAC7J,CAAT,IAAc/G,KAAK,CAAC6G,MAAN,CAAahC,CAAb,CAAe,CAAf,IAAoB7E,KAAK,CAAC6G,MAAN,CAAahC,CAAb,CAAe,CAAf,CAAlC,IAAuD,CAAtE;;AACA,MAAG7E,KAAK,CAAC6F,KAAN,CAAYK,QAAZ,CAAqBgE,OAArB,CAA6B,MAA7B,MAAyC,CAAC,CAA7C,EAAgD;AAC5C;AACAoH,IAAAA,QAAQ,GAAGA,QAAQ,GAAGH,EAAtB;AACAH,IAAAA,SAAS,CAACnM,CAAV,IAAe,CAAC,IAAIkM,OAAL,IAAgBI,EAA/B;AACAF,IAAAA,SAAS,CAAC1K,EAAV,IAAgBxG,GAAG,CAAC+N,QAAJ,CAAaC,KAAb,GAAqB,CAArC;AACH,GALD,MAKO,IAAG/N,KAAK,CAAC6F,KAAN,CAAYK,QAAZ,CAAqBgE,OAArB,CAA6B,QAA7B,MAA2C,CAAC,CAA/C,EAAkD;AACrDoH,IAAAA,QAAQ,IAAI,CAAZ;AACH,GAFM,MAEA,IAAGtR,KAAK,CAAC6F,KAAN,CAAYK,QAAZ,CAAqBgE,OAArB,CAA6B,OAA7B,MAA0C,CAAC,CAA9C,EAAiD;AACpDoH,IAAAA,QAAQ,GAAGA,QAAQ,GAAGH,EAAtB;AACAH,IAAAA,SAAS,CAACnM,CAAV,IAAe,CAAC,IAAIkM,OAAL,IAAgBI,EAA/B;AACAF,IAAAA,SAAS,CAAC1K,EAAV,IAAgBxG,GAAG,CAAC+N,QAAJ,CAAaC,KAAb,GAAqB,CAArC;AACH;;AACD8C,EAAAA,MAAM,GAAGS,QAAQ,GAAGvR,GAAG,CAAC+N,QAAJ,CAAaC,KAAjC;AACA+C,EAAAA,MAAM,GAAGS,aAAa,CAACxR,GAAD,EAAM6Q,QAAN,CAAb,GAA+B7Q,GAAG,CAAC+N,QAAJ,CAAa3I,MAArD;AACA,SAAO;AACHN,IAAAA,CAAC,EAAEmM,SAAS,CAACnM,CADV;AAEHE,IAAAA,CAAC,EAAEiM,SAAS,CAACjM,CAFV;AAGH1C,IAAAA,KAAK,EAAEgE,IAAI,CAACC,GAAL,CAASuK,MAAT,EAAiBC,MAAjB,CAHJ;AAIHvK,IAAAA,EAAE,EAAE0K,SAAS,CAAC1K,EAJX;AAKHC,IAAAA,EAAE,EAAEyK,SAAS,CAACzK;AALX,GAAP;AAOH;;AAED,SAAS4K,gBAAT,CAA0BvM,CAA1B,EAA6BwM,WAA7B,EAA0C;AACtC,SAAOxM,CAAC,IAAKwM,WAAW,KAAK5M,SAAjB,GAA8B,CAA9B,GAAkC4M,WAAtC,CAAR;AACH;;AAED,SAASE,aAAT,CAAuBxR,GAAvB,EAA4B6Q,QAA5B,EAAsC;AAClC,MAAI5Q,KAAK,GAAGD,GAAG,CAACC,KAAhB;AACA,MAAIwR,YAAY,GAAGZ,QAAQ,CAAC3J,CAAT,IAAcjH,KAAK,CAAC6G,MAAN,CAAa9B,CAAb,CAAe,CAAf,IAAoB/E,KAAK,CAAC6G,MAAN,CAAa9B,CAAb,CAAe,CAAf,CAAlC,CAAnB,CAFkC,CAGlC;;AACA,SAAOsB,IAAI,CAACC,GAAL,CAASvG,GAAG,CAAC+N,QAAJ,CAAa3I,MAAtB,EAA8BqM,YAAY,GAAG,CAA7C,CAAP;AACH;;AAED,SAASN,UAAT,CAAoBlR,KAApB,EAA2B;AACvB,MAAI+Q,OAAO,GAAG/Q,KAAK,CAAC4B,IAApB;AACA,MAAG,CAACmP,OAAJ,EAAa,OAAO,CAAP;AAEb,MAAIU,CAAJ;;AACA,MAAGhI,KAAK,CAACC,OAAN,CAAcqH,OAAd,CAAH,EAA2B;AACvBA,IAAAA,OAAO,GAAG,CAAV;;AACA,SAAIU,CAAC,GAAG,CAAR,EAAWA,CAAC,GAAGzR,KAAK,CAAC4B,IAAN,CAAW+L,MAA1B,EAAkC8D,CAAC,EAAnC,EAAuC;AACnC,UAAGzR,KAAK,CAAC4B,IAAN,CAAW6P,CAAX,IAAgBV,OAAnB,EAA4BA,OAAO,GAAG/Q,KAAK,CAAC4B,IAAN,CAAW6P,CAAX,CAAV;AAC/B;AACJ;;AACD,SAAOV,OAAP;AACH;;AAED,SAAStK,WAAT,CAAqB9F,SAArB,EAAgCX,KAAhC,EAAuC;AACnC,MAAI0R,KAAJ,EAAWC,KAAX,EAAkBC,YAAlB,EAAgCC,SAAhC,EAA2CC,SAA3C,EACIC,SADJ,EACeC,SADf,EAC0BC,QAD1B,EACoCC,YADpC,EAEIC,SAFJ,EAEerR,CAFf,EAEkBsR,eAFlB,EAEmCC,sBAFnC;;AAIA,WAASC,QAAT,CAAkBnC,CAAlB,EAAqBrI,CAArB,EAAwB;AAAE,WAAOqI,CAAC,CAAChP,KAAF,CAAQ,CAAR,IAAa2G,CAAC,CAAC3G,KAAF,CAAQ,CAAR,CAApB;AAAiC;;AAC3D,WAASoR,WAAT,CAAqBpC,CAArB,EAAwBrI,CAAxB,EAA2B;AAAE,WAAOA,CAAC,CAAC3G,KAAF,CAAQ,CAAR,IAAagP,CAAC,CAAChP,KAAF,CAAQ,CAAR,CAApB;AAAiC;;AAE9D,WAASqR,aAAT,CAAuBC,MAAvB,EAA+BC,MAA/B,EAAuC;AACnC,QAAG,CAACA,MAAJ,EAAYA,MAAM,GAAG,EAAT;AAEZ,QAAIC,UAAU,GAAGD,MAAM,CAACnN,WAAP,IAAsBoM,KAAK,GAAGe,MAAM,CAACrN,SAAV,GAAsBqN,MAAM,CAACxN,SAAxD,CAAjB;AACA,QAAI0N,UAAU,GAAGjB,KAAK,GAAGc,MAAM,CAACvN,SAAV,GAAsBuN,MAAM,CAACpN,SAAnD;AACA,QAAIwN,UAAU,GAAGlB,KAAK,GAAGc,MAAM,CAACpN,SAAV,GAAsBoN,MAAM,CAACvN,SAAnD;AACA,QAAI4N,eAAe,GAAGL,MAAM,CAACzQ,OAAP,GAAiB8P,SAAS,CAACW,MAAM,CAAC3P,GAAP,CAAW,CAAX,CAAD,EAAgB2P,MAAM,CAACzP,GAAP,CAAW,CAAX,CAAhB,CAAhD;AACA,QAAI+P,SAAS,GAAGJ,UAAU,GAAGC,UAA7B;AAEA,QAAII,OAAJ,EAAalS,CAAb,EAAgBmS,OAAhB,EAAyBC,WAAzB,EAAsCC,WAAtC,EAAmDC,SAAnD,CATmC,CAWnC;AACA;;AACA,QAAGL,SAAS,GAAGf,SAAZ,GAAwB,CAA3B,EAA8BS,MAAM,CAAClN,WAAP,GAAqBwN,SAArB,CAbK,CAenC;;AACA,QAAG,CAACtJ,KAAK,CAACC,OAAN,CAAc1J,KAAK,CAAC4B,IAApB,CAAJ,EAA+B,OAhBI,CAgBI;;AAEvC,SAAId,CAAC,GAAG,CAAR,EAAWA,CAAC,GAAGqR,SAAS,CAACxE,MAAzB,EAAiC7M,CAAC,EAAlC,EAAsC;AAClCmS,MAAAA,OAAO,GAAGd,SAAS,CAACrR,CAAD,CAAnB,CADkC,CAGlC;;AACA,UAAGmS,OAAO,KAAKR,MAAZ,IACC,CAAC7T,OAAO,CAACiD,UAAR,CAAmB7B,KAAK,CAAC4B,IAAzB,EAA+B6Q,MAAM,CAAC3Q,GAAtC,KAA8C,CAA/C,MACClD,OAAO,CAACiD,UAAR,CAAmB7B,KAAK,CAAC4B,IAAzB,EAA+BqR,OAAO,CAACnR,GAAvC,KAA+C,CADhD,CADJ,EAGE;AACE;AACH;;AAED,UAAG,CAAC2Q,MAAM,CAACtR,KAAP,CAAa,CAAb,IAAkB8R,OAAO,CAAC9R,KAAR,CAAc,CAAd,CAAnB,IAAuC6Q,SAAvC,GAAmD,CAAtD,EAAyD;AACrD;AACA;AACAkB,QAAAA,WAAW,GAAGD,OAAO,CAACjR,OAAR,GAAkB8P,SAAS,CAACmB,OAAO,CAACnQ,GAAR,CAAY,CAAZ,CAAD,EAAiBmQ,OAAO,CAACjQ,GAAR,CAAY,CAAZ,CAAjB,CAAzC;AACA+P,QAAAA,SAAS,GAAGG,WAAW,GAAGN,UAAd,GAA2BH,MAAM,CAAClN,WAA9C;AAEA,YAAGwN,SAAS,GAAGf,SAAZ,GAAwB,CAA3B,EAA8BS,MAAM,CAAClN,WAAP,IAAsBwN,SAAtB;AACjC,OAPD,MAOO,IAAG,CAACF,UAAU,GAAGJ,MAAM,CAAClN,WAApB,GAAkCuN,eAAnC,IAAsDd,SAAtD,GAAkE,CAArE,EAAwE;AAC3E;AACA;AACA;AAEA;AACA;AACAgB,QAAAA,OAAO,GAAG,IAAIjB,SAAJ,GAAgB1L,IAAI,CAACqC,GAAL,CAAS5H,CAAC,GAAGqR,SAAS,CAACjI,OAAV,CAAkBuI,MAAlB,CAAb,CAA1B;AAEAU,QAAAA,WAAW,GAAGF,OAAO,CAAClR,OAAR,GAAkB8P,SAAS,CAACoB,OAAO,CAACnQ,GAAR,CAAY,CAAZ,CAAD,EAAiBmQ,OAAO,CAACjQ,GAAR,CAAY,CAAZ,CAAjB,CAAzC;AACAoQ,QAAAA,SAAS,GAAGD,WAAW,GAAGH,OAAd,IAAyBP,MAAM,CAAC1Q,OAAP,GAAiB0Q,MAAM,CAACtR,KAAP,CAAa,CAAb,CAA1C,IAA6DsR,MAAM,CAACnN,WAAhF;AAEA,YAAG8N,SAAS,GAAGrB,SAAZ,GAAwB,CAA3B,EAA8BU,MAAM,CAACnN,WAAP,IAAsB8N,SAAtB;AACjC;AACJ;AACJ;;AAED,OAAIzB,KAAK,GAAG,CAAZ,EAAeA,KAAK,GAAG,CAAvB,EAA0BA,KAAK,EAA/B,EAAmC;AAC/BC,IAAAA,YAAY,GAAGD,KAAK,GAAGW,QAAH,GAAcC,WAAlC;AACAT,IAAAA,SAAS,GAAGH,KAAK,GAAGtL,IAAI,CAACsB,GAAR,GAActB,IAAI,CAACC,GAApC;AACA0L,IAAAA,SAAS,GAAGL,KAAK,GAAG,CAAH,GAAO,CAAC,CAAzB;;AAEA,SAAID,KAAK,GAAG,CAAZ,EAAeA,KAAK,GAAG,CAAvB,EAA0BA,KAAK,EAA/B,EAAmC;AAC/BG,MAAAA,SAAS,GAAGH,KAAK,GAAGrL,IAAI,CAACsB,GAAR,GAActB,IAAI,CAACC,GAApC;AACAyL,MAAAA,SAAS,GAAGL,KAAK,GAAG,CAAH,GAAO,CAAC,CAAzB,CAF+B,CAI/B;AACA;AACA;;AACAO,MAAAA,QAAQ,GAAGtR,SAAS,CAACgR,KAAD,CAAT,CAAiBD,KAAjB,CAAX;AACAO,MAAAA,QAAQ,CAACoB,IAAT,CAAczB,YAAd;AAEAM,MAAAA,YAAY,GAAGvR,SAAS,CAAC,IAAIgR,KAAL,CAAT,CAAqBD,KAArB,CAAf;AACAS,MAAAA,SAAS,GAAGD,YAAY,CAACoB,MAAb,CAAoBrB,QAApB,CAAZ;AAEAG,MAAAA,eAAe,GAAG,EAAlB;;AACA,WAAItR,CAAC,GAAG,CAAR,EAAWA,CAAC,GAAGmR,QAAQ,CAACtE,MAAxB,EAAgC7M,CAAC,EAAjC,EAAqC;AACjC,YAAGmR,QAAQ,CAACnR,CAAD,CAAR,CAAYsE,SAAZ,KAA0BX,SAA7B,EAAwC2N,eAAe,CAAChR,IAAhB,CAAqB6Q,QAAQ,CAACnR,CAAD,CAA7B;AAC3C;;AAEDuR,MAAAA,sBAAsB,GAAG,KAAzB;;AACA,WAAIvR,CAAC,GAAG,CAAR,EAAW6Q,KAAK,IAAI7Q,CAAC,GAAGoR,YAAY,CAACvE,MAArC,EAA6C7M,CAAC,EAA9C,EAAkD;AAC9C,YAAGoR,YAAY,CAACpR,CAAD,CAAZ,CAAgBsE,SAAhB,KAA8BX,SAAjC,EAA4C;AACxC4N,UAAAA,sBAAsB,GAAGH,YAAY,CAACpR,CAAD,CAArC;AACA;AACH;AACJ,OAxB8B,CA0B/B;;;AACA,WAAIA,CAAC,GAAG,CAAR,EAAWA,CAAC,GAAGsR,eAAe,CAACzE,MAA/B,EAAuC7M,CAAC,EAAxC,EAA4C;AACxC,YAAI4R,MAAM,GAAG5R,CAAC,IAAIsR,eAAe,CAACtR,CAAC,GAAG,CAAL,CAAjC,CADwC,CAExC;AACA;AACA;;AACA,YAAGuR,sBAAsB,IAAI,CAACvR,CAA9B,EAAiC4R,MAAM,GAAGL,sBAAT;AACjCG,QAAAA,aAAa,CAACJ,eAAe,CAACtR,CAAD,CAAhB,EAAqB4R,MAArB,CAAb;AACH;AACJ;AACJ;AACJ;;AAED,SAASnT,WAAT,CAAqBN,QAArB,EAA+B2R,QAA/B,EAAyC;AACrC,MAAI2C,WAAW,GAAG,EAAlB,CADqC,CAGrC;;AACA,OAAI,IAAIzS,CAAC,GAAG,CAAZ,EAAeA,CAAC,GAAG7B,QAAQ,CAAC0O,MAA5B,EAAoC7M,CAAC,EAArC,EAAyC;AACrC,QAAIf,GAAG,GAAGd,QAAQ,CAAC6B,CAAD,CAAR,CAAY,CAAZ,CAAV;AACA,QAAId,KAAK,GAAGD,GAAG,CAACC,KAAhB;AAEA,QAAI6G,MAAM,GAAG7G,KAAK,CAAC6G,MAAnB;AACA,QAAIkH,KAAK,GAAG6C,QAAQ,CAAC7J,CAAT,IAAcF,MAAM,CAAChC,CAAP,CAAS,CAAT,IAAcgC,MAAM,CAAChC,CAAP,CAAS,CAAT,CAA5B,CAAZ;AACA,QAAIM,MAAM,GAAGyL,QAAQ,CAAC3J,CAAT,IAAcJ,MAAM,CAAC9B,CAAP,CAAS,CAAT,IAAc8B,MAAM,CAAC9B,CAAP,CAAS,CAAT,CAA5B,CAAb,CANqC,CAOrC;;AACA,QAAG/E,KAAK,CAAC6F,KAAN,CAAYvC,IAAZ,IAAoBtD,KAAK,CAAC6F,KAAN,CAAYK,QAAZ,KAAyB,eAAhD,EAAiE;AAC7Df,MAAAA,MAAM,IAAIoM,aAAa,CAACxR,GAAD,EAAM6Q,QAAN,CAAvB;AACH;;AAED,QAAIO,EAAE,GAAGpD,KAAK,GAAG,CAAjB;AACA,QAAIyF,EAAE,GAAGrO,MAAM,GAAG,CAAlB;;AACA,QAAGnF,KAAK,CAAC0F,IAAN,KAAe,YAAf,IAA+B,CAAC1F,KAAK,CAACyT,UAAzC,EAAqD;AACjDD,MAAAA,EAAE,IAAIxT,KAAK,CAACqR,WAAZ;AACH;;AAEDtR,IAAAA,GAAG,CAACyC,CAAJ,GAAQ6D,IAAI,CAACC,GAAL,CAAS6K,EAAT,EAAaqC,EAAb,KAAoB,IAAItC,UAAU,CAAClR,KAAD,CAAlC,CAAR;AAEAD,IAAAA,GAAG,CAACsB,EAAJ,GAASuP,QAAQ,CAAClJ,CAAT,GAAakJ,QAAQ,CAAC7J,CAAT,IAAc/G,KAAK,CAAC6G,MAAN,CAAahC,CAAb,CAAe,CAAf,IAAoB7E,KAAK,CAAC6G,MAAN,CAAahC,CAAb,CAAe,CAAf,CAAlC,IAAuD,CAA7E;AACA9E,IAAAA,GAAG,CAACuB,EAAJ,GAASsP,QAAQ,CAAC5I,CAAT,GAAa4I,QAAQ,CAAC3J,CAAT,IAAc,IAAIjH,KAAK,CAAC6G,MAAN,CAAa9B,CAAb,CAAe,CAAf,CAAlB,CAAb,GAAoDI,MAAM,GAAG,CAAtE;;AACA,QAAGnF,KAAK,CAAC6F,KAAN,CAAYvC,IAAZ,IAAoBtD,KAAK,CAAC6F,KAAN,CAAYK,QAAZ,CAAqBgE,OAArB,CAA6B,QAA7B,MAA2C,CAAC,CAAnE,EAAsE;AAClEnK,MAAAA,GAAG,CAACuB,EAAJ,IAAUiQ,aAAa,CAACxR,GAAD,EAAM6Q,QAAN,CAAvB;AACH;;AAED,QAAG5Q,KAAK,CAACyT,UAAN,IAAoBF,WAAW,CAACrJ,OAAZ,CAAoBlK,KAAK,CAACyT,UAA1B,MAA0C,CAAC,CAAlE,EAAqE;AACjEF,MAAAA,WAAW,CAACnS,IAAZ,CAAiBpB,KAAK,CAACyT,UAAvB;AACH;AACJ;;AAEDC,EAAAA,UAAU,CAACzU,QAAD,EAAWsU,WAAX,CAAV;AACH;;AAED,SAASG,UAAT,CAAoBzU,QAApB,EAA8BsU,WAA9B,EAA2C;AACvC,MAAIxT,GAAJ,EAASe,CAAT,EAAYd,KAAZ,CADuC,CAGvC;;AACA,OAAI,IAAIiQ,CAAC,GAAG,CAAZ,EAAeA,CAAC,GAAGsD,WAAW,CAAC5F,MAA/B,EAAuCsC,CAAC,EAAxC,EAA4C;AACxC,QAAI3J,GAAG,GAAGqN,QAAV;AACA,QAAIC,CAAC,GAAGL,WAAW,CAACtD,CAAD,CAAnB;;AAEA,SAAInP,CAAC,GAAG,CAAR,EAAWA,CAAC,GAAG7B,QAAQ,CAAC0O,MAAxB,EAAgC7M,CAAC,EAAjC,EAAqC;AACjCf,MAAAA,GAAG,GAAGd,QAAQ,CAAC6B,CAAD,CAAR,CAAY,CAAZ,CAAN;AACAd,MAAAA,KAAK,GAAGD,GAAG,CAACC,KAAZ;;AAEA,UAAGA,KAAK,CAACyT,UAAN,KAAqBG,CAAxB,EAA2B;AACvB,YAAIC,IAAJ;;AACA,YAAG7T,KAAK,CAAC0F,IAAN,KAAe,KAAlB,EAAyB;AACrBmO,UAAAA,IAAI,GAAG9T,GAAG,CAACyC,CAAJ,GAAQzC,GAAG,CAACyC,CAAnB;AACH,SAFD,MAEO,IAAGxC,KAAK,CAAC0F,IAAN,KAAe,YAAlB,EAAgC;AACnC,cAAIyL,EAAJ,EAAQqC,EAAR;;AAEA,cAAGxT,KAAK,CAACqR,WAAN,GAAoB,CAAvB,EAA0B;AACtBF,YAAAA,EAAE,GAAGpR,GAAG,CAACyC,CAAT;AACAgR,YAAAA,EAAE,GAAGrC,EAAE,GAAGnR,KAAK,CAACqR,WAAhB;AACH,WAHD,MAGO;AACHmC,YAAAA,EAAE,GAAGzT,GAAG,CAACyC,CAAT;AACA2O,YAAAA,EAAE,GAAGqC,EAAE,GAAGxT,KAAK,CAACqR,WAAhB;AACH;;AAEDF,UAAAA,EAAE,IAAI,CAAC,IAAInR,KAAK,CAAC8T,SAAX,IAAwB,CAA9B;AAEAD,UAAAA,IAAI,GAAG1C,EAAE,GAAGqC,EAAZ;AACH;;AAEDlN,QAAAA,GAAG,GAAGD,IAAI,CAACC,GAAL,CAASA,GAAT,EAAcuN,IAAI,GAAG9T,GAAG,CAAC6C,MAAzB,CAAN;AACH;AACJ;;AAED,SAAI9B,CAAC,GAAG,CAAR,EAAWA,CAAC,GAAG7B,QAAQ,CAAC0O,MAAxB,EAAgC7M,CAAC,EAAjC,EAAqC;AACjCf,MAAAA,GAAG,GAAGd,QAAQ,CAAC6B,CAAD,CAAR,CAAY,CAAZ,CAAN;AACAd,MAAAA,KAAK,GAAGD,GAAG,CAACC,KAAZ;;AACA,UAAGA,KAAK,CAACyT,UAAN,KAAqBG,CAAxB,EAA2B;AACvB,YAAIjR,CAAC,GAAG2D,GAAG,GAAGvG,GAAG,CAAC6C,MAAlB;;AACA,YAAG5C,KAAK,CAAC0F,IAAN,KAAe,YAAlB,EAAgC;AAC5B/C,UAAAA,CAAC,IAAI,CAAC,IAAI3C,KAAK,CAAC8T,SAAX,IAAwB,CAA7B;AACAnR,UAAAA,CAAC,IAAI3C,KAAK,CAACqR,WAAX;AACH;;AAEDtR,QAAAA,GAAG,CAACyC,CAAJ,GAAQ6D,IAAI,CAACyJ,IAAL,CAAUnN,CAAV,CAAR;AACH;AACJ;AACJ;AACJ;;AAED,SAAS1C,SAAT,CAAmBL,EAAnB,EAAuB;AACnB,MAAIG,GAAG,GAAGH,EAAE,CAAC,CAAD,CAAZ;AACA,MAAI4C,CAAC,GAAGzC,GAAG,CAACyC,CAAZ;AACA,MAAIxC,KAAK,GAAGD,GAAG,CAACC,KAAhB;AACA,MAAI+T,YAAY,GAAGnV,OAAO,CAACoV,gBAAR,CAAyBhU,KAAK,CAACiU,QAA/B,CAAnB;AACA,MAAIC,WAAW,GAAG,IAAI7N,IAAI,CAACkI,EAAT,GAAcxO,GAAG,CAAC6C,MAApC;AACA,MAAIuR,OAAO,GAAG,KAAd;AACA,MAAIC,MAAM,GAAG,KAAb;AAEA,MAAItT,CAAJ,EAAOuT,GAAP,EAAYC,aAAZ;;AAEA,MAAGtU,KAAK,CAACuU,SAAN,KAAoB,kBAAvB,EAA2C;AACvC,SAAIzT,CAAC,GAAG,CAAR,EAAWA,CAAC,GAAGlB,EAAE,CAAC+N,MAAlB,EAA0B7M,CAAC,EAA3B,EAA+B;AAC3B,UAAG,CAAClB,EAAE,CAACkB,CAAD,CAAF,CAAMC,MAAV,EAAkB,MADS,CACF;AAC5B;;AACD,QAAGD,CAAC,KAAKlB,EAAE,CAAC+N,MAAZ,EAAoB,OAJmB,CAIX;;AAE5BoG,IAAAA,YAAY,IAAIG,WAAW,GAAGtU,EAAE,CAACkB,CAAD,CAAF,CAAM6B,CAApC;AACAuR,IAAAA,WAAW,IAAI,CAAC,CAAhB;AACAC,IAAAA,OAAO,GAAG,KAAV;AACAC,IAAAA,MAAM,GAAG,KAAT;AACH;;AAEDE,EAAAA,aAAa,GAAG5P,SAAS,CAAClC,CAAD,EAAIuR,YAAJ,CAAzB;;AAEA,OAAIjT,CAAC,GAAG,CAAR,EAAWA,CAAC,GAAGlB,EAAE,CAAC+N,MAAlB,EAA0B7M,CAAC,EAA3B,EAA+B;AAC3BuT,IAAAA,GAAG,GAAGzU,EAAE,CAACkB,CAAD,CAAR;AACA,QAAGuT,GAAG,CAACtT,MAAP,EAAe;AAEfsT,IAAAA,GAAG,CAACF,OAAD,CAAH,GAAeG,aAAf;AAEAD,IAAAA,GAAG,CAACnG,UAAJ,GAAiB6F,YAAjB;AACAA,IAAAA,YAAY,IAAIG,WAAW,GAAGG,GAAG,CAAC1R,CAAlB,GAAsB,CAAtC;AACA0R,IAAAA,GAAG,CAAClT,KAAJ,GAAYuD,SAAS,CAAClC,CAAD,EAAIuR,YAAJ,CAArB;AACAM,IAAAA,GAAG,CAAC1F,QAAJ,GAAeoF,YAAf;AACAA,IAAAA,YAAY,IAAIG,WAAW,GAAGG,GAAG,CAAC1R,CAAlB,GAAsB,CAAtC;AACA2R,IAAAA,aAAa,GAAG5P,SAAS,CAAClC,CAAD,EAAIuR,YAAJ,CAAzB;AACAM,IAAAA,GAAG,CAAClG,SAAJ,GAAgB4F,YAAhB;AAEAM,IAAAA,GAAG,CAACD,MAAD,CAAH,GAAcE,aAAd;AAEAD,IAAAA,GAAG,CAAC5R,QAAJ,GAAgB4R,GAAG,CAAC1R,CAAJ,GAAQ5C,GAAG,CAAC6C,MAAJ,GAAa,CAAtB,GAA2B,CAA3B,GAA+B,CAA9C;AAEAyR,IAAAA,GAAG,CAAC5F,SAAJ,GAAgBpI,IAAI,CAACkI,EAAL,GAAUlI,IAAI,CAACC,GAAL,CAAS+N,GAAG,CAAC1R,CAAJ,GAAQ5C,GAAG,CAAC6C,MAArB,EAA6B,GAA7B,CAA1B;AACAyR,IAAAA,GAAG,CAAChG,IAAJ,GAAW,IAAIrO,KAAK,CAAC0C,IAArB;AACA2R,IAAAA,GAAG,CAACvK,UAAJ,GAAiB4G,0BAA0B,CAAC2D,GAAD,EAAMtU,GAAN,CAA3C;AACH;AACJ;;AAED,SAAS2E,SAAT,CAAmBlC,CAAnB,EAAsB6M,KAAtB,EAA6B;AACzB,SAAO,CAAC7M,CAAC,GAAG6D,IAAI,CAACsK,GAAL,CAAStB,KAAT,CAAL,EAAsB,CAAC7M,CAAD,GAAK6D,IAAI,CAACkK,GAAL,CAASlB,KAAT,CAA3B,CAAP;AACH;;AAED,SAASnM,gBAAT,CAA0BlE,EAA1B,EAA8B6B,EAA9B,EAAkCd,GAAlC,EAAuC;AACnC,MAAIb,UAAU,GAAGF,EAAE,CAACG,WAApB;AACA,MAAIa,KAAK,GAAGD,GAAG,CAACC,KAAhB,CAFmC,CAGnC;;AACA,MAAIwU,YAAY,GAAGxU,KAAK,CAACwU,YAAzB,CAJmC,CAMnC;;AACA,MAAIC,QAAQ,GAAGzU,KAAK,CAACyU,QAArB;;AACA,MAAG,CAACD,YAAD,IAAiBC,QAAjB,IAA6BA,QAAQ,KAAK,MAA7C,EAAqD;AACjD,QAAIC,KAAK,GAAGD,QAAQ,CAACE,KAAT,CAAe,GAAf,CAAZ;;AACA,QAAIC,OAAO,GAAG,UAASC,IAAT,EAAe;AAAE,aAAOH,KAAK,CAACxK,OAAN,CAAc2K,IAAd,MAAwB,CAAC,CAAhC;AAAoC,KAAnE;;AACA,QAAIC,QAAQ,GAAGF,OAAO,CAAC,OAAD,CAAtB;AACA,QAAIG,OAAO,GAAGH,OAAO,CAAC,MAAD,CAArB;AACA,QAAII,QAAQ,GAAGJ,OAAO,CAAC,OAAD,CAAtB;AACA,QAAIK,UAAU,GAAGL,OAAO,CAAC,SAAD,CAAxB;AAEA,QAAI3K,UAAU,GAAG/K,UAAU,CAAC+K,UAA5B;AACA,QAAI3G,IAAJ;AAEAA,IAAAA,IAAI,GAAGwR,QAAQ,GAAG,CAACjU,EAAE,CAACsJ,KAAJ,CAAH,GAAgB,EAA/B;;AACA,QAAG4K,OAAH,EAAY;AACR,UAAIxO,EAAE,GAAG3H,OAAO,CAACsW,cAAR,CAAuBlV,KAAK,CAACsD,IAA7B,EAAmCzC,EAAE,CAACiB,GAAtC,CAAT;AACA,UAAGhD,gBAAgB,CAACyH,EAAD,CAAnB,EAAyBjD,IAAI,CAAClC,IAAL,CAAUmF,EAAV;AAC5B;;AACD,QAAGyO,QAAH,EAAa1R,IAAI,CAAClC,IAAL,CAAUxC,OAAO,CAAC2L,cAAR,CAAuB1J,EAAE,CAAC8B,CAA1B,EAA6BsH,UAA7B,CAAV;AACb,QAAGgL,UAAH,EAAe3R,IAAI,CAAClC,IAAL,CAAUxC,OAAO,CAAC8L,gBAAR,CAAyB7J,EAAE,CAAC8B,CAAH,GAAO5C,GAAG,CAAC6C,MAApC,EAA4CqH,UAA5C,CAAV;AACfpJ,IAAAA,EAAE,CAACyC,IAAH,GAAUA,IAAI,CAACmI,IAAL,CAAU,MAAV,CAAV;AACH;;AAED,WAAS0J,qBAAT,CAA+BtU,EAA/B,EAAmC;AAC/B,WAAO;AACHsJ,MAAAA,KAAK,EAAEtJ,EAAE,CAACsJ,KADP;AAEHE,MAAAA,KAAK,EAAExJ,EAAE,CAAC8B,CAFP;AAGH2H,MAAAA,UAAU,EAAE1L,OAAO,CAAC2L,cAAR,CAAuB1J,EAAE,CAAC8B,CAA1B,EAA6BzD,UAAU,CAAC+K,UAAxC,CAHT;AAIHO,MAAAA,OAAO,EAAE3J,EAAE,CAAC8B,CAAH,GAAO5C,GAAG,CAAC6C,MAJjB;AAKH6H,MAAAA,YAAY,EAAE7L,OAAO,CAAC8L,gBAAR,CAAyB7J,EAAE,CAAC8B,CAAH,GAAO5C,GAAG,CAAC6C,MAApC,EAA4C1D,UAAU,CAAC+K,UAAvD,CALX;AAMHrB,MAAAA,KAAK,EAAE/H,EAAE,CAAC+H,KANP;AAOHtF,MAAAA,IAAI,EAAEzC,EAAE,CAACyC,IAPN;AAQH8R,MAAAA,UAAU,EAAEhX,GAAG,CAACyD,UAAJ,CAAe7B,KAAf,EAAsBa,EAAE,CAACC,CAAzB,EAA4B,YAA5B;AART,KAAP;AAUH;;AAED,MAAG0T,YAAH,EAAiB;AACb,QAAIzO,GAAG,GAAG3H,GAAG,CAACyD,UAAJ,CAAe7B,KAAf,EAAsBa,EAAE,CAACC,CAAzB,EAA4B,cAA5B,CAAV;;AACA,QAAG,CAACiF,GAAJ,EAAS;AACLlF,MAAAA,EAAE,CAACyC,IAAH,GAAU,EAAV;AACH,KAFD,MAEO;AACH,UAAI+R,GAAG,GAAGF,qBAAqB,CAACtU,EAAD,CAA/B;AACA,UAAIyU,IAAI,GAAG1W,OAAO,CAACsW,cAAR,CAAuBlV,KAAK,CAACsD,IAA7B,EAAmCzC,EAAE,CAACiB,GAAtC,CAAX;AACA,UAAGhD,gBAAgB,CAACwW,IAAD,CAAhB,IAA0BA,IAAI,KAAK,EAAtC,EAA0CD,GAAG,CAAC/R,IAAJ,GAAWgS,IAAX;AAC1CzU,MAAAA,EAAE,CAACyC,IAAH,GAAUlF,GAAG,CAACmX,kBAAJ,CAAuBxP,GAAvB,EAA4BsP,GAA5B,EAAiCrW,EAAE,CAACG,WAAH,CAAeqW,SAAhD,EAA2DH,GAA3D,EAAgErV,KAAK,CAACgG,KAAN,IAAe,EAA/E,CAAV;AACH;AACJ;AACJ;;AAED,SAAShB,gBAAT,CACIlB,SADJ,EACgB;AACZE,MAFJ,CAEgB;AAFhB,EAGE;AACE,MAAImM,CAAC,GAAGrM,SAAS,CAACsK,MAAV,GAAmB/H,IAAI,CAACkI,EAAxB,GAA6B,GAArC;AACA,MAAIkH,IAAI,GAAGpP,IAAI,CAACkK,GAAL,CAASJ,CAAT,CAAX;AACA,MAAIuF,IAAI,GAAGrP,IAAI,CAACsK,GAAL,CAASR,CAAT,CAAX;AACA,MAAIwF,IAAI,GAAG,CAAC3R,MAAM,CAAC4D,IAAP,GAAc5D,MAAM,CAAC6D,KAAtB,IAA+B,CAA1C;AACA,MAAI+N,IAAI,GAAG,CAAC5R,MAAM,CAACiE,GAAP,GAAajE,MAAM,CAAC+D,MAArB,IAA+B,CAA1C;AACAjE,EAAAA,SAAS,CAAC+R,KAAV,GAAkBF,IAAI,GAAGF,IAAP,GAAcG,IAAI,GAAGF,IAAvC;AACA5R,EAAAA,SAAS,CAACgS,KAAV,GAAkBH,IAAI,GAAGD,IAAP,GAAcE,IAAI,GAAGH,IAAvC;AACA3R,EAAAA,SAAS,CAACiS,QAAV,GAAqB,IAArB;AACH;;AAEDC,MAAM,CAACC,OAAP,GAAiB;AACblX,EAAAA,IAAI,EAAEA,IADO;AAEbmE,EAAAA,gBAAgB,EAAEA,gBAFL;AAGbkB,EAAAA,mBAAmB,EAAEA,mBAHR;AAIbP,EAAAA,uBAAuB,EAAEA,uBAJZ;AAKbuC,EAAAA,oBAAoB,EAAEA,oBALT;AAMb9G,EAAAA,eAAe,EAAEA,eANJ;AAObC,EAAAA,WAAW,EAAEA,WAPA;AAQboC,EAAAA,gBAAgB,EAAEA,gBARL;AASbqD,EAAAA,gBAAgB,EAAEA;AATL,CAAjB","sourcesContent":["'use strict';\n\nvar d3 = require('@plotly/d3');\n\nvar Plots = require('../../plots/plots');\nvar Fx = require('../../components/fx');\nvar Color = require('../../components/color');\nvar Drawing = require('../../components/drawing');\nvar Lib = require('../../lib');\nvar strScale = Lib.strScale;\nvar strTranslate = Lib.strTranslate;\nvar svgTextUtils = require('../../lib/svg_text_utils');\nvar uniformText = require('../bar/uniform_text');\nvar recordMinTextSize = uniformText.recordMinTextSize;\nvar clearMinTextSize = uniformText.clearMinTextSize;\nvar TEXTPAD = require('../bar/constants').TEXTPAD;\n\nvar helpers = require('./helpers');\nvar eventData = require('./event_data');\nvar isValidTextValue = require('../../lib').isValidTextValue;\n\nfunction plot(gd, cdModule) {\n    var fullLayout = gd._fullLayout;\n    var gs = fullLayout._size;\n\n    clearMinTextSize('pie', fullLayout);\n\n    prerenderTitles(cdModule, gd);\n    layoutAreas(cdModule, gs);\n\n    var plotGroups = Lib.makeTraceGroups(fullLayout._pielayer, cdModule, 'trace').each(function(cd) {\n        var plotGroup = d3.select(this);\n        var cd0 = cd[0];\n        var trace = cd0.trace;\n\n        setCoords(cd);\n\n        // TODO: miter might look better but can sometimes cause problems\n        // maybe miter with a small-ish stroke-miterlimit?\n        plotGroup.attr('stroke-linejoin', 'round');\n\n        plotGroup.each(function() {\n            var slices = d3.select(this).selectAll('g.slice').data(cd);\n\n            slices.enter().append('g')\n                .classed('slice', true);\n            slices.exit().remove();\n\n            var quadrants = [\n                [[], []], // y<0: x<0, x>=0\n                [[], []] // y>=0: x<0, x>=0\n            ];\n            var hasOutsideText = false;\n\n            slices.each(function(pt, i) {\n                if(pt.hidden) {\n                    d3.select(this).selectAll('path,g').remove();\n                    return;\n                }\n\n                // to have consistent event data compared to other traces\n                pt.pointNumber = pt.i;\n                pt.curveNumber = trace.index;\n\n                quadrants[pt.pxmid[1] < 0 ? 0 : 1][pt.pxmid[0] < 0 ? 0 : 1].push(pt);\n\n                var cx = cd0.cx;\n                var cy = cd0.cy;\n                var sliceTop = d3.select(this);\n                var slicePath = sliceTop.selectAll('path.surface').data([pt]);\n\n                slicePath.enter().append('path')\n                    .classed('surface', true)\n                    .style({'pointer-events': 'all'});\n\n                sliceTop.call(attachFxHandlers, gd, cd);\n\n                if(trace.pull) {\n                    var pull = +helpers.castOption(trace.pull, pt.pts) || 0;\n                    if(pull > 0) {\n                        cx += pull * pt.pxmid[0];\n                        cy += pull * pt.pxmid[1];\n                    }\n                }\n\n                pt.cxFinal = cx;\n                pt.cyFinal = cy;\n\n                function arc(start, finish, cw, scale) {\n                    var dx = scale * (finish[0] - start[0]);\n                    var dy = scale * (finish[1] - start[1]);\n\n                    return 'a' +\n                        (scale * cd0.r) + ',' + (scale * cd0.r) + ' 0 ' +\n                        pt.largeArc + (cw ? ' 1 ' : ' 0 ') + dx + ',' + dy;\n                }\n\n                var hole = trace.hole;\n                if(pt.v === cd0.vTotal) { // 100% fails bcs arc start and end are identical\n                    var outerCircle = 'M' + (cx + pt.px0[0]) + ',' + (cy + pt.px0[1]) +\n                        arc(pt.px0, pt.pxmid, true, 1) +\n                        arc(pt.pxmid, pt.px0, true, 1) + 'Z';\n                    if(hole) {\n                        slicePath.attr('d',\n                            'M' + (cx + hole * pt.px0[0]) + ',' + (cy + hole * pt.px0[1]) +\n                            arc(pt.px0, pt.pxmid, false, hole) +\n                            arc(pt.pxmid, pt.px0, false, hole) +\n                            'Z' + outerCircle);\n                    } else slicePath.attr('d', outerCircle);\n                } else {\n                    var outerArc = arc(pt.px0, pt.px1, true, 1);\n\n                    if(hole) {\n                        var rim = 1 - hole;\n                        slicePath.attr('d',\n                            'M' + (cx + hole * pt.px1[0]) + ',' + (cy + hole * pt.px1[1]) +\n                            arc(pt.px1, pt.px0, false, hole) +\n                            'l' + (rim * pt.px0[0]) + ',' + (rim * pt.px0[1]) +\n                            outerArc +\n                            'Z');\n                    } else {\n                        slicePath.attr('d',\n                            'M' + cx + ',' + cy +\n                            'l' + pt.px0[0] + ',' + pt.px0[1] +\n                            outerArc +\n                            'Z');\n                    }\n                }\n\n                // add text\n                formatSliceLabel(gd, pt, cd0);\n                var textPosition = helpers.castOption(trace.textposition, pt.pts);\n                var sliceTextGroup = sliceTop.selectAll('g.slicetext')\n                    .data(pt.text && (textPosition !== 'none') ? [0] : []);\n\n                sliceTextGroup.enter().append('g')\n                    .classed('slicetext', true);\n                sliceTextGroup.exit().remove();\n\n                sliceTextGroup.each(function() {\n                    var sliceText = Lib.ensureSingle(d3.select(this), 'text', '', function(s) {\n                        // prohibit tex interpretation until we can handle\n                        // tex and regular text together\n                        s.attr('data-notex', 1);\n                    });\n\n                    var font = Lib.ensureUniformFontSize(gd, textPosition === 'outside' ?\n                        determineOutsideTextFont(trace, pt, fullLayout.font) :\n                        determineInsideTextFont(trace, pt, fullLayout.font)\n                    );\n\n                    sliceText.text(pt.text)\n                        .attr({\n                            'class': 'slicetext',\n                            transform: '',\n                            'text-anchor': 'middle'\n                        })\n                        .call(Drawing.font, font)\n                        .call(svgTextUtils.convertToTspans, gd);\n\n                    // position the text relative to the slice\n                    var textBB = Drawing.bBox(sliceText.node());\n                    var transform;\n\n                    if(textPosition === 'outside') {\n                        transform = transformOutsideText(textBB, pt);\n                    } else {\n                        transform = transformInsideText(textBB, pt, cd0);\n                        if(textPosition === 'auto' && transform.scale < 1) {\n                            var newFont = Lib.ensureUniformFontSize(gd, trace.outsidetextfont);\n\n                            sliceText.call(Drawing.font, newFont);\n                            textBB = Drawing.bBox(sliceText.node());\n\n                            transform = transformOutsideText(textBB, pt);\n                        }\n                    }\n\n                    var textPosAngle = transform.textPosAngle;\n                    var textXY = textPosAngle === undefined ? pt.pxmid : getCoords(cd0.r, textPosAngle);\n                    transform.targetX = cx + textXY[0] * transform.rCenter + (transform.x || 0);\n                    transform.targetY = cy + textXY[1] * transform.rCenter + (transform.y || 0);\n                    computeTransform(transform, textBB);\n\n                    // save some stuff to use later ensure no labels overlap\n                    if(transform.outside) {\n                        var targetY = transform.targetY;\n                        pt.yLabelMin = targetY - textBB.height / 2;\n                        pt.yLabelMid = targetY;\n                        pt.yLabelMax = targetY + textBB.height / 2;\n                        pt.labelExtraX = 0;\n                        pt.labelExtraY = 0;\n                        hasOutsideText = true;\n                    }\n\n                    transform.fontSize = font.size;\n                    recordMinTextSize(trace.type, transform, fullLayout);\n                    cd[i].transform = transform;\n\n                    sliceText.attr('transform', Lib.getTextTransform(transform));\n                });\n            });\n\n            // add the title\n            var titleTextGroup = d3.select(this).selectAll('g.titletext')\n                .data(trace.title.text ? [0] : []);\n\n            titleTextGroup.enter().append('g')\n                .classed('titletext', true);\n            titleTextGroup.exit().remove();\n\n            titleTextGroup.each(function() {\n                var titleText = Lib.ensureSingle(d3.select(this), 'text', '', function(s) {\n                    // prohibit tex interpretation as above\n                    s.attr('data-notex', 1);\n                });\n\n                var txt = trace.title.text;\n                if(trace._meta) {\n                    txt = Lib.templateString(txt, trace._meta);\n                }\n\n                titleText.text(txt)\n                    .attr({\n                        'class': 'titletext',\n                        transform: '',\n                        'text-anchor': 'middle',\n                    })\n                .call(Drawing.font, trace.title.font)\n                .call(svgTextUtils.convertToTspans, gd);\n\n                var transform;\n\n                if(trace.title.position === 'middle center') {\n                    transform = positionTitleInside(cd0);\n                } else {\n                    transform = positionTitleOutside(cd0, gs);\n                }\n\n                titleText.attr('transform',\n                    strTranslate(transform.x, transform.y) +\n                    strScale(Math.min(1, transform.scale)) +\n                    strTranslate(transform.tx, transform.ty));\n            });\n\n            // now make sure no labels overlap (at least within one pie)\n            if(hasOutsideText) scootLabels(quadrants, trace);\n\n            plotTextLines(slices, trace);\n\n            if(hasOutsideText && trace.automargin) {\n                // TODO if we ever want to improve perf,\n                // we could reuse the textBB computed above together\n                // with the sliceText transform info\n                var traceBbox = Drawing.bBox(plotGroup.node());\n\n                var domain = trace.domain;\n                var vpw = gs.w * (domain.x[1] - domain.x[0]);\n                var vph = gs.h * (domain.y[1] - domain.y[0]);\n                var xgap = (0.5 * vpw - cd0.r) / gs.w;\n                var ygap = (0.5 * vph - cd0.r) / gs.h;\n\n                Plots.autoMargin(gd, 'pie.' + trace.uid + '.automargin', {\n                    xl: domain.x[0] - xgap,\n                    xr: domain.x[1] + xgap,\n                    yb: domain.y[0] - ygap,\n                    yt: domain.y[1] + ygap,\n                    l: Math.max(cd0.cx - cd0.r - traceBbox.left, 0),\n                    r: Math.max(traceBbox.right - (cd0.cx + cd0.r), 0),\n                    b: Math.max(traceBbox.bottom - (cd0.cy + cd0.r), 0),\n                    t: Math.max(cd0.cy - cd0.r - traceBbox.top, 0),\n                    pad: 5\n                });\n            }\n        });\n    });\n\n    // This is for a bug in Chrome (as of 2015-07-22, and does not affect FF)\n    // if insidetextfont and outsidetextfont are different sizes, sometimes the size\n    // of an \"em\" gets taken from the wrong element at first so lines are\n    // spaced wrong. You just have to tell it to try again later and it gets fixed.\n    // I have no idea why we haven't seen this in other contexts. Also, sometimes\n    // it gets the initial draw correct but on redraw it gets confused.\n    setTimeout(function() {\n        plotGroups.selectAll('tspan').each(function() {\n            var s = d3.select(this);\n            if(s.attr('dy')) s.attr('dy', s.attr('dy'));\n        });\n    }, 0);\n}\n\n// TODO add support for transition\nfunction plotTextLines(slices, trace) {\n    slices.each(function(pt) {\n        var sliceTop = d3.select(this);\n\n        if(!pt.labelExtraX && !pt.labelExtraY) {\n            sliceTop.select('path.textline').remove();\n            return;\n        }\n\n        // first move the text to its new location\n        var sliceText = sliceTop.select('g.slicetext text');\n\n        pt.transform.targetX += pt.labelExtraX;\n        pt.transform.targetY += pt.labelExtraY;\n\n        sliceText.attr('transform', Lib.getTextTransform(pt.transform));\n\n        // then add a line to the new location\n        var lineStartX = pt.cxFinal + pt.pxmid[0];\n        var lineStartY = pt.cyFinal + pt.pxmid[1];\n        var textLinePath = 'M' + lineStartX + ',' + lineStartY;\n        var finalX = (pt.yLabelMax - pt.yLabelMin) * (pt.pxmid[0] < 0 ? -1 : 1) / 4;\n\n        if(pt.labelExtraX) {\n            var yFromX = pt.labelExtraX * pt.pxmid[1] / pt.pxmid[0];\n            var yNet = pt.yLabelMid + pt.labelExtraY - (pt.cyFinal + pt.pxmid[1]);\n\n            if(Math.abs(yFromX) > Math.abs(yNet)) {\n                textLinePath +=\n                    'l' + (yNet * pt.pxmid[0] / pt.pxmid[1]) + ',' + yNet +\n                    'H' + (lineStartX + pt.labelExtraX + finalX);\n            } else {\n                textLinePath += 'l' + pt.labelExtraX + ',' + yFromX +\n                    'v' + (yNet - yFromX) +\n                    'h' + finalX;\n            }\n        } else {\n            textLinePath +=\n                'V' + (pt.yLabelMid + pt.labelExtraY) +\n                'h' + finalX;\n        }\n\n        Lib.ensureSingle(sliceTop, 'path', 'textline')\n            .call(Color.stroke, trace.outsidetextfont.color)\n            .attr({\n                'stroke-width': Math.min(2, trace.outsidetextfont.size / 8),\n                d: textLinePath,\n                fill: 'none'\n            });\n    });\n}\n\nfunction attachFxHandlers(sliceTop, gd, cd) {\n    var cd0 = cd[0];\n    var cx = cd0.cx;\n    var cy = cd0.cy;\n    var trace = cd0.trace;\n    var isFunnelArea = trace.type === 'funnelarea';\n\n    // hover state vars\n    // have we drawn a hover label, so it should be cleared later\n    if(!('_hasHoverLabel' in trace)) trace._hasHoverLabel = false;\n    // have we emitted a hover event, so later an unhover event should be emitted\n    // note that click events do not depend on this - you can still get them\n    // with hovermode: false or if you were earlier dragging, then clicked\n    // in the same slice that you moused up in\n    if(!('_hasHoverEvent' in trace)) trace._hasHoverEvent = false;\n\n    sliceTop.on('mouseover', function(pt) {\n        // in case fullLayout or fullData has changed without a replot\n        var fullLayout2 = gd._fullLayout;\n        var trace2 = gd._fullData[trace.index];\n\n        if(gd._dragging || fullLayout2.hovermode === false) return;\n\n        var hoverinfo = trace2.hoverinfo;\n        if(Array.isArray(hoverinfo)) {\n            // super hacky: we need to pull out the *first* hoverinfo from\n            // pt.pts, then put it back into an array in a dummy trace\n            // and call castHoverinfo on that.\n            // TODO: do we want to have Fx.castHoverinfo somehow handle this?\n            // it already takes an array for index, for 2D, so this seems tricky.\n            hoverinfo = Fx.castHoverinfo({\n                hoverinfo: [helpers.castOption(hoverinfo, pt.pts)],\n                _module: trace._module\n            }, fullLayout2, 0);\n        }\n\n        if(hoverinfo === 'all') hoverinfo = 'label+text+value+percent+name';\n\n        // in case we dragged over the pie from another subplot,\n        // or if hover is turned off\n        if(trace2.hovertemplate || (hoverinfo !== 'none' && hoverinfo !== 'skip' && hoverinfo)) {\n            var rInscribed = pt.rInscribed || 0;\n            var hoverCenterX = cx + pt.pxmid[0] * (1 - rInscribed);\n            var hoverCenterY = cy + pt.pxmid[1] * (1 - rInscribed);\n            var separators = fullLayout2.separators;\n            var text = [];\n\n            if(hoverinfo && hoverinfo.indexOf('label') !== -1) text.push(pt.label);\n            pt.text = helpers.castOption(trace2.hovertext || trace2.text, pt.pts);\n            if(hoverinfo && hoverinfo.indexOf('text') !== -1) {\n                var tx = pt.text;\n                if(Lib.isValidTextValue(tx)) text.push(tx);\n            }\n            pt.value = pt.v;\n            pt.valueLabel = helpers.formatPieValue(pt.v, separators);\n            if(hoverinfo && hoverinfo.indexOf('value') !== -1) text.push(pt.valueLabel);\n            pt.percent = pt.v / cd0.vTotal;\n            pt.percentLabel = helpers.formatPiePercent(pt.percent, separators);\n            if(hoverinfo && hoverinfo.indexOf('percent') !== -1) text.push(pt.percentLabel);\n\n            var hoverLabel = trace2.hoverlabel;\n            var hoverFont = hoverLabel.font;\n\n            var bbox = [];\n            Fx.loneHover({\n                trace: trace,\n                x0: hoverCenterX - rInscribed * cd0.r,\n                x1: hoverCenterX + rInscribed * cd0.r,\n                y: hoverCenterY,\n                _x0: isFunnelArea ? cx + pt.TL[0] : hoverCenterX - rInscribed * cd0.r,\n                _x1: isFunnelArea ? cx + pt.TR[0] : hoverCenterX + rInscribed * cd0.r,\n                _y0: isFunnelArea ? cy + pt.TL[1] : hoverCenterY - rInscribed * cd0.r,\n                _y1: isFunnelArea ? cy + pt.BL[1] : hoverCenterY + rInscribed * cd0.r,\n                text: text.join('<br>'),\n                name: (trace2.hovertemplate || hoverinfo.indexOf('name') !== -1) ? trace2.name : undefined,\n                idealAlign: pt.pxmid[0] < 0 ? 'left' : 'right',\n                color: helpers.castOption(hoverLabel.bgcolor, pt.pts) || pt.color,\n                borderColor: helpers.castOption(hoverLabel.bordercolor, pt.pts),\n                fontFamily: helpers.castOption(hoverFont.family, pt.pts),\n                fontSize: helpers.castOption(hoverFont.size, pt.pts),\n                fontColor: helpers.castOption(hoverFont.color, pt.pts),\n                nameLength: helpers.castOption(hoverLabel.namelength, pt.pts),\n                textAlign: helpers.castOption(hoverLabel.align, pt.pts),\n                hovertemplate: helpers.castOption(trace2.hovertemplate, pt.pts),\n                hovertemplateLabels: pt,\n                eventData: [eventData(pt, trace2)]\n            }, {\n                container: fullLayout2._hoverlayer.node(),\n                outerContainer: fullLayout2._paper.node(),\n                gd: gd,\n                inOut_bbox: bbox\n            });\n            pt.bbox = bbox[0];\n\n            trace._hasHoverLabel = true;\n        }\n\n        trace._hasHoverEvent = true;\n        gd.emit('plotly_hover', {\n            points: [eventData(pt, trace2)],\n            event: d3.event\n        });\n    });\n\n    sliceTop.on('mouseout', function(evt) {\n        var fullLayout2 = gd._fullLayout;\n        var trace2 = gd._fullData[trace.index];\n        var pt = d3.select(this).datum();\n\n        if(trace._hasHoverEvent) {\n            evt.originalEvent = d3.event;\n            gd.emit('plotly_unhover', {\n                points: [eventData(pt, trace2)],\n                event: d3.event\n            });\n            trace._hasHoverEvent = false;\n        }\n\n        if(trace._hasHoverLabel) {\n            Fx.loneUnhover(fullLayout2._hoverlayer.node());\n            trace._hasHoverLabel = false;\n        }\n    });\n\n    sliceTop.on('click', function(pt) {\n        // TODO: this does not support right-click. If we want to support it, we\n        // would likely need to change pie to use dragElement instead of straight\n        // mapbox event binding. Or perhaps better, make a simple wrapper with the\n        // right mousedown, mousemove, and mouseup handlers just for a left/right click\n        // mapbox would use this too.\n        var fullLayout2 = gd._fullLayout;\n        var trace2 = gd._fullData[trace.index];\n\n        if(gd._dragging || fullLayout2.hovermode === false) return;\n\n        gd._hoverdata = [eventData(pt, trace2)];\n        Fx.click(gd, d3.event);\n    });\n}\n\nfunction determineOutsideTextFont(trace, pt, layoutFont) {\n    var color =\n        helpers.castOption(trace.outsidetextfont.color, pt.pts) ||\n        helpers.castOption(trace.textfont.color, pt.pts) ||\n        layoutFont.color;\n\n    var family =\n        helpers.castOption(trace.outsidetextfont.family, pt.pts) ||\n        helpers.castOption(trace.textfont.family, pt.pts) ||\n        layoutFont.family;\n\n    var size =\n        helpers.castOption(trace.outsidetextfont.size, pt.pts) ||\n        helpers.castOption(trace.textfont.size, pt.pts) ||\n        layoutFont.size;\n\n    return {\n        color: color,\n        family: family,\n        size: size\n    };\n}\n\nfunction determineInsideTextFont(trace, pt, layoutFont) {\n    var customColor = helpers.castOption(trace.insidetextfont.color, pt.pts);\n    if(!customColor && trace._input.textfont) {\n        // Why not simply using trace.textfont? Because if not set, it\n        // defaults to layout.font which has a default color. But if\n        // textfont.color and insidetextfont.color don't supply a value,\n        // a contrasting color shall be used.\n        customColor = helpers.castOption(trace._input.textfont.color, pt.pts);\n    }\n\n    var family =\n        helpers.castOption(trace.insidetextfont.family, pt.pts) ||\n        helpers.castOption(trace.textfont.family, pt.pts) ||\n        layoutFont.family;\n\n    var size =\n        helpers.castOption(trace.insidetextfont.size, pt.pts) ||\n        helpers.castOption(trace.textfont.size, pt.pts) ||\n        layoutFont.size;\n\n    return {\n        color: customColor || Color.contrast(pt.color),\n        family: family,\n        size: size\n    };\n}\n\nfunction prerenderTitles(cdModule, gd) {\n    var cd0, trace;\n\n    // Determine the width and height of the title for each pie.\n    for(var i = 0; i < cdModule.length; i++) {\n        cd0 = cdModule[i][0];\n        trace = cd0.trace;\n\n        if(trace.title.text) {\n            var txt = trace.title.text;\n            if(trace._meta) {\n                txt = Lib.templateString(txt, trace._meta);\n            }\n\n            var dummyTitle = Drawing.tester.append('text')\n              .attr('data-notex', 1)\n              .text(txt)\n              .call(Drawing.font, trace.title.font)\n              .call(svgTextUtils.convertToTspans, gd);\n            var bBox = Drawing.bBox(dummyTitle.node(), true);\n            cd0.titleBox = {\n                width: bBox.width,\n                height: bBox.height,\n            };\n            dummyTitle.remove();\n        }\n    }\n}\n\nfunction transformInsideText(textBB, pt, cd0) {\n    var r = cd0.r || pt.rpx1;\n    var rInscribed = pt.rInscribed;\n\n    var isEmpty = pt.startangle === pt.stopangle;\n    if(isEmpty) {\n        return {\n            rCenter: 1 - rInscribed,\n            scale: 0,\n            rotate: 0,\n            textPosAngle: 0\n        };\n    }\n\n    var ring = pt.ring;\n    var isCircle = (ring === 1) && (Math.abs(pt.startangle - pt.stopangle) === Math.PI * 2);\n\n    var halfAngle = pt.halfangle;\n    var midAngle = pt.midangle;\n\n    var orientation = cd0.trace.insidetextorientation;\n    var isHorizontal = orientation === 'horizontal';\n    var isTangential = orientation === 'tangential';\n    var isRadial = orientation === 'radial';\n    var isAuto = orientation === 'auto';\n\n    var allTransforms = [];\n    var newT;\n\n    if(!isAuto) {\n        // max size if text is placed (horizontally) at the top or bottom of the arc\n\n        var considerCrossing = function(angle, key) {\n            if(isCrossing(pt, angle)) {\n                var dStart = Math.abs(angle - pt.startangle);\n                var dStop = Math.abs(angle - pt.stopangle);\n\n                var closestEdge = dStart < dStop ? dStart : dStop;\n\n                if(key === 'tan') {\n                    newT = calcTanTransform(textBB, r, ring, closestEdge, 0);\n                } else { // case of 'rad'\n                    newT = calcRadTransform(textBB, r, ring, closestEdge, Math.PI / 2);\n                }\n                newT.textPosAngle = angle;\n\n                allTransforms.push(newT);\n            }\n        };\n\n        // to cover all cases with trace.rotation added\n        var i;\n        if(isHorizontal || isTangential) {\n            // top\n            for(i = 4; i >= -4; i -= 2) considerCrossing(Math.PI * i, 'tan');\n            // bottom\n            for(i = 4; i >= -4; i -= 2) considerCrossing(Math.PI * (i + 1), 'tan');\n        }\n        if(isHorizontal || isRadial) {\n            // left\n            for(i = 4; i >= -4; i -= 2) considerCrossing(Math.PI * (i + 1.5), 'rad');\n            // right\n            for(i = 4; i >= -4; i -= 2) considerCrossing(Math.PI * (i + 0.5), 'rad');\n        }\n    }\n\n    if(isCircle || isAuto || isHorizontal) {\n        // max size text can be inserted inside without rotating it\n        // this inscribes the text rectangle in a circle, which is then inscribed\n        // in the slice, so it will be an underestimate, which some day we may want\n        // to improve so this case can get more use\n        var textDiameter = Math.sqrt(textBB.width * textBB.width + textBB.height * textBB.height);\n\n        newT = {\n            scale: rInscribed * r * 2 / textDiameter,\n\n            // and the center position and rotation in this case\n            rCenter: 1 - rInscribed,\n            rotate: 0\n        };\n\n        newT.textPosAngle = (pt.startangle + pt.stopangle) / 2;\n        if(newT.scale >= 1) return newT;\n\n        allTransforms.push(newT);\n    }\n\n    if(isAuto || isRadial) {\n        newT = calcRadTransform(textBB, r, ring, halfAngle, midAngle);\n        newT.textPosAngle = (pt.startangle + pt.stopangle) / 2;\n        allTransforms.push(newT);\n    }\n\n    if(isAuto || isTangential) {\n        newT = calcTanTransform(textBB, r, ring, halfAngle, midAngle);\n        newT.textPosAngle = (pt.startangle + pt.stopangle) / 2;\n        allTransforms.push(newT);\n    }\n\n    var id = 0;\n    var maxScale = 0;\n    for(var k = 0; k < allTransforms.length; k++) {\n        var s = allTransforms[k].scale;\n        if(maxScale < s) {\n            maxScale = s;\n            id = k;\n        }\n\n        if(!isAuto && maxScale >= 1) {\n            // respect test order for non-auto options\n            break;\n        }\n    }\n    return allTransforms[id];\n}\n\nfunction isCrossing(pt, angle) {\n    var start = pt.startangle;\n    var stop = pt.stopangle;\n    return (\n        (start > angle && angle > stop) ||\n        (start < angle && angle < stop)\n    );\n}\n\nfunction calcRadTransform(textBB, r, ring, halfAngle, midAngle) {\n    r = Math.max(0, r - 2 * TEXTPAD);\n\n    // max size if text is rotated radially\n    var a = textBB.width / textBB.height;\n    var s = calcMaxHalfSize(a, halfAngle, r, ring);\n    return {\n        scale: s * 2 / textBB.height,\n        rCenter: calcRCenter(a, s / r),\n        rotate: calcRotate(midAngle)\n    };\n}\n\nfunction calcTanTransform(textBB, r, ring, halfAngle, midAngle) {\n    r = Math.max(0, r - 2 * TEXTPAD);\n\n    // max size if text is rotated tangentially\n    var a = textBB.height / textBB.width;\n    var s = calcMaxHalfSize(a, halfAngle, r, ring);\n    return {\n        scale: s * 2 / textBB.width,\n        rCenter: calcRCenter(a, s / r),\n        rotate: calcRotate(midAngle + Math.PI / 2)\n    };\n}\n\nfunction calcRCenter(a, b) {\n    return Math.cos(b) - a * b;\n}\n\nfunction calcRotate(t) {\n    return (180 / Math.PI * t + 720) % 180 - 90;\n}\n\nfunction calcMaxHalfSize(a, halfAngle, r, ring) {\n    var q = a + 1 / (2 * Math.tan(halfAngle));\n    return r * Math.min(\n        1 / (Math.sqrt(q * q + 0.5) + q),\n        ring / (Math.sqrt(a * a + ring / 2) + a)\n    );\n}\n\nfunction getInscribedRadiusFraction(pt, cd0) {\n    if(pt.v === cd0.vTotal && !cd0.trace.hole) return 1;// special case of 100% with no hole\n\n    return Math.min(1 / (1 + 1 / Math.sin(pt.halfangle)), pt.ring / 2);\n}\n\nfunction transformOutsideText(textBB, pt) {\n    var x = pt.pxmid[0];\n    var y = pt.pxmid[1];\n    var dx = textBB.width / 2;\n    var dy = textBB.height / 2;\n\n    if(x < 0) dx *= -1;\n    if(y < 0) dy *= -1;\n\n    return {\n        scale: 1,\n        rCenter: 1,\n        rotate: 0,\n        x: dx + Math.abs(dy) * (dx > 0 ? 1 : -1) / 2,\n        y: dy / (1 + x * x / (y * y)),\n        outside: true\n    };\n}\n\nfunction positionTitleInside(cd0) {\n    var textDiameter =\n        Math.sqrt(cd0.titleBox.width * cd0.titleBox.width + cd0.titleBox.height * cd0.titleBox.height);\n    return {\n        x: cd0.cx,\n        y: cd0.cy,\n        scale: cd0.trace.hole * cd0.r * 2 / textDiameter,\n        tx: 0,\n        ty: - cd0.titleBox.height / 2 + cd0.trace.title.font.size\n    };\n}\n\nfunction positionTitleOutside(cd0, plotSize) {\n    var scaleX = 1;\n    var scaleY = 1;\n    var maxPull;\n\n    var trace = cd0.trace;\n    // position of the baseline point of the text box in the plot, before scaling.\n    // we anchored the text in the middle, so the baseline is on the bottom middle\n    // of the first line of text.\n    var topMiddle = {\n        x: cd0.cx,\n        y: cd0.cy\n    };\n    // relative translation of the text box after scaling\n    var translate = {\n        tx: 0,\n        ty: 0\n    };\n\n    // we reason below as if the baseline is the top middle point of the text box.\n    // so we must add the font size to approximate the y-coord. of the top.\n    // note that this correction must happen after scaling.\n    translate.ty += trace.title.font.size;\n    maxPull = getMaxPull(trace);\n\n    if(trace.title.position.indexOf('top') !== -1) {\n        topMiddle.y -= (1 + maxPull) * cd0.r;\n        translate.ty -= cd0.titleBox.height;\n    } else if(trace.title.position.indexOf('bottom') !== -1) {\n        topMiddle.y += (1 + maxPull) * cd0.r;\n    }\n\n    var rx = applyAspectRatio(cd0.r, cd0.trace.aspectratio);\n\n    var maxWidth = plotSize.w * (trace.domain.x[1] - trace.domain.x[0]) / 2;\n    if(trace.title.position.indexOf('left') !== -1) {\n        // we start the text at the left edge of the pie\n        maxWidth = maxWidth + rx;\n        topMiddle.x -= (1 + maxPull) * rx;\n        translate.tx += cd0.titleBox.width / 2;\n    } else if(trace.title.position.indexOf('center') !== -1) {\n        maxWidth *= 2;\n    } else if(trace.title.position.indexOf('right') !== -1) {\n        maxWidth = maxWidth + rx;\n        topMiddle.x += (1 + maxPull) * rx;\n        translate.tx -= cd0.titleBox.width / 2;\n    }\n    scaleX = maxWidth / cd0.titleBox.width;\n    scaleY = getTitleSpace(cd0, plotSize) / cd0.titleBox.height;\n    return {\n        x: topMiddle.x,\n        y: topMiddle.y,\n        scale: Math.min(scaleX, scaleY),\n        tx: translate.tx,\n        ty: translate.ty\n    };\n}\n\nfunction applyAspectRatio(x, aspectratio) {\n    return x / ((aspectratio === undefined) ? 1 : aspectratio);\n}\n\nfunction getTitleSpace(cd0, plotSize) {\n    var trace = cd0.trace;\n    var pieBoxHeight = plotSize.h * (trace.domain.y[1] - trace.domain.y[0]);\n    // use at most half of the plot for the title\n    return Math.min(cd0.titleBox.height, pieBoxHeight / 2);\n}\n\nfunction getMaxPull(trace) {\n    var maxPull = trace.pull;\n    if(!maxPull) return 0;\n\n    var j;\n    if(Array.isArray(maxPull)) {\n        maxPull = 0;\n        for(j = 0; j < trace.pull.length; j++) {\n            if(trace.pull[j] > maxPull) maxPull = trace.pull[j];\n        }\n    }\n    return maxPull;\n}\n\nfunction scootLabels(quadrants, trace) {\n    var xHalf, yHalf, equatorFirst, farthestX, farthestY,\n        xDiffSign, yDiffSign, thisQuad, oppositeQuad,\n        wholeSide, i, thisQuadOutside, firstOppositeOutsidePt;\n\n    function topFirst(a, b) { return a.pxmid[1] - b.pxmid[1]; }\n    function bottomFirst(a, b) { return b.pxmid[1] - a.pxmid[1]; }\n\n    function scootOneLabel(thisPt, prevPt) {\n        if(!prevPt) prevPt = {};\n\n        var prevOuterY = prevPt.labelExtraY + (yHalf ? prevPt.yLabelMax : prevPt.yLabelMin);\n        var thisInnerY = yHalf ? thisPt.yLabelMin : thisPt.yLabelMax;\n        var thisOuterY = yHalf ? thisPt.yLabelMax : thisPt.yLabelMin;\n        var thisSliceOuterY = thisPt.cyFinal + farthestY(thisPt.px0[1], thisPt.px1[1]);\n        var newExtraY = prevOuterY - thisInnerY;\n\n        var xBuffer, i, otherPt, otherOuterY, otherOuterX, newExtraX;\n\n        // make sure this label doesn't overlap other labels\n        // this *only* has us move these labels vertically\n        if(newExtraY * yDiffSign > 0) thisPt.labelExtraY = newExtraY;\n\n        // make sure this label doesn't overlap any slices\n        if(!Array.isArray(trace.pull)) return; // this can only happen with array pulls\n\n        for(i = 0; i < wholeSide.length; i++) {\n            otherPt = wholeSide[i];\n\n            // overlap can only happen if the other point is pulled more than this one\n            if(otherPt === thisPt || (\n                (helpers.castOption(trace.pull, thisPt.pts) || 0) >=\n                (helpers.castOption(trace.pull, otherPt.pts) || 0))\n            ) {\n                continue;\n            }\n\n            if((thisPt.pxmid[1] - otherPt.pxmid[1]) * yDiffSign > 0) {\n                // closer to the equator - by construction all of these happen first\n                // move the text vertically to get away from these slices\n                otherOuterY = otherPt.cyFinal + farthestY(otherPt.px0[1], otherPt.px1[1]);\n                newExtraY = otherOuterY - thisInnerY - thisPt.labelExtraY;\n\n                if(newExtraY * yDiffSign > 0) thisPt.labelExtraY += newExtraY;\n            } else if((thisOuterY + thisPt.labelExtraY - thisSliceOuterY) * yDiffSign > 0) {\n                // farther from the equator - happens after we've done all the\n                // vertical moving we're going to do\n                // move horizontally to get away from these more polar slices\n\n                // if we're moving horz. based on a slice that's several slices away from this one\n                // then we need some extra space for the lines to labels between them\n                xBuffer = 3 * xDiffSign * Math.abs(i - wholeSide.indexOf(thisPt));\n\n                otherOuterX = otherPt.cxFinal + farthestX(otherPt.px0[0], otherPt.px1[0]);\n                newExtraX = otherOuterX + xBuffer - (thisPt.cxFinal + thisPt.pxmid[0]) - thisPt.labelExtraX;\n\n                if(newExtraX * xDiffSign > 0) thisPt.labelExtraX += newExtraX;\n            }\n        }\n    }\n\n    for(yHalf = 0; yHalf < 2; yHalf++) {\n        equatorFirst = yHalf ? topFirst : bottomFirst;\n        farthestY = yHalf ? Math.max : Math.min;\n        yDiffSign = yHalf ? 1 : -1;\n\n        for(xHalf = 0; xHalf < 2; xHalf++) {\n            farthestX = xHalf ? Math.max : Math.min;\n            xDiffSign = xHalf ? 1 : -1;\n\n            // first sort the array\n            // note this is a copy of cd, so cd itself doesn't get sorted\n            // but we can still modify points in place.\n            thisQuad = quadrants[yHalf][xHalf];\n            thisQuad.sort(equatorFirst);\n\n            oppositeQuad = quadrants[1 - yHalf][xHalf];\n            wholeSide = oppositeQuad.concat(thisQuad);\n\n            thisQuadOutside = [];\n            for(i = 0; i < thisQuad.length; i++) {\n                if(thisQuad[i].yLabelMid !== undefined) thisQuadOutside.push(thisQuad[i]);\n            }\n\n            firstOppositeOutsidePt = false;\n            for(i = 0; yHalf && i < oppositeQuad.length; i++) {\n                if(oppositeQuad[i].yLabelMid !== undefined) {\n                    firstOppositeOutsidePt = oppositeQuad[i];\n                    break;\n                }\n            }\n\n            // each needs to avoid the previous\n            for(i = 0; i < thisQuadOutside.length; i++) {\n                var prevPt = i && thisQuadOutside[i - 1];\n                // bottom half needs to avoid the first label of the top half\n                // top half we still need to call scootOneLabel on the first slice\n                // so we can avoid other slices, but we don't pass a prevPt\n                if(firstOppositeOutsidePt && !i) prevPt = firstOppositeOutsidePt;\n                scootOneLabel(thisQuadOutside[i], prevPt);\n            }\n        }\n    }\n}\n\nfunction layoutAreas(cdModule, plotSize) {\n    var scaleGroups = [];\n\n    // figure out the center and maximum radius\n    for(var i = 0; i < cdModule.length; i++) {\n        var cd0 = cdModule[i][0];\n        var trace = cd0.trace;\n\n        var domain = trace.domain;\n        var width = plotSize.w * (domain.x[1] - domain.x[0]);\n        var height = plotSize.h * (domain.y[1] - domain.y[0]);\n        // leave some space for the title, if it will be displayed outside\n        if(trace.title.text && trace.title.position !== 'middle center') {\n            height -= getTitleSpace(cd0, plotSize);\n        }\n\n        var rx = width / 2;\n        var ry = height / 2;\n        if(trace.type === 'funnelarea' && !trace.scalegroup) {\n            ry /= trace.aspectratio;\n        }\n\n        cd0.r = Math.min(rx, ry) / (1 + getMaxPull(trace));\n\n        cd0.cx = plotSize.l + plotSize.w * (trace.domain.x[1] + trace.domain.x[0]) / 2;\n        cd0.cy = plotSize.t + plotSize.h * (1 - trace.domain.y[0]) - height / 2;\n        if(trace.title.text && trace.title.position.indexOf('bottom') !== -1) {\n            cd0.cy -= getTitleSpace(cd0, plotSize);\n        }\n\n        if(trace.scalegroup && scaleGroups.indexOf(trace.scalegroup) === -1) {\n            scaleGroups.push(trace.scalegroup);\n        }\n    }\n\n    groupScale(cdModule, scaleGroups);\n}\n\nfunction groupScale(cdModule, scaleGroups) {\n    var cd0, i, trace;\n\n    // scale those that are grouped\n    for(var k = 0; k < scaleGroups.length; k++) {\n        var min = Infinity;\n        var g = scaleGroups[k];\n\n        for(i = 0; i < cdModule.length; i++) {\n            cd0 = cdModule[i][0];\n            trace = cd0.trace;\n\n            if(trace.scalegroup === g) {\n                var area;\n                if(trace.type === 'pie') {\n                    area = cd0.r * cd0.r;\n                } else if(trace.type === 'funnelarea') {\n                    var rx, ry;\n\n                    if(trace.aspectratio > 1) {\n                        rx = cd0.r;\n                        ry = rx / trace.aspectratio;\n                    } else {\n                        ry = cd0.r;\n                        rx = ry * trace.aspectratio;\n                    }\n\n                    rx *= (1 + trace.baseratio) / 2;\n\n                    area = rx * ry;\n                }\n\n                min = Math.min(min, area / cd0.vTotal);\n            }\n        }\n\n        for(i = 0; i < cdModule.length; i++) {\n            cd0 = cdModule[i][0];\n            trace = cd0.trace;\n            if(trace.scalegroup === g) {\n                var v = min * cd0.vTotal;\n                if(trace.type === 'funnelarea') {\n                    v /= (1 + trace.baseratio) / 2;\n                    v /= trace.aspectratio;\n                }\n\n                cd0.r = Math.sqrt(v);\n            }\n        }\n    }\n}\n\nfunction setCoords(cd) {\n    var cd0 = cd[0];\n    var r = cd0.r;\n    var trace = cd0.trace;\n    var currentAngle = helpers.getRotationAngle(trace.rotation);\n    var angleFactor = 2 * Math.PI / cd0.vTotal;\n    var firstPt = 'px0';\n    var lastPt = 'px1';\n\n    var i, cdi, currentCoords;\n\n    if(trace.direction === 'counterclockwise') {\n        for(i = 0; i < cd.length; i++) {\n            if(!cd[i].hidden) break; // find the first non-hidden slice\n        }\n        if(i === cd.length) return; // all slices hidden\n\n        currentAngle += angleFactor * cd[i].v;\n        angleFactor *= -1;\n        firstPt = 'px1';\n        lastPt = 'px0';\n    }\n\n    currentCoords = getCoords(r, currentAngle);\n\n    for(i = 0; i < cd.length; i++) {\n        cdi = cd[i];\n        if(cdi.hidden) continue;\n\n        cdi[firstPt] = currentCoords;\n\n        cdi.startangle = currentAngle;\n        currentAngle += angleFactor * cdi.v / 2;\n        cdi.pxmid = getCoords(r, currentAngle);\n        cdi.midangle = currentAngle;\n        currentAngle += angleFactor * cdi.v / 2;\n        currentCoords = getCoords(r, currentAngle);\n        cdi.stopangle = currentAngle;\n\n        cdi[lastPt] = currentCoords;\n\n        cdi.largeArc = (cdi.v > cd0.vTotal / 2) ? 1 : 0;\n\n        cdi.halfangle = Math.PI * Math.min(cdi.v / cd0.vTotal, 0.5);\n        cdi.ring = 1 - trace.hole;\n        cdi.rInscribed = getInscribedRadiusFraction(cdi, cd0);\n    }\n}\n\nfunction getCoords(r, angle) {\n    return [r * Math.sin(angle), -r * Math.cos(angle)];\n}\n\nfunction formatSliceLabel(gd, pt, cd0) {\n    var fullLayout = gd._fullLayout;\n    var trace = cd0.trace;\n    // look for textemplate\n    var texttemplate = trace.texttemplate;\n\n    // now insert text\n    var textinfo = trace.textinfo;\n    if(!texttemplate && textinfo && textinfo !== 'none') {\n        var parts = textinfo.split('+');\n        var hasFlag = function(flag) { return parts.indexOf(flag) !== -1; };\n        var hasLabel = hasFlag('label');\n        var hasText = hasFlag('text');\n        var hasValue = hasFlag('value');\n        var hasPercent = hasFlag('percent');\n\n        var separators = fullLayout.separators;\n        var text;\n\n        text = hasLabel ? [pt.label] : [];\n        if(hasText) {\n            var tx = helpers.getFirstFilled(trace.text, pt.pts);\n            if(isValidTextValue(tx)) text.push(tx);\n        }\n        if(hasValue) text.push(helpers.formatPieValue(pt.v, separators));\n        if(hasPercent) text.push(helpers.formatPiePercent(pt.v / cd0.vTotal, separators));\n        pt.text = text.join('<br>');\n    }\n\n    function makeTemplateVariables(pt) {\n        return {\n            label: pt.label,\n            value: pt.v,\n            valueLabel: helpers.formatPieValue(pt.v, fullLayout.separators),\n            percent: pt.v / cd0.vTotal,\n            percentLabel: helpers.formatPiePercent(pt.v / cd0.vTotal, fullLayout.separators),\n            color: pt.color,\n            text: pt.text,\n            customdata: Lib.castOption(trace, pt.i, 'customdata')\n        };\n    }\n\n    if(texttemplate) {\n        var txt = Lib.castOption(trace, pt.i, 'texttemplate');\n        if(!txt) {\n            pt.text = '';\n        } else {\n            var obj = makeTemplateVariables(pt);\n            var ptTx = helpers.getFirstFilled(trace.text, pt.pts);\n            if(isValidTextValue(ptTx) || ptTx === '') obj.text = ptTx;\n            pt.text = Lib.texttemplateString(txt, obj, gd._fullLayout._d3locale, obj, trace._meta || {});\n        }\n    }\n}\n\nfunction computeTransform(\n    transform,  // inout\n    textBB      // in\n) {\n    var a = transform.rotate * Math.PI / 180;\n    var cosA = Math.cos(a);\n    var sinA = Math.sin(a);\n    var midX = (textBB.left + textBB.right) / 2;\n    var midY = (textBB.top + textBB.bottom) / 2;\n    transform.textX = midX * cosA - midY * sinA;\n    transform.textY = midX * sinA + midY * cosA;\n    transform.noCenter = true;\n}\n\nmodule.exports = {\n    plot: plot,\n    formatSliceLabel: formatSliceLabel,\n    transformInsideText: transformInsideText,\n    determineInsideTextFont: determineInsideTextFont,\n    positionTitleOutside: positionTitleOutside,\n    prerenderTitles: prerenderTitles,\n    layoutAreas: layoutAreas,\n    attachFxHandlers: attachFxHandlers,\n    computeTransform: computeTransform\n};\n"]},"metadata":{},"sourceType":"script"}