{"ast":null,"code":"'use strict';\n\nvar d3 = require('@plotly/d3');\n\nvar Drawing = require('../drawing');\n\nvar Axes = require('../../plots/cartesian/axes');\n\nvar axisIds = require('../../plots/cartesian/axis_ids');\n\nvar xmlnsNamespaces = require('../../constants/xmlns_namespaces');\n\nmodule.exports = function draw(gd) {\n  var fullLayout = gd._fullLayout;\n  var imageDataAbove = [];\n  var imageDataSubplot = {};\n  var imageDataBelow = [];\n  var subplot;\n  var i; // Sort into top, subplot, and bottom layers\n\n  for (i = 0; i < fullLayout.images.length; i++) {\n    var img = fullLayout.images[i];\n\n    if (img.visible) {\n      if (img.layer === 'below' && img.xref !== 'paper' && img.yref !== 'paper') {\n        subplot = axisIds.ref2id(img.xref) + axisIds.ref2id(img.yref);\n        var plotinfo = fullLayout._plots[subplot];\n\n        if (!plotinfo) {\n          // Fall back to _imageLowerLayer in case the requested subplot doesn't exist.\n          // This can happen if you reference the image to an x / y axis combination\n          // that doesn't have any data on it (and layer is below)\n          imageDataBelow.push(img);\n          continue;\n        }\n\n        if (plotinfo.mainplot) {\n          subplot = plotinfo.mainplot.id;\n        }\n\n        if (!imageDataSubplot[subplot]) {\n          imageDataSubplot[subplot] = [];\n        }\n\n        imageDataSubplot[subplot].push(img);\n      } else if (img.layer === 'above') {\n        imageDataAbove.push(img);\n      } else {\n        imageDataBelow.push(img);\n      }\n    }\n  }\n\n  var anchors = {\n    x: {\n      left: {\n        sizing: 'xMin',\n        offset: 0\n      },\n      center: {\n        sizing: 'xMid',\n        offset: -1 / 2\n      },\n      right: {\n        sizing: 'xMax',\n        offset: -1\n      }\n    },\n    y: {\n      top: {\n        sizing: 'YMin',\n        offset: 0\n      },\n      middle: {\n        sizing: 'YMid',\n        offset: -1 / 2\n      },\n      bottom: {\n        sizing: 'YMax',\n        offset: -1\n      }\n    }\n  }; // Images must be converted to dataURL's for exporting.\n\n  function setImage(d) {\n    var thisImage = d3.select(this);\n\n    if (this._imgSrc === d.source) {\n      return;\n    }\n\n    thisImage.attr('xmlns', xmlnsNamespaces.svg);\n\n    if (d.source && d.source.slice(0, 5) === 'data:') {\n      thisImage.attr('xlink:href', d.source);\n      this._imgSrc = d.source;\n    } else {\n      var imagePromise = new Promise(function (resolve) {\n        var img = new Image();\n        this.img = img; // If not set, a `tainted canvas` error is thrown\n\n        img.setAttribute('crossOrigin', 'anonymous');\n        img.onerror = errorHandler;\n\n        img.onload = function () {\n          var canvas = document.createElement('canvas');\n          canvas.width = this.width;\n          canvas.height = this.height;\n          var ctx = canvas.getContext('2d');\n          ctx.drawImage(this, 0, 0);\n          var dataURL = canvas.toDataURL('image/png');\n          thisImage.attr('xlink:href', dataURL); // resolve promise in onload handler instead of on 'load' to support IE11\n          // see https://github.com/plotly/plotly.js/issues/1685\n          // for more details\n\n          resolve();\n        };\n\n        thisImage.on('error', errorHandler);\n        img.src = d.source;\n        this._imgSrc = d.source;\n\n        function errorHandler() {\n          thisImage.remove();\n          resolve();\n        }\n      }.bind(this));\n\n      gd._promises.push(imagePromise);\n    }\n  }\n\n  function applyAttributes(d) {\n    var thisImage = d3.select(this); // Axes if specified\n\n    var xa = Axes.getFromId(gd, d.xref);\n    var ya = Axes.getFromId(gd, d.yref);\n    var xIsDomain = Axes.getRefType(d.xref) === 'domain';\n    var yIsDomain = Axes.getRefType(d.yref) === 'domain';\n    var size = fullLayout._size;\n    var width, height;\n\n    if (xa !== undefined) {\n      width = typeof d.xref === 'string' && xIsDomain ? xa._length * d.sizex : Math.abs(xa.l2p(d.sizex) - xa.l2p(0));\n    } else {\n      width = d.sizex * size.w;\n    }\n\n    if (ya !== undefined) {\n      height = typeof d.yref === 'string' && yIsDomain ? ya._length * d.sizey : Math.abs(ya.l2p(d.sizey) - ya.l2p(0));\n    } else {\n      height = d.sizey * size.h;\n    } // Offsets for anchor positioning\n\n\n    var xOffset = width * anchors.x[d.xanchor].offset;\n    var yOffset = height * anchors.y[d.yanchor].offset;\n    var sizing = anchors.x[d.xanchor].sizing + anchors.y[d.yanchor].sizing; // Final positions\n\n    var xPos, yPos;\n\n    if (xa !== undefined) {\n      xPos = typeof d.xref === 'string' && xIsDomain ? xa._length * d.x + xa._offset : xa.r2p(d.x) + xa._offset;\n    } else {\n      xPos = d.x * size.w + size.l;\n    }\n\n    xPos += xOffset;\n\n    if (ya !== undefined) {\n      yPos = typeof d.yref === 'string' && yIsDomain ? // consistent with \"paper\" yref value, where positive values\n      // move up the page\n      ya._length * (1 - d.y) + ya._offset : ya.r2p(d.y) + ya._offset;\n    } else {\n      yPos = size.h - d.y * size.h + size.t;\n    }\n\n    yPos += yOffset; // Construct the proper aspectRatio attribute\n\n    switch (d.sizing) {\n      case 'fill':\n        sizing += ' slice';\n        break;\n\n      case 'stretch':\n        sizing = 'none';\n        break;\n    }\n\n    thisImage.attr({\n      x: xPos,\n      y: yPos,\n      width: width,\n      height: height,\n      preserveAspectRatio: sizing,\n      opacity: d.opacity\n    }); // Set proper clipping on images\n\n    var xId = xa && Axes.getRefType(d.xref) !== 'domain' ? xa._id : '';\n    var yId = ya && Axes.getRefType(d.yref) !== 'domain' ? ya._id : '';\n    var clipAxes = xId + yId;\n    Drawing.setClipUrl(thisImage, clipAxes ? 'clip' + fullLayout._uid + clipAxes : null, gd);\n  }\n\n  var imagesBelow = fullLayout._imageLowerLayer.selectAll('image').data(imageDataBelow);\n\n  var imagesAbove = fullLayout._imageUpperLayer.selectAll('image').data(imageDataAbove);\n\n  imagesBelow.enter().append('image');\n  imagesAbove.enter().append('image');\n  imagesBelow.exit().remove();\n  imagesAbove.exit().remove();\n  imagesBelow.each(function (d) {\n    setImage.bind(this)(d);\n    applyAttributes.bind(this)(d);\n  });\n  imagesAbove.each(function (d) {\n    setImage.bind(this)(d);\n    applyAttributes.bind(this)(d);\n  });\n  var allSubplots = Object.keys(fullLayout._plots);\n\n  for (i = 0; i < allSubplots.length; i++) {\n    subplot = allSubplots[i];\n    var subplotObj = fullLayout._plots[subplot]; // filter out overlaid plots (which have their images on the main plot)\n    // and gl2d plots (which don't support below images, at least not yet)\n\n    if (!subplotObj.imagelayer) continue;\n    var imagesOnSubplot = subplotObj.imagelayer.selectAll('image') // even if there are no images on this subplot, we need to run\n    // enter and exit in case there were previously\n    .data(imageDataSubplot[subplot] || []);\n    imagesOnSubplot.enter().append('image');\n    imagesOnSubplot.exit().remove();\n    imagesOnSubplot.each(function (d) {\n      setImage.bind(this)(d);\n      applyAttributes.bind(this)(d);\n    });\n  }\n};","map":{"version":3,"sources":["C:/Projects/reactApp/frontend/node_modules/plotly.js/src/components/images/draw.js"],"names":["d3","require","Drawing","Axes","axisIds","xmlnsNamespaces","module","exports","draw","gd","fullLayout","_fullLayout","imageDataAbove","imageDataSubplot","imageDataBelow","subplot","i","images","length","img","visible","layer","xref","yref","ref2id","plotinfo","_plots","push","mainplot","id","anchors","x","left","sizing","offset","center","right","y","top","middle","bottom","setImage","d","thisImage","select","_imgSrc","source","attr","svg","slice","imagePromise","Promise","resolve","Image","setAttribute","onerror","errorHandler","onload","canvas","document","createElement","width","height","ctx","getContext","drawImage","dataURL","toDataURL","on","src","remove","bind","_promises","applyAttributes","xa","getFromId","ya","xIsDomain","getRefType","yIsDomain","size","_size","undefined","_length","sizex","Math","abs","l2p","w","sizey","h","xOffset","xanchor","yOffset","yanchor","xPos","yPos","_offset","r2p","l","t","preserveAspectRatio","opacity","xId","_id","yId","clipAxes","setClipUrl","_uid","imagesBelow","_imageLowerLayer","selectAll","data","imagesAbove","_imageUpperLayer","enter","append","exit","each","allSubplots","Object","keys","subplotObj","imagelayer","imagesOnSubplot"],"mappings":"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","sourcesContent":["'use strict';\n\nvar d3 = require('@plotly/d3');\nvar Drawing = require('../drawing');\nvar Axes = require('../../plots/cartesian/axes');\nvar axisIds = require('../../plots/cartesian/axis_ids');\nvar xmlnsNamespaces = require('../../constants/xmlns_namespaces');\n\nmodule.exports = function draw(gd) {\n    var fullLayout = gd._fullLayout;\n    var imageDataAbove = [];\n    var imageDataSubplot = {};\n    var imageDataBelow = [];\n    var subplot;\n    var i;\n\n    // Sort into top, subplot, and bottom layers\n    for(i = 0; i < fullLayout.images.length; i++) {\n        var img = fullLayout.images[i];\n\n        if(img.visible) {\n            if(img.layer === 'below' && img.xref !== 'paper' && img.yref !== 'paper') {\n                subplot = axisIds.ref2id(img.xref) + axisIds.ref2id(img.yref);\n\n                var plotinfo = fullLayout._plots[subplot];\n\n                if(!plotinfo) {\n                    // Fall back to _imageLowerLayer in case the requested subplot doesn't exist.\n                    // This can happen if you reference the image to an x / y axis combination\n                    // that doesn't have any data on it (and layer is below)\n                    imageDataBelow.push(img);\n                    continue;\n                }\n\n                if(plotinfo.mainplot) {\n                    subplot = plotinfo.mainplot.id;\n                }\n\n                if(!imageDataSubplot[subplot]) {\n                    imageDataSubplot[subplot] = [];\n                }\n                imageDataSubplot[subplot].push(img);\n            } else if(img.layer === 'above') {\n                imageDataAbove.push(img);\n            } else {\n                imageDataBelow.push(img);\n            }\n        }\n    }\n\n\n    var anchors = {\n        x: {\n            left: { sizing: 'xMin', offset: 0 },\n            center: { sizing: 'xMid', offset: -1 / 2 },\n            right: { sizing: 'xMax', offset: -1 }\n        },\n        y: {\n            top: { sizing: 'YMin', offset: 0 },\n            middle: { sizing: 'YMid', offset: -1 / 2 },\n            bottom: { sizing: 'YMax', offset: -1 }\n        }\n    };\n\n\n    // Images must be converted to dataURL's for exporting.\n    function setImage(d) {\n        var thisImage = d3.select(this);\n\n        if(this._imgSrc === d.source) {\n            return;\n        }\n\n        thisImage.attr('xmlns', xmlnsNamespaces.svg);\n\n        if(d.source && d.source.slice(0, 5) === 'data:') {\n            thisImage.attr('xlink:href', d.source);\n            this._imgSrc = d.source;\n        } else {\n            var imagePromise = new Promise(function(resolve) {\n                var img = new Image();\n                this.img = img;\n\n                // If not set, a `tainted canvas` error is thrown\n                img.setAttribute('crossOrigin', 'anonymous');\n                img.onerror = errorHandler;\n                img.onload = function() {\n                    var canvas = document.createElement('canvas');\n                    canvas.width = this.width;\n                    canvas.height = this.height;\n\n                    var ctx = canvas.getContext('2d');\n                    ctx.drawImage(this, 0, 0);\n\n                    var dataURL = canvas.toDataURL('image/png');\n\n                    thisImage.attr('xlink:href', dataURL);\n\n                    // resolve promise in onload handler instead of on 'load' to support IE11\n                    // see https://github.com/plotly/plotly.js/issues/1685\n                    // for more details\n                    resolve();\n                };\n\n                thisImage.on('error', errorHandler);\n\n                img.src = d.source;\n                this._imgSrc = d.source;\n\n                function errorHandler() {\n                    thisImage.remove();\n                    resolve();\n                }\n            }.bind(this));\n\n            gd._promises.push(imagePromise);\n        }\n    }\n\n    function applyAttributes(d) {\n        var thisImage = d3.select(this);\n\n        // Axes if specified\n        var xa = Axes.getFromId(gd, d.xref);\n        var ya = Axes.getFromId(gd, d.yref);\n        var xIsDomain = Axes.getRefType(d.xref) === 'domain';\n        var yIsDomain = Axes.getRefType(d.yref) === 'domain';\n\n        var size = fullLayout._size;\n        var width, height;\n        if(xa !== undefined) {\n            width = ((typeof(d.xref) === 'string') && xIsDomain) ?\n                xa._length * d.sizex :\n                Math.abs(xa.l2p(d.sizex) - xa.l2p(0));\n        } else {\n            width = d.sizex * size.w;\n        }\n        if(ya !== undefined) {\n            height = ((typeof(d.yref) === 'string') && yIsDomain) ?\n                ya._length * d.sizey :\n                Math.abs(ya.l2p(d.sizey) - ya.l2p(0));\n        } else {\n            height = d.sizey * size.h;\n        }\n\n        // Offsets for anchor positioning\n        var xOffset = width * anchors.x[d.xanchor].offset;\n        var yOffset = height * anchors.y[d.yanchor].offset;\n\n        var sizing = anchors.x[d.xanchor].sizing + anchors.y[d.yanchor].sizing;\n\n        // Final positions\n        var xPos, yPos;\n        if(xa !== undefined) {\n            xPos = ((typeof(d.xref) === 'string') && xIsDomain) ?\n                xa._length * d.x + xa._offset :\n                xa.r2p(d.x) + xa._offset;\n        } else {\n            xPos = d.x * size.w + size.l;\n        }\n        xPos += xOffset;\n        if(ya !== undefined) {\n            yPos = ((typeof(d.yref) === 'string') && yIsDomain) ?\n                // consistent with \"paper\" yref value, where positive values\n                // move up the page\n                ya._length * (1 - d.y) + ya._offset :\n                ya.r2p(d.y) + ya._offset;\n        } else {\n            yPos = size.h - d.y * size.h + size.t;\n        }\n        yPos += yOffset;\n\n        // Construct the proper aspectRatio attribute\n        switch(d.sizing) {\n            case 'fill':\n                sizing += ' slice';\n                break;\n\n            case 'stretch':\n                sizing = 'none';\n                break;\n        }\n\n        thisImage.attr({\n            x: xPos,\n            y: yPos,\n            width: width,\n            height: height,\n            preserveAspectRatio: sizing,\n            opacity: d.opacity\n        });\n\n\n        // Set proper clipping on images\n        var xId = xa && (Axes.getRefType(d.xref) !== 'domain') ? xa._id : '';\n        var yId = ya && (Axes.getRefType(d.yref) !== 'domain') ? ya._id : '';\n        var clipAxes = xId + yId;\n\n        Drawing.setClipUrl(\n            thisImage,\n            clipAxes ? ('clip' + fullLayout._uid + clipAxes) : null,\n            gd\n        );\n    }\n\n    var imagesBelow = fullLayout._imageLowerLayer.selectAll('image')\n        .data(imageDataBelow);\n    var imagesAbove = fullLayout._imageUpperLayer.selectAll('image')\n        .data(imageDataAbove);\n\n    imagesBelow.enter().append('image');\n    imagesAbove.enter().append('image');\n\n    imagesBelow.exit().remove();\n    imagesAbove.exit().remove();\n\n    imagesBelow.each(function(d) {\n        setImage.bind(this)(d);\n        applyAttributes.bind(this)(d);\n    });\n    imagesAbove.each(function(d) {\n        setImage.bind(this)(d);\n        applyAttributes.bind(this)(d);\n    });\n\n    var allSubplots = Object.keys(fullLayout._plots);\n    for(i = 0; i < allSubplots.length; i++) {\n        subplot = allSubplots[i];\n        var subplotObj = fullLayout._plots[subplot];\n\n        // filter out overlaid plots (which have their images on the main plot)\n        // and gl2d plots (which don't support below images, at least not yet)\n        if(!subplotObj.imagelayer) continue;\n\n        var imagesOnSubplot = subplotObj.imagelayer.selectAll('image')\n            // even if there are no images on this subplot, we need to run\n            // enter and exit in case there were previously\n            .data(imageDataSubplot[subplot] || []);\n\n        imagesOnSubplot.enter().append('image');\n        imagesOnSubplot.exit().remove();\n\n        imagesOnSubplot.each(function(d) {\n            setImage.bind(this)(d);\n            applyAttributes.bind(this)(d);\n        });\n    }\n};\n"]},"metadata":{},"sourceType":"script"}